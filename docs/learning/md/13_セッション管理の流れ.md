# セッション管理の流れ

このドキュメントでは、複数の会話（セッション）を管理する仕組みを解説します。

## セッションとは？

「セッション」とは、1つの独立した会話のことです。

```
例：
- セッションA: 「Pythonについて教えて」
- セッションB: 「今日の天気は？」
- セッションC: 「レシピを教えて」
```

複数のセッションを持つことで、異なるトピックの会話を同時に進行できます。

## ファイル構成

| ファイル | 役割 |
|---------|------|
| `useSessions.ts` | セッションの作成・切り替え・削除を管理 |
| `useChat.ts` | メッセージの送受信を管理 |
| `SessionTabs.tsx` | タブUI（セッション一覧）を表示 |
| `App.tsx` | 各フックを統合 |

## データの流れ

<div class="architecture-box">
<h3>📊 コンポーネント構成</h3>
<pre>
┌────────────────────────────────────────────────────────┐
│                    App.tsx                              │
│  ┌─────────────────┐    ┌─────────────────┐            │
│  │  useSessions()  │←──→│    useChat()    │            │
│  │ セッション管理   │    │ メッセージ管理   │            │
│  └────────┬────────┘    └────────┬────────┘            │
│           │                      │                      │
│           └──────────┬───────────┘                      │
│                      ↓                                  │
│             ┌────────────────┐                          │
│             │  ChatScreen    │                          │
│             │ ┌────────────┐ │                          │
│             │ │SessionTabs │ │                          │
│             │ └────────────┘ │                          │
│             └────────────────┘                          │
└────────────────────────────────────────────────────────┘
</pre>
</div>

## セッションの作成フロー

<div class="flow-box">
<h3>➕ 新規セッション作成</h3>
<pre>
ユーザーが「+」ボタンをクリック
      ↓
SessionTabs: onNewSession() を呼び出し
      ↓
App.tsx: createSession() を呼び出し
      ↓
useSessions: 新しいセッションを作成
      ↓
ローカルストレージに自動保存
      ↓
画面に新しいタブが表示される
</pre>
</div>

## セッション切り替えフロー

<div class="flow-box">
<h3>🔄 セッション切り替え</h3>
<pre>
ユーザーがタブをクリック
      ↓
SessionTabs: onSelectSession(id) を呼び出し
      ↓
useSessions: activeSessionId を更新
      ↓
useChat: 選択したセッションのメッセージを表示
</pre>
</div>

## メッセージ送信時の処理

<div class="flow-box">
<h3>💬 メッセージ送信フロー</h3>
<pre>
ユーザーがメッセージを送信
      ↓
useChat: sendMessage() を実行
      ↓
バックエンドからレスポンスを受信
      ↓
useChat: onMessagesUpdate() を呼び出し
      ↓
useSessions: セッションのメッセージを更新
      ↓
ローカルストレージに自動保存
      ↓
タイトルが「新しい会話」の場合は自動生成
</pre>
</div>

## セッションのデータ構造

```typescript
interface ChatSession {
  id: string           // 一意のID（例: "session_1705471200_abc123"）
  title: string        // タイトル（例: "Pythonについて教えて"）
  messages: Message[]  // メッセージ履歴
  threadId: string     // バックエンドとの会話ID
  createdAt: number    // 作成日時
  updatedAt: number    // 最終更新日時
}
```

## ローカルストレージでの保存

セッションはブラウザの**ローカルストレージ**に保存されます。

### 保存場所
- キー: `chat_sessions`
- 形式: JSON配列

### 制限事項

| 項目 | 制限 |
|------|------|
| 最大セッション数 | 10個 |
| 容量目安 | 約80KB（10セッション × 20メッセージ） |
| デバイス間同期 | なし（ブラウザごとに独立） |
| データ消失 | ブラウザのデータクリア時 |

### なぜローカルストレージ？

<div class="tip-box">
<h3>💡 ローカルストレージを使う理由</h3>
<ul>
<li>GCP設定なしで動作確認できる</li>
<li>バックエンドAPIの追加が不要</li>
<li>シンプルな実装で初学者にも理解しやすい</li>
</ul>
</div>

## よくある質問

<div class="info-box">
<h3>❓ FAQ</h3>
<p><strong>Q. セッションを削除したら復元できる？</strong><br>
A. できません。削除前に確認ダイアログが表示されますが、一度削除すると復元できません。</p>
<p><strong>Q. PCを変えたらセッションが見えない？</strong><br>
A. 見えません。ローカルストレージはブラウザごとに独立しているため、別のデバイスでは表示されません。</p>
<p><strong>Q. 最大10セッションを超えたらどうなる？</strong><br>
A. 古いセッションが自動削除されます。新しいセッションを作成すると、最も古いセッションが削除されます。</p>
<p><strong>Q. ブラウザのキャッシュをクリアしたら？</strong><br>
A. セッションは消えます。ローカルストレージもクリアされるため、すべてのセッションが失われます。</p>
</div>

## 関連ドキュメント

- [11_チャット送信の流れ](./11_チャット送信の流れ.md) - メッセージ送受信の詳細
- [04_フロントエンド解説](./04_フロントエンド解説.md) - React/TypeScriptの基本

## コード例

### セッション管理フックの使用

```typescript
// App.tsx での使用例
import { useSessions } from './hooks/useSessions'

function App() {
  const {
    sessions,           // セッション一覧
    activeSession,      // 現在のセッション
    createSession,      // 新規作成
    switchSession,      // 切り替え
    closeSession,       // 削除
  } = useSessions()

  // 新しいセッションを作成
  const handleNewChat = () => {
    createSession()
  }

  // セッションを切り替え
  const handleSelectSession = (id: string) => {
    switchSession(id)
  }
}
```

### タイトル自動生成の仕組み

```typescript
// 最初のユーザーメッセージからタイトルを生成
// 例: "Pythonでリストをソートする方法を..." → "Pythonでリストをソート..."

function generateTitleFromMessage(content: string): string {
  const maxLength = 20
  const trimmed = content.trim().replace(/\n/g, ' ')
  if (trimmed.length <= maxLength) {
    return trimmed
  }
  return trimmed.substring(0, maxLength) + '...'
}
```
