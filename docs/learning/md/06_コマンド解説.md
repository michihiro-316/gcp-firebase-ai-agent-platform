# コマンド解説

「黒い画面（ターミナル）」で使うコマンドを解説します。
魔法のように見えますが、一つ一つ意味があります。

---

## 🚀 ワンコマンド起動（推奨）

本プロジェクトでは、複雑なコマンドを1つにまとめた起動スクリプトを用意しています。

```bash
./start.sh
```

**これだけで以下が自動実行されます：**

| ステップ | 内容 | 詳細 |
|---------|------|------|
| 1 | バックエンド起動 | `python -m functions_framework --target=main --port=8080` |
| 2 | フロントエンド起動 | `npm run dev` |
| 3 | 接続確認 | ヘルスチェック |

### start.sh の中身を理解する

```bash
# Step 1: バックエンド起動
python -m functions_framework --target=main --port=8080 &
#   └── python -m: Pythonモジュールとして実行
#   └── functions_framework: Cloud Functionsローカル実行ツール
#   └── --target=main: backend/src/main.py の main関数を実行
#   └── --port=8080: ポート8080で待ち受け
#   └── &: バックグラウンドで実行

# Step 2: フロントエンド起動
npm run dev &
#   └── npm run: package.jsonのscriptsを実行
#   └── dev: 開発サーバー（Vite）を起動
#   └── &: バックグラウンドで実行
```

### 起動後のシステム構成

<div class="architecture-box">
<h3>🖥️ ローカル開発環境</h3>
<pre>
┌─────────────────────────────────────────────────────────────────┐
│                        あなたのPC                                │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  [ブラウザ]                                                      │
│  http://localhost:5173                                          │
│       │                                                         │
│       │ HTTPリクエスト                                           │
│       ▼                                                         │
│  ┌─────────────────┐         ┌─────────────────┐               │
│  │  フロントエンド   │ ──API→ │  バックエンド    │               │
│  │  (React/Vite)   │         │  (Python/Flask) │               │
│  │  :5173          │         │  :8080          │               │
│  └─────────────────┘         └────────┬────────┘               │
│                                       │                         │
│                                       │ Vertex AI API           │
│                                       ▼                         │
│                              ┌─────────────────┐               │
│                              │  Google Cloud    │               │
│                              │  (Gemini AI)     │               │
│                              └─────────────────┘               │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
</pre>
</div>

---

## 📦 デプロイコマンド

### 顧客別デプロイ

```bash
./infrastructure/deploy-customer.sh <customer-id>
```

**例:**
```bash
./infrastructure/deploy-customer.sh acme-corp
```

### deploy-customer.sh の中身を理解する

```bash
# 1. バックエンドをCloud Functionsにデプロイ
gcloud functions deploy ${CUSTOMER_ID}-chat-api \
  --runtime python311 \              # Python 3.11を使用
  --trigger-http \                   # HTTPリクエストで起動
  --entry-point main \               # main関数を実行
  --set-env-vars CUSTOMER_ID=${CUSTOMER_ID}  # 環境変数設定

# 2. フロントエンドをビルド
npm run build                        # dist/ フォルダに出力

# 3. Firebase Hostingにデプロイ
firebase deploy --only hosting       # dist/ をアップロード
```

### デプロイ後の構成

<div class="architecture-box">
<h3>☁️ Google Cloud Platform</h3>
<pre>
┌─────────────────────────────────────────────────────────────────┐
│                    Google Cloud Platform                         │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  [ユーザーのブラウザ]                                             │
│       │                                                         │
│       ▼                                                         │
│  ┌─────────────────┐         ┌─────────────────┐               │
│  │ Firebase Hosting │ ──API→ │ Cloud Functions │               │
│  │ (静的ファイル)   │         │ (Python)        │               │
│  │ your-app.web.app│         │ /chat エンドポ  │               │
│  └─────────────────┘         └────────┬────────┘               │
│                                       │                         │
│       ┌───────────────────────────────┼───────────────────┐     │
│       │                               │                   │     │
│       ▼                               ▼                   ▼     │
│  ┌──────────┐                  ┌──────────┐        ┌──────────┐│
│  │ Firestore │                  │ Vertex AI│        │ Firebase ││
│  │ (データ)  │                  │ (AI)     │        │ Auth     ││
│  └──────────┘                  └──────────┘        └──────────┘│
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
</pre>
</div>

---

## 基本：ターミナルとは？

```
ターミナル = コンピュータに文字で命令を出す画面

マウスでクリック → GUI（グラフィカル）
文字で命令       → CLI（コマンドライン）
```

プログラマーはCLIをよく使います。速いからです。

---

## 📄 シェルスクリプト（.sh）とは？

### 一言で説明

```
.shファイル = 複数のコマンドをまとめた「レシピ」
```

### 何が嬉しいの？

<div class="tip-box">
<h3>💡 シェルスクリプトのメリット</h3>
<p><strong>【.shファイルがない場合】</strong><br>
毎回これを打つ必要がある：</p>
<pre>
$ cd src/backend
$ pip install -r requirements.txt
$ python -m functions_framework --target=main --port=8080 &
$ cd ../src/frontend
$ npm install
$ npm run dev
</pre>
<p><strong>【.shファイルがある場合】</strong><br>
これだけでOK：</p>
<pre>$ ./start.sh</pre>
</div>

### 実行方法

```bash
# 方法1: ./ファイル名
./start.sh

# 方法2: bash ファイル名
bash start.sh

# 方法3: sh ファイル名
sh start.sh
```

### 「./」の意味

<div class="info-box">
<h3>📝 「./」の意味</h3>
<pre>
./start.sh
 │└── start.sh というファイル
 └── 「今いるフォルダの」という意味
</pre>
<p>「./」がないと、コンピュータは「システムにインストールされたコマンド」を探しに行く<br>
「./」をつけると「今いるフォルダにあるファイル」を実行する</p>
</div>

### .shファイルの中身

```bash
#!/bin/bash           ← 「このファイルはbashで実行してね」という宣言

echo "Hello"          ← コマンド1
cd src/backend            ← コマンド2
pip install ...       ← コマンド3

# 上から順番に実行される
```

### 本プロジェクトの.shファイル一覧

| ファイル | 場所 | 役割 |
|---------|------|------|
| `start.sh` | プロジェクト直下 | 開発環境を1コマンドで起動 |
| `deploy.sh` | プロジェクト直下 | 本番環境に1コマンドでデプロイ |
| `deploy-customer.sh` | infrastructure/ | 顧客別デプロイ |

### イメージ

```
.shファイル = 料理のレシピ

【レシピがない場合】
1. 卵を割る
2. 塩を入れる
3. かき混ぜる
4. フライパンで焼く
...を毎回思い出しながら作る

【レシピがある場合】
「卵焼きのレシピ.sh」を見れば誰でも同じように作れる
しかも「./卵焼きのレシピ.sh」で自動で作ってくれる！
```

---

## 👥 顧客管理コマンド

顧客（会社）とユーザーを管理するコマンドです。
**src/backend/scripts/manage_customer.py** を使います。

### 実行方法

```bash
cd src/backend
python scripts/manage_customer.py <コマンド> [引数...]
```

### コマンド一覧

| コマンド | 役割 | 使用例 |
|----------|------|--------|
| `list` | 顧客一覧を表示 | `python scripts/manage_customer.py list` |
| `add` | 顧客を作成 | `python scripts/manage_customer.py add acme-corp "株式会社ACME"` |
| `show` | 顧客の詳細表示 | `python scripts/manage_customer.py show acme-corp` |
| `show-user` | ユーザーの詳細表示 | `python scripts/manage_customer.py show-user yamada@acme.co.jp` |
| `add-domain` | メールドメイン（@以降）を追加 | `python scripts/manage_customer.py add-domain acme-corp acme.co.jp` |
| `add-email` | メールを追加 | `python scripts/manage_customer.py add-email acme-corp tanaka@gmail.com` |
| `remove-domain` | ドメインを削除 | `python scripts/manage_customer.py remove-domain acme-corp acme.co.jp` |
| `remove-email` | メールを削除 | `python scripts/manage_customer.py remove-email acme-corp tanaka@gmail.com` |
| `add-user` | 手動紐付け | `python scripts/manage_customer.py add-user acme-corp yamada@acme.co.jp` |

### クイックスタート（新規顧客の追加）

```bash
cd src/backend

# 1. 顧客を作成
python scripts/manage_customer.py add acme-corp "株式会社ACME"

# 2. メールドメイン（@以降）を登録（社員全員が自動振り分け）
python scripts/manage_customer.py add-domain acme-corp acme.co.jp

# 3. 確認
python scripts/manage_customer.py show acme-corp
```

**これだけで @acme.co.jp のユーザーは全員自動で振り分けられます！**

### 自動振り分けの仕組み

<div class="tip-box">
<h3>✨ 自動振り分け</h3>
<p><strong>【従来の方法】400人の会社を登録する場合</strong><br>
→ 400回 add-user コマンドを実行... 大変！</p>
<p><strong>【自動振り分け】</strong><br>
→ 1回 add-domain を実行するだけ！<br>
→ @acme.co.jp のユーザーは全員自動で振り分け</p>
<p><strong>メモ:</strong> ここでいう「ドメイン」は、メールアドレスの@以降の部分（メールドメイン）です。URLドメインではありません。</p>
<table>
<tr><th>方法</th><th>コマンド</th><th>用途</th></tr>
<tr><td>メールドメイン登録</td><td>add-domain</td><td>社員全員を一括登録（@acme.co.jpなど）</td></tr>
<tr><td>個別メール登録</td><td>add-email</td><td>業務委託者を個別登録（外部メール）</td></tr>
<tr><td>手動紐付け</td><td>add-user</td><td>自動振り分けを使わない特殊ケース</td></tr>
</table>
</div>

### 出力例

```bash
$ python scripts/manage_customer.py show acme-corp

=== 株式会社ACME ===

  顧客ID: acme-corp
  作成日: 2024-01-15

  --- 自動振り分け設定 ---
  許可ドメイン:
    @acme.co.jp
  許可メール（個別）:
    tanaka@gmail.com

  --- 所属ユーザー ---
    yamada@acme.co.jp （自動）
    sato@acme.co.jp （自動）
    tanaka@gmail.com （自動）

  ユーザー数: 3人
```

---

## よく使うコマンド

### cd（Change Directory）

```bash
cd src/backend
```

**意味**: 「backendフォルダに移動する」

<div class="info-box">
<h3>📁 cdコマンド</h3>
<pre>
【イメージ】
あなたは今「GCP」という部屋にいます
    ↓
「cd src/backend」で「backend」という部屋に移動
    ↓
今は「GCP/backend」の部屋にいます
</pre>
</div>

**よく使うパターン**:
```bash
cd src/backend      # backendフォルダに入る
cd ..           # 一つ上のフォルダに戻る
cd ~            # ホームフォルダに戻る
```

---

### ls（List）

```bash
ls
```

**意味**: 「今いるフォルダの中身を表示する」

```
【実行例】
$ ls
README.md  backend/  frontend/  learning/
```

**オプション**:
```bash
ls -la    # 隠しファイルも含めて詳細表示
```

---

### pip install

```bash
pip install -r requirements.txt
```

**分解して理解**:

| 部分 | 意味 |
|------|------|
| `pip` | Pythonのパッケージ管理ツール |
| `install` | インストールする |
| `-r` | ファイルから読み込む（-r = read） |
| `requirements.txt` | インストールするパッケージ一覧が書かれたファイル |

**何が起きる？**
```
requirements.txt の中身:
  flask==3.0.0
  firebase-admin==6.2.0
  langchain==0.1.0
  ...

これらのパッケージがインターネットからダウンロードされて
あなたのパソコンにインストールされます
```

**イメージ**:
```
pip install = アプリストアからアプリをインストール
requirements.txt = 買い物リスト
```

---

### npm install

```bash
npm install
```

**意味**: 「package.jsonに書かれたパッケージをインストール」

| 用語 | 意味 |
|------|------|
| `npm` | Node.jsのパッケージ管理ツール（Node Package Manager） |
| `install` | インストールする |
| `package.json` | 必要なパッケージ一覧（自動で読み込まれる） |

**pip と npm の違い**:
```
pip     → Python用
npm     → JavaScript/TypeScript用
```

---

### functions-framework

```bash
functions-framework --target=main --port=8080
```

**分解して理解**:

| 部分 | 意味 |
|------|------|
| `functions-framework` | Cloud Functionsをローカルで動かすツール |
| `--target=main` | main という関数を実行する |
| `--port=8080` | ポート8080で待ち受ける |

**何が起きる？**
```
1. あなたのPythonコード（main.py）が読み込まれる
2. main という関数がサーバーとして起動
3. http://localhost:8080 でアクセス可能になる
```

<div class="info-box">
<h3>🔌 ポートとは？</h3>
<pre>
ポート = マンションの部屋番号

http://localhost:8080
  └── localhost = あなたのパソコン
  └── 8080 = 8080号室

別のアプリは別の部屋番号（ポート）を使う
</pre>
</div>

---

### npm run dev

```bash
npm run dev
```

**意味**: 「package.jsonのscripts.devを実行」

```json
// package.json の中身（抜粋）
{
  "scripts": {
    "dev": "vite",           ← npm run dev で実行される
    "build": "vite build",   ← npm run build で実行される
  }
}
```

**何が起きる？**
```
1. Vite（開発サーバー）が起動
2. Reactアプリがコンパイルされる
3. http://localhost:5173 でアクセス可能になる
4. コードを変更すると自動で画面が更新される（ホットリロード）
```

---

## ローカル開発の全体像

<div class="flow-box">
<h3>🔄 ローカル開発フロー</h3>
<pre>
【ターミナル1】                【ターミナル2】
cd src/backend                     cd src/frontend
pip install -r requirements.txt    npm install
functions-framework ...        npm run dev
    ↓                              ↓
バックエンド起動                フロントエンド起動
http://localhost:8080          http://localhost:5173
    ↑                              │
    └──────── API呼び出し ─────────┘

【ブラウザ】
http://localhost:5173 を開く
    ↓
Reactの画面が表示される
    ↓
チャット送信すると localhost:8080 にAPIリクエスト
    ↓
AIが返答
</pre>
</div>

---

## よくあるエラーと対処

### 「command not found」

```bash
$ pip install ...
zsh: command not found: pip
```

**原因**: pipがインストールされていない、またはパスが通っていない

**対処**:
```bash
# Macの場合
pip3 install ...    # pip の代わりに pip3 を使う

# または Python経由で
python3 -m pip install ...
```

---

### 「EADDRINUSE: address already in use」

```bash
Error: EADDRINUSE: address already in use :::8080
```

**原因**: ポート8080が既に使われている

**対処**:
```bash
# 使っているプロセスを探す
lsof -i :8080

# 見つかったプロセスを終了（PID番号を指定）
kill -9 12345
```

---

### 「ModuleNotFoundError」

```bash
ModuleNotFoundError: No module named 'flask'
```

**原因**: パッケージがインストールされていない

**対処**:
```bash
pip install -r requirements.txt
```

---

## まとめ

| コマンド | 一言で言うと |
|----------|-------------|
| `cd フォルダ名` | フォルダ移動 |
| `ls` | 中身を見る |
| `pip install -r requirements.txt` | Python用パッケージをインストール |
| `npm install` | JavaScript用パッケージをインストール |
| `functions-framework --target=main --port=8080` | バックエンドサーバー起動 |
| `npm run dev` | フロントエンドサーバー起動 |

**最初は意味がわからなくても大丈夫！**
何度も使っていると自然と覚えます。
