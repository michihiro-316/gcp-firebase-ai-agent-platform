# ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã¨ãƒ•ã‚¡ã‚¤ãƒ«é€£æº - å®Œå…¨è§£èª¬

<div class="goal-box">
<div class="box-title">ã“ã®ãƒšãƒ¼ã‚¸ã®ã‚´ãƒ¼ãƒ«</div>
<div class="box-content">

ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã¨ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®é€šä¿¡ã«ãŠã„ã¦:
- **ã©ã“ã§ä½•ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãŒåŠ¹ã„ã¦ã„ã‚‹ã‹** ã‚’ç†è§£ã™ã‚‹
- **ã©ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒã©ã®ãƒ•ã‚¡ã‚¤ãƒ«ã«ç¹‹ãŒã£ã¦ã„ã‚‹ã‹** ã‚’æŠŠæ¡ã™ã‚‹

</div>
</div>

---

## å…¨ä½“ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ•ãƒ­ãƒ¼å›³

<div class="architecture-box">
<div class="box-title">ğŸ” ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆå…¨ä½“å›³</div>
<div class="box-content">

```
ã€ãƒ–ãƒ©ã‚¦ã‚¶ã€‘                    ã€Gatewayã€‘                     ã€Backendã€‘

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œ     â”‚
â”‚  (ãƒãƒ£ãƒƒãƒˆé€ä¿¡)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  useChat.ts     â”‚
â”‚  sendMessage()  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  api.ts         â”‚     â”‚                                             â”‚
â”‚  â‘ IDãƒˆãƒ¼ã‚¯ãƒ³å–å¾—â”‚â”€â”€â”€â”€â–¶â”‚ Firebase Auth                               â”‚
â”‚  getAuthToken() â”‚â—€â”€â”€â”€â”€â”‚ (ãƒˆãƒ¼ã‚¯ãƒ³ç™ºè¡Œ)                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ Authorization: Bearer {token}
         â”‚
â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  gateway/       â”‚
â”‚  main.py        â”‚
â”‚                 â”‚
â”‚ â‘¡CORSæ¤œè¨¼      â”‚â”€â”€â”€ ãƒ–ãƒ©ã‚¦ã‚¶ã‹ã‚‰ã®ä¸æ­£ã‚ªãƒªã‚¸ãƒ³ã‚’ãƒ–ãƒ­ãƒƒã‚¯
â”‚                 â”‚
â”‚ â‘¢ãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â–¶ Firebase Admin SDK
â”‚ verify_request()â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€  (ç½²åãƒ»æœ‰åŠ¹æœŸé™ãƒ»ç™ºè¡Œè€…ã‚’æ¤œè¨¼)
â”‚                 â”‚
â”‚ â‘£customer_id   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â–¶ Firestore
â”‚   å–å¾—/æ¤œè¨¼     â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€  (customers ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³)
â”‚                 â”‚
â”‚ â‘¤è»¢é€å…ˆURLå–å¾—  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â–¶ Firestore
â”‚                 â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€  (cloud_functions_url)
â”‚                 â”‚
â”‚ â‘¥å†…éƒ¨ãƒ˜ãƒƒãƒ€ãƒ¼   â”‚
â”‚   + HMACç½²å    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ X-Gateway-Verified: true
         â”‚ X-User-Id: xxx
         â”‚ X-Customer-Id: xxx
         â”‚ X-Gateway-Signature: {hmac}
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  backend/       â”‚
â”‚  main.py        â”‚
â”‚                 â”‚
â”‚ â‘¦GatewayçµŒç”±   â”‚â”€â”€â”€ X-Gateway-Verified + HMACç½²åæ¤œè¨¼
â”‚   ç¢ºèª          â”‚
â”‚                 â”‚
â”‚ â‘§ãƒ¬ãƒ¼ãƒˆåˆ¶é™    â”‚â”€â”€â”€ DoSæ”»æ’ƒãƒ»èª²é‡‘æ”»æ’ƒã‚’é˜²æ­¢
â”‚ check_rate_limitâ”‚
â”‚                 â”‚
â”‚ â‘¨å…¥åŠ›å€¤æ¤œè¨¼    â”‚â”€â”€â”€ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é•·ãƒ»thread_idå½¢å¼
â”‚                 â”‚
â”‚ â‘©é¡§å®¢IDæ¤œè¨¼    â”‚â”€â”€â”€ ç’°å¢ƒå¤‰æ•°ã¨ä¸€è‡´ã™ã‚‹ã‹
â”‚                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  agent.py       â”‚
â”‚  AIå‡¦ç†         â”‚â”€â”€â”€â”€â”€â”€â”€â”€â–¶ Vertex AI (Gemini)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

</div>
</div>

---

## ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆè©³ç´°

### ãƒã‚§ãƒƒã‚¯â‘  IDãƒˆãƒ¼ã‚¯ãƒ³å–å¾—

<div class="info-box">
<div class="box-title">ğŸ« ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰: api.ts</div>
<div class="box-content">

**ãƒ•ã‚¡ã‚¤ãƒ«**: `src/frontend/src/services/api.ts`

```typescript
async function getAuthToken(): Promise<string> {
  const user = auth.currentUser
  if (!user) {
    throw new Error('ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™')
  }
  return user.getIdToken()  // Firebase ã‹ã‚‰ãƒˆãƒ¼ã‚¯ãƒ³å–å¾—
}
```

**ä½•ã‚’é˜²ãï¼Ÿ**
- æœªãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®APIå‘¼ã³å‡ºã—

**ãƒˆãƒ¼ã‚¯ãƒ³ã®ä¸­èº«**:
```json
{
  "uid": "abc123",
  "email": "yamada@acme.co.jp",
  "exp": 1705471200,  // æœ‰åŠ¹æœŸé™ï¼ˆ1æ™‚é–“ï¼‰
  "iss": "https://securetoken.google.com/PROJECT_ID"
}
```

</div>
</div>

---

### ãƒã‚§ãƒƒã‚¯â‘¡ CORSæ¤œè¨¼

<div class="info-box">
<div class="box-title">ğŸŒ Gateway: main.py / cors.py</div>
<div class="box-content">

**ãƒ•ã‚¡ã‚¤ãƒ«**: `src/gateway/src/main.py`, `src/backend/src/common/cors.py`

```python
# Gateway ã§ã® CORS è¨­å®š
ALLOWED_ORIGINS = [
    "http://localhost:5173",
    "https://your-project.web.app",
]

# ãƒ—ãƒªãƒ•ãƒ©ã‚¤ãƒˆãƒªã‚¯ã‚¨ã‚¹ãƒˆã¸ã®å¯¾å¿œ
if request.method == 'OPTIONS':
    response = Response()
    response.headers['Access-Control-Allow-Origin'] = origin
    response.headers['Access-Control-Allow-Methods'] = 'POST, OPTIONS'
    response.headers['Access-Control-Allow-Headers'] = 'Authorization, Content-Type'
    return response
```

**ä½•ã‚’é˜²ãï¼Ÿ**
- è¨±å¯ã•ã‚Œã¦ã„ãªã„ãƒ‰ãƒ¡ã‚¤ãƒ³ã‹ã‚‰ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ã®ã¿ï¼‰

**æ³¨æ„**: CORS ã¯ãƒ–ãƒ©ã‚¦ã‚¶ã ã‘ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã€‚curl ã‚„ Postman ã§ã¯ç„¡åŠ¹ã€‚

</div>
</div>

---

### ãƒã‚§ãƒƒã‚¯â‘¢ ãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼

<div class="info-box">
<div class="box-title">ğŸ”‘ Gateway: main.py</div>
<div class="box-content">

**ãƒ•ã‚¡ã‚¤ãƒ«**: `src/gateway/src/main.py`

```python
def verify_request():
    """Firebase IDãƒˆãƒ¼ã‚¯ãƒ³ã‚’æ¤œè¨¼"""
    auth_header = request.headers.get("Authorization")
    if not auth_header or not auth_header.startswith("Bearer "):
        raise ValueError("èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ãŒã‚ã‚Šã¾ã›ã‚“")

    token = auth_header.split(" ")[1]

    # Firebase Admin SDK ã§ãƒˆãƒ¼ã‚¯ãƒ³ã‚’æ¤œè¨¼
    decoded_token = firebase_auth.verify_id_token(token, check_revoked=True)

    return decoded_token["uid"], decoded_token.get("customer_id")
```

**æ¤œè¨¼é …ç›®**:
| é …ç›® | å†…å®¹ |
|------|------|
| ç½²åæ¤œè¨¼ | Googleã®å…¬é–‹éµã§ç½²åã‚’æ¤œè¨¼ |
| æœ‰åŠ¹æœŸé™ | exp ãŒç¾åœ¨æ™‚åˆ»ã‚ˆã‚Šæœªæ¥ã‹ |
| ç™ºè¡Œè€… | Firebase ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒç™ºè¡Œã—ãŸã‹ |
| å¤±åŠ¹ç¢ºèª | check_revoked=True ã§ãƒ­ã‚°ã‚¢ã‚¦ãƒˆæ¸ˆã¿ã‚’å¼¾ã |

**ä½•ã‚’é˜²ãï¼Ÿ**
- ãªã‚Šã™ã¾ã—ã€æ”¹ã–ã‚“ã•ã‚ŒãŸãƒˆãƒ¼ã‚¯ãƒ³ã€æœ‰åŠ¹æœŸé™åˆ‡ã‚Œãƒˆãƒ¼ã‚¯ãƒ³

</div>
</div>

---

### ãƒã‚§ãƒƒã‚¯â‘£ é¡§å®¢IDå–å¾—/æ¤œè¨¼

<div class="info-box">
<div class="box-title">ğŸ¢ Gateway / Backend: auth.py</div>
<div class="box-content">

**ãƒ•ã‚¡ã‚¤ãƒ«**: `src/backend/src/common/auth.py`

```python
def get_customer_id(decoded_token, email):
    """é¡§å®¢IDã‚’å–å¾—ï¼ˆCustom Claims ã¾ãŸã¯ è‡ªå‹•æŒ¯ã‚Šåˆ†ã‘ï¼‰"""

    # 1. Custom Claims ã« customer_id ãŒã‚ã‚Œã°ãã‚Œã‚’è¿”ã™
    if "customer_id" in decoded_token:
        return decoded_token["customer_id"]

    # 2. ãªã‘ã‚Œã°ãƒ¡ãƒ¼ãƒ«ãƒ‰ãƒ¡ã‚¤ãƒ³ã‹ã‚‰è‡ªå‹•æŒ¯ã‚Šåˆ†ã‘
    domain = email.split("@")[1]

    # Firestore ã§ allowed_domains ã‚’æ¤œç´¢
    customers_ref = db.collection("customers")
    query = customers_ref.where("allowed_domains", "array_contains", domain)
    docs = list(query.stream())

    if docs:
        customer_id = docs[0].id
        # Custom Claims ã«ä¿å­˜ï¼ˆæ¬¡å›ã‹ã‚‰ã¯ã“ã“ã«æ¥ãªã„ï¼‰
        auth.set_custom_user_claims(uid, {"customer_id": customer_id})
        return customer_id

    raise ValueError("é¡§å®¢ã«ç´ä»˜ã‘ã•ã‚Œã¦ã„ã¾ã›ã‚“")
```

**ä½•ã‚’é˜²ãï¼Ÿ**
- æœªç™»éŒ²ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚¢ã‚¯ã‚»ã‚¹
- ä»–ç¤¾ãƒ‡ãƒ¼ã‚¿ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ï¼ˆcustomer_id ã«ã‚ˆã‚‹åˆ†é›¢ï¼‰

</div>
</div>

---

### ãƒã‚§ãƒƒã‚¯â‘¤ è»¢é€å…ˆURLå–å¾—

<div class="info-box">
<div class="box-title">ğŸ¯ Gateway: main.py</div>
<div class="box-content">

**ãƒ•ã‚¡ã‚¤ãƒ«**: `src/gateway/src/main.py`

```python
def get_backend_url(customer_id):
    """é¡§å®¢IDã‹ã‚‰è»¢é€å…ˆURLã‚’å–å¾—"""
    doc = db.collection("customers").document(customer_id).get()

    if not doc.exists:
        raise ValueError(f"é¡§å®¢ {customer_id} ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“")

    data = doc.to_dict()
    url = data.get("cloud_functions_url")

    if not url:
        raise ValueError("cloud_functions_url ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“")

    return url
```

**Firestore ãƒ‡ãƒ¼ã‚¿æ§‹é€ **:
```
customers/
â””â”€â”€ acme-corp/
    â”œâ”€â”€ name: "æ ªå¼ä¼šç¤¾ACME"
    â”œâ”€â”€ cloud_functions_url: "https://acme-backend-xxx.run.app"
    â”œâ”€â”€ allowed_domains: ["acme.co.jp"]
    â””â”€â”€ enabled: true
```

**ä½•ã‚’é˜²ãï¼Ÿ**
- å­˜åœ¨ã—ãªã„é¡§å®¢ã¸ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
- æœªè¨­å®šã®ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã¸ã®è»¢é€

</div>
</div>

---

### ãƒã‚§ãƒƒã‚¯â‘¥â‘¦ Gateway-Backendé–“èªè¨¼ï¼ˆHMACç½²åï¼‰

<div class="info-box">
<div class="box-title">ğŸ” Gateway â†’ Backend é–“ã®èªè¨¼</div>
<div class="box-content">

**ãƒ•ã‚¡ã‚¤ãƒ«**:
- Gateway: `src/gateway/src/main.py`
- Backend: `src/backend/src/main.py`

**ã€Gatewayå´ã€‘ç½²åã‚’ç”Ÿæˆã—ã¦ä»˜ä¸**

```python
# Gateway main.py
import hmac
import hashlib

GATEWAY_SECRET = os.environ.get("GATEWAY_SECRET")

def create_signature(user_id, customer_id):
    """HMACç½²åã‚’ç”Ÿæˆ"""
    message = f"{user_id}:{customer_id}".encode()
    return hmac.new(
        GATEWAY_SECRET.encode(),
        message,
        hashlib.sha256
    ).hexdigest()

# ãƒªã‚¯ã‚¨ã‚¹ãƒˆè»¢é€æ™‚
headers = {
    "X-Gateway-Verified": "true",
    "X-User-Id": user_id,
    "X-Customer-Id": customer_id,
    "X-Gateway-Signature": create_signature(user_id, customer_id),
}
```

**ã€Backendå´ã€‘ç½²åã‚’æ¤œè¨¼**

```python
# Backend main.py
def verify_gateway_signature(user_id, customer_id, signature):
    """Gateway ã‹ã‚‰ã®ç½²åã‚’æ¤œè¨¼"""
    message = f"{user_id}:{customer_id}".encode()
    expected = hmac.new(
        GATEWAY_SECRET.encode(),
        message,
        hashlib.sha256
    ).hexdigest()

    # ã‚¿ã‚¤ãƒŸãƒ³ã‚°æ”»æ’ƒã‚’é˜²ã
    return hmac.compare_digest(signature, expected)
```

**ä½•ã‚’é˜²ãï¼Ÿ**
- æ”»æ’ƒè€…ãŒç›´æ¥ Backend ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’å½è£…

**ãªãœå¿…è¦ï¼Ÿ**
- `X-Gateway-Verified: true` ã ã‘ã§ã¯ã€èª°ã§ã‚‚ä»˜ã‘ã‚‰ã‚Œã‚‹
- HMACç½²åãŒã‚ã‚Œã°ã€å…±æœ‰ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’çŸ¥ã‚‰ãªã„ã¨å½é€ ä¸å¯èƒ½

</div>
</div>

---

### ãƒã‚§ãƒƒã‚¯â‘§ ãƒ¬ãƒ¼ãƒˆåˆ¶é™

<div class="info-box">
<div class="box-title">â±ï¸ Backend: rate_limiter.py</div>
<div class="box-content">

**ãƒ•ã‚¡ã‚¤ãƒ«**: `src/backend/src/common/rate_limiter.py`

```python
from collections import defaultdict
import time

# ãƒ¦ãƒ¼ã‚¶ãƒ¼ã”ã¨ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆå±¥æ­´
_request_history = defaultdict(list)

RATE_LIMIT = 60      # 1åˆ†é–“ã®æœ€å¤§ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ•°
WINDOW_SIZE = 60     # ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚µã‚¤ã‚ºï¼ˆç§’ï¼‰

def check_rate_limit(user_id: str) -> bool:
    """ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã‚’ãƒã‚§ãƒƒã‚¯"""
    now = time.time()
    history = _request_history[user_id]

    # å¤ã„ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å‰Šé™¤
    history[:] = [t for t in history if now - t < WINDOW_SIZE]

    # åˆ¶é™ã‚’è¶…ãˆã¦ã„ãªã„ã‹ãƒã‚§ãƒƒã‚¯
    if len(history) >= RATE_LIMIT:
        return False

    # ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’è¨˜éŒ²
    history.append(now)
    return True
```

**ä½•ã‚’é˜²ãï¼Ÿ**
- DoSæ”»æ’ƒï¼ˆå¤§é‡ãƒªã‚¯ã‚¨ã‚¹ãƒˆã§ã‚µãƒ¼ãƒãƒ¼ãƒ€ã‚¦ãƒ³ï¼‰
- èª²é‡‘æ”»æ’ƒï¼ˆAIå‘¼ã³å‡ºã—ã¯é«˜é¡ï¼‰

</div>
</div>

---

### ãƒã‚§ãƒƒã‚¯â‘¨ å…¥åŠ›å€¤æ¤œè¨¼

<div class="info-box">
<div class="box-title">ğŸ“ Backend: main.py</div>
<div class="box-content">

**ãƒ•ã‚¡ã‚¤ãƒ«**: `src/backend/src/main.py`

```python
MAX_MESSAGE_LENGTH = 10000
THREAD_ID_PATTERN = re.compile(r'^[a-zA-Z0-9_-]{1,100}$')

def validate_input(data):
    """å…¥åŠ›å€¤ã‚’æ¤œè¨¼"""
    message = data.get("message", "").strip()
    thread_id = data.get("thread_id")

    # ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒç©º
    if not message:
        raise ValueError("ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„")

    # ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒé•·ã™ãã‚‹
    if len(message) > MAX_MESSAGE_LENGTH:
        raise ValueError(f"ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒé•·ã™ãã¾ã™ï¼ˆ{MAX_MESSAGE_LENGTH}æ–‡å­—ã¾ã§ï¼‰")

    # thread_id ã®å½¢å¼ãƒã‚§ãƒƒã‚¯
    if thread_id and not THREAD_ID_PATTERN.match(thread_id):
        raise ValueError("thread_idã®å½¢å¼ãŒä¸æ­£ã§ã™")

    return message, thread_id
```

**ä½•ã‚’é˜²ãï¼Ÿ**
- å·¨å¤§ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«ã‚ˆã‚‹ãƒ¡ãƒ¢ãƒªæ¯æ¸‡
- thread_id ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³æ”»æ’ƒ

</div>
</div>

---

## ãƒ•ã‚¡ã‚¤ãƒ«é€£æºå›³ï¼ˆãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ â†’ ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ï¼‰

<div class="architecture-box">
<div class="box-title">ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«é–“ã®å‘¼ã³å‡ºã—é–¢ä¿‚</div>
<div class="box-content">

```
ã€ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã€‘                     ã€ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã€‘

src/frontend/src/
â”‚
â”œâ”€â”€ App.tsx
â”‚   â”‚
â”‚   â”œâ”€â”€ hooks/useAuth.ts â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   â”‚   â””â”€â”€ services/firebase.ts               â”‚
â”‚   â”‚       â””â”€â”€ Firebase Auth (SDK)            â”‚
â”‚   â”‚                                          â”‚
â”‚   â”œâ”€â”€ hooks/useChat.ts                       â”‚
â”‚   â”‚   â””â”€â”€ services/api.ts â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   â”‚       â”‚                                  â”‚                        â”‚
â”‚   â”‚       â”œâ”€â”€ getAuthToken()                 â”‚                        â”‚
â”‚   â”‚       â”‚   â””â”€â”€ auth.currentUser.getIdToken()                       â”‚
â”‚   â”‚       â”‚                                  â”‚                        â”‚
â”‚   â”‚       â””â”€â”€ sendChatMessage() â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   â”‚           â””â”€â”€ fetch("/chat", {...})      â”‚                        â”‚
â”‚   â”‚                                          â”‚                        â–¼
â”‚   â””â”€â”€ hooks/useSessions.ts                   â”‚
â”‚       â””â”€â”€ localStorage                       â”‚          src/gateway/src/
â”‚                                              â”‚          â”‚
â””â”€â”€ components/                                â”‚          â””â”€â”€ main.py
    â”œâ”€â”€ ChatScreen.tsx                         â”‚              â”‚
    â”œâ”€â”€ LoginScreen.tsx                        â”‚              â”œâ”€â”€ verify_request()
    â””â”€â”€ SessionTabs.tsx                        â”‚              â”‚   â””â”€â”€ firebase_auth.verify_id_token()
                                               â”‚              â”‚
                                               â”‚              â”œâ”€â”€ get_backend_url()
                                               â”‚              â”‚   â””â”€â”€ Firestore (customers)
                                               â”‚              â”‚
                                               â”‚              â””â”€â”€ proxy_request() â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                               â”‚                                                   â”‚
                                               â”‚                                                   â–¼
                                               â”‚                               src/backend/src/
                                               â”‚                               â”‚
                                               â”‚                               â””â”€â”€ main.py
                                               â”‚                                   â”‚
                                               â”‚                                   â”œâ”€â”€ authenticate_request_with_gateway()
                                               â”‚                                   â”‚   â””â”€â”€ common/auth.py
                                               â”‚                                   â”‚
                                               â”‚                                   â”œâ”€â”€ check_rate_limit()
                                               â”‚                                   â”‚   â””â”€â”€ common/rate_limiter.py
                                               â”‚                                   â”‚
                                               â”‚                                   â”œâ”€â”€ get_agent()
                                               â”‚                                   â”‚   â””â”€â”€ agents/_template/agent.py
                                               â”‚                                   â”‚       â””â”€â”€ Vertex AI (Gemini)
                                               â”‚                                   â”‚
                                               â”‚                                   â””â”€â”€ post_process()
                                               â”‚                                       â””â”€â”€ å¾Œå‡¦ç†ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³
                                               â”‚
                                               â””â”€â”€â”€â”€â”€â”€â”€â”€ Firebase Admin SDK ã§æ¤œè¨¼
```

</div>
</div>

---

## ãƒ•ã‚¡ã‚¤ãƒ«å¯¾å¿œè¡¨

<div class="info-box">
<div class="box-title">ğŸ“‹ ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ â†” ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ ãƒ•ã‚¡ã‚¤ãƒ«å¯¾å¿œ</div>
<div class="box-content">

| ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ | å½¹å‰² | å¯¾å¿œã™ã‚‹ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ | å½¹å‰² |
|--------------|------|-------------------|------|
| `api.ts` | HTTPé€šä¿¡ | `gateway/main.py` | ãƒªã‚¯ã‚¨ã‚¹ãƒˆå—ä»˜ |
| `api.ts` getAuthToken() | ãƒˆãƒ¼ã‚¯ãƒ³å–å¾— | `gateway/main.py` verify_request() | ãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼ |
| `useChat.ts` | ãƒãƒ£ãƒƒãƒˆãƒ­ã‚¸ãƒƒã‚¯ | `backend/main.py` /chat | ãƒãƒ£ãƒƒãƒˆAPI |
| `useAuth.ts` | èªè¨¼çŠ¶æ…‹ç®¡ç† | `common/auth.py` | èªè¨¼å‡¦ç† |
| `useSessions.ts` | ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç† | `checkpointer.py` | ä¼šè©±å±¥æ­´ä¿å­˜ |
| `firebase.ts` | FirebaseåˆæœŸåŒ– | Firebase Admin SDK | ã‚µãƒ¼ãƒãƒ¼å´SDK |

</div>
</div>

---

## ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¾ã¨ã‚

<div class="info-box">
<div class="box-title">ğŸ›¡ï¸ 6å±¤ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£</div>
<div class="box-content">

| å±¤ | å ´æ‰€ | å†…å®¹ | é˜²ãæ”»æ’ƒ |
|----|------|------|---------|
| 1 | ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ | IDãƒˆãƒ¼ã‚¯ãƒ³å¿…é ˆ | æœªèªè¨¼ã‚¢ã‚¯ã‚»ã‚¹ |
| 2 | Gateway | CORS | ä¸æ­£ã‚ªãƒªã‚¸ãƒ³ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ã®ã¿ï¼‰ |
| 3 | Gateway | ãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼ | ãªã‚Šã™ã¾ã—ã€æ”¹ã–ã‚“ |
| 4 | Gatewayâ†’Backend | HMACç½²å | ãƒ˜ãƒƒãƒ€ãƒ¼å½è£… |
| 5 | Backend | ãƒ¬ãƒ¼ãƒˆåˆ¶é™ | DoSã€èª²é‡‘æ”»æ’ƒ |
| 6 | Backend | å…¥åŠ›æ¤œè¨¼ | ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ |

**é‡è¦**: ã™ã¹ã¦ã®å±¤ã‚’é€šéã—ãªã„ã¨AIã¯å¿œç­”ã—ã¾ã›ã‚“ã€‚

</div>
</div>

---

## ç†è§£åº¦ãƒã‚§ãƒƒã‚¯

| è³ªå• | ãƒ’ãƒ³ãƒˆ |
|------|--------|
| IDãƒˆãƒ¼ã‚¯ãƒ³ã¯ã©ã“ã§ç™ºè¡Œã•ã‚Œã‚‹ï¼Ÿ | Firebase Auth |
| Gateway ã¯ä½•ã‚’ã—ã¦ã„ã‚‹ï¼Ÿ | èªè¨¼ + è»¢é€å…ˆæ±ºå®š + è»¢é€ |
| HMACç½²åã¯ãªãœå¿…è¦ï¼Ÿ | X-Gateway-Verified ã ã‘ã§ã¯å½è£…å¯èƒ½ |
| ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã®è¨­å®šå€¤ã¯ï¼Ÿ | 1åˆ†é–“60å› |
| customer_id ã¯ã©ã“ã«ä¿å­˜ã•ã‚Œã‚‹ï¼Ÿ | Custom Claimsï¼ˆãƒˆãƒ¼ã‚¯ãƒ³å†…ï¼‰ |

---

## æ¬¡ã«èª­ã‚€ã¹ããƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

| ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ | å†…å®¹ |
|-------------|------|
| [11_ãƒãƒ£ãƒƒãƒˆé€ä¿¡ã®æµã‚Œ](./11_ãƒãƒ£ãƒƒãƒˆé€ä¿¡ã®æµã‚Œ.md) | å‡¦ç†ãƒ•ãƒ­ãƒ¼ã®è©³ç´° |
| [12_ãƒ­ã‚°ã‚¤ãƒ³ã®æµã‚Œ](./12_ãƒ­ã‚°ã‚¤ãƒ³ã®æµã‚Œ.md) | èªè¨¼ãƒ•ãƒ­ãƒ¼ã®è©³ç´° |
| [03_ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰è§£èª¬](./03_ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰è§£èª¬.md) | Python/Flaskã®è©³ç´° |

