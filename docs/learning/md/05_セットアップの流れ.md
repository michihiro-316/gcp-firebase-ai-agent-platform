# セットアップの流れ

<div class="chapter-hero">
<span class="emoji">🛠️</span>
<h1>セットアップの流れ</h1>
<p class="subtitle">「手順は多いけど、一つ一つは簡単！」<br>「焦らずゆっくり進めよう」</p>
</div>

---

## この章で学ぶこと

<div class="goal-box">
<h3>📚 学習目標</h3>
<ol>
<li>GCPプロジェクトの作成</li>
<li>Firebase の設定</li>
<li>サービスアカウントの作成</li>
<li>環境変数の設定</li>
<li>依存パッケージのインストール</li>
<li>顧客の登録と自動振り分け</li>
</ol>
<p><strong>⏱️ 想定作業時間: 30-45分</strong></p>
</div>

---

## GAS経験者向け: 環境構築の違い

<div class="info-box">
<h3>📊 GAS vs 本番システム</h3>
<p><strong>【GASの場合】</strong><br>
Googleドライブ → 新規作成 → Google Apps Script<br>
→ すぐコードが書ける！（環境構築不要）</p>
<p><strong>【本番システムの場合】</strong><br>
GCPプロジェクト作成 → Firebase設定 → サービスアカウント作成 → ...<br>
→ 手順が多い（でも一度やれば終わり！）</p>
<table>
<tr><th>項目</th><th>GAS</th><th>本番システム</th></tr>
<tr><td>管理者</td><td>Googleが全部管理</td><td>自分で管理（自由度が高い）</td></tr>
<tr><td>ユーザー想定</td><td>1人で使う前提</td><td>複数ユーザー・複数会社</td></tr>
<tr><td>セキュリティ</td><td>Google任せ</td><td>自分で設定</td></tr>
<tr><td>料金</td><td>無料の範囲</td><td>使った分だけ課金</td></tr>
</table>
</div>

---

## 全体の流れ

<div class="flow-box">
<h3>🗺️ セットアップの全体像</h3>
<p><strong>【事前準備】</strong></p>
<pre>
┌──────────┐   ┌──────────┐   ┌──────────────────┐
│ 1. GCP   │ → │ 2. Fire- │ → │ 3. サービス      │
│ プロジェ │   │   base   │   │   アカウント     │
│ クト作成 │   │   設定   │   │   作成           │
└──────────┘   └──────────┘   └──────────────────┘
</pre>
<p><strong>【環境変数設定】</strong></p>
<pre>
┌──────────────────┐   ┌──────────────────┐
│ 4. backend/.env  │   │ 5. frontend/.env │
└──────────────────┘   └──────────────────┘
</pre>
<p><strong>【依存関係インストール】</strong></p>
<pre>
┌──────────────────┐   ┌──────────────────┐
│ 6. pip install   │   │ 7. npm install   │
└──────────────────┘   └──────────────────┘
</pre>
<p><strong>【初期データ設定】</strong></p>
<pre>
┌──────────────────┐   ┌──────────────────┐
│ 8. 顧客を追加    │ → │ 9. ドメイン登録  │
└──────────────────┘   └──────────────────┘
</pre>
<p><strong>【起動】</strong></p>
<pre>
┌──────────────────┐   ┌──────────────────┐   ┌──────────┐
│ 10. バックエンド │ → │ 11. フロント     │ → │ 12. 動作 │
│     起動         │   │     エンド起動   │   │   確認   │
└──────────────────┘   └──────────────────┘   └──────────┘
</pre>
</div>

---

## ステップ1: GCPプロジェクト作成

### 1.1 Google Cloud Console を開く

1. https://console.cloud.google.com/ にアクセス
2. 右上のGoogleアカウントでログイン

### 1.2 新しいプロジェクトを作成

1. 左上の「プロジェクトを選択」をクリック
2. 「新しいプロジェクト」をクリック
3. プロジェクト名を入力（例: `my-ai-agent`）
4. 「作成」をクリック

<div class="tip-box">
<h3>💡 なぜプロジェクトが必要？</h3>
<p>GCPのすべてのリソース（データベース、AI、認証など）は<br>
プロジェクト単位で管理される。<br>
請求もプロジェクト単位で行われる。</p>
<p><strong>イメージ:</strong> プロジェクト = 1つのアプリ用の「箱」</p>
</div>

### 1.3 必要なAPIを有効化

左メニュー → 「APIとサービス」 → 「ライブラリ」

以下を検索して「有効にする」:
- **Vertex AI API** - AIモデルを使うため
- **Cloud Firestore API** - データベースを使うため
- **Identity and Access Management (IAM) API** - 権限管理のため

---

## ステップ2: Firebase設定

### 2.1 Firebase Console を開く

1. https://console.firebase.google.com/ にアクセス
2. 「プロジェクトを追加」をクリック
3. **既存のGCPプロジェクトを選択**（さっき作ったもの）
4. 「続行」を数回クリック

<div class="tip-box">
<h3>💡 なぜFirebase？</h3>
<p>Firebase は GCP の上に作られた「使いやすい層」</p>
<pre>
┌─────────────────────────────────────────┐
│  Firebase（使いやすい）                  │
│  ┌──────────────────────────────────┐   │
│  │  GCP（パワフル）                  │   │
│  └──────────────────────────────────┘   │
└─────────────────────────────────────────┘
</pre>
<p>認証（ログイン機能）が特に簡単に作れる！</p>
</div>

### 2.2 Authentication を設定

1. 左メニュー → 「Authentication」
2. 「始める」をクリック
3. 「Sign-in method」タブ
4. 「Google」を選択 → 「有効にする」
5. サポートメール（自分のメール）を入力
6. 「保存」

### 2.3 Firestore を設定

1. 左メニュー → 「Firestore Database」
2. 「データベースを作成」をクリック
3. 「本番モードで開始」を選択
4. ロケーション: `asia-northeast1`（東京）を選択
5. 「有効にする」

### 2.4 Firestore セキュリティルール

1. Firebase Console → Firestore Database
2. 「ルール」タブをクリック
3. 以下のルールをコピー＆ペースト:

```javascript
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // 基本: 全て拒否（明示的に許可したものだけアクセス可能）
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
```

4. 「公開」をクリック

<div class="info-box">
<h3>🔒 セキュリティルールの意味</h3>
<pre>allow read, write: if false;</pre>
<p>→ 「すべてのドキュメントに対して、読み書きを禁止」</p>
<p>でも、サーバー（Admin SDK）はこのルールを無視できる<br>
→ サーバー経由でのみデータにアクセスできる<br>
→ ブラウザから直接Firestoreを触れない（セキュア！）</p>
<p><strong>【GASで例えると】</strong><br>
セキュリティルール = スプレッドシートの保護<br>
「シートを保護」→「自分だけ編集可能」に設定</p>
</div>

### 2.5 Webアプリを登録

1. プロジェクト設定（歯車アイコン）→ 「全般」
2. 下の方の「アプリを追加」→ Web（</>アイコン）
3. アプリのニックネーム: `frontend`
4. 「アプリを登録」

表示された設定をメモ:
```javascript
const firebaseConfig = {
  apiKey: "AIzaSy...",              // ← これをメモ
  authDomain: "xxx.firebaseapp.com", // ← これをメモ
  projectId: "your-project-id",      // ← これをメモ
};
```

---

## ステップ3: サービスアカウント作成

### サービスアカウントとは？

<div class="info-box">
<h3>🤖 サービスアカウント</h3>
<p><strong>【人間のアカウント】</strong><br>
Googleアカウント（〇〇@gmail.com）<br>
→ 人間がブラウザでログインする用</p>
<p><strong>【サービスアカウント】</strong><br>
xxx@project.iam.gserviceaccount.com<br>
→ プログラム（バックエンド）がGCPにアクセスする用</p>
<p><strong>イメージ:</strong> サービスアカウント = プログラム専用のGoogleアカウント</p>
</div>

### 3.1 サービスアカウントを作成

1. Google Cloud Console を開く
2. 左メニュー → 「IAMと管理」 → 「サービスアカウント」
3. 「サービスアカウントを作成」

設定:
- 名前: `backend-service`
- ID: `backend-service`（自動入力）
- 「作成して続行」

### 3.2 ロール（権限）を付与

以下のロールを追加:
- **Firebase Admin SDK 管理者サービス エージェント**
- **Cloud Datastore ユーザー**
- **Vertex AI ユーザー**

「続行」→「完了」

### 3.3 鍵をダウンロード

1. 作成したサービスアカウントをクリック
2. 「鍵」タブ
3. 「鍵を追加」→「新しい鍵を作成」
4. 「JSON」を選択 →「作成」

JSONファイルがダウンロードされる。

### 3.4 鍵ファイルを配置

ダウンロードしたJSONファイルを:
```
backend/service-account.json
```
に配置（リネーム）。

<div class="warning-box">
<h3>⚠️ 重要な注意</h3>
<p><strong>このファイルは絶対にGitにコミットしないこと！</strong></p>
<p>.gitignore に入っているか確認:</p>
<pre>service-account.json</pre>
<p>もし誤ってコミットしたら:</p>
<ol>
<li>即座に鍵を無効化（GCP Console）</li>
<li>新しい鍵を作成</li>
<li>Git履歴からも削除</li>
</ol>
</div>

---

## ステップ4: バックエンド環境変数設定

### 場所: `backend/.env`

```bash
# ===== GCP設定 =====
# GCPプロジェクトID（Firebase Consoleで確認）
GOOGLE_CLOUD_PROJECT=your-project-id

# サービスアカウントの鍵ファイルパス
GOOGLE_APPLICATION_CREDENTIALS=./service-account.json

# ===== CORS設定 =====
# フロントエンドのURL（ローカル開発時）
ALLOWED_ORIGINS=http://localhost:5173

# ===== Vertex AI設定 =====
# AIモデルのリージョン
VERTEX_AI_LOCATION=asia-northeast1

# ===== レート制限 =====
# 1分あたりの最大リクエスト数
RATE_LIMIT_REQUESTS=60
RATE_LIMIT_WINDOW=60
```

### 各設定の意味

| 設定 | 意味 | 間違えると |
|------|------|-----------|
| `GOOGLE_CLOUD_PROJECT` | どのGCPプロジェクトを使うか | Firestoreにアクセスできない |
| `GOOGLE_APPLICATION_CREDENTIALS` | 認証情報ファイルの場所 | 「認証エラー」が出る |
| `ALLOWED_ORIGINS` | どのURLからのアクセスを許可するか | 「CORSエラー」が出る |
| `VERTEX_AI_LOCATION` | AIモデルのリージョン | 「リージョンエラー」が出る |

---

## ステップ5: フロントエンド環境変数設定

### 場所: `frontend/.env`

```bash
# ===== Firebase設定 =====
# Firebase Console → プロジェクト設定 → Webアプリ から取得
VITE_FIREBASE_API_KEY=AIzaSyXXXXXXXXXXXXXXXXXXXX
VITE_FIREBASE_AUTH_DOMAIN=your-project.firebaseapp.com
VITE_FIREBASE_PROJECT_ID=your-project-id

# ===== API設定 =====
# バックエンドのURL（ローカル開発時）
VITE_API_BASE_URL=http://localhost:8080
```

### なぜ VITE_ で始まる？

<div class="info-box">
<h3>🔐 Viteの環境変数ルール</h3>
<p>VITE_ で始まる変数だけがブラウザ側のJavaScriptで使える</p>
<ul>
<li>✅ VITE_FIREBASE_API_KEY → ブラウザで使える</li>
<li>❌ SECRET_KEY → ブラウザで使えない（サーバー側のみ）</li>
</ul>
<p>セキュリティのため、うっかり秘密情報がブラウザに渡らないようになっている</p>
</div>

---

## ステップ6: バックエンド依存関係インストール

### ターミナルで実行

```bash
# backendフォルダに移動
cd backend

# 仮想環境を作成（推奨）
python -m venv venv

# 仮想環境を有効化
# Mac/Linux:
source venv/bin/activate
# Windows:
# venv\Scripts\activate

# 依存パッケージをインストール
pip install -r requirements.txt
```

### requirements.txt の中身（抜粋）

```text
functions-framework==3.*   # Cloud Functions ローカル実行
firebase-admin==6.*        # Firebase管理
google-cloud-aiplatform==1.*  # Vertex AI
langchain==0.3.*           # AIフレームワーク
langgraph==0.2.*           # 状態管理付きAI
flask==3.*                 # Webサーバー
flask-cors==4.*            # CORS対応
```

---

## ステップ7: フロントエンド依存関係インストール

### ターミナルで実行

```bash
# frontendフォルダに移動
cd frontend

# 依存パッケージをインストール
npm install
```

成功すると:
```
added 200 packages in 30s
```

---

## ステップ8: 顧客を追加

### なぜ顧客が必要？

<div class="info-box">
<h3>🏢 マルチテナント構造</h3>
<pre>
顧客（会社） → ユーザー（社員）
            → データ（会話履歴など）
</pre>
<p>ユーザーは必ずどこかの顧客に所属する必要がある</p>
<p><strong>例:</strong></p>
<pre>
株式会社ACME
  ├── yamada@acme.co.jp（山田さん）
  ├── tanaka@acme.co.jp（田中さん）
  └── 会話履歴、設定など
</pre>
</div>

### 実行

```bash
# backendフォルダにいることを確認
cd backend

# 顧客を追加
python scripts/manage_customer.py add test-corp "テスト株式会社"
```

成功すると:
```
=== 顧客を作成 ===

✅ 顧客 'テスト株式会社' (test-corp) を作成しました

次のステップ:
  python scripts/manage_customer.py add-domain test-corp example.com
```

---

## ステップ9: メールドメインを登録（自動振り分け）

### 推奨：自動振り分けを使う

```bash
# メールドメイン（@以降）を登録（社員全員が自動で振り分けられる）
python scripts/manage_customer.py add-domain test-corp test-corp.co.jp
```

成功すると:
```
=== メールドメインを追加 ===

✅ メールドメイン '@test-corp.co.jp' を 'テスト株式会社' に追加しました

→ @test-corp.co.jp のユーザーはログイン時に自動で振り分けられます
```

### テスト用に個別メールを登録する場合

Gmailなど会社のメールドメイン以外でテストする場合:

```bash
python scripts/manage_customer.py add-email test-corp your-email@gmail.com
```

<div class="tip-box">
<h3>✨ 自動振り分けの仕組み</h3>
<p><strong>【従来の方法】400人の会社を登録する場合</strong><br>
→ 400回 add-user コマンドを実行... 大変！</p>
<p><strong>【自動振り分け】</strong><br>
→ 1回 add-domain を実行するだけ！<br>
→ @acme.co.jp のユーザーは全員自動で振り分け</p>
<p><strong>メモ:</strong> ここでいう「ドメイン」は、メールアドレスの@以降の部分（メールドメイン）です。URLドメインではありません。</p>
<table>
<tr><th>方法</th><th>コマンド</th><th>用途</th></tr>
<tr><td>メールドメイン登録</td><td>add-domain</td><td>社員全員を一括登録（@acme.co.jpなど）</td></tr>
<tr><td>個別メール登録</td><td>add-email</td><td>業務委託者を個別登録（外部メール）</td></tr>
</table>
</div>

---

## ステップ10: バックエンド起動

### ターミナル1で実行

```bash
# backendフォルダにいることを確認
cd backend

# 仮想環境が有効か確認（プロンプトに(venv)があるか）
# なければ: source venv/bin/activate

# サーバーを起動
functions-framework --target=main --port=8080
```

成功すると:
```
 * Serving Flask app 'main'
 * Running on http://127.0.0.1:8080
```

---

## ステップ11: フロントエンド起動

### ターミナル2（別のターミナル）で実行

```bash
# frontendフォルダに移動
cd frontend

# 開発サーバーを起動
npm run dev
```

成功すると:
```
  VITE v5.x.x  ready in 500ms

  ➜  Local:   http://localhost:5173/
```

---

## ステップ12: 動作確認

### ブラウザでアクセス

http://localhost:5173/ を開く

### ログイン

1. 「Googleでログイン」をクリック
2. Googleアカウントを選択
3. 自動振り分けが設定されていれば、そのままチャット画面へ

### チャット

1. 「こんにちは」と入力
2. 送信
3. AIが返答する！

---

## よくあるエラーと対処法

<div class="warning-box">
<h3>🔧 トラブルシューティング</h3>
<p><strong>【エラー1】Module not found</strong><br>
原因: 依存パッケージがインストールされていない<br>
対処: pip install -r requirements.txt を再実行</p>
<p><strong>【エラー2】CORS エラー</strong><br>
原因: ALLOWED_ORIGINS の設定が違う<br>
対処: backend/.env を確認<br>
ALLOWED_ORIGINS=http://localhost:5173（末尾スラッシュなし）</p>
<p><strong>【エラー3】認証エラー / トークンの検証に失敗</strong><br>
原因: service-account.json がない、または環境変数が未設定<br>
対処: ファイルの存在と.envの設定を確認</p>
<p><strong>【エラー4】顧客に紐付けされていません</strong><br>
原因: 自動振り分けにマッチしない<br>
対処: add-email でメールを個別登録<br>
<code>python scripts/manage_customer.py add-email test-corp you@gmail.com</code></p>
<p><strong>【エラー5】Vertex AI API が無効です</strong><br>
原因: APIが有効化されていない<br>
対処: GCP Console → APIとサービス → Vertex AI API を有効化</p>
</div>

---

## チェックリスト

セットアップが完了したか確認:

- [ ] GCPプロジェクトを作成した
- [ ] Vertex AI API を有効化した
- [ ] Firebase プロジェクトを設定した
- [ ] Authentication で Google を有効化した
- [ ] Firestore データベースを作成した
- [ ] Webアプリを登録してAPIキー等を取得した
- [ ] サービスアカウントを作成した
- [ ] 鍵をダウンロードして `backend/service-account.json` に配置した
- [ ] `backend/.env` を作成した
- [ ] `frontend/.env` を作成した
- [ ] `pip install -r requirements.txt` を実行した
- [ ] `npm install` を実行した
- [ ] 顧客を追加した
- [ ] ドメインまたはメールを登録した
- [ ] バックエンドが起動している
- [ ] フロントエンドが起動している
- [ ] チャットができた！

---

## まとめ

<div class="summary-box">
<h3>🎓 この章で完了したこと</h3>
<ul>
<li>✅ GCPプロジェクトとFirebaseを設定</li>
<li>✅ サービスアカウントで認証情報を取得</li>
<li>✅ 環境変数を設定</li>
<li>✅ バックエンド・フロントエンドを起動</li>
<li>✅ 顧客を登録してチャットできる状態に</li>
</ul>
<p><strong>これで開発環境が整いました！</strong></p>
</div>

---

## 次に読むべきドキュメント

| 順番 | ドキュメント | 内容 |
|------|-------------|------|
| 1 | [06_コマンド解説.md](./06_コマンド解説.md) | ターミナルコマンドの解説 |
| 2 | [07_動かしてみよう.md](./07_動かしてみよう.md) | 実際に動かしてみる |
| 3 | [08_AIカスタマイズ.md](./08_AIカスタマイズ.md) | AIの応答をカスタマイズ |
