# システム全体像 - 5分で掴む！

<div class="goal-box">
<div class="box-title">🎯 このページのゴール</div>
<div class="box-content">

「このシステムってこういう仕組みなんだ！」と説明できるようになる

</div>
</div>

---

## ズバリ、何をするシステム？

<div class="flow-box">
<div class="box-content" style="text-align: center;">

<strong>👤 ユーザー → 💬 チャット送信 → 🤖 AI回答 → 📱 画面表示</strong>

つまり「ChatGPTみたいなもの」を
自分で作って提供するシステム！

</div>
</div>

---

## アーキテクチャ全体図

<div class="architecture-box">
<div class="box-title">🏗️ システム構成図</div>
<div class="box-content" style="text-align: center;">

<strong>👤 ユーザー（ブラウザ）</strong>
↓ ① 画面を見る

<strong>🖥️ フロントエンド（画面担当）</strong>
React + TypeScript「見た目」を作る
↓ ② APIリクエスト

<strong>🚪 Gateway（認証・振り分け担当）</strong>
Cloud Run Functions「どの会社のバックエンドに送るか」を決める
↓ ③ 転送

<strong>🐍 バックエンド（処理担当）※会社ごとに1つ</strong>
Python + Flask「中身」を作る
↓

<table>
<tr><th>🔐 認証</th><th>💾 DB</th><th>🤖 AI</th></tr>
<tr><td>Firebase Auth</td><td>Firestore</td><td>Vertex AI (Gemini)</td></tr>
</table>

</div>
</div>

<div class="tip-box">
<div class="box-title">💡 なぜGatewayがあるの？</div>
<div class="box-content">

<strong>会社ごとにバックエンドを分ける</strong>ことで、以下のメリットがあります：

<ul>
<li><strong>🏢 A社だけの特殊カスタマイズ</strong>が可能</li>
<li><strong>🔒 他社への影響ゼロ</strong>で安全に更新</li>
<li><strong>📦 会社ごとに独立した環境</strong>を提供</li>
</ul>

Gatewayは「受付」として、ログインしたユーザーを正しい会社のバックエンドに案内します。

</div>
</div>

---

## 各パーツの役割（レストランで例える）

<div class="info-box">
<div class="box-title">🍽️ レストランに例えると...</div>
<div class="box-content">

<table>
<tr><th>技術</th><th>役割</th><th>レストランで言うと</th></tr>
<tr><td>React</td><td>画面を作る</td><td>内装・メニュー表</td></tr>
<tr><td>Gateway</td><td>認証・振り分け</td><td>受付フロント（どの厨房に案内するか決める）</td></tr>
<tr><td>Python/Flask</td><td>処理をする</td><td>厨房（会社ごとに別々）</td></tr>
<tr><td>Firebase Auth</td><td>ログイン</td><td>会員証発行・確認</td></tr>
<tr><td>Firestore</td><td>データ保存</td><td>冷蔵庫・倉庫</td></tr>
<tr><td>Vertex AI (Gemini)</td><td>AI回答生成</td><td>シェフの頭脳</td></tr>
</table>

</div>
</div>

---

## データの流れ①: ログイン

<div class="flow-box">
<div class="box-title">🔐 ログインの流れ</div>
<div class="box-content">

<ol>
<li>ユーザーが「Googleでログイン」をクリック</li>
<li>Googleの画面が出る（おなじみのやつ！）</li>
<li>ログイン成功 → 「IDトークン」をもらう（これが「私は〇〇です」の証明書）</li>
<li>このトークンを使ってAPIを呼び出す</li>
</ol>

</div>
</div>

**IDトークンって何？**

<div class="info-box">
<div class="box-title">📜 IDトークン = デジタル身分証明書</div>
<div class="box-content">

<p>中身（イメージ）:</p>
<pre><code>{
  "name": "山田太郎",
  "email": "yamada@acme.co.jp",
  "会社": "株式会社ACME",
  "有効期限": "2024-01-16 15:00",
  "署名": "Google公式のお墨付き ✅"
}</code></pre>

<ul>
<li>✅ Googleが「この人は本物」と保証</li>
<li>✅ 改ざんすると署名が壊れる → 偽造不可能</li>
</ul>

</div>
</div>

---

## データの流れ②: チャット送信

<div class="flow-box">
<div class="box-title">💬 チャット送信の流れ</div>
<div class="box-content">

<ol>
<li>ユーザーが「こんにちは」と入力して送信</li>
<li>フロントエンド → <strong>Gateway</strong>にリクエスト（IDトークン付き）</li>
<li><strong>Gateway</strong>でトークン検証<br>
　「この人、本物？」→ ✅ OK!<br>
　「どの会社の人？」→ A社！</li>
<li><strong>Gateway</strong> → A社のバックエンドに転送</li>
<li>バックエンドでAI処理<br>
　Vertex AI (Gemini) に質問 → AIが回答を生成</li>
<li>回答を画面に表示（処理中は「AIが考え中...」と表示）</li>
</ol>

</div>
</div>

---

## GCP配置設計（マルチテナント）

<div class="architecture-box">
<div class="box-title">☁️ Cloud Run Functions の配置</div>
<div class="box-content">

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        顧客（ブラウザ）                                   │
│     A社社員         B社社員         C社社員                              │
│        │              │              │                                  │
└────────┼──────────────┼──────────────┼──────────────────────────────────┘
         │              │              │
         ▼              ▼              ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                  Cloud Run Functions【共通：1つだけ】                     │
│  ┌───────────────────────────────────────────────────────────────────┐  │
│  │                         Gateway                                   │  │
│  │                                                                   │  │
│  │  1. Firebase トークン検証（本人確認）                              │  │
│  │  2. customer_id から転送先 URL を Firestore で取得                │  │
│  │  3. 適切な Backend に転送                                         │  │
│  └───────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────┘
                         │              │              │
                         ▼              ▼              ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                 Cloud Run Functions【顧客別：会社数ぶん】                 │
│                                                                         │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                      │
│  │ Backend A   │  │ Backend B   │  │ Backend C   │  ...                 │
│  │ (A社専用)   │  │ (B社専用)   │  │ (C社専用)   │                      │
│  │             │  │             │  │             │                      │
│  │ AI Agent    │  │ AI Agent    │  │ AI Agent    │                      │
│  │ カスタム可  │  │ カスタム可  │  │ カスタム可  │                      │
│  └─────────────┘  └─────────────┘  └─────────────┘                      │
└─────────────────────────────────────────────────────────────────────────┘
                         │              │              │
                         ▼              ▼              ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                      Firestore【共通：1つだけ】                          │
│                                                                         │
│  customers/                                                             │
│  ├── acme-corp/     → cloud_functions_url で Backend A を指定          │
│  ├── beta-inc/      → cloud_functions_url で Backend B を指定          │
│  └── gamma-llc/     → cloud_functions_url で Backend C を指定          │
│                                                                         │
│  ※ 会話履歴は customers/{customer_id}/checkpoints/ に保存              │
│  ※ customer_id でデータを完全分離                                       │
└─────────────────────────────────────────────────────────────────────────┘
```

</div>
</div>

<div class="info-box">
<div class="box-title">📊 デプロイ構成まとめ</div>
<div class="box-content">

<table>
<tr><th>コンポーネント</th><th>数</th><th>役割</th></tr>
<tr><td><strong>Gateway</strong></td><td>1つ</td><td>認証・ルーティングのみ</td></tr>
<tr><td><strong>Backend</strong></td><td>顧客数ぶん</td><td>AI エージェント実行（会社ごとにカスタマイズ可能）</td></tr>
<tr><td><strong>Firestore</strong></td><td>1つ</td><td>全顧客のデータを保存（customer_id で分離）</td></tr>
<tr><td><strong>Firebase Auth</strong></td><td>1つ</td><td>全顧客の認証を管理</td></tr>
<tr><td><strong>フロントエンド</strong></td><td>下記参照</td><td>チャット画面（React）の配信</td></tr>
</table>

</div>
</div>

<div class="info-box">
<div class="box-title">🖥️ フロントエンド配信方法</div>
<div class="box-content">

フロントエンド（React アプリ）の配信方法は2つから選べます：

<table>
<tr><th>方法</th><th>URL例</th><th>特徴</th></tr>
<tr><td><strong>Firebase Hosting</strong>（シンプル）</td><td><code>https://PROJECT_ID.web.app</code></td><td>全顧客で同じUI、カスタムドメイン設定可能</td></tr>
<tr><td><strong>GCS + Load Balancer</strong>（顧客別）</td><td><code>https://chat.acme.co.jp</code></td><td>顧客ごとに別URL・別デザインが可能</td></tr>
</table>

<strong>カスタムドメインの設定:</strong>
<ul>
<li>Firebase Hosting → Firebase Console で「カスタムドメインを追加」</li>
<li>GCS → Load Balancer でドメインルーティングを設定</li>
</ul>

💡 <strong>初めは Firebase Hosting（シンプル）から始めて</strong>、顧客別カスタマイズが必要になったら GCS に移行するのがおすすめです。

</div>
</div>

<div class="tip-box">
<div class="box-title">💡 なぜ Backend を会社ごとに分けるの？</div>
<div class="box-content">

<strong>メリット:</strong>
<ul>
<li><strong>🔧 A社だけ特殊なAIプロンプト</strong>を設定できる</li>
<li><strong>🚀 B社だけ先行リリース</strong>してテストできる</li>
<li><strong>🛡️ C社のバグがA社に影響しない</strong></li>
<li><strong>📦 会社ごとに独立したバージョン管理</strong>が可能</li>
</ul>

<strong>共通の Gateway を通すことで:</strong>
<ul>
<li>認証処理を一元管理</li>
<li>フロントエンドは1つのURLだけ知っていればOK</li>
</ul>

</div>
</div>

---

## マルチテナント（複数会社対応）

<div class="architecture-box">
<div class="box-title">🏢 会社ごとにデータとバックエンドを分離</div>
<div class="box-content">

<strong>Firestore（データベース）</strong>

<pre><code>customers/
├── 🏢 acme-corp/          ← A社のデータ
│   ├── name: "株式会社ACME"
│   ├── allowed_domains: ["acme.co.jp"]
│   ├── cloud_functions_url: "https://acme-backend-xxx.run.app"  ← A社専用のバックエンドURL
│   ├── enabled: true
│   └── checkpoints/       ← A社の会話履歴
│       ├── user1_abc/
│       └── user2_def/
│
├── 🏢 beta-inc/           ← B社のデータ
│   ├── name: "ベータ株式会社"
│   ├── allowed_domains: ["beta-inc.co.jp"]
│   ├── cloud_functions_url: "https://beta-backend-xxx.run.app"  ← B社専用のバックエンドURL
│   ├── enabled: true
│   └── checkpoints/       ← B社の会話履歴
│
└── 🏢 gamma-llc/          ← C社のデータ
</code></pre>

💡 <strong>A社の人はB社のデータを見れない！</strong>（セキュリティ確保）

<strong>3層のセキュリティで保護:</strong>
<ol>
<li><strong>Firestore セキュリティルール</strong> - 自社のデータのみアクセス可能</li>
<li><strong>会社別バックエンド</strong> - 物理的に別のCloud Run Functionsにデプロイ</li>
<li><strong>Gatewayでの認証</strong> - <code>customer_id</code> で正しいバックエンドに振り分け</li>
</ol>

</div>
</div>

**自動振り分けの仕組み**

<div class="tip-box">
<div class="box-title">🎯 メールドメインで自動振り分け</div>
<div class="box-content">

<strong>【従来】</strong> 400人の社員を1人ずつ登録... 😓 大変！

<strong>【今のシステム】</strong>
<ol>
<li>管理者:「acme.co.jp というメールドメインを登録しておくね」</li>
<li>yamada@acme.co.jp がログイン</li>
<li>システム:「@acme.co.jp だ！→ A社のデータに振り分け」</li>
<li>完了！✅（再ログイン不要）</li>
</ol>

<p><strong>メモ:</strong> ここでいう「ドメイン」は、メールアドレスの@以降の部分（メールドメイン）です。URLドメインではありません。</p>

</div>
</div>

---

## 重要なファイル一覧

<div class="info-box">
<div class="box-title">📁 覚えておきたいファイル</div>
<div class="box-content">

**【Gateway】gateway/**
```
└── main.py              ★ 認証とルーティング（全リクエストの入口）
```

**【バックエンド】backend/**
```
├── main.py              ★ 会社ごとのバックエンド入口
├── common/
│   ├── auth.py          ★ 認証処理（Gateway連携 + 自動振り分け）
│   └── rate_limiter.py    使いすぎ防止
└── agents/
    └── _template/
        └── agent.py     ★ AI処理本体
```

**【フロントエンド】frontend/src/**
```
├── App.tsx              ★ 画面の入口
├── hooks/
│   ├── useAuth.ts       ★ ログイン処理
│   ├── useChat.ts       ★ チャット処理
│   └── useSessions.ts     セッション管理
└── services/
    ├── firebase.ts        Firebase接続
    └── api.ts             サーバー通信（Gatewayにリクエスト）
```

**【顧客管理】Firebase Console**
```
Firestore Database → customers コレクションで顧客データを管理
```

</div>
</div>

---

## ファイル間の呼び出しの流れ

<div class="info-box">
<div class="box-title">🔗 フロントエンド → バックエンドの接続</div>
<div class="box-content">

<strong>チャット送信時、コードはこの順番で呼ばれます:</strong>

<pre>
【フロントエンド（ブラウザ）】
main.tsx ─▶ App.tsx ─▶ useChat.ts ─▶ api.ts ═══▶【バックエンド】
   │           │           │            │              │
   │           │           │            │              ▼
  起動      画面描画    チャット     HTTP通信      main.py
                        ロジック    fetch()        ↓
                                                 auth.py
                                                   ↓
                                                 agent.py
                                                   ↓
                                                 Vertex AI
</pre>

<table>
<tr><th>ファイル</th><th>役割</th><th>ポイント</th></tr>
<tr><td><code>main.tsx</code></td><td>アプリ起動</td><td>App.tsx を描画するだけ</td></tr>
<tr><td><code>App.tsx</code></td><td>画面の土台</td><td>useChat, useSessions を使う</td></tr>
<tr><td><code>useChat.ts</code></td><td>チャットロジック</td><td>api.ts の sendChatMessage を呼ぶ</td></tr>
<tr><td><code>api.ts</code></td><td>サーバー通信</td><td><strong>ここで fetch() → バックエンドへ</strong></td></tr>
</table>

<p>💡 <strong>重要</strong>: App.tsx は api.ts を直接使わず、<strong>useChat 経由</strong>で間接的に使います。</p>

</div>
</div>

<div class="info-box">
<div class="box-title">🔐 認証トークンの流れ</div>
<div class="box-content">

<p><strong>なぜ認証が必要？</strong><br>
認証がないと、誰でもAPIにアクセスできてしまい、他人のデータを見られたり、悪用されたりします。<br>
「私は〇〇です」という<strong>身分証明書（IDトークン）</strong>を使って、正しいユーザーだけがアクセスできるようにします。</p>

<table style="width: 100%; border-collapse: collapse; margin: 20px 0;">
<tr style="background: #4a5568; color: white;">
<th style="padding: 12px; text-align: center; width: 80px;">ステップ</th>
<th style="padding: 12px; text-align: left;">何が起きる？</th>
<th style="padding: 12px; text-align: center; width: 200px;">データの流れ</th>
</tr>
<tr style="background: #f0fdf4;">
<td style="padding: 12px; text-align: center; font-weight: bold; font-size: 20px;">①</td>
<td style="padding: 12px;">
<strong>🔑 ログイン</strong><br>
ユーザーが「Googleでログイン」ボタンをクリック。<br>
Googleの画面でメールアドレス・パスワードを入力します。
</td>
<td style="padding: 12px; text-align: center; font-family: monospace;">
🖥️ ブラウザ<br>↓<br>🔥 Firebase
</td>
</tr>
<tr style="background: #fef3c7;">
<td style="padding: 12px; text-align: center; font-weight: bold; font-size: 20px;">②</td>
<td style="padding: 12px;">
<strong>📜 IDトークン発行</strong><br>
ログイン成功すると、Firebaseが<strong>IDトークン</strong>を発行します。<br>
<code style="background: #1e1e1e; color: #98c379; padding: 2px 6px; border-radius: 4px;">eyJhbG...</code> という長い文字列（JWT形式）で、<br>
「この人は本物の〇〇さんです」という情報が暗号化されています。
</td>
<td style="padding: 12px; text-align: center; font-family: monospace;">
🔥 Firebase<br>↓<br>🖥️ ブラウザ
</td>
</tr>
<tr style="background: #e0f2fe;">
<td style="padding: 12px; text-align: center; font-weight: bold; font-size: 20px;">③</td>
<td style="padding: 12px;">
<strong>📝 ヘッダー形式に整形（api.ts）</strong><br>
ブラウザ側のコード（api.ts）で、トークンをHTTPヘッダーの形式に整形します。<br>
<code style="background: #1e1e1e; color: #98c379; padding: 2px 6px; border-radius: 4px;">Authorization: Bearer eyJhbG...</code><br>
<small>💡 「Bearer」は「持参人」の意味。このトークンを持っている人に権限を与える形式です。</small>
</td>
<td style="padding: 12px; text-align: center; font-family: monospace; color: #666;">
（ブラウザ内部の処理）
</td>
</tr>
<tr style="background: #fce7f3;">
<td style="padding: 12px; text-align: center; font-weight: bold; font-size: 20px;">④</td>
<td style="padding: 12px;">
<strong>📤 トークン付きでAPIリクエスト</strong><br>
チャットメッセージを送るとき、ヘッダーにトークンを付けてバックエンドに送信します。<br>
バックエンドは受け取ったトークンをFirebaseで検証し、<br>
<strong>本物なら処理を続行</strong>、偽物ならエラーを返します。
</td>
<td style="padding: 12px; text-align: center; font-family: monospace;">
🖥️ ブラウザ<br>↓<br>🐍 バックエンド<br>↔️ 🔥 Firebase検証
</td>
</tr>
</table>

<p><strong>📋 役割分担まとめ</strong></p>
<table>
<tr><th>役割</th><th>フロントエンド</th><th>バックエンド</th></tr>
<tr><td>トークン取得</td><td>✅ api.ts で Firebase から取得</td><td>—</td></tr>
<tr><td>トークン送信</td><td>✅ HTTPヘッダーに付けて送る</td><td>—</td></tr>
<tr><td>トークン検証</td><td>—</td><td>✅ auth.py で Firebase に問い合わせて検証</td></tr>
</table>

<p>→ 詳細は <a href="./04_フロントエンド解説.html">04_フロントエンド解説</a> で説明しています。</p>

</div>
</div>

---

## 理解度チェック

以下の質問に答えられたら、全体像はバッチリ！

| 質問 | ヒント |
|------|--------|
| ユーザーが送ったメッセージは、どの順番で処理される？ | フロント→Gateway→バック→AI→... |
| Gatewayの役割は？ | 認証して、正しい会社のバックエンドに転送 |
| 会社Aのデータが会社Bに見えないのはなぜ？ | customer_id で分離 + 別々のバックエンド |
| ログイン後、何がもらえる？ | IDトークン |

---

## 次のステップ

<div class="summary-box">
<div class="box-title">✅ 全体像を把握できた！</div>
<div class="box-content">

<strong>→ 次は 03_バックエンド解説.md でPython/AIの仕組みを学ぼう！</strong>

</div>
</div>
