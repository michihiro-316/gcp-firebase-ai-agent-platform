# 動かしてみよう

<div class="chapter-hero">
<span class="emoji">🚀</span>
<h1>動かしてみよう</h1>
<p class="subtitle">「百聞は一見にしかず、百見は一動にしかず」<br>「実際に動かしてみると理解が深まる！」</p>
</div>

---

## この章で学ぶこと

<div class="goal-box">
<h3>📚 学習目標</h3>
<ol>
<li>モックモードで動作確認（GCP不要）</li>
<li>本番モードでAI動作確認</li>
<li>トラブルシューティング</li>
<li>デバッグのコツ</li>
</ol>
<p><strong>⏱️ 想定学習時間: 15分</strong></p>
</div>

---

## 2つの起動方法

| 方法 | 用途 | GCP必要 | 認証必要 |
|------|------|---------|---------|
| **モックモード** | フロントエンド開発、UI確認 | 不要 | 不要 |
| **本番モード** | AI動作確認、本番テスト | 必要 | 必要 |

<div class="tip-box">
<h3>💡 おすすめの順番</h3>
<ol>
<li><strong>まずモックモードで動作確認</strong><br>
→ GCP設定なしですぐ動く<br>
→ UIやフロントエンドの動作を確認</li>
<li><strong>次に本番モードでAI確認</strong><br>
→ 実際のGemini AIと会話<br>
→ 本番と同じ動作を確認</li>
</ol>
</div>

---

## モックモード（GCP不要・すぐ動く）

GCP/Firebase接続なしでフロントエンドの動作確認ができます。

### 準備するもの

- Python 3.11以上
- Node.js 18以上
- **GCPは不要！**

### 手順

**ターミナル1: モックサーバー起動**

```bash
cd backend/dev
pip install flask flask-cors  # 初回のみ
python mock_server.py
```

**ターミナル2: フロントエンド起動**

```bash
cd frontend
npm install  # 初回のみ

# .env を編集
# VITE_API_BASE_URL=http://localhost:8080
# VITE_DEBUG_MODE=true

npm run dev
```

**ブラウザで確認**

http://localhost:5173/ を開く → 認証なしでチャット画面が表示される

### モックサーバーの特徴

<div class="info-box">
<h3>🎭 モックサーバーとは？</h3>
<p>本物のバックエンドの「ふり」をするサーバー</p>
<ul>
<li>✅ AIの代わりに固定レスポンスを返す</li>
<li>✅ 課金なし（Vertex AI を使わない）</li>
<li>✅ 認証スキップ</li>
<li>✅ フロントエンド開発に集中できる</li>
</ul>
<p>詳細は backend/dev/README.md を参照</p>
</div>

---

## 本番モード（AI動作確認）

### 準備するもの

- Python 3.11以上
- Node.js 18以上
- GCPプロジェクト（セットアップ済み）
- service-account.json（ダウンロード済み）

---

## 本番モードの手順

### 1. バックエンドを起動

ターミナル1:

```bash
# backendフォルダに移動
cd backend

# 依存パッケージをインストール（初回のみ）
pip install -r requirements.txt

# サーバーを起動
functions-framework --target=main --port=8080
```

成功すると:
```
* Serving Flask app 'main'
* Running on http://127.0.0.1:8080
```

### 2. フロントエンドを起動

ターミナル2（別のターミナルを開く）:

```bash
# frontendフォルダに移動
cd frontend

# 依存パッケージをインストール（初回のみ）
npm install

# 開発サーバーを起動
npm run dev
```

成功すると:
```
VITE v5.x.x  ready in xxx ms

➜  Local:   http://localhost:5173/
```

### 3. ブラウザでアクセス

http://localhost:5173/ を開く

---

## 試してみること

### 1. ログインする

1. 「Googleでログイン」をクリック
2. Googleアカウントを選択
3. ログイン成功 → チャット画面が表示される

### 2. チャットする

1. 「こんにちは」と入力
2. 送信ボタンをクリック
3. AIが返答する

<div class="info-box">
<h3>💬 チャットの動きを観察しよう</h3>
<ul>
<li>「AIが考え中...」と表示される（待機中UI）</li>
<li>AIの応答が表示される</li>
<li>入力中はボタンが無効になる</li>
<li>エラーがあればメッセージが表示される</li>
</ul>
<p>これらは全てフロントエンドのコードで制御されています！</p>
</div>

### 3. Firestoreを確認

1. Firebase Console を開く
2. Firestore Database をクリック
3. `customers/{customer_id}/checkpoints` を確認
4. 会話履歴が保存されている！

---

## トラブルシューティング

<div class="warning-box">
<h3>🔧 よくあるエラーと対処法</h3>
<p><strong>【CORS エラー】</strong><br>
backend/.env を確認:<br>
<code>ALLOWED_ORIGINS=http://localhost:5173</code><br>
（末尾にスラッシュをつけない）</p>
<p><strong>【認証エラー】</strong></p>
<ol>
<li>Firebase Console → Authentication</li>
<li>Sign-in method で Google が有効か確認</li>
<li>config/access_control にドメイン/メールを追加</li>
</ol>
<p><strong>【Vertex AI エラー】</strong></p>
<ol>
<li>GCP Console → APIs & Services</li>
<li>Vertex AI API が有効か確認</li>
<li>サービスアカウントに「Vertex AI ユーザー」ロールがあるか確認</li>
</ol>
<p><strong>【顧客に紐付けされていません】</strong><br>
<code>python scripts/manage_customer.py add-email test-corp you@gmail.com</code></p>
</div>

---

## デバッグのコツ

### バックエンドのログを見る

ターミナル1に表示される:
```
127.0.0.1 - - [16/Jan/2024 10:00:00] "POST /chat HTTP/1.1" 200 -
```

### ブラウザの開発者ツール

<div class="info-box">
<h3>🔍 開発者ツールの使い方</h3>
<ol>
<li><strong>F12 を押す</strong>（または右クリック → 検証）</li>
<li><strong>Network タブ</strong><br>
→ API呼び出しを確認<br>
→ リクエスト/レスポンスの中身を見る</li>
<li><strong>Console タブ</strong><br>
→ エラーメッセージを確認<br>
→ console.log の出力を見る</li>
<li><strong>Application タブ</strong><br>
→ localStorage の中身を確認<br>
→ セッション情報を見る</li>
</ol>
</div>

### Firestoreのデータを見る

Firebase Console → Firestore Database
- リアルタイムでデータが更新される
- どんなデータが保存されているか確認

---

## コードを変更してみよう

### 実験1: AIの返答を変える

```python
# backend/agents/_template/agent.py

SYSTEM_PROMPT = """あなたは関西弁で話すAIアシスタントやで。
ユーザーの質問にフレンドリーに答えてや。"""
```

→ バックエンドを再起動 → チャットしてみる

### 実験2: 画面の色を変える

```css
/* frontend/src/styles.css */

.chat-container {
  background-color: #f0f8ff;  /* 薄い青に変更 */
}
```

→ 自動で画面が更新される（ホットリロード）

---

## まとめ

<div class="summary-box">
<h3>🎓 この章で学んだこと</h3>
<ul>
<li>✅ モックモードでGCPなしでも動作確認できる</li>
<li>✅ 本番モードで実際のAIと会話できる</li>
<li>✅ 開発者ツールでデバッグできる</li>
<li>✅ コードを変更して動作を確認する方法</li>
</ul>
<p><strong>次は AIのカスタマイズに挑戦してみよう！</strong></p>
</div>

---

## 次に読むべきドキュメント

| 順番 | ドキュメント | 内容 |
|------|-------------|------|
| 1 | [08_AIカスタマイズ.md](./08_AIカスタマイズ.md) | AIの応答をカスタマイズ |
| 2 | [11_チャット送信の流れ.md](./11_チャット送信の流れ.md) | 詳細なデータフロー |
