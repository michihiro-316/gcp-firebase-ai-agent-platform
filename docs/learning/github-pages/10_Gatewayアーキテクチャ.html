<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>10 Gatewayã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ - GCP AI Agent è¨­è¨ˆè³‡æ–™</title>
  <link rel="stylesheet" href="assets/style.css">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ“š</text></svg>">
</head>
<body>
  <header class="header">
    <a href="index.html" class="header-logo">
      <span>ğŸ“š</span>
      <span>GCP AI Agent è¨­è¨ˆè³‡æ–™</span>
    </a>
    <nav class="header-nav">
      <a href="index.html">ãƒ›ãƒ¼ãƒ </a>
      <a href="02_å…¨ä½“åƒ.html">å…¨ä½“åƒ</a>
      <a href="https://github.com" target="_blank">GitHub</a>
    </nav>
    <button class="menu-toggle" onclick="toggleSidebar()">
      <span></span>
      <span></span>
      <span></span>
    </button>
  </header>

  <div class="layout">
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-section">
        <div class="sidebar-title">ğŸ“– ã¯ã˜ã‚ã«</div>
        <ul class="sidebar-nav">
          <li><a href="01_ã¯ã˜ã‚ã«èª­ã‚“ã§ãã ã•ã„.html" >ã¯ã˜ã‚ã«èª­ã‚“ã§ãã ã•ã„</a></li>
        </ul>
      </div>

      <div class="sidebar-section">
        <div class="sidebar-title">ğŸ—ï¸ ä»•çµ„ã¿ã‚’ç†è§£</div>
        <ul class="sidebar-nav">
          <li><a href="02_å…¨ä½“åƒ.html" >å…¨ä½“åƒ</a></li>
          <li><a href="03_ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰è§£èª¬.html" >ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰è§£èª¬</a></li>
          <li><a href="04_ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰è§£èª¬.html" >ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰è§£èª¬</a></li>
        </ul>
      </div>

      <div class="sidebar-section">
        <div class="sidebar-title">ğŸ› ï¸ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—</div>
        <ul class="sidebar-nav">
          <li><a href="05_ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã®æµã‚Œ.html" >ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã®æµã‚Œ</a></li>
          <li><a href="06_ã‚³ãƒãƒ³ãƒ‰è§£èª¬.html" >ã‚³ãƒãƒ³ãƒ‰è§£èª¬</a></li>
        </ul>
      </div>

      <div class="sidebar-section">
        <div class="sidebar-title">ğŸš€ å‹•ã‹ã™</div>
        <ul class="sidebar-nav">
          <li><a href="07_å‹•ã‹ã—ã¦ã¿ã‚ˆã†.html" >å‹•ã‹ã—ã¦ã¿ã‚ˆã†</a></li>
          <li><a href="08_AIã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º.html" >AIã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º</a></li>
        </ul>
      </div>

      <div class="sidebar-section">
        <div class="sidebar-title">ğŸ”§ ä¸Šç´šç·¨</div>
        <ul class="sidebar-nav">
          <li><a href="10_Gatewayã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£.html" class="active">Gatewayã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£</a></li>
        </ul>
      </div>

      <div class="sidebar-section">
        <div class="sidebar-title">ğŸ”„ å‚è€ƒ: ãƒ•ãƒ­ãƒ¼è§£èª¬</div>
        <ul class="sidebar-nav">
          <li><a href="11_ãƒãƒ£ãƒƒãƒˆé€ä¿¡ã®æµã‚Œ.html" >ãƒãƒ£ãƒƒãƒˆé€ä¿¡ã®æµã‚Œ</a></li>
          <li><a href="12_ãƒ­ã‚°ã‚¤ãƒ³ã®æµã‚Œ.html" >ãƒ­ã‚°ã‚¤ãƒ³ã®æµã‚Œ</a></li>
          <li><a href="13_ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ã®æµã‚Œ.html" >ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ã®æµã‚Œ</a></li>
        </ul>
      </div>
    </aside>

    <main class="main">
      <article class="content">
        <h1 id="gateway-ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è§£èª¬">Gateway ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è§£èª¬<a class="header-link" href="#gateway-ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è§£èª¬" title="Permanent link">&para;</a></h1>
<h2 id="æ¦‚è¦">æ¦‚è¦<a class="header-link" href="#æ¦‚è¦" title="Permanent link">&para;</a></h2>
<p>æœ¬ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã¯ã€ŒGateway + Company Cloud Functionsã€æ§‹æˆã‚’æ¡ç”¨ã—ã¦ã„ã¾ã™ã€‚</p>
<pre class="codehilite"><code>   ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ï¼‰
        â”‚
        â”‚ HTTPS + Firebase Token
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     Gateway Cloud Functionsï¼ˆ1ã¤ï¼‰       â”‚
â”‚                                         â”‚
â”‚  ã‚„ã‚‹ã“ã¨ï¼ˆ3ã¤ã ã‘ï¼‰:                     â”‚
â”‚  1. Firebase èªè¨¼ãƒã‚§ãƒƒã‚¯                â”‚
â”‚  2. customer_id ã‹ã‚‰ URL ã‚’å–å¾—          â”‚
â”‚  3. ãã®ã¾ã¾è»¢é€ï¼ˆãƒ—ãƒ­ã‚­ã‚·ï¼‰              â”‚
â”‚                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â”‚ ãã®ã¾ã¾è»¢é€
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Company Cloud Functionsï¼ˆä¼šç¤¾ã”ã¨ï¼‰    â”‚
â”‚                                         â”‚
â”‚  ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ API + AI Agent             â”‚
â”‚  â†’ æ—¢å­˜ã® src/backend/src/main.py       â”‚
â”‚                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre>

<hr />
<h2 id="ãªãœã“ã®è¨­è¨ˆã‹">ãªãœã“ã®è¨­è¨ˆã‹<a class="header-link" href="#ãªãœã“ã®è¨­è¨ˆã‹" title="Permanent link">&para;</a></h2>
<h3 id="æ—¢å­˜ã®å•é¡Œç‚¹">æ—¢å­˜ã®å•é¡Œç‚¹<a class="header-link" href="#æ—¢å­˜ã®å•é¡Œç‚¹" title="Permanent link">&para;</a></h3>
<ul>
<li>Cloud Functions ã¯å„ç¤¾ã”ã¨ã«ãƒ‡ãƒ—ãƒ­ã‚¤ â†’ OKã€ãã®ã¾ã¾ç¶­æŒ</li>
<li>ã§ã‚‚ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã¯ GCS ã§å…±æœ‰ â†’ ãã®ã¾ã¾ç¶­æŒï¼ˆä»Šå›ã¯å¤‰æ›´ã—ãªã„ï¼‰</li>
<li>èªè¨¼ãŒå„ Cloud Functions ã§åˆ†æ•£ â†’ Gateway ã§ä¸€å…ƒåŒ–</li>
</ul>
<h3 id="ã“ã®è¨­è¨ˆã®è‰¯ã„ç‚¹">ã“ã®è¨­è¨ˆã®è‰¯ã„ç‚¹<a class="header-link" href="#ã“ã®è¨­è¨ˆã®è‰¯ã„ç‚¹" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>Gateway ã¯ã€Œèªè¨¼ã—ã¦è»¢é€ã™ã‚‹ã ã‘ã€</strong> â†’ ã‚·ãƒ³ãƒ—ãƒ«</li>
<li><strong>æ—¢å­˜ã® Cloud Functions ã‚’å¤‰æ›´ã—ãªã„</strong> â†’ ç§»è¡Œãƒªã‚¹ã‚¯æœ€å°</li>
<li><strong>æ—¢å­˜ã‚³ãƒ¼ãƒ‰ã‚’ã»ã¼ãã®ã¾ã¾ä½¿ãˆã‚‹</strong> â†’ å­¦ç¿’ã‚³ã‚¹ãƒˆä½ã„</li>
<li><strong>Docker ä¸ä½¿ç”¨</strong> â†’ æ—¢å­˜ã®ãƒ‡ãƒ—ãƒ­ã‚¤æ–¹å¼ã‚’ç¶­æŒ</li>
</ul>
<h3 id="å—è¨—é•·æœŸé‹ç”¨ã«å‘ã„ã¦ã„ã‚‹ç†ç”±">å—è¨—ãƒ»é•·æœŸé‹ç”¨ã«å‘ã„ã¦ã„ã‚‹ç†ç”±<a class="header-link" href="#å—è¨—é•·æœŸé‹ç”¨ã«å‘ã„ã¦ã„ã‚‹ç†ç”±" title="Permanent link">&para;</a></h3>
<ul>
<li>é¡§å®¢ã”ã¨ã«ã‚³ãƒ¼ãƒ‰ã‚’ãƒ•ã‚©ãƒ¼ã‚¯ã§ãã‚‹</li>
<li>1ç¤¾ã ã‘ç‰¹æ®Šãªã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã‚‚å¯èƒ½</li>
<li>ä»–ç¤¾ã¸ã®å½±éŸ¿ã‚¼ãƒ­</li>
<li>æ–°äººã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã§ã‚‚ç†è§£ã—ã‚„ã™ã„</li>
</ul>
<hr />
<h2 id="gateway-ã®è²¬å‹™">Gateway ã®è²¬å‹™<a class="header-link" href="#gateway-ã®è²¬å‹™" title="Permanent link">&para;</a></h2>
<p>Gateway ã¯ä»¥ä¸‹ã®3ã¤ã ã‘ã‚’è¡Œã„ã¾ã™:</p>
<h3 id="1-firebase-èªè¨¼ãƒã‚§ãƒƒã‚¯">1. Firebase èªè¨¼ãƒã‚§ãƒƒã‚¯<a class="header-link" href="#1-firebase-èªè¨¼ãƒã‚§ãƒƒã‚¯" title="Permanent link">&para;</a></h3>
<pre class="codehilite"><code class="language-python">def verify_request():
    &quot;&quot;&quot;Firebase ãƒˆãƒ¼ã‚¯ãƒ³ã‚’æ¤œè¨¼ã—ã¦ uid, customer_id ã‚’è¿”ã™&quot;&quot;&quot;
    token = request.headers.get(&quot;Authorization&quot;, &quot;&quot;).replace(&quot;Bearer &quot;, &quot;&quot;)
    decoded = auth.verify_id_token(token, check_revoked=True)
    uid = decoded[&quot;uid&quot;]

    # Custom Claims ã‹ã‚‰ customer_id ã‚’å–å¾—
    user = auth.get_user(uid)
    customer_id = (user.custom_claims or {}).get(&quot;customer_id&quot;)

    return uid, customer_id
</code></pre>

<h3 id="2-customer_id-ã‹ã‚‰-url-ã‚’å–å¾—">2. customer_id ã‹ã‚‰ URL ã‚’å–å¾—<a class="header-link" href="#2-customer_id-ã‹ã‚‰-url-ã‚’å–å¾—" title="Permanent link">&para;</a></h3>
<pre class="codehilite"><code class="language-python">def get_company_url(customer_id: str) -&gt; str:
    &quot;&quot;&quot;Firestore ã‹ã‚‰è»¢é€å…ˆ URL ã‚’å–å¾—&quot;&quot;&quot;
    doc = db.collection(&quot;customers&quot;).document(customer_id).get()
    if doc.exists:
        return doc.to_dict().get(&quot;cloud_functions_url&quot;)
    return None
</code></pre>

<h3 id="3-ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ãã®ã¾ã¾è»¢é€">3. ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ãã®ã¾ã¾è»¢é€<a class="header-link" href="#3-ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ãã®ã¾ã¾è»¢é€" title="Permanent link">&para;</a></h3>
<pre class="codehilite"><code class="language-python"># ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’è»¢é€ï¼ˆã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°å¯¾å¿œï¼‰
resp = requests.request(
    method=request.method,
    url=target_url,
    headers={
        &quot;X-Gateway-Verified&quot;: &quot;true&quot;,
        &quot;X-User-Id&quot;: uid,
        &quot;X-Customer-Id&quot;: customer_id,
    },
    data=request.get_data(),
    stream=True,  # SSE å¯¾å¿œ
    timeout=300,
)
</code></pre>

<hr />
<h2 id="gateway-ãŒã‚„ã‚‰ãªã„ã“ã¨é‡è¦">Gateway ãŒã‚„ã‚‰ãªã„ã“ã¨ï¼ˆé‡è¦ï¼‰<a class="header-link" href="#gateway-ãŒã‚„ã‚‰ãªã„ã“ã¨é‡è¦" title="Permanent link">&para;</a></h2>
<ul>
<li>AI å‡¦ç†</li>
<li>ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯</li>
<li>UI ãƒ­ã‚¸ãƒƒã‚¯</li>
<li>ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ“ä½œï¼ˆé¡§å®¢ URL å–å¾—ä»¥å¤–ï¼‰</li>
</ul>
<p>ã“ã‚Œã‚‰ã¯ã™ã¹ã¦ Company Cloud Functions ã§è¡Œã„ã¾ã™ã€‚</p>
<hr />
<h2 id="company-cloud-functions-ã®å¤‰æ›´ç‚¹">Company Cloud Functions ã®å¤‰æ›´ç‚¹<a class="header-link" href="#company-cloud-functions-ã®å¤‰æ›´ç‚¹" title="Permanent link">&para;</a></h2>
<p>Gateway çµŒç”±ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å—ã‘ä»˜ã‘ã‚‹ãŸã‚ã€ä»¥ä¸‹ã®èªè¨¼é–¢æ•°ãŒè¿½åŠ ã•ã‚Œã¦ã„ã¾ã™:</p>
<pre class="codehilite"><code class="language-python">def authenticate_request_with_gateway(request) -&gt; dict:
    &quot;&quot;&quot;Gateway çµŒç”±ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’èªè¨¼&quot;&quot;&quot;

    # Gateway çµŒç”±ã‹ã©ã†ã‹ã‚’ç¢ºèª
    gateway_verified = request.headers.get(&quot;X-Gateway-Verified&quot;)

    if gateway_verified == &quot;true&quot;:
        # Gateway ãŒèªè¨¼æ¸ˆã¿ãªã®ã§ã€å†…éƒ¨ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ä¿¡é ¼
        user_id = request.headers.get(&quot;X-User-Id&quot;)
        customer_id = request.headers.get(&quot;X-Customer-Id&quot;)
        return {
            &quot;uid&quot;: user_id,
            &quot;customer_id&quot;: customer_id,
        }

    # Gateway çµŒç”±ã§ãªã„å ´åˆã¯å¾“æ¥ã®èªè¨¼
    return authenticate_request(request)
</code></pre>

<hr />
<h2 id="firestore-ã‚¹ã‚­ãƒ¼ãƒ">Firestore ã‚¹ã‚­ãƒ¼ãƒ<a class="header-link" href="#firestore-ã‚¹ã‚­ãƒ¼ãƒ" title="Permanent link">&para;</a></h2>
<p>Gateway ãŒé¡§å®¢ã® Cloud Functions URL ã‚’å–å¾—ã™ã‚‹ãŸã‚ã€ä»¥ä¸‹ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒå¿…è¦ã§ã™:</p>
<pre class="codehilite"><code>customers/{customer_id}
â”œâ”€â”€ name: &quot;ACME Corporation&quot;
â”œâ”€â”€ allowed_emails: [&quot;user@acme.co.jp&quot;, ...]
â”œâ”€â”€ allowed_domains: [&quot;acme.co.jp&quot;]
â”œâ”€â”€ cloud_functions_url: &quot;https://xxx.cloudfunctions.net/{customer_id}-api&quot;  â† è¿½åŠ 
â”œâ”€â”€ enabled: true  â† è¿½åŠ 
â””â”€â”€ created_at: timestamp
</code></pre>

<hr />
<h2 id="ãƒ‡ãƒ—ãƒ­ã‚¤æ–¹æ³•">ãƒ‡ãƒ—ãƒ­ã‚¤æ–¹æ³•<a class="header-link" href="#ãƒ‡ãƒ—ãƒ­ã‚¤æ–¹æ³•" title="Permanent link">&para;</a></h2>
<h3 id="gateway-ã®ãƒ‡ãƒ—ãƒ­ã‚¤">Gateway ã®ãƒ‡ãƒ—ãƒ­ã‚¤<a class="header-link" href="#gateway-ã®ãƒ‡ãƒ—ãƒ­ã‚¤" title="Permanent link">&para;</a></h3>
<pre class="codehilite"><code class="language-bash">export PROJECT_ID=your-project-id
./infrastructure/deploy-gateway.sh
</code></pre>

<h3 id="company-cloud-functions-ã®ãƒ‡ãƒ—ãƒ­ã‚¤">Company Cloud Functions ã®ãƒ‡ãƒ—ãƒ­ã‚¤<a class="header-link" href="#company-cloud-functions-ã®ãƒ‡ãƒ—ãƒ­ã‚¤" title="Permanent link">&para;</a></h3>
<pre class="codehilite"><code class="language-bash">export PROJECT_ID=your-project-id
./infrastructure/deploy-customer.sh customer-a
</code></pre>

<hr />
<h2 id="ç§»è¡Œã®æµã‚Œ">ç§»è¡Œã®æµã‚Œ<a class="header-link" href="#ç§»è¡Œã®æµã‚Œ" title="Permanent link">&para;</a></h2>
<h3 id="phase-1-gateway-ã®è¿½åŠ æ—¢å­˜ã‚’å£Šã•ãªã„">Phase 1: Gateway ã®è¿½åŠ ï¼ˆæ—¢å­˜ã‚’å£Šã•ãªã„ï¼‰<a class="header-link" href="#phase-1-gateway-ã®è¿½åŠ æ—¢å­˜ã‚’å£Šã•ãªã„" title="Permanent link">&para;</a></h3>
<ol>
<li><code>src/gateway/src/main.py</code> ã‚’ä½œæˆï¼ˆæ¸ˆã¿ï¼‰</li>
<li>Gateway Cloud Functions ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤</li>
<li>å‹•ä½œç¢ºèªï¼ˆæ—¢å­˜ã®æ§‹æˆã¨ä¸¦è¡Œç¨¼åƒï¼‰</li>
</ol>
<h3 id="phase-2-ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®æ¥ç¶šå…ˆå¤‰æ›´">Phase 2: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®æ¥ç¶šå…ˆå¤‰æ›´<a class="header-link" href="#phase-2-ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®æ¥ç¶šå…ˆå¤‰æ›´" title="Permanent link">&para;</a></h3>
<ol>
<li>ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã® <code>VITE_API_BASE_URL</code> ã‚’ Gateway ã«å¤‰æ›´</li>
<li>å‹•ä½œç¢ºèª</li>
</ol>
<h3 id="phase-3-æ—¢å­˜-cloud-functions-ã®èª¿æ•´ã‚ªãƒ—ã‚·ãƒ§ãƒ³">Phase 3: æ—¢å­˜ Cloud Functions ã®èª¿æ•´ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰<a class="header-link" href="#phase-3-æ—¢å­˜-cloud-functions-ã®èª¿æ•´ã‚ªãƒ—ã‚·ãƒ§ãƒ³" title="Permanent link">&para;</a></h3>
<ol>
<li>Gateway ã‹ã‚‰ã®å†…éƒ¨ãƒ˜ãƒƒãƒ€ãƒ¼å¯¾å¿œã‚’è¿½åŠ ï¼ˆæ¸ˆã¿ï¼‰</li>
<li>ç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹ã‚’æ®µéšçš„ã«åˆ¶é™ï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰</li>
</ol>
<p><strong>é‡è¦</strong>: Phase 1 ã ã‘ã§å‹•ä½œã™ã‚‹ã®ã§ã€æ®µéšçš„ã«é€²ã‚ã‚‰ã‚Œã¾ã™ã€‚</p>
<hr />
<h2 id="ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ ">ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ <a class="header-link" href="#ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ " title="Permanent link">&para;</a></h2>
<pre class="codehilite"><code>gcp-firebase-ai-agent-platform/
â”‚
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ gateway/                      # Gateway Cloud Functions
â”‚   â”‚   â””â”€â”€ src/
â”‚   â”‚       â”œâ”€â”€ main.py               # Gateway æœ¬ä½“ï¼ˆç´„100è¡Œï¼‰
â”‚   â”‚       â””â”€â”€ requirements.txt      # ä¾å­˜é–¢ä¿‚
â”‚   â”‚
â”‚   â”œâ”€â”€ backend/                      # Company Cloud Functionsï¼ˆæ—¢å­˜ï¼‰
â”‚   â”‚   â””â”€â”€ src/
â”‚   â”‚       â”œâ”€â”€ main.py               # ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰æœ¬ä½“
â”‚   â”‚       â”œâ”€â”€ agents/               # AI ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ
â”‚   â”‚       â””â”€â”€ common/               # å…±é€šãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«
â”‚   â”‚
â”‚   â””â”€â”€ frontend/                     # ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ï¼ˆæ—¢å­˜ï¼‰
â”‚
â””â”€â”€ infrastructure/
    â”œâ”€â”€ deploy-gateway.sh             # Gateway ãƒ‡ãƒ—ãƒ­ã‚¤
    â””â”€â”€ deploy-customer.sh            # Company ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆæ—¢å­˜ï¼‰
</code></pre>

<hr />
<h2 id="ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£">ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£<a class="header-link" href="#ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£" title="Permanent link">&para;</a></h2>
<h3 id="èªè¨¼ãƒ•ãƒ­ãƒ¼">èªè¨¼ãƒ•ãƒ­ãƒ¼<a class="header-link" href="#èªè¨¼ãƒ•ãƒ­ãƒ¼" title="Permanent link">&para;</a></h3>
<ol>
<li>ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãŒ Firebase Token ã‚’å–å¾—</li>
<li>Gateway ãŒ Token ã‚’æ¤œè¨¼ã—ã€customer_id ã‚’å–å¾—</li>
<li>Gateway ãŒå†…éƒ¨ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆ<code>X-Gateway-Verified</code>, <code>X-User-Id</code>, <code>X-Customer-Id</code>ï¼‰ã‚’ä»˜ä¸</li>
<li>Company Cloud Functions ãŒå†…éƒ¨ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ä¿¡é ¼</li>
</ol>
<h3 id="backend-ã¸ã®ç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹é˜²æ­¢cloud-run-iam">Backend ã¸ã®ç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹é˜²æ­¢ï¼ˆCloud Run IAMï¼‰<a class="header-link" href="#backend-ã¸ã®ç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹é˜²æ­¢cloud-run-iam" title="Permanent link">&para;</a></h3>
<p><strong>é‡è¦</strong>: Backend ã¸ã®ç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹ã‚’é˜²ããŸã‚ã€Cloud Run IAM ã§ Gateway ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ã«è¨­å®šã™ã‚‹ã“ã¨ã‚’æ¨å¥¨ã—ã¾ã™ã€‚</p>
<pre class="codehilite"><code class="language-bash"># Backend ã‚’éå…¬é–‹ã«è¨­å®š
gcloud run services update backend \
  --no-allow-unauthenticated \
  --region=asia-northeast1

# Gateway ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã« Backend ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹æ¨©ã‚’ä»˜ä¸
gcloud run services add-iam-policy-binding backend \
  --member=&quot;serviceAccount:gateway@PROJECT_ID.iam.gserviceaccount.com&quot; \
  --role=&quot;roles/run.invoker&quot; \
  --region=asia-northeast1
</code></pre>

<p>ã“ã‚Œã«ã‚ˆã‚Šã€ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆã‹ã‚‰ç›´æ¥ Backend ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ããªããªã‚Šã€<code>X-Gateway-Verified</code> ãƒ˜ãƒƒãƒ€ãƒ¼ã®å½è£…ã‚’é˜²æ­¢ã§ãã¾ã™ã€‚</p>
<h3 id="ç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹ã®å ´åˆ">ç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹ã®å ´åˆ<a class="header-link" href="#ç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹ã®å ´åˆ" title="Permanent link">&para;</a></h3>
<p>Gateway ã‚’çµŒç”±ã—ãªã„å ´åˆã§ã‚‚ã€Company Cloud Functions ã¯å¾“æ¥é€šã‚Š Firebase Token ã‚’æ¤œè¨¼ã—ã¾ã™ã€‚</p>
<pre class="codehilite"><code class="language-python">if gateway_verified == &quot;true&quot;:
    # Gateway çµŒç”± â†’ å†…éƒ¨ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ä¿¡é ¼
    return {&quot;uid&quot;: user_id, &quot;customer_id&quot;: customer_id}
else:
    # å¾“æ¥ã®èªè¨¼
    return authenticate_request(request)
</code></pre>

<hr />
<h2 id="ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°">ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°<a class="header-link" href="#ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°" title="Permanent link">&para;</a></h2>
<h3 id="gateway-ã®ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯">Gateway ã®ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯<a class="header-link" href="#gateway-ã®ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯" title="Permanent link">&para;</a></h3>
<pre class="codehilite"><code class="language-bash">curl https://gateway-xxx.cloudfunctions.net/health
# â†’ {&quot;status&quot;: &quot;healthy&quot;, &quot;service&quot;: &quot;gateway&quot;}
</code></pre>

<h3 id="èªè¨¼ã‚¨ãƒ©ãƒ¼">èªè¨¼ã‚¨ãƒ©ãƒ¼<a class="header-link" href="#èªè¨¼ã‚¨ãƒ©ãƒ¼" title="Permanent link">&para;</a></h3>
<ul>
<li><code>401</code>: Firebase Token ãŒç„¡åŠ¹</li>
<li><code>403</code>: customer_id ãŒæœªè¨­å®š</li>
<li><code>404</code>: customers ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã« cloud_functions_url ãŒæœªè¨­å®š</li>
</ul>
<h3 id="sse-ãŒé€”åˆ‡ã‚Œã‚‹">SSE ãŒé€”åˆ‡ã‚Œã‚‹<a class="header-link" href="#sse-ãŒé€”åˆ‡ã‚Œã‚‹" title="Permanent link">&para;</a></h3>
<p>Gateway ã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã¯ 300 ç§’ã«è¨­å®šã•ã‚Œã¦ã„ã¾ã™ã€‚ãã‚Œä»¥ä¸Šã‹ã‹ã‚‹å ´åˆã¯èª¿æ•´ãŒå¿…è¦ã§ã™ã€‚</p>
      </article>
      <footer class="footer">
        GCP AI Agent è¨­è¨ˆè³‡æ–™ | Built with Python & Markdown
      </footer>
    </main>
  </div>

  <script>
    function toggleSidebar() {
      document.getElementById('sidebar').classList.toggle('open');
    }

    // Close sidebar when clicking outside on mobile
    document.addEventListener('click', function(e) {
      const sidebar = document.getElementById('sidebar');
      const toggle = document.querySelector('.menu-toggle');
      if (!sidebar.contains(e.target) && !toggle.contains(e.target)) {
        sidebar.classList.remove('open');
      }
    });
  </script>
</body>
</html>