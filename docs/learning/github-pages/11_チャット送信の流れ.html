<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>11 ãƒãƒ£ãƒƒãƒˆé€ä¿¡ã®æµã‚Œ - GCP AI Agent è¨­è¨ˆè³‡æ–™</title>
  <link rel="stylesheet" href="assets/style.css">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ“š</text></svg>">
</head>
<body>
  <header class="header">
    <a href="index.html" class="header-logo">
      <span>ğŸ“š</span>
      <span>GCP AI Agent è¨­è¨ˆè³‡æ–™</span>
    </a>
    <nav class="header-nav">
      <a href="index.html">ãƒ›ãƒ¼ãƒ </a>
      <a href="02_å…¨ä½“åƒ.html">å…¨ä½“åƒ</a>
      <a href="https://github.com" target="_blank">GitHub</a>
    </nav>
    <button class="menu-toggle" onclick="toggleSidebar()">
      <span></span>
      <span></span>
      <span></span>
    </button>
  </header>

  <div class="layout">
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-section">
        <div class="sidebar-title">ğŸ“– ã¯ã˜ã‚ã«</div>
        <ul class="sidebar-nav">
          <li><a href="01_ã¯ã˜ã‚ã«èª­ã‚“ã§ãã ã•ã„.html" >ã¯ã˜ã‚ã«èª­ã‚“ã§ãã ã•ã„</a></li>
        </ul>
      </div>

      <div class="sidebar-section">
        <div class="sidebar-title">ğŸ—ï¸ ä»•çµ„ã¿ã‚’ç†è§£</div>
        <ul class="sidebar-nav">
          <li><a href="02_å…¨ä½“åƒ.html" >å…¨ä½“åƒ</a></li>
          <li><a href="03_ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰è§£èª¬.html" >ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰è§£èª¬</a></li>
          <li><a href="04_ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰è§£èª¬.html" >ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰è§£èª¬</a></li>
        </ul>
      </div>

      <div class="sidebar-section">
        <div class="sidebar-title">ğŸ› ï¸ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—</div>
        <ul class="sidebar-nav">
          <li><a href="05_ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã®æµã‚Œ.html" >ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã®æµã‚Œ</a></li>
          <li><a href="06_ã‚³ãƒãƒ³ãƒ‰è§£èª¬.html" >ã‚³ãƒãƒ³ãƒ‰è§£èª¬</a></li>
        </ul>
      </div>

      <div class="sidebar-section">
        <div class="sidebar-title">ğŸš€ å‹•ã‹ã™</div>
        <ul class="sidebar-nav">
          <li><a href="07_å‹•ã‹ã—ã¦ã¿ã‚ˆã†.html" >å‹•ã‹ã—ã¦ã¿ã‚ˆã†</a></li>
          <li><a href="08_AIã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º.html" >AIã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º</a></li>
        </ul>
      </div>

      <div class="sidebar-section">
        <div class="sidebar-title">ğŸ”§ ä¸Šç´šç·¨</div>
        <ul class="sidebar-nav">
          <li><a href="10_Gatewayã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£.html" >Gatewayã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£</a></li>
        </ul>
      </div>

      <div class="sidebar-section">
        <div class="sidebar-title">ğŸ”„ å‚è€ƒ: ãƒ•ãƒ­ãƒ¼è§£èª¬</div>
        <ul class="sidebar-nav">
          <li><a href="11_ãƒãƒ£ãƒƒãƒˆé€ä¿¡ã®æµã‚Œ.html" class="active">ãƒãƒ£ãƒƒãƒˆé€ä¿¡ã®æµã‚Œ</a></li>
          <li><a href="12_ãƒ­ã‚°ã‚¤ãƒ³ã®æµã‚Œ.html" >ãƒ­ã‚°ã‚¤ãƒ³ã®æµã‚Œ</a></li>
          <li><a href="13_ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ã®æµã‚Œ.html" >ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ã®æµã‚Œ</a></li>
        </ul>
      </div>
    </aside>

    <main class="main">
      <article class="content">
        <h1 id="ãƒãƒ£ãƒƒãƒˆé€ä¿¡ã®æµã‚Œ---å®Œå…¨è§£èª¬">ãƒãƒ£ãƒƒãƒˆé€ä¿¡ã®æµã‚Œ - å®Œå…¨è§£èª¬<a class="header-link" href="#ãƒãƒ£ãƒƒãƒˆé€ä¿¡ã®æµã‚Œ---å®Œå…¨è§£èª¬" title="Permanent link">&para;</a></h1>
<p><strong>ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®ç›®çš„</strong>ï¼š<br />
ã€Œãƒãƒ£ãƒƒãƒˆã‚’é€ä¿¡ã—ãŸã‚‰ä½•ãŒèµ·ãã‚‹ã‹ã€ã‚’ã€<strong>å®Ÿéš›ã®ã‚³ãƒ¼ãƒ‰</strong>ã¨<strong>ç¹‹ãŒã‚Š</strong>ã‚’è¦‹ãªãŒã‚‰ç†è§£ã™ã‚‹ã€‚</p>
<p><strong>æƒ³å®šèª­è€…</strong>: GASã‚’å°‘ã—è§¦ã£ãŸã“ã¨ãŒã‚ã‚‹æ–°å’ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢</p>
<p><strong>èª­äº†æ™‚é–“</strong>: ç´„45åˆ†</p>
<hr />
<h2 id="ã¾ãšçŸ¥ã£ã¦ãŠãã¹ãã“ã¨">ã¾ãšçŸ¥ã£ã¦ãŠãã¹ãã“ã¨<a class="header-link" href="#ã¾ãšçŸ¥ã£ã¦ãŠãã¹ãã“ã¨" title="Permanent link">&para;</a></h2>
<h3 id="ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ã¨ã¯">ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ã¨ã¯ï¼Ÿ<a class="header-link" href="#ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ã¨ã¯" title="Permanent link">&para;</a></h3>
<div class="flow-box">
<h3>ğŸ“¡ ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ã®ä»•çµ„ã¿</h3>
<p><strong>ã€æ™®é€šã®é€šä¿¡ã€‘</strong></p>
<pre>
è³ªå• â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ ã‚µãƒ¼ãƒãƒ¼
                                        â†“ å…¨éƒ¨ä½œã£ã¦ã‹ã‚‰è¿”ã™
ã€Œã“ã‚“ã«ã¡ã¯ã€ä»Šæ—¥ã¯è‰¯ã„å¤©æ°—ã§ã™ã­ï¼ã€ â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
</pre>
<p><strong>ã€ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°é€šä¿¡ã€‘</strong></p>
<pre>
è³ªå• â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ ã‚µãƒ¼ãƒãƒ¼
ã€Œã“ã‚“ã€     â†â”€â”€â”€â”€ å°‘ã—ãšã¤è¿”ã™
ã€Œã«ã¡ã€     â†â”€â”€â”€â”€
ã€Œã¯ã€ã€     â†â”€â”€â”€â”€
ã€Œä»Šæ—¥ã€     â†â”€â”€â”€â”€
ã€Œã¯...ã€    â†â”€â”€â”€â”€
</pre>
<p>â†’ ChatGPTã®ã‚ˆã†ã«æ–‡å­—ãŒæµã‚Œã‚‹ã‚ˆã†ã«è¡¨ç¤ºã•ã‚Œã‚‹ï¼</p>
</div>

<h3 id="asyncawait-ã¨ã¯gasçµŒé¨“è€…å‘ã‘">async/await ã¨ã¯ï¼Ÿï¼ˆGASçµŒé¨“è€…å‘ã‘ï¼‰<a class="header-link" href="#asyncawait-ã¨ã¯gasçµŒé¨“è€…å‘ã‘" title="Permanent link">&para;</a></h3>
<pre class="codehilite"><code class="language-javascript">// GASã®å ´åˆï¼ˆåŒæœŸå‡¦ç†ï¼‰
function myFunction() {
  const response = UrlFetchApp.fetch('https://...');  // ã“ã“ã§å¾…ã¤
  const data = response.getContentText();  // çµ‚ã‚ã£ã¦ã‹ã‚‰æ¬¡ã¸
}

// TypeScript/Pythonã®å ´åˆï¼ˆéåŒæœŸå‡¦ç†ï¼‰
async function myFunction() {
  const response = await fetch('https://...');  // awaitã§ã€Œå¾…ã¤ã€ã¨æ˜ç¤º
  const data = await response.json();
}
</code></pre>

<p><strong>ãƒã‚¤ãƒ³ãƒˆ</strong>: <code>await</code> ã¯ã€Œã“ã®å‡¦ç†ãŒçµ‚ã‚ã‚‹ã¾ã§å¾…ã£ã¦ã€ã¨ã„ã†æ„å‘³ã€‚<br />
GASã§ã¯è‡ªå‹•ã§å¾…ã£ã¦ã„ãŸãŒã€TypeScript/Pythonã§ã¯ <code>await</code> ã‚’æ›¸ãå¿…è¦ãŒã‚ã‚‹ã€‚</p>
<hr />
<h2 id="å…¨ä½“ãƒ•ãƒ­ãƒ¼å›³">å…¨ä½“ãƒ•ãƒ­ãƒ¼å›³<a class="header-link" href="#å…¨ä½“ãƒ•ãƒ­ãƒ¼å›³" title="Permanent link">&para;</a></h2>
<div class="architecture-box">
<h3>ğŸ”„ ãƒãƒ£ãƒƒãƒˆé€ä¿¡ã®å…¨ä½“ãƒ•ãƒ­ãƒ¼</h3>
<pre>
ã€ãƒ–ãƒ©ã‚¦ã‚¶ã€‘                     ã€ã‚µãƒ¼ãƒãƒ¼ã€‘                    ã€å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ã€‘

1. å…¥åŠ›ãƒœãƒƒã‚¯ã‚¹ã«
   ã€Œã“ã‚“ã«ã¡ã¯ã€ã¨å…¥åŠ›
        â†“
2. é€ä¿¡ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
        â†“
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚  useChat.ts     â”‚  â† ã€Œãƒãƒ£ãƒƒãƒˆã®ãƒ­ã‚¸ãƒƒã‚¯æ‹…å½“ã€
   â”‚  sendMessage()  â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â†“
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚  api.ts         â”‚  â† ã€Œã‚µãƒ¼ãƒãƒ¼ã¨ã®é€šä¿¡æ‹…å½“ã€
   â”‚  sendChatMessage()
   â”‚  + IDãƒˆãƒ¼ã‚¯ãƒ³å–å¾— â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ Firebase Auth
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜               (ãƒˆãƒ¼ã‚¯ãƒ³ç™ºè¡Œ)
            â†“
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Authorization:  â”‚  â† ã€Œç§ã¯ã€‡ã€‡ã§ã™ã€ã¨ã„ã†è¨¼æ˜æ›¸
   â”‚ Bearer xxxx     â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â†“
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            â†“
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚  Gateway        â”‚  â† ã€Œèªè¨¼ãƒ»æŒ¯ã‚Šåˆ†ã‘æ‹…å½“ã€ï¼ˆ1ã¤ã ã‘ï¼‰
   â”‚  main.py        â”‚
   â”‚  ãƒ»ãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ Firebase Admin SDK
   â”‚  ãƒ»customer_idå–å¾—â”‚               (æœ¬äººç¢ºèª)
   â”‚  ãƒ»è»¢é€å…ˆURLå–å¾—  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ Firestore (customers)
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â†“ å†…éƒ¨ãƒ˜ãƒƒãƒ€ãƒ¼ä»˜ä¸
              X-Gateway-Verified: true
              X-User-Id: xxx
              X-Customer-Id: xxx
            â†“
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚  Backend        â”‚  â† ã€Œä¼šç¤¾ã”ã¨ã®ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã€
   â”‚  main.py        â”‚
   â”‚  /chat          â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â†“
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚  agent.py       â”‚  â† ã€ŒAIæ‹…å½“ã€
   â”‚  AIã«è³ªå•       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ Vertex AI (Gemini)
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜               (å¿œç­”ç”Ÿæˆ)
            â†“
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ checkpointer.py â”‚  â† ã€Œè¨˜éŒ²æ‹…å½“ã€
   â”‚  ä¼šè©±å±¥æ­´ä¿å­˜    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ Firestore
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜               (ãƒ‡ãƒ¼ã‚¿ä¿å­˜)
            â†“
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            â†“
3. ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ã§
   ã€Œã“ã‚“ã€ã€Œã«ã¡ã€ã€Œã¯ã€
   ã¨å°‘ã—ãšã¤è¡¨ç¤º
</pre>
</div>

<p><strong>ãã‚Œãã‚Œã®ãƒ•ã‚¡ã‚¤ãƒ«ã®å½¹å‰²</strong>:<br />
| ãƒ•ã‚¡ã‚¤ãƒ« | å½¹å‰² | ä¾‹ãˆã‚‹ã¨ |<br />
|----------|------|----------|<br />
| useChat.ts | ãƒãƒ£ãƒƒãƒˆç”»é¢ã®çŠ¶æ…‹ç®¡ç† | ãƒ¡ãƒ¢å¸³ |<br />
| api.ts | ã‚µãƒ¼ãƒãƒ¼ã¨ã®é€šä¿¡ | é›»è©± |<br />
| Gateway main.py | èªè¨¼ãƒ»æŒ¯ã‚Šåˆ†ã‘ | ãƒ›ãƒ†ãƒ«ã®ãƒ•ãƒ­ãƒ³ãƒˆï¼ˆã©ã®éƒ¨å±‹ã«æ¡ˆå†…ã™ã‚‹ã‹ï¼‰ |<br />
| Backend main.py | ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®å—ä»˜ | å„éƒ¨å±‹ã®ä¿‚å“¡ |<br />
| agent.py | AIå‡¦ç† | ç›¸è«‡å“¡ |<br />
| checkpointer.py | å±¥æ­´ä¿å­˜ | æ›¸è¨˜ |</p>
<hr />
<h2 id="ã‚¹ãƒ†ãƒƒãƒ—1-ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡">ã‚¹ãƒ†ãƒƒãƒ—1: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡<a class="header-link" href="#ã‚¹ãƒ†ãƒƒãƒ—1-ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡" title="Permanent link">&para;</a></h2>
<h3 id="ãªãœã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚‹ã®ã‹">ãªãœã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚‹ã®ã‹ï¼Ÿ<a class="header-link" href="#ãªãœã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚‹ã®ã‹" title="Permanent link">&para;</a></h3>
<p><strong>å•é¡Œ</strong>: ãƒãƒ£ãƒƒãƒˆç”»é¢ã®ãƒœã‚¿ãƒ³ã‚„ãƒ†ã‚­ã‚¹ãƒˆãƒœãƒƒã‚¯ã‚¹ã«ã€é€ä¿¡ãƒ­ã‚¸ãƒƒã‚¯ã‚’ç›´æ¥æ›¸ãã¨...<br />
- ã‚³ãƒ¼ãƒ‰ãŒé•·ããªã‚‹<br />
- ä»–ã®ç”»é¢ã§å†åˆ©ç”¨ã§ããªã„<br />
- ãƒ†ã‚¹ãƒˆã—ã«ãã„</p>
<p><strong>è§£æ±º</strong>: ãƒ­ã‚¸ãƒƒã‚¯ã‚’ã€Œãƒ•ãƒƒã‚¯ï¼ˆHookï¼‰ã€ã¨ã—ã¦åˆ†é›¢ã™ã‚‹</p>
<h3 id="å ´æ‰€-srcfrontendsrchooksusechatts">å ´æ‰€: <code>src/frontend/src/hooks/useChat.ts</code><a class="header-link" href="#å ´æ‰€-srcfrontendsrchooksusechatts" title="Permanent link">&para;</a></h3>
<pre class="codehilite"><code class="language-typescript">// useChat.ts ã® sendMessage é–¢æ•°ï¼ˆç°¡ç•¥ç‰ˆï¼‰

const sendMessage = useCallback(async (content: string) =&gt; {
  // ====================================
  // ã€ã“ã®é–¢æ•°ã®å½¹å‰²ã€‘
  // 1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç”»é¢ã«è¡¨ç¤º
  // 2. ã‚µãƒ¼ãƒãƒ¼ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡
  // 3. AIã®è¿”ç­”ã‚’å°‘ã—ãšã¤å—ã‘å–ã£ã¦è¡¨ç¤º
  // ====================================

  if (!content.trim() || isLoading) return  // ç©ºæ–‡å­—ã‚„é€£æ‰“ã‚’é˜²æ­¢

  setIsLoading(true)  // â† ã€Œé€ä¿¡ä¸­...ã€çŠ¶æ…‹ã«ã™ã‚‹

  // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç”»é¢ã«è¿½åŠ 
  const userMessage = { id: '...', role: 'user', content }
  setMessages(prev =&gt; [...prev, userMessage])

  // AIã®è¿”ç­”ç”¨ã®ã€Œç©ºã®ç®±ã€ã‚’ç”¨æ„
  const assistantMessage = { id: '...', role: 'assistant', content: '' }
  setMessages(prev =&gt; [...prev, assistantMessage])

  try {
    // â˜… ã“ã“ã§ api.ts ã®é–¢æ•°ã‚’å‘¼ã¶
    await sendChatMessage(
      content,         // ã€Œã“ã‚“ã«ã¡ã¯ã€
      threadId,        // ä¼šè©±ã®ID
      (chunk) =&gt; {     // AIã®è¿”ç­”ã‚’å°‘ã—ãšã¤å—ã‘å–ã‚‹
        // ã€Œã“ã‚“ã€ã€Œã«ã¡ã€ã€Œã¯ã€ã¨æ¥ã‚‹ãŸã³ã«ç”»é¢ã‚’æ›´æ–°
        // â†’ æ–‡å­—ãŒæµã‚Œã‚‹ã‚ˆã†ã«è¡¨ç¤ºã•ã‚Œã‚‹
      }
    )
  } catch (err) {
    setError(err.message)  // ã‚¨ãƒ©ãƒ¼ãŒã‚ã‚Œã°è¡¨ç¤º
  } finally {
    setIsLoading(false)  // é€ä¿¡å®Œäº†
  }
}, [threadId, isLoading])
</code></pre>

<h3 id="gasçµŒé¨“è€…å‘ã‘è§£èª¬">GASçµŒé¨“è€…å‘ã‘è§£èª¬<a class="header-link" href="#gasçµŒé¨“è€…å‘ã‘è§£èª¬" title="Permanent link">&para;</a></h3>
<pre class="codehilite"><code class="language-javascript">// GASã§ã®ä¼¼ãŸã‚ˆã†ãªå‡¦ç†
function sendMessage(content) {
  // GASã§ã¯ã“ã†æ›¸ãã¨ã“ã‚ã‚’...
  const response = UrlFetchApp.fetch(url, options);
  return response.getContentText();
}

// TypeScriptã§ã¯ async/await ã‚’ä½¿ã†
async function sendMessage(content: string) {
  const response = await fetch(url, options);
  return await response.json();
}
</code></pre>

<hr />
<h2 id="ã‚¹ãƒ†ãƒƒãƒ—2-apiã‚’å‘¼ã³å‡ºã™ãƒˆãƒ¼ã‚¯ãƒ³ä»˜ã">ã‚¹ãƒ†ãƒƒãƒ—2: APIã‚’å‘¼ã³å‡ºã™ï¼ˆãƒˆãƒ¼ã‚¯ãƒ³ä»˜ãï¼‰<a class="header-link" href="#ã‚¹ãƒ†ãƒƒãƒ—2-apiã‚’å‘¼ã³å‡ºã™ãƒˆãƒ¼ã‚¯ãƒ³ä»˜ã" title="Permanent link">&para;</a></h2>
<h3 id="ãªãœã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚‹ã®ã‹_1">ãªãœã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚‹ã®ã‹ï¼Ÿ<a class="header-link" href="#ãªãœã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚‹ã®ã‹_1" title="Permanent link">&para;</a></h3>
<p><strong>å•é¡Œ</strong>: ã‚µãƒ¼ãƒãƒ¼ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ã‚‹ã¨ãã€æ¯å›ã€Œç§ã¯èª°ã§ã™ã€ã¨ã„ã†è¨¼æ˜ãŒå¿…è¦<br />
<strong>è§£æ±º</strong>: èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ã‚’è‡ªå‹•ã§ä»˜ã‘ã‚‹å‡¦ç†ã‚’ä¸€ç®‡æ‰€ã«ã¾ã¨ã‚ã‚‹</p>
<h3 id="å ´æ‰€-srcfrontendsrcservicesapits">å ´æ‰€: <code>src/frontend/src/services/api.ts</code><a class="header-link" href="#å ´æ‰€-srcfrontendsrcservicesapits" title="Permanent link">&para;</a></h3>
<pre class="codehilite"><code class="language-typescript">// api.tsï¼ˆç°¡ç•¥ç‰ˆï¼‰

// â˜… ãƒãƒ£ãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã™ã‚‹é–¢æ•°
export async function sendChatMessage(
  message: string,                      // é€ã‚ŠãŸã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
  threadId: string | null,              // ä¼šè©±ã®ID
  onChunk: (chunk: string) =&gt; void      // è¿”ç­”ã‚’å°‘ã—ãšã¤å—ã‘å–ã‚‹ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯
): Promise&lt;string&gt; {

  // 1. èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—ã—ã¦ã€ãƒ˜ãƒƒãƒ€ãƒ¼ã«ä»˜ã‘ã‚‹
  const token = await auth.currentUser?.getIdToken()
  const headers = {
    'Authorization': `Bearer ${token}`,  // â† ã“ã‚ŒãŒã€Œç§ã¯ã€‡ã€‡ã§ã™ã€ã®è¨¼æ˜
  }

  // 2. ã‚µãƒ¼ãƒãƒ¼ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡
  const response = await fetch(`${API_URL}/chat`, {
    method: 'POST',
    headers,
    body: JSON.stringify({ message, thread_id: threadId }),
  })

  // 3. ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ã§è¿”ç­”ã‚’å—ã‘å–ã‚‹
  const reader = response.body?.getReader()
  while (true) {
    const { done, value } = await reader.read()
    if (done) break

    // ã€Œdata: ã“ã‚“ã€â†’ã€Œã“ã‚“ã€ã‚’å–ã‚Šå‡ºã—ã¦å‘¼ã³å‡ºã—å…ƒã«è¿”ã™
    const text = new TextDecoder().decode(value)
    // ... ãƒ‘ãƒ¼ã‚¹å‡¦ç† ...
    onChunk(parsedData)  // â† useChat.ts ã«æ¸¡ã•ã‚Œã‚‹
  }
}
</code></pre>

<h3 id="idãƒˆãƒ¼ã‚¯ãƒ³ã¨ã¯">IDãƒˆãƒ¼ã‚¯ãƒ³ã¨ã¯ï¼Ÿ<a class="header-link" href="#idãƒˆãƒ¼ã‚¯ãƒ³ã¨ã¯" title="Permanent link">&para;</a></h3>
<div class="info-box">
<h3>ğŸ« IDãƒˆãƒ¼ã‚¯ãƒ³</h3>
<p>ã€Œã“ã®äººã¯æœ¬ç‰©ã®å±±ç”°å¤ªéƒã•ã‚“ã§ã™ã€ã¨ã„ã†è¨¼æ˜æ›¸</p>
<p><strong>ä¸­èº«:</strong></p>
<pre>
{
  "name": "å±±ç”°å¤ªéƒ",      â† åå‰
  "email": "yamada@...",  â† ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
  "uid": "abc123",        â† ãƒ¦ãƒ¼ã‚¶ãƒ¼ID
  "exp": 1705471200       â† æœ‰åŠ¹æœŸé™ï¼ˆ1æ™‚é–“ï¼‰
}
</pre>
<ul>
<li>GoogleãŒã€Œã“ã®äººã¯æœ¬ç‰©ã§ã™ã€ã¨ç½²åã—ã¦ã„ã‚‹</li>
<li>æ”¹ã–ã‚“ã™ã‚‹ã¨ç½²åãŒå£Šã‚Œã‚‹ã®ã§ã€å½é€ ã§ããªã„</li>
</ul>
</div>

<hr />
<h2 id="ã‚¹ãƒ†ãƒƒãƒ—3-gatewayã§èªè¨¼æŒ¯ã‚Šåˆ†ã‘">ã‚¹ãƒ†ãƒƒãƒ—3: Gatewayã§èªè¨¼ãƒ»æŒ¯ã‚Šåˆ†ã‘<a class="header-link" href="#ã‚¹ãƒ†ãƒƒãƒ—3-gatewayã§èªè¨¼æŒ¯ã‚Šåˆ†ã‘" title="Permanent link">&para;</a></h2>
<h3 id="ãªãœgatewayãŒã‚ã‚‹ã®ã‹">ãªãœGatewayãŒã‚ã‚‹ã®ã‹ï¼Ÿ<a class="header-link" href="#ãªãœgatewayãŒã‚ã‚‹ã®ã‹" title="Permanent link">&para;</a></h3>
<p><strong>å½¹å‰²</strong>: ã™ã¹ã¦ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ã€Œå…¥å£ã€<br />
- èªè¨¼ãƒã‚§ãƒƒã‚¯ï¼ˆãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼ï¼‰<br />
- customer_id ã‹ã‚‰è»¢é€å…ˆURLå–å¾—<br />
- ä¼šç¤¾ã”ã¨ã®ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã«è»¢é€</p>
<h3 id="å ´æ‰€-srcgatewaysrcmainpy">å ´æ‰€: <code>src/gateway/src/main.py</code><a class="header-link" href="#å ´æ‰€-srcgatewaysrcmainpy" title="Permanent link">&para;</a></h3>
<pre class="codehilite"><code class="language-python"># Gateway main.pyï¼ˆç°¡ç•¥ç‰ˆï¼‰

@app.route(&quot;/chat&quot;, methods=[&quot;POST&quot;])
def chat():
    &quot;&quot;&quot;ãƒãƒ£ãƒƒãƒˆAPIã‚’ãƒ—ãƒ­ã‚­ã‚·&quot;&quot;&quot;

    # 1. èªè¨¼ãƒã‚§ãƒƒã‚¯
    uid, customer_id = verify_request()

    # 2. è»¢é€å…ˆURLã‚’å–å¾—ï¼ˆFirestoreã‹ã‚‰ï¼‰
    target_url = get_company_url(customer_id)

    # 3. å†…éƒ¨ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ä»˜ã‘ã¦è»¢é€
    return proxy_request(
        target_url,
        headers={
            &quot;X-Gateway-Verified&quot;: &quot;true&quot;,
            &quot;X-User-Id&quot;: uid,
            &quot;X-Customer-Id&quot;: customer_id,
        }
    )
</code></pre>

<h3 id="gateway-ã®å½¹å‰²ã‚’å›³è§£">Gateway ã®å½¹å‰²ã‚’å›³è§£<a class="header-link" href="#gateway-ã®å½¹å‰²ã‚’å›³è§£" title="Permanent link">&para;</a></h3>
<div class="flow-box">
<h3>ğŸš¦ Gateway ã®å‡¦ç†ãƒ•ãƒ­ãƒ¼</h3>
<pre>
ãƒªã‚¯ã‚¨ã‚¹ãƒˆåˆ°ç€ï¼ˆAuthorization: Bearer xxxï¼‰
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Gateway                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                         â”‚
â”‚  â‘  verify_request()                    â”‚
â”‚     â†’ Firebase Admin SDK ã§ãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼  â”‚
â”‚     â†’ customer_id ã‚’ Custom Claims ã‹ã‚‰å–å¾—â”‚
â”‚                                         â”‚
â”‚  â‘¡ get_company_url(customer_id)        â”‚
â”‚     â†’ Firestore ã‹ã‚‰è»¢é€å…ˆURLå–å¾—        â”‚
â”‚     â†’ customers/{customer_id}/cloud_functions_url â”‚
â”‚                                         â”‚
â”‚  â‘¢ proxy_request()                     â”‚
â”‚     â†’ å†…éƒ¨ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ä»˜ã‘ã¦è»¢é€           â”‚
â”‚                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
 ä¼šç¤¾ã”ã¨ã®ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã¸
</pre>
</div>

<hr />
<h2 id="ã‚¹ãƒ†ãƒƒãƒ—4-ä¼šç¤¾åˆ¥ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å‡¦ç†">ã‚¹ãƒ†ãƒƒãƒ—4: ä¼šç¤¾åˆ¥ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å‡¦ç†<a class="header-link" href="#ã‚¹ãƒ†ãƒƒãƒ—4-ä¼šç¤¾åˆ¥ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å‡¦ç†" title="Permanent link">&para;</a></h2>
<h3 id="ãªãœä¼šç¤¾ã”ã¨ã«ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãŒã‚ã‚‹ã®ã‹">ãªãœä¼šç¤¾ã”ã¨ã«ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãŒã‚ã‚‹ã®ã‹ï¼Ÿ<a class="header-link" href="#ãªãœä¼šç¤¾ã”ã¨ã«ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãŒã‚ã‚‹ã®ã‹" title="Permanent link">&para;</a></h3>
<p><strong>ãƒ¡ãƒªãƒƒãƒˆ</strong>:<br />
- Aç¤¾ã ã‘ã®ç‰¹æ®Šã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºãŒå¯èƒ½<br />
- ä»–ç¤¾ã¸ã®å½±éŸ¿ã‚¼ãƒ­ã§å®‰å…¨ã«æ›´æ–°<br />
- éšœå®³ãŒä»–ç¤¾ã«æ³¢åŠã—ãªã„</p>
<h3 id="å ´æ‰€-srcbackendsrcmainpy">å ´æ‰€: <code>src/backend/src/main.py</code><a class="header-link" href="#å ´æ‰€-srcbackendsrcmainpy" title="Permanent link">&para;</a></h3>
<pre class="codehilite"><code class="language-python"># Backend main.pyï¼ˆç°¡ç•¥ç‰ˆï¼‰

@app.route(&quot;/chat&quot;, methods=[&quot;POST&quot;])
def chat():
    &quot;&quot;&quot;ãƒãƒ£ãƒƒãƒˆAPIï¼ˆã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ï¼‰&quot;&quot;&quot;

    # 1. èªè¨¼ãƒã‚§ãƒƒã‚¯ï¼ˆGatewayçµŒç”±ã‹ã©ã†ã‹ã§åˆ†å²ï¼‰
    user_info = authenticate_request_with_gateway(request)
    customer_id = user_info[&quot;customer_id&quot;]

    # 2. ãƒ¬ãƒ¼ãƒˆåˆ¶é™ãƒã‚§ãƒƒã‚¯
    if not check_rate_limit(user_info[&quot;uid&quot;]):
        return error_response(&quot;ãƒªã‚¯ã‚¨ã‚¹ãƒˆåˆ¶é™ã‚’è¶…ãˆã¾ã—ãŸ&quot;, 429)

    # 3. ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å–å¾—
    data = request.get_json()
    message = data.get(&quot;message&quot;)

    # 4. AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’å‘¼ã³å‡ºã—
    agent = get_agent(&quot;template&quot;, customer_id)

    # 5. ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ã§è¿”ã™
    def generate():
        for chunk in agent.run(message, thread_id):
            yield f&quot;data: {chunk}\n\n&quot;  # SSEå½¢å¼
        yield &quot;data: [DONE]\n\n&quot;

    return Response(generate(), mimetype=&quot;text/event-stream&quot;)
</code></pre>

<h3 id="backend-mainpy-ã®å½¹å‰²ã‚’å›³è§£">Backend main.py ã®å½¹å‰²ã‚’å›³è§£<a class="header-link" href="#backend-mainpy-ã®å½¹å‰²ã‚’å›³è§£" title="Permanent link">&para;</a></h3>
<div class="flow-box">
<h3>ğŸš¦ Backend main.py ã®å‡¦ç†ãƒ•ãƒ­ãƒ¼</h3>
<pre>
ãƒªã‚¯ã‚¨ã‚¹ãƒˆåˆ°ç€ï¼ˆGateway ã‹ã‚‰å†…éƒ¨ãƒ˜ãƒƒãƒ€ãƒ¼ä»˜ãï¼‰
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Backend main.py             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                         â”‚
â”‚  â‘  authenticate_request_with_gateway() â”‚
â”‚     â†’ X-Gateway-Verified ã‚’ç¢ºèª          â”‚
â”‚     â†’ true ãªã‚‰å†…éƒ¨ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ä¿¡é ¼         â”‚
â”‚                                         â”‚
â”‚  â‘¡ check_rate_limit()                  â”‚
â”‚     â†’ ä½¿ã„ã™ãã¦ã„ãªã„ã‹ãƒã‚§ãƒƒã‚¯          â”‚
â”‚                                         â”‚
â”‚  â‘¢ get_agent()                         â”‚
â”‚     â†’ é©åˆ‡ãªAIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’å–å¾—          â”‚
â”‚                                         â”‚
â”‚  â‘£ agent.run()                         â”‚
â”‚     â†’ AIã«è³ªå•ã—ã¦è¿”ç­”ã‚’ç”Ÿæˆ             â”‚
â”‚                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
 ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ã§è¿”ã™
</pre>
</div>

<hr />
<h2 id="ã‚¹ãƒ†ãƒƒãƒ—5-èªè¨¼å‡¦ç†gatewayçµŒç”±å¯¾å¿œ">ã‚¹ãƒ†ãƒƒãƒ—5: èªè¨¼å‡¦ç†ï¼ˆGatewayçµŒç”±å¯¾å¿œï¼‰<a class="header-link" href="#ã‚¹ãƒ†ãƒƒãƒ—5-èªè¨¼å‡¦ç†gatewayçµŒç”±å¯¾å¿œ" title="Permanent link">&para;</a></h2>
<h3 id="ãªãœã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚‹ã®ã‹_2">ãªãœã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚‹ã®ã‹ï¼Ÿ<a class="header-link" href="#ãªãœã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚‹ã®ã‹_2" title="Permanent link">&para;</a></h3>
<p><strong>å•é¡Œ</strong>: ã€Œèªè¨¼ã€å‡¦ç†ã¯ã„ã‚ã‚“ãªå ´æ‰€ã§ä½¿ã„ãŸã„<br />
- <code>/chat</code> ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ<br />
- <code>/agents</code> ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ<br />
- å°†æ¥ã®æ–°ã—ã„ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ</p>
<p><strong>è§£æ±º</strong>: èªè¨¼å‡¦ç†ã‚’åˆ¥ãƒ•ã‚¡ã‚¤ãƒ«ã«ã¾ã¨ã‚ã‚‹ + GatewayçµŒç”±ã«å¯¾å¿œ</p>
<h3 id="å ´æ‰€-srcbackendsrccommonauthpy">å ´æ‰€: <code>src/backend/src/common/auth.py</code><a class="header-link" href="#å ´æ‰€-srcbackendsrccommonauthpy" title="Permanent link">&para;</a></h3>
<pre class="codehilite"><code class="language-python"># auth.pyï¼ˆç°¡ç•¥ç‰ˆï¼‰

def authenticate_request_with_gateway(request) -&gt; dict:
    &quot;&quot;&quot;
    Gateway çµŒç”±ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’èªè¨¼

    ã€å‡¦ç†ã®æµã‚Œã€‘
    1. X-Gateway-Verified ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ç¢ºèª
    2. GatewayçµŒç”±ãªã‚‰å†…éƒ¨ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ä¿¡é ¼
    3. GatewayçµŒç”±ã§ãªã‘ã‚Œã°å¾“æ¥ã®èªè¨¼
    &quot;&quot;&quot;
    gateway_verified = request.headers.get(&quot;X-Gateway-Verified&quot;)

    if gateway_verified == &quot;true&quot;:
        # Gateway ãŒèªè¨¼æ¸ˆã¿ãªã®ã§ã€å†…éƒ¨ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ä¿¡é ¼
        user_id = request.headers.get(&quot;X-User-Id&quot;)
        customer_id = request.headers.get(&quot;X-Customer-Id&quot;)
        return {
            &quot;uid&quot;: user_id,
            &quot;customer_id&quot;: customer_id,
        }

    # Gateway çµŒç”±ã§ãªã„å ´åˆã¯å¾“æ¥ã®èªè¨¼
    return authenticate_request(request)


def authenticate_request(request) -&gt; dict:
    &quot;&quot;&quot;
    ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’èªè¨¼ã—ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’è¿”ã™ï¼ˆå¾“æ¥ã®æ–¹å¼ï¼‰

    ã€å‡¦ç†ã®æµã‚Œã€‘
    1. ãƒ˜ãƒƒãƒ€ãƒ¼ã‹ã‚‰ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–ã‚Šå‡ºã™ï¼ˆå½¢å¼ã‚’å³å¯†ã«æ¤œè¨¼ï¼‰
    2. ãƒˆãƒ¼ã‚¯ãƒ³ãŒæœ¬ç‰©ã‹æ¤œè¨¼ï¼ˆå¤±åŠ¹ãƒã‚§ãƒƒã‚¯å«ã‚€ï¼‰
    3. ã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯è¨±å¯ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
    4. ã©ã®ä¼šç¤¾ï¼ˆé¡§å®¢ï¼‰ã«æ‰€å±ã—ã¦ã„ã‚‹ã‹å–å¾—
    &quot;&quot;&quot;
    # 1. ãƒ˜ãƒƒãƒ€ãƒ¼ã‹ã‚‰ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–ã‚Šå‡ºã™ï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–ç‰ˆï¼‰
    auth_header = request.headers.get(&quot;Authorization&quot;, &quot;&quot;)
    if not auth_header:
        raise ValueError(&quot;èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ãŒã‚ã‚Šã¾ã›ã‚“&quot;)

    parts = auth_header.split(&quot; &quot;)
    if len(parts) != 2 or parts[0] != &quot;Bearer&quot;:
        raise ValueError(&quot;èªè¨¼ãƒ˜ãƒƒãƒ€ãƒ¼ã®å½¢å¼ãŒä¸æ­£ã§ã™&quot;)

    id_token = parts[1]

    # 2. Firebase Admin SDK ã§ãƒˆãƒ¼ã‚¯ãƒ³ã‚’æ¤œè¨¼
    # check_revoked=True: ãƒ­ã‚°ã‚¢ã‚¦ãƒˆæ¸ˆã¿/ç„¡åŠ¹åŒ–ã•ã‚ŒãŸãƒˆãƒ¼ã‚¯ãƒ³ã‚’æ‹’å¦
    user_info = auth.verify_id_token(id_token, check_revoked=True)

    # 3. ã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯è¨±å¯ã•ã‚Œã¦ã„ã‚‹ã‹
    if not is_user_allowed(user_info[&quot;email&quot;]):
        raise ValueError(&quot;ã‚¢ã‚¯ã‚»ã‚¹ãŒè¨±å¯ã•ã‚Œã¦ã„ã¾ã›ã‚“&quot;)

    # 4. é¡§å®¢IDã‚’å–å¾—ï¼ˆãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆç”¨ï¼‰
    user_info[&quot;customer_id&quot;] = get_user_customer_id(user_info[&quot;uid&quot;])

    return user_info
</code></pre>

<h3 id="èªè¨¼ã®æµã‚Œå›³">èªè¨¼ã®æµã‚Œå›³<a class="header-link" href="#èªè¨¼ã®æµã‚Œå›³" title="Permanent link">&para;</a></h3>
<div class="flow-box">
<h3>ğŸ” èªè¨¼ãƒ•ãƒ­ãƒ¼ï¼ˆGatewayå¯¾å¿œç‰ˆï¼‰</h3>
<pre>
ãƒªã‚¯ã‚¨ã‚¹ãƒˆåˆ°ç€
        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ X-Gateway-Verified == "true"? â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”
    â†“               â†“
  true            false
    â†“               â†“
å†…éƒ¨ãƒ˜ãƒƒãƒ€ãƒ¼      å¾“æ¥ã®èªè¨¼
ã‚’ä¿¡é ¼           (ãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼)
    â†“               â†“
    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
            â†“
      æ¬¡ã®å‡¦ç†ã¸
</pre>
</div>

<hr />
<h2 id="ã‚¹ãƒ†ãƒƒãƒ—6-aiã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒå¿œç­”ã‚’ç”Ÿæˆ">ã‚¹ãƒ†ãƒƒãƒ—6: AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒå¿œç­”ã‚’ç”Ÿæˆ<a class="header-link" href="#ã‚¹ãƒ†ãƒƒãƒ—6-aiã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒå¿œç­”ã‚’ç”Ÿæˆ" title="Permanent link">&para;</a></h2>
<h3 id="ãªãœã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚‹ã®ã‹_3">ãªãœã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚‹ã®ã‹ï¼Ÿ<a class="header-link" href="#ãªãœã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚‹ã®ã‹_3" title="Permanent link">&para;</a></h3>
<p><strong>å•é¡Œ</strong>: å°†æ¥ã€é•ã†ç¨®é¡ã®AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’è¿½åŠ ã—ãŸã„<br />
- ã‚«ã‚¹ã‚¿ãƒãƒ¼ã‚µãƒãƒ¼ãƒˆç”¨<br />
- ç¤¾å†…FAQç”¨<br />
- ç¿»è¨³ç”¨</p>
<p><strong>è§£æ±º</strong>: ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’ã€Œå·®ã—æ›¿ãˆå¯èƒ½ã€ãªå½¢ã§ä½œã‚‹</p>
<h3 id="å ´æ‰€-srcbackendsrcagents_templateagentpy">å ´æ‰€: <code>src/backend/src/agents/_template/agent.py</code><a class="header-link" href="#å ´æ‰€-srcbackendsrcagents_templateagentpy" title="Permanent link">&para;</a></h3>
<pre class="codehilite"><code class="language-python"># agent.pyï¼ˆç°¡ç•¥ç‰ˆï¼‰

class TemplateAgent(BaseAgent):
    &quot;&quot;&quot;ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆQ&amp;Aã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ&quot;&quot;&quot;

    # â˜… AIã®ã€Œæ€§æ ¼ã€ã‚’å®šç¾©
    SYSTEM_PROMPT = &quot;&quot;&quot;ã‚ãªãŸã¯è¦ªåˆ‡ã§ä¸å¯§ãªAIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚
ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è³ªå•ã«å¯¾ã—ã¦ã€ã‚ã‹ã‚Šã‚„ã™ãç°¡æ½”ã«å›ç­”ã—ã¦ãã ã•ã„ã€‚&quot;&quot;&quot;

    # â˜… ä½¿ç”¨ã™ã‚‹ãƒ¢ãƒ‡ãƒ«ï¼ˆGemini 1.5 Flashï¼‰
    MODEL_NAME = &quot;gemini-1.5-flash&quot;

    async def _chat_node(self, state):
        &quot;&quot;&quot;
        ãƒãƒ£ãƒƒãƒˆå‡¦ç†ã®æœ¬ä½“

        ã€æµã‚Œã€‘
        1. ã“ã‚Œã¾ã§ã®ä¼šè©±å±¥æ­´ã‚’å–å¾—
        2. ã€Œã‚ãªãŸã¯è¦ªåˆ‡ãª...ã€ã¨ã„ã†ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’å…ˆé ­ã«è¿½åŠ 
        3. Vertex AI (Gemini) ã«é€ä¿¡
        4. å¿œç­”ã‚’è¿”ã™
        &quot;&quot;&quot;
        messages = state[&quot;messages&quot;]

        # ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’è¿½åŠ 
        full_messages = [
            {&quot;role&quot;: &quot;system&quot;, &quot;content&quot;: self.SYSTEM_PROMPT},
            *messages
        ]

        # Vertex AI ã«å•ã„åˆã‚ã›
        response = await self.llm.ainvoke(full_messages)

        return {&quot;messages&quot;: [response]}
</code></pre>

<h3 id="ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ä»•çµ„ã¿">ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ä»•çµ„ã¿<a class="header-link" href="#ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ä»•çµ„ã¿" title="Permanent link">&para;</a></h3>
<div class="info-box">
<h3>ğŸ¤– TemplateAgent ã®å‡¦ç†</h3>
<p><strong>SYSTEM_PROMPT = "ã‚ãªãŸã¯è¦ªåˆ‡ãª..."</strong> â† AIã®æ€§æ ¼ã‚’æ±ºã‚ã‚‹</p>
<p><strong>_chat_node() ã®å‡¦ç†:</strong></p>
<pre>
[ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ]
[ãƒ¦ãƒ¼ã‚¶ãƒ¼: ã“ã‚“ã«ã¡ã¯]     â† ã“ã‚Œã¾ã§ã®ä¼šè©±
[AI: ã“ã‚“ã«ã¡ã¯ï¼]
[ãƒ¦ãƒ¼ã‚¶ãƒ¼: ä»Šæ—¥ã®å¤©æ°—ã¯ï¼Ÿ]  â† ä»Šå›ã®è³ªå•
        â†“
    Gemini ã«é€ä¿¡
        â†“
[AI: ä»Šæ—¥ã¯æ™´ã‚Œã§ã™ã­]     â† Geminiã‹ã‚‰ã®è¿”ç­”
</pre>
</div>

<hr />
<h2 id="ã‚¹ãƒ†ãƒƒãƒ—7-ä¼šè©±å±¥æ­´ã‚’firestoreã«ä¿å­˜">ã‚¹ãƒ†ãƒƒãƒ—7: ä¼šè©±å±¥æ­´ã‚’Firestoreã«ä¿å­˜<a class="header-link" href="#ã‚¹ãƒ†ãƒƒãƒ—7-ä¼šè©±å±¥æ­´ã‚’firestoreã«ä¿å­˜" title="Permanent link">&para;</a></h2>
<h3 id="ãªãœã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚‹ã®ã‹_4">ãªãœã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚‹ã®ã‹ï¼Ÿ<a class="header-link" href="#ãªãœã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚‹ã®ã‹_4" title="Permanent link">&para;</a></h3>
<p><strong>å•é¡Œ</strong>:<br />
- ã‚µãƒ¼ãƒãƒ¼ã‚’å†èµ·å‹•ã™ã‚‹ã¨ã€ä¼šè©±å±¥æ­´ãŒæ¶ˆãˆã‚‹<br />
- é•ã†ä¼šç¤¾ã®ä¼šè©±ãŒæ··ã–ã‚‹ã¨æƒ…å ±æ¼æ´©</p>
<p><strong>è§£æ±º</strong>:<br />
- Firestoreã«ä¿å­˜ã—ã¦æ°¸ç¶šåŒ–<br />
- ä¼šç¤¾ï¼ˆé¡§å®¢ï¼‰ã”ã¨ã«ãƒ‡ãƒ¼ã‚¿ã‚’åˆ†é›¢</p>
<h3 id="å ´æ‰€-srcbackendsrcagents_basefirestore_checkpointerpy">å ´æ‰€: <code>src/backend/src/agents/_base/firestore_checkpointer.py</code><a class="header-link" href="#å ´æ‰€-srcbackendsrcagents_basefirestore_checkpointerpy" title="Permanent link">&para;</a></h3>
<pre class="codehilite"><code class="language-python"># firestore_checkpointer.pyï¼ˆç°¡ç•¥ç‰ˆï¼‰

class FirestoreCheckpointer(BaseCheckpointSaver):
    &quot;&quot;&quot;ä¼šè©±å±¥æ­´ã‚’Firestoreã«ä¿å­˜&quot;&quot;&quot;

    def __init__(self, db, customer_id: str):
        self.db = db
        self.customer_id = customer_id  # â˜… ã©ã®ä¼šç¤¾ã®ãƒ‡ãƒ¼ã‚¿ã‹

    def _get_checkpoint_ref(self, thread_id: str):
        &quot;&quot;&quot;
        ä¿å­˜å…ˆã®ãƒ‘ã‚¹ã‚’ç”Ÿæˆ

        ä¾‹: customers/acme-corp/checkpoints/user123_abc/...
        &quot;&quot;&quot;
        return (
            self.db.collection(&quot;customers&quot;)
            .document(self.customer_id)      # â† ä¼šç¤¾ã”ã¨ã«åˆ†é›¢
            .collection(&quot;checkpoints&quot;)
            .document(thread_id)
        )
</code></pre>

<h3 id="firestoreã®ãƒ‡ãƒ¼ã‚¿æ§‹é€ ">Firestoreã®ãƒ‡ãƒ¼ã‚¿æ§‹é€ <a class="header-link" href="#firestoreã®ãƒ‡ãƒ¼ã‚¿æ§‹é€ " title="Permanent link">&para;</a></h3>
<div class="architecture-box">
<h3>ğŸ—„ï¸ Firestore ãƒ‡ãƒ¼ã‚¿æ§‹é€ </h3>
<pre>
Firestoreï¼ˆãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ï¼‰
â”‚
â””â”€â”€ customers/                        â† ã€Œé¡§å®¢ã€ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³
    â”‚
    â”œâ”€â”€ acme-corp/                    â† ä¼šç¤¾A ã®ãƒ‡ãƒ¼ã‚¿
    â”‚   â””â”€â”€ checkpoints/
    â”‚       â”œâ”€â”€ user1_abc123/         â† ãƒ¦ãƒ¼ã‚¶ãƒ¼1ã®ä¼šè©±
    â”‚       â””â”€â”€ user2_def456/         â† ãƒ¦ãƒ¼ã‚¶ãƒ¼2ã®ä¼šè©±
    â”‚
    â””â”€â”€ beta-inc/                     â† ä¼šç¤¾B ã®ãƒ‡ãƒ¼ã‚¿
        â””â”€â”€ checkpoints/
            â””â”€â”€ ...                   â† ä¼šç¤¾Bã®ä¼šè©±ï¼ˆä¼šç¤¾Aã‹ã‚‰ã¯è¦‹ãˆãªã„ï¼‰
</pre>
<p><strong>ã€ãƒã‚¤ãƒ³ãƒˆã€‘</strong><br>
ä¼šç¤¾Aã®äººã¯ä¼šç¤¾Bã®ãƒ‡ãƒ¼ã‚¿ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ããªã„ â†’ æƒ…å ±æ¼æ´©ã‚’é˜²æ­¢</p>
</div>

<hr />
<h2 id="ã¾ã¨ã‚ãƒ•ã‚¡ã‚¤ãƒ«ã®ç¹‹ãŒã‚Š">ã¾ã¨ã‚ï¼šãƒ•ã‚¡ã‚¤ãƒ«ã®ç¹‹ãŒã‚Š<a class="header-link" href="#ã¾ã¨ã‚ãƒ•ã‚¡ã‚¤ãƒ«ã®ç¹‹ãŒã‚Š" title="Permanent link">&para;</a></h2>
<div class="architecture-box">
<h3>ğŸ“ ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ»Gatewayãƒ»ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®é€£æº</h3>
<pre>
ã€ãƒ–ãƒ©ã‚¦ã‚¶å´ï¼ˆãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ï¼‰ã€‘

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ useChat.ts   â”‚ â”€â”€â”€â”€â”€â†’ â”‚   api.ts     â”‚
â”‚              â”‚        â”‚              â”‚
â”‚ ãƒ»ç”»é¢ã®çŠ¶æ…‹ç®¡ç†â”‚        â”‚ ãƒ»ã‚µãƒ¼ãƒãƒ¼é€šä¿¡  â”‚
â”‚ ãƒ»ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä¸€è¦§â”‚        â”‚ ãƒ»èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ä»˜ä¸â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â†“ HTTP ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                              â”‚
                              â†“

ã€Gatewayï¼ˆ1ã¤ã ã‘ï¼‰ã€‘

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           Gateway main.py                 â”‚
â”‚                                          â”‚
â”‚  ãƒ»Firebase ãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼                   â”‚
â”‚  ãƒ»customer_id ã‹ã‚‰è»¢é€å…ˆURLå–å¾—           â”‚
â”‚  ãƒ»å†…éƒ¨ãƒ˜ãƒƒãƒ€ãƒ¼ä»˜ä¸ã—ã¦è»¢é€                 â”‚
â”‚    (X-Gateway-Verified, X-User-Id, etc.)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â†“ è»¢é€

ã€ã‚µãƒ¼ãƒãƒ¼å´ï¼ˆä¼šç¤¾ã”ã¨ã®ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ï¼‰ã€‘

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Backend      â”‚ â”€â”€â”€â”€â”€â†’ â”‚   auth.py    â”‚
â”‚ main.py      â”‚        â”‚              â”‚
â”‚              â”‚        â”‚ ãƒ»Gatewayé€£æº  â”‚
â”‚ ãƒ»ãƒªã‚¯ã‚¨ã‚¹ãƒˆå—ä»˜â”‚        â”‚ ãƒ»å†…éƒ¨ãƒ˜ãƒƒãƒ€ãƒ¼ä¿¡é ¼â”‚
â”‚ ãƒ»ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå‘¼å‡ºâ”‚       â”‚              â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚               â”‚  agent.py    â”‚
       â”‚               â”‚              â”‚
       â”‚               â”‚ ãƒ»AIå‡¦ç†      â”‚
       â”‚               â”‚ ãƒ»å¿œç­”ç”Ÿæˆ    â”‚
       â”‚               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                       â”‚checkpointer.pyâ”‚
                       â”‚              â”‚
                       â”‚ ãƒ»å±¥æ­´ä¿å­˜    â”‚
                       â”‚ ãƒ»é¡§å®¢åˆ†é›¢    â”‚
                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</pre>
</div>

<hr />
<h2 id="ã‚ˆãã‚ã‚‹ã‚¨ãƒ©ãƒ¼ã¨å¯¾å‡¦æ³•">ã‚ˆãã‚ã‚‹ã‚¨ãƒ©ãƒ¼ã¨å¯¾å‡¦æ³•<a class="header-link" href="#ã‚ˆãã‚ã‚‹ã‚¨ãƒ©ãƒ¼ã¨å¯¾å‡¦æ³•" title="Permanent link">&para;</a></h2>
<table>
<thead>
<tr>
<th>ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</th>
<th>åŸå› </th>
<th>å¯¾å‡¦æ³•</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™</code></td>
<td>æœªãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã§APIå‘¼ã³å‡ºã—</td>
<td>ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹</td>
</tr>
<tr>
<td><code>èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ãŒã‚ã‚Šã¾ã›ã‚“</code></td>
<td>Authorization ãƒ˜ãƒƒãƒ€ãƒ¼ãŒãªã„</td>
<td>ãƒ­ã‚°ã‚¤ãƒ³ã—ç›´ã™</td>
</tr>
<tr>
<td><code>èªè¨¼ãƒ˜ãƒƒãƒ€ãƒ¼ã®å½¢å¼ãŒä¸æ­£ã§ã™</code></td>
<td>Bearerå½¢å¼ã§ãªã„</td>
<td>ãƒ­ã‚°ã‚¤ãƒ³ã—ç›´ã™</td>
</tr>
<tr>
<td><code>ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒç„¡åŠ¹ã§ã™</code></td>
<td>ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå¾Œã®ãƒˆãƒ¼ã‚¯ãƒ³ä½¿ç”¨</td>
<td>å†ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹</td>
</tr>
<tr>
<td><code>ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®æœ‰åŠ¹æœŸé™ãŒåˆ‡ã‚Œã¾ã—ãŸ</code></td>
<td>ãƒˆãƒ¼ã‚¯ãƒ³ã®æœ‰åŠ¹æœŸé™åˆ‡ã‚Œï¼ˆ1æ™‚é–“ï¼‰</td>
<td>ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰</td>
</tr>
<tr>
<td><code>èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ãŒç„¡åŠ¹ã§ã™</code></td>
<td>æ”¹ã–ã‚“ã•ã‚ŒãŸãƒˆãƒ¼ã‚¯ãƒ³</td>
<td>å†ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹</td>
</tr>
<tr>
<td><code>é¡§å®¢ã«ç´ä»˜ã‘ã•ã‚Œã¦ã„ã¾ã›ã‚“</code></td>
<td>ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒä¼šç¤¾ã«ç™»éŒ²ã•ã‚Œã¦ã„ãªã„</td>
<td>ç®¡ç†è€…ã«é€£çµ¡</td>
</tr>
<tr>
<td><code>ãƒªã‚¯ã‚¨ã‚¹ãƒˆåˆ¶é™ã‚’è¶…ãˆã¾ã—ãŸ</code></td>
<td>çŸ­æ™‚é–“ã«é€ã‚Šã™ã</td>
<td>1åˆ†å¾…ã¤</td>
</tr>
<tr>
<td><code>ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒé•·ã™ãã¾ã™</code></td>
<td>10,000æ–‡å­—ã‚’è¶…ãˆãŸ</td>
<td>ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’çŸ­ãã™ã‚‹</td>
</tr>
<tr>
<td><code>thread_idã®å½¢å¼ãŒä¸æ­£ã§ã™</code></td>
<td>ä¸æ­£ãªthread_id</td>
<td>thread_idã‚’æŒ‡å®šã—ãªã„</td>
</tr>
<tr>
<td><code>CORSã‚¨ãƒ©ãƒ¼</code></td>
<td>ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®URLãŒè¨±å¯ã•ã‚Œã¦ã„ãªã„</td>
<td>ALLOWED_ORIGINS ç¢ºèª</td>
</tr>
<tr>
<td><code>ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</code></td>
<td>ã‚µãƒ¼ãƒãƒ¼å†…éƒ¨ã‚¨ãƒ©ãƒ¼</td>
<td>ã—ã°ã‚‰ãå¾…ã£ã¦å†è©¦è¡Œ</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="ç¢ºèªå•é¡Œ">ç¢ºèªå•é¡Œ<a class="header-link" href="#ç¢ºèªå•é¡Œ" title="Permanent link">&para;</a></h2>
<h3 id="ç†è§£åº¦ãƒã‚§ãƒƒã‚¯">ç†è§£åº¦ãƒã‚§ãƒƒã‚¯<a class="header-link" href="#ç†è§£åº¦ãƒã‚§ãƒƒã‚¯" title="Permanent link">&para;</a></h3>
<ol>
<li><strong>é€ä¿¡ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ã‹ã‚‰ã€ç”»é¢ã«æ–‡å­—ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã¾ã§ã«ã€ä½•å€‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é€šéã™ã‚‹ï¼Ÿ</strong></li>
</ol>
<details>
   <summary>ç­”ãˆ</summary>
   7å€‹ï¼ˆuseChat.ts â†’ api.ts â†’ Gateway main.py â†’ Backend main.py â†’ auth.py â†’ agent.py â†’ checkpointer.pyï¼‰
   </details>

<ol start="2">
<li><strong>ã€ŒBearerã€ã¨ã¯ä½•ï¼Ÿ</strong></li>
</ol>
<details>
   <summary>ç­”ãˆ</summary>
   ã€Œãƒˆãƒ¼ã‚¯ãƒ³ã‚’æŒã£ã¦ã„ã‚‹äººã€ã¨ã„ã†æ„å‘³ã€‚Authorization ãƒ˜ãƒƒãƒ€ãƒ¼ã§ãƒˆãƒ¼ã‚¯ãƒ³ã‚’é€ã‚‹æ¨™æº–çš„ãªå½¢å¼ã€‚
   </details>

<ol start="3">
<li><strong>Gatewayã®å½¹å‰²ã¯ï¼Ÿ</strong></li>
</ol>
<details>
   <summary>ç­”ãˆ</summary>
   èªè¨¼ï¼ˆãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼ï¼‰ã¨æŒ¯ã‚Šåˆ†ã‘ï¼ˆcustomer_idã‹ã‚‰è»¢é€å…ˆURLå–å¾—ï¼‰ã€‚AIå‡¦ç†ã¯è¡Œã‚ãªã„ã€‚
   </details>

<ol start="4">
<li><strong>ä¼šç¤¾Aã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒä¼šç¤¾Bã®ãƒ‡ãƒ¼ã‚¿ã‚’è¦‹ã‚Œãªã„ã®ã¯ã€ã©ã®ã‚ˆã†ãªä»•çµ„ã¿ã®ãŠã‹ã’ï¼Ÿ</strong></li>
</ol>
<details>
   <summary>ç­”ãˆ</summary>
   è¤‡æ•°ã®ä»•çµ„ã¿ã§ä¿è­·ï¼š
   - GatewayãŒæ­£ã—ã„ä¼šç¤¾ã®ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã«ã®ã¿è»¢é€
   - checkpointer.pyãŒcustomer_idã§ä¿å­˜å…ˆã‚’åˆ†é›¢
   - Firestoreã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«ã§è‡ªç¤¾ãƒ‡ãƒ¼ã‚¿ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½
   </details>

<h3 id="å®Ÿè·µãƒãƒ£ãƒ¬ãƒ³ã‚¸">å®Ÿè·µãƒãƒ£ãƒ¬ãƒ³ã‚¸<a class="header-link" href="#å®Ÿè·µãƒãƒ£ãƒ¬ãƒ³ã‚¸" title="Permanent link">&para;</a></h3>
<p>ãƒ–ãƒ©ã‚¦ã‚¶ã®é–‹ç™ºè€…ãƒ„ãƒ¼ãƒ«ï¼ˆF12ï¼‰ã‚’é–‹ã„ã¦ã€å®Ÿéš›ã«ãƒãƒ£ãƒƒãƒˆã‚’é€ä¿¡ã—ã€<br />
Network ã‚¿ãƒ–ã§ä»¥ä¸‹ã‚’ç¢ºèªã—ã¦ã¿ã‚ˆã†ï¼š</p>
<ol>
<li><code>/chat</code> ã¸ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã« <code>Authorization: Bearer ...</code> ãŒä»˜ã„ã¦ã„ã‚‹ã‹</li>
<li>ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒ <code>data: ã“ã‚“</code> ã®ã‚ˆã†ãªå½¢å¼ã§è¿”ã£ã¦ãã¦ã„ã‚‹ã‹</li>
</ol>
<hr />
<h2 id="æ¬¡ã«èª­ã‚€ã¹ããƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ">æ¬¡ã«èª­ã‚€ã¹ããƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ<a class="header-link" href="#æ¬¡ã«èª­ã‚€ã¹ããƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ" title="Permanent link">&para;</a></h2>
<ul>
<li><code>12_ãƒ­ã‚°ã‚¤ãƒ³ã®æµã‚Œ.md</code> - ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†ã®è©³ç´°</li>
<li><code>05_ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã®æµã‚Œ.md</code> - ç’°å¢ƒæ§‹ç¯‰ã®æ‰‹é †</li>
</ul>
      </article>
      <footer class="footer">
        GCP AI Agent è¨­è¨ˆè³‡æ–™ | Built with Python & Markdown
      </footer>
    </main>
  </div>

  <script>
    function toggleSidebar() {
      document.getElementById('sidebar').classList.toggle('open');
    }

    // Close sidebar when clicking outside on mobile
    document.addEventListener('click', function(e) {
      const sidebar = document.getElementById('sidebar');
      const toggle = document.querySelector('.menu-toggle');
      if (!sidebar.contains(e.target) && !toggle.contains(e.target)) {
        sidebar.classList.remove('open');
      }
    });
  </script>
</body>
</html>