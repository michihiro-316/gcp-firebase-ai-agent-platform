<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>14 ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã¨ãƒ•ã‚¡ã‚¤ãƒ«é€£æº - GCP AI Agent è¨­è¨ˆè³‡æ–™</title>
  <link rel="stylesheet" href="assets/style.css">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ“š</text></svg>">
</head>
<body>
  <header class="header">
    <a href="index.html" class="header-logo">
      <span>ğŸ“š</span>
      <span>GCP AI Agent è¨­è¨ˆè³‡æ–™</span>
    </a>
    <nav class="header-nav">
      <a href="index.html">ãƒ›ãƒ¼ãƒ </a>
      <a href="02_å…¨ä½“åƒ.html">å…¨ä½“åƒ</a>
      <a href="https://github.com" target="_blank">GitHub</a>
    </nav>
    <button class="menu-toggle" onclick="toggleSidebar()">
      <span></span>
      <span></span>
      <span></span>
    </button>
  </header>

  <div class="layout">
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-section">
        <div class="sidebar-title">ğŸ“– ã¯ã˜ã‚ã«</div>
        <ul class="sidebar-nav">
          <li><a href="01_ã¯ã˜ã‚ã«èª­ã‚“ã§ãã ã•ã„.html" >ã¯ã˜ã‚ã«èª­ã‚“ã§ãã ã•ã„</a></li>
        </ul>
      </div>

      <div class="sidebar-section">
        <div class="sidebar-title">ğŸ—ï¸ ä»•çµ„ã¿ã‚’ç†è§£</div>
        <ul class="sidebar-nav">
          <li><a href="02_å…¨ä½“åƒ.html" >å…¨ä½“åƒ</a></li>
          <li><a href="03_ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰è§£èª¬.html" >ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰è§£èª¬</a></li>
          <li><a href="04_ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰è§£èª¬.html" >ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰è§£èª¬</a></li>
        </ul>
      </div>

      <div class="sidebar-section">
        <div class="sidebar-title">ğŸ› ï¸ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—</div>
        <ul class="sidebar-nav">
          <li><a href="05_ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã®æµã‚Œ.html" >ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã®æµã‚Œ</a></li>
          <li><a href="06_ã‚³ãƒãƒ³ãƒ‰è§£èª¬.html" >ã‚³ãƒãƒ³ãƒ‰è§£èª¬</a></li>
        </ul>
      </div>

      <div class="sidebar-section">
        <div class="sidebar-title">ğŸš€ å‹•ã‹ã™</div>
        <ul class="sidebar-nav">
          <li><a href="07_å‹•ã‹ã—ã¦ã¿ã‚ˆã†.html" >å‹•ã‹ã—ã¦ã¿ã‚ˆã†</a></li>
          <li><a href="08_AIã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º.html" >AIã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º</a></li>
        </ul>
      </div>

      <div class="sidebar-section">
        <div class="sidebar-title">ğŸ”§ ä¸Šç´šç·¨</div>
        <ul class="sidebar-nav">
          <li><a href="10_Gatewayã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£.html" >Gatewayã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£</a></li>
          <li><a href="14_ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã¨ãƒ•ã‚¡ã‚¤ãƒ«é€£æº.html" class="active">ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã¨ãƒ•ã‚¡ã‚¤ãƒ«é€£æº</a></li>
        </ul>
      </div>

      <div class="sidebar-section">
        <div class="sidebar-title">ğŸ”„ å‚è€ƒ: ãƒ•ãƒ­ãƒ¼è§£èª¬</div>
        <ul class="sidebar-nav">
          <li><a href="11_ãƒãƒ£ãƒƒãƒˆé€ä¿¡ã®æµã‚Œ.html" >ãƒãƒ£ãƒƒãƒˆé€ä¿¡ã®æµã‚Œ</a></li>
          <li><a href="12_ãƒ­ã‚°ã‚¤ãƒ³ã®æµã‚Œ.html" >ãƒ­ã‚°ã‚¤ãƒ³ã®æµã‚Œ</a></li>
          <li><a href="13_ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ã®æµã‚Œ.html" >ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ã®æµã‚Œ</a></li>
        </ul>
      </div>
    </aside>

    <main class="main">
      <article class="content">
        <h1 id="ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã¨ãƒ•ã‚¡ã‚¤ãƒ«é€£æº---å®Œå…¨è§£èª¬">ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã¨ãƒ•ã‚¡ã‚¤ãƒ«é€£æº - å®Œå…¨è§£èª¬<a class="header-link" href="#ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã¨ãƒ•ã‚¡ã‚¤ãƒ«é€£æº---å®Œå…¨è§£èª¬" title="Permanent link">&para;</a></h1>
<div class="goal-box">
<div class="box-title">ã“ã®ãƒšãƒ¼ã‚¸ã®ã‚´ãƒ¼ãƒ«</div>
<div class="box-content">

ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã¨ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®é€šä¿¡ã«ãŠã„ã¦:
- **ã©ã“ã§ä½•ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãŒåŠ¹ã„ã¦ã„ã‚‹ã‹** ã‚’ç†è§£ã™ã‚‹
- **ã©ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒã©ã®ãƒ•ã‚¡ã‚¤ãƒ«ã«ç¹‹ãŒã£ã¦ã„ã‚‹ã‹** ã‚’æŠŠæ¡ã™ã‚‹

</div>
</div>

<hr />
<h2 id="å…¨ä½“ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ•ãƒ­ãƒ¼å›³">å…¨ä½“ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ•ãƒ­ãƒ¼å›³<a class="header-link" href="#å…¨ä½“ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ•ãƒ­ãƒ¼å›³" title="Permanent link">&para;</a></h2>
<div class="architecture-box">
<div class="box-title">ğŸ” ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆå…¨ä½“å›³</div>
<div class="box-content">

### ã‚·ãƒ³ãƒ—ãƒ«ç‰ˆï¼ˆã¾ãšã“ã‚Œã‚’ç†è§£ï¼‰

<div style="background: linear-gradient(90deg, #e3f2fd 0%, #e8f5e9 50%, #fff3e0 100%); padding: 20px; border-radius: 12px; font-family: sans-serif;">
<div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 20px;">

<div style="text-align: center; flex: 1; min-width: 150px;">
<div style="background: #1976d2; color: white; padding: 15px; border-radius: 8px; font-weight: bold;">ğŸ‘¤ ãƒ–ãƒ©ã‚¦ã‚¶</div>
<div style="margin-top: 10px; font-size: 14px;">
â‘  ãƒ­ã‚°ã‚¤ãƒ³<br>
â‘¡ ãƒˆãƒ¼ã‚¯ãƒ³å–å¾—<br>
â‘¢ ãƒãƒ£ãƒƒãƒˆé€ä¿¡
</div>
</div>

<div style="font-size: 32px; color: #666;">â†’</div>

<div style="text-align: center; flex: 1; min-width: 150px;">
<div style="background: #388e3c; color: white; padding: 15px; border-radius: 8px; font-weight: bold;">ğŸšª Gateway</div>
<div style="margin-top: 10px; font-size: 14px;">
â‘£ ãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼<br>
â‘¤ é¡§å®¢IDå–å¾—<br>
â‘¥ è»¢é€å…ˆæ±ºå®š
</div>
</div>

<div style="font-size: 32px; color: #666;">â†’</div>

<div style="text-align: center; flex: 1; min-width: 150px;">
<div style="background: #f57c00; color: white; padding: 15px; border-radius: 8px; font-weight: bold;">âš™ï¸ Backend</div>
<div style="margin-top: 10px; font-size: 14px;">
â‘¦ ç½²åæ¤œè¨¼<br>
â‘§ ãƒ¬ãƒ¼ãƒˆåˆ¶é™<br>
â‘¨ AIå‡¦ç†
</div>
</div>

</div>
</div>

### è©³ç´°ç‰ˆï¼ˆå„ã‚¹ãƒ†ãƒƒãƒ—ã®è©³ç´°ï¼‰


<div class="codehilite"><pre><span></span><code>ã€ã‚¹ãƒ†ãƒƒãƒ—â‘ ã€œâ‘¢ã€‘ãƒ–ãƒ©ã‚¦ã‚¶å´
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ­ã‚°ã‚¤ãƒ³
        â†“
  Firebase Auth ãŒIDãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç™ºè¡Œ
        â†“
  ãƒãƒ£ãƒƒãƒˆé€ä¿¡æ™‚ã€ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ãƒ˜ãƒƒãƒ€ãƒ¼ã«ä»˜ä¸
        â†“
  Authorization: Bearer {token}


ã€ã‚¹ãƒ†ãƒƒãƒ—â‘£ã€œâ‘¥ã€‘Gateway
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  â‘£ ãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼
     â””â”€ Firebase Admin SDK ã§ç½²åãƒ»æœ‰åŠ¹æœŸé™ã‚’ãƒã‚§ãƒƒã‚¯
        â†“
  â‘¤ é¡§å®¢IDå–å¾—
     â””â”€ Custom Claims or ãƒ¡ãƒ¼ãƒ«ãƒ‰ãƒ¡ã‚¤ãƒ³ã‹ã‚‰ç‰¹å®š
        â†“
  â‘¥ è»¢é€å…ˆæ±ºå®š
     â””â”€ Firestore ã‹ã‚‰ cloud_functions_url ã‚’å–å¾—
        â†“
  å†…éƒ¨ãƒ˜ãƒƒãƒ€ãƒ¼ + HMACç½²åã‚’ä»˜ä¸ã—ã¦è»¢é€


ã€ã‚¹ãƒ†ãƒƒãƒ—â‘¦ã€œâ‘¨ã€‘Backend
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  â‘¦ HMACç½²åæ¤œè¨¼
     â””â”€ Gateway ã‹ã‚‰ã®æ­£è¦ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‹ç¢ºèª
        â†“
  â‘§ ãƒ¬ãƒ¼ãƒˆåˆ¶é™ãƒã‚§ãƒƒã‚¯
     â””â”€ 1åˆ†é–“60å›ã¾ã§
        â†“
  â‘¨ AIå‡¦ç†
     â””â”€ Vertex AI (Gemini) ã«å•ã„åˆã‚ã›
</code></pre></div>



</div>
</div>

<hr />
<h2 id="ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆè©³ç´°">ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆè©³ç´°<a class="header-link" href="#ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆè©³ç´°" title="Permanent link">&para;</a></h2>
<h3 id="ãƒã‚§ãƒƒã‚¯â‘ -idãƒˆãƒ¼ã‚¯ãƒ³å–å¾—">ãƒã‚§ãƒƒã‚¯â‘  IDãƒˆãƒ¼ã‚¯ãƒ³å–å¾—<a class="header-link" href="#ãƒã‚§ãƒƒã‚¯â‘ -idãƒˆãƒ¼ã‚¯ãƒ³å–å¾—" title="Permanent link">&para;</a></h3>
<div class="info-box">
<div class="box-title">ğŸ« ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰: api.ts</div>
<div class="box-content">

**ãƒ•ã‚¡ã‚¤ãƒ«**: `frontend/src/services/api.ts`


<div class="codehilite"><pre><span></span><code><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">getAuthToken</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="kt">string</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">auth</span><span class="p">.</span><span class="nx">currentUser</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">user</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="s1">&#39;ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™&#39;</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">user</span><span class="p">.</span><span class="nx">getIdToken</span><span class="p">()</span><span class="w">  </span><span class="c1">// Firebase ã‹ã‚‰ãƒˆãƒ¼ã‚¯ãƒ³å–å¾—</span>
<span class="p">}</span>
</code></pre></div>



**ä½•ã‚’é˜²ãï¼Ÿ**
- æœªãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®APIå‘¼ã³å‡ºã—

**ãƒˆãƒ¼ã‚¯ãƒ³ã®ä¸­èº«**:

<div class="codehilite"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;uid&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;abc123&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;email&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;yamada@acme.co.jp&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;exp&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1705471200</span><span class="p">,</span><span class="w">  </span><span class="c1">// æœ‰åŠ¹æœŸé™ï¼ˆ1æ™‚é–“ï¼‰</span>
<span class="w">  </span><span class="nt">&quot;iss&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;https://securetoken.google.com/PROJECT_ID&quot;</span>
<span class="p">}</span>
</code></pre></div>



</div>
</div>

<hr />
<h3 id="ãƒã‚§ãƒƒã‚¯â‘¡-corsæ¤œè¨¼">ãƒã‚§ãƒƒã‚¯â‘¡ CORSæ¤œè¨¼<a class="header-link" href="#ãƒã‚§ãƒƒã‚¯â‘¡-corsæ¤œè¨¼" title="Permanent link">&para;</a></h3>
<div class="info-box">
<div class="box-title">ğŸŒ Gateway: main.py / cors.py</div>
<div class="box-content">

**ãƒ•ã‚¡ã‚¤ãƒ«**: `gateway/main.py`, `backend/common/cors.py`


<div class="codehilite"><pre><span></span><code><span class="c1"># Gateway ã§ã® CORS è¨­å®š</span>
<span class="n">ALLOWED_ORIGINS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;http://localhost:5173&quot;</span><span class="p">,</span>
    <span class="s2">&quot;https://your-project.web.app&quot;</span><span class="p">,</span>
<span class="p">]</span>

<span class="c1"># ãƒ—ãƒªãƒ•ãƒ©ã‚¤ãƒˆãƒªã‚¯ã‚¨ã‚¹ãƒˆã¸ã®å¯¾å¿œ</span>
<span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;OPTIONS&#39;</span><span class="p">:</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">Response</span><span class="p">()</span>
    <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;Access-Control-Allow-Origin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">origin</span>
    <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;Access-Control-Allow-Methods&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;POST, OPTIONS&#39;</span>
    <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;Access-Control-Allow-Headers&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Authorization, Content-Type&#39;</span>
    <span class="k">return</span> <span class="n">response</span>
</code></pre></div>



**ä½•ã‚’é˜²ãï¼Ÿ**
- è¨±å¯ã•ã‚Œã¦ã„ãªã„ãƒ‰ãƒ¡ã‚¤ãƒ³ã‹ã‚‰ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ã®ã¿ï¼‰

**æ³¨æ„**: CORS ã¯ãƒ–ãƒ©ã‚¦ã‚¶ã ã‘ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã€‚curl ã‚„ Postman ã§ã¯ç„¡åŠ¹ã€‚

</div>
</div>

<hr />
<h3 id="ãƒã‚§ãƒƒã‚¯â‘¢-ãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼">ãƒã‚§ãƒƒã‚¯â‘¢ ãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼<a class="header-link" href="#ãƒã‚§ãƒƒã‚¯â‘¢-ãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼" title="Permanent link">&para;</a></h3>
<div class="info-box">
<div class="box-title">ğŸ”‘ Gateway: main.py</div>
<div class="box-content">

**ãƒ•ã‚¡ã‚¤ãƒ«**: `gateway/main.py`


<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">verify_request</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Firebase IDãƒˆãƒ¼ã‚¯ãƒ³ã‚’æ¤œè¨¼&quot;&quot;&quot;</span>
    <span class="n">auth_header</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Authorization&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">auth_header</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">auth_header</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;Bearer &quot;</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ãŒã‚ã‚Šã¾ã›ã‚“&quot;</span><span class="p">)</span>

    <span class="n">token</span> <span class="o">=</span> <span class="n">auth_header</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1"># Firebase Admin SDK ã§ãƒˆãƒ¼ã‚¯ãƒ³ã‚’æ¤œè¨¼</span>
    <span class="n">decoded_token</span> <span class="o">=</span> <span class="n">firebase_auth</span><span class="o">.</span><span class="n">verify_id_token</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">check_revoked</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">decoded_token</span><span class="p">[</span><span class="s2">&quot;uid&quot;</span><span class="p">],</span> <span class="n">decoded_token</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;customer_id&quot;</span><span class="p">)</span>
</code></pre></div>



**æ¤œè¨¼é …ç›®**:
| é …ç›® | å†…å®¹ |
|------|------|
| ç½²åæ¤œè¨¼ | Googleã®å…¬é–‹éµã§ç½²åã‚’æ¤œè¨¼ |
| æœ‰åŠ¹æœŸé™ | exp ãŒç¾åœ¨æ™‚åˆ»ã‚ˆã‚Šæœªæ¥ã‹ |
| ç™ºè¡Œè€… | Firebase ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒç™ºè¡Œã—ãŸã‹ |
| å¤±åŠ¹ç¢ºèª | check_revoked=True ã§ãƒ­ã‚°ã‚¢ã‚¦ãƒˆæ¸ˆã¿ã‚’å¼¾ã |

**ä½•ã‚’é˜²ãï¼Ÿ**
- ãªã‚Šã™ã¾ã—ã€æ”¹ã–ã‚“ã•ã‚ŒãŸãƒˆãƒ¼ã‚¯ãƒ³ã€æœ‰åŠ¹æœŸé™åˆ‡ã‚Œãƒˆãƒ¼ã‚¯ãƒ³

</div>
</div>

<hr />
<h3 id="ãƒã‚§ãƒƒã‚¯â‘£-é¡§å®¢idå–å¾—æ¤œè¨¼">ãƒã‚§ãƒƒã‚¯â‘£ é¡§å®¢IDå–å¾—/æ¤œè¨¼<a class="header-link" href="#ãƒã‚§ãƒƒã‚¯â‘£-é¡§å®¢idå–å¾—æ¤œè¨¼" title="Permanent link">&para;</a></h3>
<div class="info-box">
<div class="box-title">ğŸ¢ Gateway / Backend: auth.py</div>
<div class="box-content">

**ãƒ•ã‚¡ã‚¤ãƒ«**: `backend/common/auth.py`


<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_customer_id</span><span class="p">(</span><span class="n">decoded_token</span><span class="p">,</span> <span class="n">email</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;é¡§å®¢IDã‚’å–å¾—ï¼ˆCustom Claims ã¾ãŸã¯ è‡ªå‹•æŒ¯ã‚Šåˆ†ã‘ï¼‰&quot;&quot;&quot;</span>

    <span class="c1"># 1. Custom Claims ã« customer_id ãŒã‚ã‚Œã°ãã‚Œã‚’è¿”ã™</span>
    <span class="k">if</span> <span class="s2">&quot;customer_id&quot;</span> <span class="ow">in</span> <span class="n">decoded_token</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">decoded_token</span><span class="p">[</span><span class="s2">&quot;customer_id&quot;</span><span class="p">]</span>

    <span class="c1"># 2. ãªã‘ã‚Œã°ãƒ¡ãƒ¼ãƒ«ãƒ‰ãƒ¡ã‚¤ãƒ³ã‹ã‚‰è‡ªå‹•æŒ¯ã‚Šåˆ†ã‘</span>
    <span class="n">domain</span> <span class="o">=</span> <span class="n">email</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;@&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1"># Firestore ã§ allowed_domains ã‚’æ¤œç´¢</span>
    <span class="n">customers_ref</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">collection</span><span class="p">(</span><span class="s2">&quot;customers&quot;</span><span class="p">)</span>
    <span class="n">query</span> <span class="o">=</span> <span class="n">customers_ref</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s2">&quot;allowed_domains&quot;</span><span class="p">,</span> <span class="s2">&quot;array_contains&quot;</span><span class="p">,</span> <span class="n">domain</span><span class="p">)</span>
    <span class="n">docs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">stream</span><span class="p">())</span>

    <span class="k">if</span> <span class="n">docs</span><span class="p">:</span>
        <span class="n">customer_id</span> <span class="o">=</span> <span class="n">docs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">id</span>
        <span class="c1"># Custom Claims ã«ä¿å­˜ï¼ˆæ¬¡å›ã‹ã‚‰ã¯ã“ã“ã«æ¥ãªã„ï¼‰</span>
        <span class="n">auth</span><span class="o">.</span><span class="n">set_custom_user_claims</span><span class="p">(</span><span class="n">uid</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;customer_id&quot;</span><span class="p">:</span> <span class="n">customer_id</span><span class="p">})</span>
        <span class="k">return</span> <span class="n">customer_id</span>

    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;é¡§å®¢ã«ç´ä»˜ã‘ã•ã‚Œã¦ã„ã¾ã›ã‚“&quot;</span><span class="p">)</span>
</code></pre></div>



**ä½•ã‚’é˜²ãï¼Ÿ**
- æœªç™»éŒ²ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚¢ã‚¯ã‚»ã‚¹
- ä»–ç¤¾ãƒ‡ãƒ¼ã‚¿ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ï¼ˆcustomer_id ã«ã‚ˆã‚‹åˆ†é›¢ï¼‰

</div>
</div>

<hr />
<h3 id="ãƒã‚§ãƒƒã‚¯â‘¤-è»¢é€å…ˆurlå–å¾—">ãƒã‚§ãƒƒã‚¯â‘¤ è»¢é€å…ˆURLå–å¾—<a class="header-link" href="#ãƒã‚§ãƒƒã‚¯â‘¤-è»¢é€å…ˆurlå–å¾—" title="Permanent link">&para;</a></h3>
<div class="info-box">
<div class="box-title">ğŸ¯ Gateway: main.py</div>
<div class="box-content">

**ãƒ•ã‚¡ã‚¤ãƒ«**: `gateway/main.py`


<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_backend_url</span><span class="p">(</span><span class="n">customer_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;é¡§å®¢IDã‹ã‚‰è»¢é€å…ˆURLã‚’å–å¾—&quot;&quot;&quot;</span>
    <span class="n">doc</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">collection</span><span class="p">(</span><span class="s2">&quot;customers&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">document</span><span class="p">(</span><span class="n">customer_id</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">doc</span><span class="o">.</span><span class="n">exists</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;é¡§å®¢ </span><span class="si">{</span><span class="n">customer_id</span><span class="si">}</span><span class="s2"> ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“&quot;</span><span class="p">)</span>

    <span class="n">data</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
    <span class="n">url</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;cloud_functions_url&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">url</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;cloud_functions_url ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">url</span>
</code></pre></div>



**Firestore ãƒ‡ãƒ¼ã‚¿æ§‹é€ **:

<div class="codehilite"><pre><span></span><code>customers/
â””â”€â”€ acme-corp/
    â”œâ”€â”€ name: &quot;æ ªå¼ä¼šç¤¾ACME&quot;
    â”œâ”€â”€ cloud_functions_url: &quot;https://acme-backend-xxx.run.app&quot;
    â”œâ”€â”€ allowed_domains: [&quot;acme.co.jp&quot;]
    â””â”€â”€ enabled: true
</code></pre></div>



**ä½•ã‚’é˜²ãï¼Ÿ**
- å­˜åœ¨ã—ãªã„é¡§å®¢ã¸ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
- æœªè¨­å®šã®ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã¸ã®è»¢é€

</div>
</div>

<hr />
<h3 id="ãƒã‚§ãƒƒã‚¯â‘¥â‘¦-gateway-backendé–“èªè¨¼hmacç½²å">ãƒã‚§ãƒƒã‚¯â‘¥â‘¦ Gateway-Backendé–“èªè¨¼ï¼ˆHMACç½²åï¼‰<a class="header-link" href="#ãƒã‚§ãƒƒã‚¯â‘¥â‘¦-gateway-backendé–“èªè¨¼hmacç½²å" title="Permanent link">&para;</a></h3>
<div class="info-box">
<div class="box-title">ğŸ” Gateway â†’ Backend é–“ã®èªè¨¼</div>
<div class="box-content">

**ãƒ•ã‚¡ã‚¤ãƒ«**:
- Gateway: `gateway/main.py`
- Backend: `backend/main.py`

**ã€Gatewayå´ã€‘ç½²åã‚’ç”Ÿæˆã—ã¦ä»˜ä¸**


<div class="codehilite"><pre><span></span><code><span class="c1"># Gateway main.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">hmac</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">hashlib</span>

<span class="n">GATEWAY_SECRET</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;GATEWAY_SECRET&quot;</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">create_signature</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">customer_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;HMACç½²åã‚’ç”Ÿæˆ&quot;&quot;&quot;</span>
    <span class="n">message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">customer_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">hmac</span><span class="o">.</span><span class="n">new</span><span class="p">(</span>
        <span class="n">GATEWAY_SECRET</span><span class="o">.</span><span class="n">encode</span><span class="p">(),</span>
        <span class="n">message</span><span class="p">,</span>
        <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span>
    <span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>

<span class="c1"># ãƒªã‚¯ã‚¨ã‚¹ãƒˆè»¢é€æ™‚</span>
<span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;X-Gateway-Verified&quot;</span><span class="p">:</span> <span class="s2">&quot;true&quot;</span><span class="p">,</span>
    <span class="s2">&quot;X-User-Id&quot;</span><span class="p">:</span> <span class="n">user_id</span><span class="p">,</span>
    <span class="s2">&quot;X-Customer-Id&quot;</span><span class="p">:</span> <span class="n">customer_id</span><span class="p">,</span>
    <span class="s2">&quot;X-Gateway-Signature&quot;</span><span class="p">:</span> <span class="n">create_signature</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">customer_id</span><span class="p">),</span>
<span class="p">}</span>
</code></pre></div>



**ã€Backendå´ã€‘ç½²åã‚’æ¤œè¨¼**


<div class="codehilite"><pre><span></span><code><span class="c1"># Backend main.py</span>
<span class="k">def</span><span class="w"> </span><span class="nf">verify_gateway_signature</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">customer_id</span><span class="p">,</span> <span class="n">signature</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Gateway ã‹ã‚‰ã®ç½²åã‚’æ¤œè¨¼&quot;&quot;&quot;</span>
    <span class="n">message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">customer_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
    <span class="n">expected</span> <span class="o">=</span> <span class="n">hmac</span><span class="o">.</span><span class="n">new</span><span class="p">(</span>
        <span class="n">GATEWAY_SECRET</span><span class="o">.</span><span class="n">encode</span><span class="p">(),</span>
        <span class="n">message</span><span class="p">,</span>
        <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span>
    <span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>

    <span class="c1"># ã‚¿ã‚¤ãƒŸãƒ³ã‚°æ”»æ’ƒã‚’é˜²ã</span>
    <span class="k">return</span> <span class="n">hmac</span><span class="o">.</span><span class="n">compare_digest</span><span class="p">(</span><span class="n">signature</span><span class="p">,</span> <span class="n">expected</span><span class="p">)</span>
</code></pre></div>



**ä½•ã‚’é˜²ãï¼Ÿ**
- æ”»æ’ƒè€…ãŒç›´æ¥ Backend ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’å½è£…

**ãªãœå¿…è¦ï¼Ÿ**
- `X-Gateway-Verified: true` ã ã‘ã§ã¯ã€èª°ã§ã‚‚ä»˜ã‘ã‚‰ã‚Œã‚‹
- HMACç½²åãŒã‚ã‚Œã°ã€å…±æœ‰ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’çŸ¥ã‚‰ãªã„ã¨å½é€ ä¸å¯èƒ½

</div>
</div>

<hr />
<h3 id="ãƒã‚§ãƒƒã‚¯â‘§-ãƒ¬ãƒ¼ãƒˆåˆ¶é™">ãƒã‚§ãƒƒã‚¯â‘§ ãƒ¬ãƒ¼ãƒˆåˆ¶é™<a class="header-link" href="#ãƒã‚§ãƒƒã‚¯â‘§-ãƒ¬ãƒ¼ãƒˆåˆ¶é™" title="Permanent link">&para;</a></h3>
<div class="info-box">
<div class="box-title">â±ï¸ Backend: rate_limiter.py</div>
<div class="box-content">

**ãƒ•ã‚¡ã‚¤ãƒ«**: `backend/common/rate_limiter.py`


<div class="codehilite"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">defaultdict</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>

<span class="c1"># ãƒ¦ãƒ¼ã‚¶ãƒ¼ã”ã¨ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆå±¥æ­´</span>
<span class="n">_request_history</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>

<span class="n">RATE_LIMIT</span> <span class="o">=</span> <span class="mi">60</span>      <span class="c1"># 1åˆ†é–“ã®æœ€å¤§ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ•°</span>
<span class="n">WINDOW_SIZE</span> <span class="o">=</span> <span class="mi">60</span>     <span class="c1"># ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚µã‚¤ã‚ºï¼ˆç§’ï¼‰</span>

<span class="k">def</span><span class="w"> </span><span class="nf">check_rate_limit</span><span class="p">(</span><span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã‚’ãƒã‚§ãƒƒã‚¯&quot;&quot;&quot;</span>
    <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">history</span> <span class="o">=</span> <span class="n">_request_history</span><span class="p">[</span><span class="n">user_id</span><span class="p">]</span>

    <span class="c1"># å¤ã„ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å‰Šé™¤</span>
    <span class="n">history</span><span class="p">[:]</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">history</span> <span class="k">if</span> <span class="n">now</span> <span class="o">-</span> <span class="n">t</span> <span class="o">&lt;</span> <span class="n">WINDOW_SIZE</span><span class="p">]</span>

    <span class="c1"># åˆ¶é™ã‚’è¶…ãˆã¦ã„ãªã„ã‹ãƒã‚§ãƒƒã‚¯</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">history</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">RATE_LIMIT</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="c1"># ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’è¨˜éŒ²</span>
    <span class="n">history</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">now</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">True</span>
</code></pre></div>



**ä½•ã‚’é˜²ãï¼Ÿ**
- DoSæ”»æ’ƒï¼ˆå¤§é‡ãƒªã‚¯ã‚¨ã‚¹ãƒˆã§ã‚µãƒ¼ãƒãƒ¼ãƒ€ã‚¦ãƒ³ï¼‰
- èª²é‡‘æ”»æ’ƒï¼ˆAIå‘¼ã³å‡ºã—ã¯é«˜é¡ï¼‰

</div>
</div>

<hr />
<h3 id="ãƒã‚§ãƒƒã‚¯â‘¨-å…¥åŠ›å€¤æ¤œè¨¼">ãƒã‚§ãƒƒã‚¯â‘¨ å…¥åŠ›å€¤æ¤œè¨¼<a class="header-link" href="#ãƒã‚§ãƒƒã‚¯â‘¨-å…¥åŠ›å€¤æ¤œè¨¼" title="Permanent link">&para;</a></h3>
<div class="info-box">
<div class="box-title">ğŸ“ Backend: main.py</div>
<div class="box-content">

**ãƒ•ã‚¡ã‚¤ãƒ«**: `backend/main.py`


<div class="codehilite"><pre><span></span><code><span class="n">MAX_MESSAGE_LENGTH</span> <span class="o">=</span> <span class="mi">10000</span>
<span class="n">THREAD_ID_PATTERN</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^[a-zA-Z0-9_-]{1,100}$&#39;</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">validate_input</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;å…¥åŠ›å€¤ã‚’æ¤œè¨¼&quot;&quot;&quot;</span>
    <span class="n">message</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;message&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="n">thread_id</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;thread_id&quot;</span><span class="p">)</span>

    <span class="c1"># ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒç©º</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">message</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„&quot;</span><span class="p">)</span>

    <span class="c1"># ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒé•·ã™ãã‚‹</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">message</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">MAX_MESSAGE_LENGTH</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒé•·ã™ãã¾ã™ï¼ˆ</span><span class="si">{</span><span class="n">MAX_MESSAGE_LENGTH</span><span class="si">}</span><span class="s2">æ–‡å­—ã¾ã§ï¼‰&quot;</span><span class="p">)</span>

    <span class="c1"># thread_id ã®å½¢å¼ãƒã‚§ãƒƒã‚¯</span>
    <span class="k">if</span> <span class="n">thread_id</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">THREAD_ID_PATTERN</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">thread_id</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;thread_idã®å½¢å¼ãŒä¸æ­£ã§ã™&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">message</span><span class="p">,</span> <span class="n">thread_id</span>
</code></pre></div>



**ä½•ã‚’é˜²ãï¼Ÿ**
- å·¨å¤§ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«ã‚ˆã‚‹ãƒ¡ãƒ¢ãƒªæ¯æ¸‡
- thread_id ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³æ”»æ’ƒ

</div>
</div>

<hr />
<h2 id="ãƒ•ã‚¡ã‚¤ãƒ«é€£æºå›³ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰--ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰">ãƒ•ã‚¡ã‚¤ãƒ«é€£æºå›³ï¼ˆãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ â†’ ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ï¼‰<a class="header-link" href="#ãƒ•ã‚¡ã‚¤ãƒ«é€£æºå›³ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰--ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰" title="Permanent link">&para;</a></h2>
<div class="architecture-box">
<div class="box-title">ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«é–“ã®å‘¼ã³å‡ºã—é–¢ä¿‚</div>
<div class="box-content">


<div class="codehilite"><pre><span></span><code>ã€ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã€‘                     ã€ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã€‘

frontend/src/
â”‚
â”œâ”€â”€ App.tsx
â”‚   â”‚
â”‚   â”œâ”€â”€ hooks/useAuth.ts â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   â”‚   â””â”€â”€ services/firebase.ts               â”‚
â”‚   â”‚       â””â”€â”€ Firebase Auth (SDK)            â”‚
â”‚   â”‚                                          â”‚
â”‚   â”œâ”€â”€ hooks/useChat.ts                       â”‚
â”‚   â”‚   â””â”€â”€ services/api.ts â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   â”‚       â”‚                                  â”‚                        â”‚
â”‚   â”‚       â”œâ”€â”€ getAuthToken()                 â”‚                        â”‚
â”‚   â”‚       â”‚   â””â”€â”€ auth.currentUser.getIdToken()                       â”‚
â”‚   â”‚       â”‚                                  â”‚                        â”‚
â”‚   â”‚       â””â”€â”€ sendChatMessage() â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   â”‚           â””â”€â”€ fetch(&quot;/chat&quot;, {...})      â”‚                        â”‚
â”‚   â”‚                                          â”‚                        â–¼
â”‚   â””â”€â”€ hooks/useSessions.ts                   â”‚
â”‚       â””â”€â”€ localStorage                       â”‚          gateway/
â”‚                                              â”‚          â”‚
â””â”€â”€ components/                                â”‚          â””â”€â”€ main.py
    â”œâ”€â”€ ChatScreen.tsx                         â”‚              â”‚
    â”œâ”€â”€ LoginScreen.tsx                        â”‚              â”œâ”€â”€ verify_request()
    â””â”€â”€ SessionTabs.tsx                        â”‚              â”‚   â””â”€â”€ firebase_auth.verify_id_token()
                                               â”‚              â”‚
                                               â”‚              â”œâ”€â”€ get_backend_url()
                                               â”‚              â”‚   â””â”€â”€ Firestore (customers)
                                               â”‚              â”‚
                                               â”‚              â””â”€â”€ proxy_request() â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                               â”‚                                                   â”‚
                                               â”‚                                                   â–¼
                                               â”‚                               backend/
                                               â”‚                               â”‚
                                               â”‚                               â””â”€â”€ main.py
                                               â”‚                                   â”‚
                                               â”‚                                   â”œâ”€â”€ authenticate_request_with_gateway()
                                               â”‚                                   â”‚   â””â”€â”€ common/auth.py
                                               â”‚                                   â”‚
                                               â”‚                                   â”œâ”€â”€ check_rate_limit()
                                               â”‚                                   â”‚   â””â”€â”€ common/rate_limiter.py
                                               â”‚                                   â”‚
                                               â”‚                                   â”œâ”€â”€ get_agent()
                                               â”‚                                   â”‚   â””â”€â”€ agents/_template/agent.py
                                               â”‚                                   â”‚       â””â”€â”€ Vertex AI (Gemini)
                                               â”‚                                   â”‚
                                               â”‚                                   â””â”€â”€ post_process()
                                               â”‚                                       â””â”€â”€ å¾Œå‡¦ç†ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³
                                               â”‚
                                               â””â”€â”€â”€â”€â”€â”€â”€â”€ Firebase Admin SDK ã§æ¤œè¨¼
</code></pre></div>



</div>
</div>

<hr />
<h2 id="ãƒ•ã‚¡ã‚¤ãƒ«å¯¾å¿œè¡¨">ãƒ•ã‚¡ã‚¤ãƒ«å¯¾å¿œè¡¨<a class="header-link" href="#ãƒ•ã‚¡ã‚¤ãƒ«å¯¾å¿œè¡¨" title="Permanent link">&para;</a></h2>
<div class="info-box">
<div class="box-title">ğŸ“‹ ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ â†” ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ ãƒ•ã‚¡ã‚¤ãƒ«å¯¾å¿œ</div>
<div class="box-content">

| ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ | å½¹å‰² | å¯¾å¿œã™ã‚‹ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ | å½¹å‰² |
|--------------|------|-------------------|------|
| `api.ts` | HTTPé€šä¿¡ | `gateway/main.py` | ãƒªã‚¯ã‚¨ã‚¹ãƒˆå—ä»˜ |
| `api.ts` getAuthToken() | ãƒˆãƒ¼ã‚¯ãƒ³å–å¾— | `gateway/main.py` verify_request() | ãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼ |
| `useChat.ts` | ãƒãƒ£ãƒƒãƒˆãƒ­ã‚¸ãƒƒã‚¯ | `backend/main.py` /chat | ãƒãƒ£ãƒƒãƒˆAPI |
| `useAuth.ts` | èªè¨¼çŠ¶æ…‹ç®¡ç† | `common/auth.py` | èªè¨¼å‡¦ç† |
| `useSessions.ts` | ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç† | `checkpointer.py` | ä¼šè©±å±¥æ­´ä¿å­˜ |
| `firebase.ts` | FirebaseåˆæœŸåŒ– | Firebase Admin SDK | ã‚µãƒ¼ãƒãƒ¼å´SDK |

</div>
</div>

<hr />
<h2 id="ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¾ã¨ã‚">ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¾ã¨ã‚<a class="header-link" href="#ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¾ã¨ã‚" title="Permanent link">&para;</a></h2>
<div class="info-box">
<div class="box-title">ğŸ›¡ï¸ 6å±¤ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£</div>
<div class="box-content">

| å±¤ | å ´æ‰€ | å†…å®¹ | é˜²ãæ”»æ’ƒ |
|----|------|------|---------|
| 1 | ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ | IDãƒˆãƒ¼ã‚¯ãƒ³å¿…é ˆ | æœªèªè¨¼ã‚¢ã‚¯ã‚»ã‚¹ |
| 2 | Gateway | CORS | ä¸æ­£ã‚ªãƒªã‚¸ãƒ³ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ã®ã¿ï¼‰ |
| 3 | Gateway | ãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼ | ãªã‚Šã™ã¾ã—ã€æ”¹ã–ã‚“ |
| 4 | Gatewayâ†’Backend | HMACç½²å | ãƒ˜ãƒƒãƒ€ãƒ¼å½è£… |
| 5 | Backend | ãƒ¬ãƒ¼ãƒˆåˆ¶é™ | DoSã€èª²é‡‘æ”»æ’ƒ |
| 6 | Backend | å…¥åŠ›æ¤œè¨¼ | ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ |

**é‡è¦**: ã™ã¹ã¦ã®å±¤ã‚’é€šéã—ãªã„ã¨AIã¯å¿œç­”ã—ã¾ã›ã‚“ã€‚

</div>
</div>

<hr />
<h2 id="ç†è§£åº¦ãƒã‚§ãƒƒã‚¯">ç†è§£åº¦ãƒã‚§ãƒƒã‚¯<a class="header-link" href="#ç†è§£åº¦ãƒã‚§ãƒƒã‚¯" title="Permanent link">&para;</a></h2>
<table>
<thead>
<tr>
<th>è³ªå•</th>
<th>ãƒ’ãƒ³ãƒˆ</th>
</tr>
</thead>
<tbody>
<tr>
<td>IDãƒˆãƒ¼ã‚¯ãƒ³ã¯ã©ã“ã§ç™ºè¡Œã•ã‚Œã‚‹ï¼Ÿ</td>
<td>Firebase Auth</td>
</tr>
<tr>
<td>Gateway ã¯ä½•ã‚’ã—ã¦ã„ã‚‹ï¼Ÿ</td>
<td>èªè¨¼ + è»¢é€å…ˆæ±ºå®š + è»¢é€</td>
</tr>
<tr>
<td>HMACç½²åã¯ãªãœå¿…è¦ï¼Ÿ</td>
<td>X-Gateway-Verified ã ã‘ã§ã¯å½è£…å¯èƒ½</td>
</tr>
<tr>
<td>ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã®è¨­å®šå€¤ã¯ï¼Ÿ</td>
<td>1åˆ†é–“60å›</td>
</tr>
<tr>
<td>customer_id ã¯ã©ã“ã«ä¿å­˜ã•ã‚Œã‚‹ï¼Ÿ</td>
<td>Custom Claimsï¼ˆãƒˆãƒ¼ã‚¯ãƒ³å†…ï¼‰</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="æ¬¡ã«èª­ã‚€ã¹ããƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ">æ¬¡ã«èª­ã‚€ã¹ããƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ<a class="header-link" href="#æ¬¡ã«èª­ã‚€ã¹ããƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ" title="Permanent link">&para;</a></h2>
<table>
<thead>
<tr>
<th>ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ</th>
<th>å†…å®¹</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="./11_ãƒãƒ£ãƒƒãƒˆé€ä¿¡ã®æµã‚Œ.md">11_ãƒãƒ£ãƒƒãƒˆé€ä¿¡ã®æµã‚Œ</a></td>
<td>å‡¦ç†ãƒ•ãƒ­ãƒ¼ã®è©³ç´°</td>
</tr>
<tr>
<td><a href="./12_ãƒ­ã‚°ã‚¤ãƒ³ã®æµã‚Œ.md">12_ãƒ­ã‚°ã‚¤ãƒ³ã®æµã‚Œ</a></td>
<td>èªè¨¼ãƒ•ãƒ­ãƒ¼ã®è©³ç´°</td>
</tr>
<tr>
<td><a href="./03_ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰è§£èª¬.md">03_ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰è§£èª¬</a></td>
<td>Python/Flaskã®è©³ç´°</td>
</tr>
</tbody>
</table>
      </article>
      <footer class="footer">
        GCP AI Agent è¨­è¨ˆè³‡æ–™ | Built with Python & Markdown
      </footer>
    </main>
  </div>

  <script>
    function toggleSidebar() {
      document.getElementById('sidebar').classList.toggle('open');
    }

    // Close sidebar when clicking outside on mobile
    document.addEventListener('click', function(e) {
      const sidebar = document.getElementById('sidebar');
      const toggle = document.querySelector('.menu-toggle');
      if (!sidebar.contains(e.target) && !toggle.contains(e.target)) {
        sidebar.classList.remove('open');
      }
    });
  </script>
</body>
</html>