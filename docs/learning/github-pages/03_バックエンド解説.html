<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>03 ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰è§£èª¬ - GCP AI Agent è¨­è¨ˆè³‡æ–™</title>
  <link rel="stylesheet" href="assets/style.css">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ“š</text></svg>">
</head>
<body>
  <header class="header">
    <a href="index.html" class="header-logo">
      <span>ğŸ“š</span>
      <span>GCP AI Agent è¨­è¨ˆè³‡æ–™</span>
    </a>
    <nav class="header-nav">
      <a href="index.html">ãƒ›ãƒ¼ãƒ </a>
      <a href="02_å…¨ä½“åƒ.html">å…¨ä½“åƒ</a>
      <a href="https://github.com" target="_blank">GitHub</a>
    </nav>
    <button class="menu-toggle" onclick="toggleSidebar()">
      <span></span>
      <span></span>
      <span></span>
    </button>
  </header>

  <div class="layout">
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-section">
        <div class="sidebar-title">ğŸ“– ã¯ã˜ã‚ã«</div>
        <ul class="sidebar-nav">
          <li><a href="01_ã¯ã˜ã‚ã«èª­ã‚“ã§ãã ã•ã„.html" >ã¯ã˜ã‚ã«èª­ã‚“ã§ãã ã•ã„</a></li>
        </ul>
      </div>

      <div class="sidebar-section">
        <div class="sidebar-title">ğŸ—ï¸ ä»•çµ„ã¿ã‚’ç†è§£</div>
        <ul class="sidebar-nav">
          <li><a href="02_å…¨ä½“åƒ.html" >å…¨ä½“åƒ</a></li>
          <li><a href="03_ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰è§£èª¬.html" class="active">ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰è§£èª¬</a></li>
          <li><a href="04_ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰è§£èª¬.html" >ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰è§£èª¬</a></li>
        </ul>
      </div>

      <div class="sidebar-section">
        <div class="sidebar-title">ğŸ› ï¸ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—</div>
        <ul class="sidebar-nav">
          <li><a href="05_ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã®æµã‚Œ.html" >ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã®æµã‚Œ</a></li>
          <li><a href="06_ã‚³ãƒãƒ³ãƒ‰è§£èª¬.html" >ã‚³ãƒãƒ³ãƒ‰è§£èª¬</a></li>
        </ul>
      </div>

      <div class="sidebar-section">
        <div class="sidebar-title">ğŸš€ å‹•ã‹ã™</div>
        <ul class="sidebar-nav">
          <li><a href="07_å‹•ã‹ã—ã¦ã¿ã‚ˆã†.html" >å‹•ã‹ã—ã¦ã¿ã‚ˆã†</a></li>
          <li><a href="08_AIã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º.html" >AIã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º</a></li>
        </ul>
      </div>

      <div class="sidebar-section">
        <div class="sidebar-title">ğŸ”§ ä¸Šç´šç·¨</div>
        <ul class="sidebar-nav">
          <li><a href="10_Gatewayã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£.html" >Gatewayã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£</a></li>
        </ul>
      </div>

      <div class="sidebar-section">
        <div class="sidebar-title">ğŸ”„ å‚è€ƒ: ãƒ•ãƒ­ãƒ¼è§£èª¬</div>
        <ul class="sidebar-nav">
          <li><a href="11_ãƒãƒ£ãƒƒãƒˆé€ä¿¡ã®æµã‚Œ.html" >ãƒãƒ£ãƒƒãƒˆé€ä¿¡ã®æµã‚Œ</a></li>
          <li><a href="12_ãƒ­ã‚°ã‚¤ãƒ³ã®æµã‚Œ.html" >ãƒ­ã‚°ã‚¤ãƒ³ã®æµã‚Œ</a></li>
          <li><a href="13_ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ã®æµã‚Œ.html" >ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ã®æµã‚Œ</a></li>
        </ul>
      </div>
    </aside>

    <main class="main">
      <article class="content">
        <h1 id="ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰è§£èª¬---ã‚µãƒ¼ãƒãƒ¼ã®ä¸­èº«ã‚’å®Œå…¨ç†è§£">ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰è§£èª¬ - ã‚µãƒ¼ãƒãƒ¼ã®ä¸­èº«ã‚’å®Œå…¨ç†è§£ï¼<a class="header-link" href="#ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰è§£èª¬---ã‚µãƒ¼ãƒãƒ¼ã®ä¸­èº«ã‚’å®Œå…¨ç†è§£" title="Permanent link">&para;</a></h1>
<div class="goal-box">
<div class="box-title">ğŸ¯ ã“ã®ãƒšãƒ¼ã‚¸ã®ã‚´ãƒ¼ãƒ«</div>
<div class="box-content">

ã€Œã‚µãƒ¼ãƒãƒ¼å´ã®ã‚³ãƒ¼ãƒ‰ã‚’è¦‹ã¦ã€ä½•ã‚’ã—ã¦ã‚‹ã‹ã‚ã‹ã‚‹ï¼ã€çŠ¶æ…‹ã«ãªã‚‹

ğŸ”¥ ã‚´ãƒ¼ãƒ«é”æˆå¾Œã®ã‚ãªãŸ:
ã€Œã“ã®APIã€èªè¨¼ â†’ ãƒ¬ãƒ¼ãƒˆåˆ¶é™ â†’ AIå‘¼ã³å‡ºã—ã®é †ã§å‡¦ç†ã—ã¦ã‚‹ã­ã€
ã¨è¨€ãˆã‚‹ã‚ˆã†ã«ãªã‚‹ï¼

</div>
</div>

<hr />
<h2 id="ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã£ã¦ä½•ã—ã¦ã‚‹ã®">ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã£ã¦ä½•ã—ã¦ã‚‹ã®ï¼Ÿ<a class="header-link" href="#ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã£ã¦ä½•ã—ã¦ã‚‹ã®" title="Permanent link">&para;</a></h2>
<div class="info-box">
<div class="box-title">ğŸ ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®ä»•äº‹</div>
<div class="box-content">

ã€Œè¦‹ãˆãªã„ã¨ã“ã‚ã§é ‘å¼µã‚‹ç¸ã®ä¸‹ã®åŠ›æŒã¡ã€

<ul>
<li>ã“ã®äººã¯æœ¬ç‰©ï¼Ÿ â†’ èªè¨¼</li>
<li>ã“ã®äººã¯ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã„ã„ï¼Ÿ â†’ è¨±å¯ç¢ºèª</li>
<li>ä½¿ã„ã™ãã¦ãªã„ï¼Ÿ â†’ ãƒ¬ãƒ¼ãƒˆåˆ¶é™</li>
<li>AIã«èã„ã¦ç­”ãˆã‚’è¿”ã™ â†’ AIå‘¼ã³å‡ºã—</li>
<li>ä¼šè©±ã‚’è¦šãˆã¦ãŠã â†’ å±¥æ­´ä¿å­˜</li>
</ul>

ğŸ’¡ GASã§è¨€ã†ã¨: doGet() ã‚„ doPost() ã®ä¸­èº«ã‚’ä½œã‚‹ã‚¤ãƒ¡ãƒ¼ã‚¸

</div>
</div>

<hr />
<h2 id="ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ">ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ<a class="header-link" href="#ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ" title="Permanent link">&para;</a></h2>
<pre class="codehilite"><code>src/gateway/src/
â””â”€â”€ main.py              â˜… Gatewayï¼ˆã™ã¹ã¦ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®å…¥å£ï¼‰

src/backend/src/
â”œâ”€â”€ main.py              â˜… ä¼šç¤¾åˆ¥ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®å…¥å£ï¼ˆGatewayã‹ã‚‰è»¢é€ã•ã‚Œã‚‹ï¼‰
â”œâ”€â”€ common/
â”‚   â”œâ”€â”€ auth.py          â˜… èªè¨¼å‡¦ç†ï¼ˆGatewayé€£æº + è‡ªå‹•æŒ¯ã‚Šåˆ†ã‘ï¼‰
â”‚   â”œâ”€â”€ config.py           è¨­å®šèª­ã¿è¾¼ã¿
â”‚   â”œâ”€â”€ firebase_init.py    FirebaseåˆæœŸåŒ–
â”‚   â””â”€â”€ rate_limiter.py     ãƒ¬ãƒ¼ãƒˆåˆ¶é™
â””â”€â”€ agents/
    â”œâ”€â”€ _base/
    â”‚   â”œâ”€â”€ base_agent.py        ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®åŸºåº•ã‚¯ãƒ©ã‚¹
    â”‚   â””â”€â”€ firestore_checkpointer.py  ä¼šè©±å±¥æ­´ä¿å­˜
    â””â”€â”€ _template/
        â””â”€â”€ agent.py     â˜… AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆæœ¬ä½“

src/backend/scripts/
â””â”€â”€ manage_customer.py   â˜… é¡§å®¢ç®¡ç†ã‚³ãƒãƒ³ãƒ‰ï¼ˆé‹ç”¨æ™‚ã«å¿…é ˆï¼‰
</code></pre>

<div class="tip-box">
<div class="box-title">ğŸ’¡ Gateway ã¨ Backend ã®é–¢ä¿‚</div>
<div class="box-content">


<pre class="codehilite"><code>ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ â†’ Gatewayï¼ˆ1ã¤ï¼‰â†’ Backendï¼ˆä¼šç¤¾ã”ã¨ã«1ã¤ï¼‰
                    â†“
         ãƒ»èªè¨¼ï¼ˆãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼ï¼‰
         ãƒ»customer_id ã‹ã‚‰è»¢é€å…ˆURLå–å¾—
         ãƒ»ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ãã®ã¾ã¾è»¢é€
</code></pre>



Gatewayã¯ã€Œèªè¨¼ã—ã¦è»¢é€ã™ã‚‹ã ã‘ã€ã®ã‚·ãƒ³ãƒ—ãƒ«ãªå½¹å‰²ã§ã™ã€‚
AIå‡¦ç†ã‚„ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã¯å„ä¼šç¤¾ã®Backendã§è¡Œã„ã¾ã™ã€‚

</div>
</div>

<hr />
<h2 id="1-gateway-srcgatewaysrcmainpy---ã™ã¹ã¦ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®å…¥å£">1. Gateway (src/gateway/src/main.py) - ã™ã¹ã¦ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®å…¥å£<a class="header-link" href="#1-gateway-srcgatewaysrcmainpy---ã™ã¹ã¦ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®å…¥å£" title="Permanent link">&para;</a></h2>
<h3 id="gatewayã®å½¹å‰²3ã¤ã ã‘">Gatewayã®å½¹å‰²ï¼ˆ3ã¤ã ã‘ï¼‰<a class="header-link" href="#gatewayã®å½¹å‰²3ã¤ã ã‘" title="Permanent link">&para;</a></h3>
<div class="info-box">
<div class="box-title">ğŸšª Gateway = ãƒ›ãƒ†ãƒ«ã®ãƒ•ãƒ­ãƒ³ãƒˆãƒ‡ã‚¹ã‚¯</div>
<div class="box-content">

<strong>ã€Gatewayã®ä»•äº‹ã€‘</strong>

1. **Firebase èªè¨¼ãƒã‚§ãƒƒã‚¯** - ãƒˆãƒ¼ã‚¯ãƒ³ã¯æœ¬ç‰©ï¼Ÿ
2. **customer_id ã‹ã‚‰ URL ã‚’å–å¾—** - ã“ã®äººã¯ã©ã®ä¼šç¤¾ï¼Ÿ
3. **ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ãã®ã¾ã¾è»¢é€** - ãã®ä¼šç¤¾ã®ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã¸


<pre class="codehilite"><code class="language-python"># Gateway ã®å‡¦ç†ï¼ˆç°¡ç•¥ç‰ˆï¼‰
def chat():
    # 1. èªè¨¼
    uid, customer_id = verify_request()

    # 2. è»¢é€å…ˆURLå–å¾—ï¼ˆFirestoreã‹ã‚‰ï¼‰
    target_url = get_company_url(customer_id)

    # 3. è»¢é€ï¼ˆå†…éƒ¨ãƒ˜ãƒƒãƒ€ãƒ¼ä»˜ãï¼‰
    return proxy_request(target_url, uid, customer_id)
</code></pre>



Gatewayã¯ã€Œèªè¨¼ã—ã¦è»¢é€ã™ã‚‹ã ã‘ã€ã€‚AIå‡¦ç†ã¯è¡Œã„ã¾ã›ã‚“ã€‚

</div>
</div>

<hr />
<h2 id="2-backend-mainpy---ä¼šç¤¾ã”ã¨ã®ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰">2. Backend main.py - ä¼šç¤¾ã”ã¨ã®ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰<a class="header-link" href="#2-backend-mainpy---ä¼šç¤¾ã”ã¨ã®ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰" title="Permanent link">&para;</a></h2>
<h3 id="ãªãœä¼šç¤¾ã”ã¨ã«ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãŒå¿…è¦">ãªãœã€Œä¼šç¤¾ã”ã¨ã«ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã€ãŒå¿…è¦ï¼Ÿ<a class="header-link" href="#ãªãœä¼šç¤¾ã”ã¨ã«ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãŒå¿…è¦" title="Permanent link">&para;</a></h3>
<div class="info-box">
<div class="box-title">ğŸ¢ ä¼šç¤¾åˆ¥ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®ãƒ¡ãƒªãƒƒãƒˆ</div>
<div class="box-content">

- **Aç¤¾ã ã‘ç‰¹æ®Šãªã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º**ãŒå¯èƒ½
- **ä»–ç¤¾ã¸ã®å½±éŸ¿ã‚¼ãƒ­**ã§å®‰å…¨ã«æ›´æ–°
- **éšœå®³ãŒä»–ç¤¾ã«æ³¢åŠã—ãªã„**

<strong>ã€main.py ã®ä»•äº‹ã€‘</strong>

ãƒªã‚¯ã‚¨ã‚¹ãƒˆ:ã€Œ/chat ã« POST ã—ãŸã„ã‚“ã§ã™ã‘ã©ã€
â†“
main.py:ã€ŒGatewayã‹ã‚‰æ¥ãŸã­ã€‚ãƒˆãƒ¼ã‚¯ãƒ³ã¯ï¼Ÿãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ï¼Ÿã€
â†“
main.py:ã€Œç¢ºèªã§ãã¾ã—ãŸã€‚ã“ã¡ã‚‰ãŒAIã®å›ç­”ã§ã™ã€

</div>
</div>

<h3 id="ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆä¸€è¦§">ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆä¸€è¦§<a class="header-link" href="#ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆä¸€è¦§" title="Permanent link">&para;</a></h3>
<div class="info-box">
<div class="box-title">ğŸ“¡ ç”¨æ„ã•ã‚Œã¦ã„ã‚‹ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ</div>
<div class="box-content">

<table>
<tr><th>ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ</th><th>ãƒ¡ã‚½ãƒƒãƒ‰</th><th>å½¹å‰²</th></tr>
<tr><td>/health</td><td>GET</td><td>ç”Ÿå­˜ç¢ºèªï¼ˆã‚µãƒ¼ãƒãƒ¼å‹•ã„ã¦ã‚‹ï¼Ÿï¼‰</td></tr>
<tr><td>/chat</td><td>POST</td><td>ãƒãƒ£ãƒƒãƒˆAPIï¼ˆãƒ¡ã‚¤ãƒ³æ©Ÿèƒ½ï¼‰</td></tr>
<tr><td>/agents</td><td>GET</td><td>ä½¿ãˆã‚‹AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆä¸€è¦§</td></tr>
</table>

ğŸ’¡ ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¨ã¯:
ã€Œã“ã®URLã«ã“ã®ãƒ¡ã‚½ãƒƒãƒ‰ã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆã™ã‚‹ã¨ã€ã“ã®å‡¦ç†ãŒå®Ÿè¡Œã•ã‚Œã¾ã™ã‚ˆã€ã¨ã„ã†çª“å£ã®ã“ã¨

</div>
</div>

<h3 id="chat-ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®å…¨å‡¦ç†ãƒ•ãƒ­ãƒ¼">/chat ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®å…¨å‡¦ç†ãƒ•ãƒ­ãƒ¼<a class="header-link" href="#chat-ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®å…¨å‡¦ç†ãƒ•ãƒ­ãƒ¼" title="Permanent link">&para;</a></h3>
<div class="flow-box">
<div class="box-title">ğŸ’¬ /chat ã®å‡¦ç†ãƒ•ãƒ­ãƒ¼ï¼ˆå®Œå…¨ç‰ˆï¼‰</div>
<div class="box-content">

<strong>POST /chat</strong> â†’ `{ "message": "ã“ã‚“ã«ã¡ã¯", "thread_id": "abc123" }`

<strong>ã‚¹ãƒ†ãƒƒãƒ—1: èªè¨¼ãƒã‚§ãƒƒã‚¯ï¼ˆGatewayçµŒç”±ã‹ã©ã†ã‹ã§åˆ†å²ï¼‰</strong>
<ul>
<li>**GatewayçµŒç”±ã®å ´åˆ**: å†…éƒ¨ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆX-Gateway-Verified, X-User-Id, X-Customer-Idï¼‰ã‚’ä¿¡é ¼</li>
<li>**ç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹ã®å ´åˆ**: å¾“æ¥ã®ãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼ã‚’å®Ÿè¡Œ</li>
</ul>


<pre class="codehilite"><code class="language-python">if request.headers.get(&quot;X-Gateway-Verified&quot;) == &quot;true&quot;:
    # Gateway ãŒèªè¨¼æ¸ˆã¿ â†’ å†…éƒ¨ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ä¿¡é ¼
    user_id = request.headers.get(&quot;X-User-Id&quot;)
    customer_id = request.headers.get(&quot;X-Customer-Id&quot;)
else:
    # å¾“æ¥ã®èªè¨¼
    user_info = authenticate_request(request)
</code></pre>



<strong>ã‚¹ãƒ†ãƒƒãƒ—2: ãƒ¬ãƒ¼ãƒˆåˆ¶é™ãƒã‚§ãƒƒã‚¯</strong>
<ul>
<li>1åˆ†60å›è¶…é â†’ ã‚¨ãƒ©ãƒ¼ã€Œãƒªã‚¯ã‚¨ã‚¹ãƒˆåˆ¶é™ã‚’è¶…ãˆã¾ã—ãŸã€</li>
<li>OK â†’ å‡¦ç†ç¶šè¡Œ</li>
</ul>

ğŸ’¡ ãªãœãƒ¬ãƒ¼ãƒˆåˆ¶é™ï¼Ÿ æ‚ªæ„ã®ã‚ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒAPIã‚’å¤§é‡ã«å©ã„ã¦ã‚µãƒ¼ãƒãƒ¼ã‚’ãƒ€ã‚¦ãƒ³ã•ã›ã‚‹ã“ã¨ã‚’é˜²ãã€‚AIå‘¼ã³å‡ºã—ã¯ãŠé‡‘ãŒã‹ã‹ã‚‹ã®ã§èª²é‡‘æ”»æ’ƒã‚‚é˜²ã

<strong>ã‚¹ãƒ†ãƒƒãƒ—3: å…¥åŠ›å€¤æ¤œè¨¼</strong>
<ul>
<li>ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒç©ºï¼Ÿ â†’ ã‚¨ãƒ©ãƒ¼</li>
<li>ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒ10,000æ–‡å­—è¶…ï¼Ÿ â†’ ã‚¨ãƒ©ãƒ¼ï¼ˆDoSå¯¾ç­–ï¼‰</li>
<li>thread_idã«å¤‰ãªæ–‡å­—ï¼Ÿ â†’ ã‚¨ãƒ©ãƒ¼ï¼ˆã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³å¯¾ç­–ï¼‰</li>
</ul>

<strong>ã‚¹ãƒ†ãƒƒãƒ—4: AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå–å¾—</strong>
<ul>
<li>é¡§å®¢IDã«ç´ã¥ã„ãŸã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’å–å¾—</li>
</ul>

<strong>ã‚¹ãƒ†ãƒƒãƒ—5: AIã‚’å‘¼ã³å‡ºã—ã¦ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°è¿”å´</strong>
<ul>
<li>Server-Sent Events (SSE) å½¢å¼ã§è¿”ã™</li>
<li>`data: å†…å®¹` ã®å½¢ã§é€ã‚‹ã¨ã€ãƒ–ãƒ©ã‚¦ã‚¶ãŒè‡ªå‹•ã§å—ã‘å–ã‚‹</li>
<li>`[DONE]` ã¯ã€Œã‚‚ã†çµ‚ã‚ã‚Šã ã‚ˆã€ã®åˆå›³</li>
</ul>

</div>
</div>

<h3 id="ã‚³ãƒ¼ãƒ‰å®Ÿéš›ã®æ§‹é€ ã«è¿‘ã„å½¢">ã‚³ãƒ¼ãƒ‰ï¼ˆå®Ÿéš›ã®æ§‹é€ ã«è¿‘ã„å½¢ï¼‰<a class="header-link" href="#ã‚³ãƒ¼ãƒ‰å®Ÿéš›ã®æ§‹é€ ã«è¿‘ã„å½¢" title="Permanent link">&para;</a></h3>
<pre class="codehilite"><code class="language-python"># main.py ã®æ§‹é€ ï¼ˆç°¡ç•¥åŒ–ã—ãŸã‚‚ã®ï¼‰

from flask import Flask, request, Response
from common.auth import authenticate_request
from common.rate_limiter import check_rate_limit

app = Flask(__name__)

# ========================================
# ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯: ã‚µãƒ¼ãƒãƒ¼ãŒç”Ÿãã¦ã‚‹ã‹ç¢ºèª
# ========================================
@app.route(&quot;/health&quot;, methods=[&quot;GET&quot;])
def health():
    &quot;&quot;&quot;ã‚µãƒ¼ãƒãƒ¼ç”Ÿå­˜ç¢ºèª&quot;&quot;&quot;
    return {&quot;status&quot;: &quot;healthy&quot;}


# ========================================
# ãƒãƒ£ãƒƒãƒˆAPI: ãƒ¡ã‚¤ãƒ³ã®æ©Ÿèƒ½
# ========================================
@app.route(&quot;/chat&quot;, methods=[&quot;POST&quot;])
def chat():
    &quot;&quot;&quot;ãƒãƒ£ãƒƒãƒˆAPIï¼ˆã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°å¯¾å¿œï¼‰&quot;&quot;&quot;

    # === ã‚¹ãƒ†ãƒƒãƒ—1: èªè¨¼ãƒã‚§ãƒƒã‚¯ ===
    try:
        user_info = authenticate_request(request)
    except ValueError as e:
        return {&quot;error&quot;: str(e)}, 401  # 401 = èªè¨¼ã‚¨ãƒ©ãƒ¼

    user_id = user_info[&quot;uid&quot;]
    customer_id = user_info[&quot;customer_id&quot;]

    # === ã‚¹ãƒ†ãƒƒãƒ—2: ãƒ¬ãƒ¼ãƒˆåˆ¶é™ãƒã‚§ãƒƒã‚¯ ===
    if not check_rate_limit(user_id):
        return {&quot;error&quot;: &quot;ãƒªã‚¯ã‚¨ã‚¹ãƒˆåˆ¶é™ã‚’è¶…ãˆã¾ã—ãŸã€‚1åˆ†å¾Œã«å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚&quot;}, 429

    # === ã‚¹ãƒ†ãƒƒãƒ—3: å…¥åŠ›å€¤æ¤œè¨¼ ===
    data = request.get_json()
    message = data.get(&quot;message&quot;, &quot;&quot;)
    thread_id = data.get(&quot;thread_id&quot;)

    # ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒç©º
    if not message.strip():
        return {&quot;error&quot;: &quot;ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒç©ºã§ã™&quot;}, 400

    # ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒé•·ã™ãã‚‹ï¼ˆDoSå¯¾ç­–ï¼‰
    if len(message) &gt; 10000:
        return {&quot;error&quot;: &quot;ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒé•·ã™ãã¾ã™ï¼ˆ10,000æ–‡å­—ã¾ã§ï¼‰&quot;}, 400

    # thread_idã®å½¢å¼ãƒã‚§ãƒƒã‚¯ï¼ˆã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³å¯¾ç­–ï¼‰
    if thread_id and not is_valid_thread_id(thread_id):
        return {&quot;error&quot;: &quot;thread_idã®å½¢å¼ãŒä¸æ­£ã§ã™&quot;}, 400

    # === ã‚¹ãƒ†ãƒƒãƒ—4: AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå–å¾— ===
    agent = get_agent(&quot;template&quot;, customer_id)

    # === ã‚¹ãƒ†ãƒƒãƒ—5: ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ã§è¿”ã™ ===
    def generate():
        &quot;&quot;&quot;AIã®å›ç­”ã‚’å°‘ã—ãšã¤è¿”ã™ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼&quot;&quot;&quot;
        try:
            for chunk in agent.run(message, thread_id, user_id):
                # Server-Sent Events å½¢å¼ã§è¿”ã™
                yield f&quot;data: {chunk}\n\n&quot;
            yield &quot;data: [DONE]\n\n&quot;
        except Exception as e:
            yield f&quot;data: ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {str(e)}\n\n&quot;
            yield &quot;data: [DONE]\n\n&quot;

    return Response(
        generate(),
        mimetype=&quot;text/event-stream&quot;,  # ã“ã‚ŒãŒSSEã®å°
        headers={
            &quot;Cache-Control&quot;: &quot;no-cache&quot;,     # ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã—ãªã„
            &quot;X-Accel-Buffering&quot;: &quot;no&quot;        # Nginxç”¨ã®ãƒãƒƒãƒ•ã‚¡ãƒªãƒ³ã‚°ç„¡åŠ¹åŒ–
        }
    )


def is_valid_thread_id(thread_id: str) -&gt; bool:
    &quot;&quot;&quot;thread_idã®å½¢å¼ã‚’æ¤œè¨¼ï¼ˆè‹±æ•°å­—ã€ãƒã‚¤ãƒ•ãƒ³ã€ã‚¢ãƒ³ãƒ€ãƒ¼ã‚¹ã‚³ã‚¢ã®ã¿ï¼‰&quot;&quot;&quot;
    import re
    return bool(re.match(r'^[a-zA-Z0-9_-]+$', thread_id))
</code></pre>

<hr />
<h2 id="3-authpy---èªè¨¼å‡¦ç†è¶…é‡è¦">3. auth.py - èªè¨¼å‡¦ç†ï¼ˆè¶…é‡è¦ï¼ï¼‰<a class="header-link" href="#3-authpy---èªè¨¼å‡¦ç†è¶…é‡è¦" title="Permanent link">&para;</a></h2>
<h3 id="ãªãœèªè¨¼ãŒå¿…è¦">ãªãœèªè¨¼ãŒå¿…è¦ï¼Ÿ<a class="header-link" href="#ãªãœèªè¨¼ãŒå¿…è¦" title="Permanent link">&para;</a></h3>
<div class="warning-box">
<div class="box-title">ğŸ” èªè¨¼ãŒãªã„ã¨ä½•ãŒèµ·ãã‚‹ï¼Ÿ</div>
<div class="box-content">

<strong>ã€èªè¨¼ãªã—ã®å ´åˆã€‘</strong>

æ‚ªã„äºº:ã€Œä¿ºã¯å±±ç”°ã ï¼ãƒ‡ãƒ¼ã‚¿è¦‹ã›ã‚ï¼ã€
ã‚µãƒ¼ãƒãƒ¼:ã€Œã¯ã„ã€ã©ã†ãã€

â†’ æƒ…å ±æ¼æ´©ï¼ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£äº‹æ•…ï¼æ–°èæ²™æ±°ï¼ğŸ˜±

<strong>ã€èªè¨¼ã‚ã‚Šã®å ´åˆã€‘</strong>

æ‚ªã„äºº:ã€Œä¿ºã¯å±±ç”°ã ï¼ãƒ‡ãƒ¼ã‚¿è¦‹ã›ã‚ï¼ã€
ã‚µãƒ¼ãƒãƒ¼:ã€Œèº«åˆ†è¨¼è¦‹ã›ã¦ã€
æ‚ªã„äºº:ã€Œ...æŒã£ã¦ãªã„ã€
ã‚µãƒ¼ãƒãƒ¼:ã€Œã˜ã‚ƒã‚ãƒ€ãƒ¡ã€

â†’ å®‰å…¨ï¼ğŸ˜Š

</div>
</div>

<h3 id="èªè¨¼ã®4ã¤ã®é–¢é–€è©³ç´°ç‰ˆ">èªè¨¼ã®4ã¤ã®é–¢é–€ï¼ˆè©³ç´°ç‰ˆï¼‰<a class="header-link" href="#èªè¨¼ã®4ã¤ã®é–¢é–€è©³ç´°ç‰ˆ" title="Permanent link">&para;</a></h3>
<div class="flow-box">
<div class="box-title">ğŸš¨ èªè¨¼ã®4ã¤ã®é–¢é–€</div>
<div class="box-content">

<strong>ãƒªã‚¯ã‚¨ã‚¹ãƒˆåˆ°ç€</strong> â†’ Headers: `{ "Authorization": "Bearer eyJhbGciOiJSUzI1NiIsInR5cCI6..." }`

<strong>é–¢é–€1: ãƒˆãƒ¼ã‚¯ãƒ³ãŒã‚ã‚‹ã‹ï¼Ÿ</strong>
<ul>
<li>`auth_header = request.headers.get("Authorization")`</li>
<li>ãªã„ â†’ ã‚¨ãƒ©ãƒ¼ã€Œèªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ãŒã‚ã‚Šã¾ã›ã‚“ã€</li>
<li>"Bearer "ã§å§‹ã¾ã‚‰ãªã„ â†’ ã‚¨ãƒ©ãƒ¼ã€Œèªè¨¼ãƒ˜ãƒƒãƒ€ãƒ¼ã®å½¢å¼ãŒä¸æ­£ã§ã™ã€</li>
<li>ğŸ’¡ "Bearer" = ã€ŒæŒã¡ä¸»ã€ã®æ„å‘³ã€‚ã€Œã“ã®ãƒˆãƒ¼ã‚¯ãƒ³ã‚’æŒã£ã¦ã‚‹äººã«æ¨©é™ã‚’ä¸ãˆã‚‹ã€å½¢å¼</li>
</ul>

<strong>é–¢é–€2: ãƒˆãƒ¼ã‚¯ãƒ³ã¯æœ¬ç‰©ã‹ï¼Ÿ</strong>
<ul>
<li>Firebase Admin SDK ã§æ¤œè¨¼</li>
<li>ç½²åã‚’Googleã®å…¬é–‹éµã§æ¤œè¨¼</li>
<li>æœ‰åŠ¹æœŸé™ãŒåˆ‡ã‚Œã¦ã„ãªã„ã‹ç¢ºèªï¼ˆ1æ™‚é–“ï¼‰</li>
<li>ãƒˆãƒ¼ã‚¯ãƒ³ã®ç™ºè¡Œè€…ãŒFirebaseã‹ç¢ºèª</li>
<li>check_revoked=True ãªã‚‰å¤±åŠ¹ãƒªã‚¹ãƒˆã‚‚ç¢ºèª</li>
</ul>

<strong>é–¢é–€3: ã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯è¨±å¯ã•ã‚Œã¦ã„ã‚‹ã‹ï¼Ÿ</strong>
<ul>
<li>Firestoreã® config/access_control ã‚’ç¢ºèª</li>
<li>è¨±å¯ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒªã‚¹ãƒˆ (@acme.co.jp ãªã©)</li>
<li>è¨±å¯ãƒ¡ãƒ¼ãƒ«ãƒªã‚¹ãƒˆ (tanaka@gmail.com ãªã©)</li>
<li>ã©ã¡ã‚‰ã‹ã«ãƒãƒƒãƒã™ã‚Œã°OK</li>
</ul>

<strong>é–¢é–€4: ã©ã®ä¼šç¤¾ã«æ‰€å±ã—ã¦ã„ã‚‹ã‹ï¼Ÿ</strong>
<ul>
<li>ã¾ãšCustom Claimsã« customer_id ãŒã‚ã‚‹ã‹ç¢ºèª â†’ ã‚ã‚Œã°ãã‚Œã‚’è¿”ã™</li>
<li>ãªã‘ã‚Œã°è‡ªå‹•æŒ¯ã‚Šåˆ†ã‘ã‚’è©¦è¡Œ â†’ ãƒ¡ãƒ¼ãƒ«ãƒ‰ãƒ¡ã‚¤ãƒ³ã‹ã‚‰é¡§å®¢ã‚’æ¤œç´¢</li>
<li>è¦‹ã¤ã‹ã£ãŸã‚‰è‡ªå‹•ã§Custom Claimsã‚’è¨­å®š</li>
<li>ã©ã¡ã‚‰ã«ã‚‚è©²å½“ã—ãªã‘ã‚Œã°ã‚¨ãƒ©ãƒ¼ â†’ ã€Œé¡§å®¢ã«ç´ä»˜ã‘ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€</li>
<li>ğŸ’¡ Custom Claims = IDãƒˆãƒ¼ã‚¯ãƒ³ã«è¿½åŠ ã§ãã‚‹å±æ€§ã€‚ã‚µãƒ¼ãƒãƒ¼ã§ã—ã‹è¨­å®šã§ããªã„ï¼ˆæ”¹ã–ã‚“ä¸å¯èƒ½ï¼‰</li>
</ul>

<strong>âœ… èªè¨¼æˆåŠŸï¼</strong> `{ "uid": "abc123", "email": "yamada@acme.co.jp", "name": "å±±ç”°å¤ªéƒ", "customer_id": "acme-corp" }`

</div>
</div>

<h3 id="ã‚³ãƒ¼ãƒ‰å®Ÿéš›ã®æ§‹é€ ã«è¿‘ã„å½¢_1">ã‚³ãƒ¼ãƒ‰ï¼ˆå®Ÿéš›ã®æ§‹é€ ã«è¿‘ã„å½¢ï¼‰<a class="header-link" href="#ã‚³ãƒ¼ãƒ‰å®Ÿéš›ã®æ§‹é€ ã«è¿‘ã„å½¢_1" title="Permanent link">&para;</a></h3>
<pre class="codehilite"><code class="language-python"># auth.py ã®ä¸»è¦ãªé–¢æ•°

from firebase_admin import auth
from common.firebase_init import get_firestore_client

db = get_firestore_client()


def authenticate_request(request) -&gt; dict:
    &quot;&quot;&quot;
    ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’èªè¨¼ã—ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’è¿”ã™

    Returns:
        dict: {uid, email, name, customer_id, ...}

    Raises:
        ValueError: èªè¨¼ã«å¤±æ•—ã—ãŸå ´åˆ
    &quot;&quot;&quot;

    # === é–¢é–€1: ãƒˆãƒ¼ã‚¯ãƒ³ãŒã‚ã‚‹ã‹ï¼Ÿ ===
    auth_header = request.headers.get(&quot;Authorization&quot;, &quot;&quot;)

    if not auth_header:
        raise ValueError(&quot;èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ãŒã‚ã‚Šã¾ã›ã‚“&quot;)

    # &quot;Bearer &quot; ã§å§‹ã¾ã£ã¦ã„ã‚‹ã‹ï¼Ÿ
    # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¸Šã€å½¢å¼ã‚’å³å¯†ã«ãƒã‚§ãƒƒã‚¯
    parts = auth_header.split(&quot; &quot;)
    if len(parts) != 2 or parts[0] != &quot;Bearer&quot;:
        raise ValueError(&quot;èªè¨¼ãƒ˜ãƒƒãƒ€ãƒ¼ã®å½¢å¼ãŒä¸æ­£ã§ã™&quot;)

    id_token = parts[1]

    # === é–¢é–€2: ãƒˆãƒ¼ã‚¯ãƒ³ã¯æœ¬ç‰©ã‹ï¼Ÿ ===
    try:
        # Firebase Admin SDK ã§ãƒˆãƒ¼ã‚¯ãƒ³ã‚’æ¤œè¨¼
        # check_revoked=True: ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå¾Œã®ãƒˆãƒ¼ã‚¯ãƒ³ä½¿ç”¨ã‚’é˜²ã
        user_info = auth.verify_id_token(id_token, check_revoked=True)

    except auth.RevokedIdTokenError:
        # ãƒˆãƒ¼ã‚¯ãƒ³ãŒå¤±åŠ¹æ¸ˆã¿ï¼ˆãƒ­ã‚°ã‚¢ã‚¦ãƒˆå¾Œãªã©ï¼‰
        raise ValueError(&quot;ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒç„¡åŠ¹ã§ã™ã€‚å†åº¦ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚&quot;)

    except auth.ExpiredIdTokenError:
        # ãƒˆãƒ¼ã‚¯ãƒ³ã®æœ‰åŠ¹æœŸé™åˆ‡ã‚Œï¼ˆ1æ™‚é–“ï¼‰
        raise ValueError(&quot;ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®æœ‰åŠ¹æœŸé™ãŒåˆ‡ã‚Œã¾ã—ãŸã€‚å†åº¦ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚&quot;)

    except auth.InvalidIdTokenError:
        # ãƒˆãƒ¼ã‚¯ãƒ³ãŒä¸æ­£ï¼ˆæ”¹ã–ã‚“ã€å½¢å¼ã‚¨ãƒ©ãƒ¼ãªã©ï¼‰
        raise ValueError(&quot;èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ãŒç„¡åŠ¹ã§ã™&quot;)

    # === é–¢é–€3: ã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯è¨±å¯ã•ã‚Œã¦ã„ã‚‹ã‹ï¼Ÿ ===
    email = user_info.get(&quot;email&quot;, &quot;&quot;)

    if not is_user_allowed(email):
        raise ValueError(f&quot;ã‚¢ã‚¯ã‚»ã‚¹ãŒè¨±å¯ã•ã‚Œã¦ã„ã¾ã›ã‚“: {email}&quot;)

    # === é–¢é–€4: é¡§å®¢IDã‚’å–å¾— ===
    uid = user_info[&quot;uid&quot;]
    customer_id = get_user_customer_id(uid, email)
    user_info[&quot;customer_id&quot;] = customer_id

    return user_info


def is_user_allowed(email: str) -&gt; bool:
    &quot;&quot;&quot;
    ã“ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯ã‚¢ã‚¯ã‚»ã‚¹è¨±å¯ã•ã‚Œã¦ã„ã‚‹ã‹ï¼Ÿ

    Firestoreã® config/access_control ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ç¢ºèª
    &quot;&quot;&quot;
    if not email:
        return False

    # Firestore ã‹ã‚‰è¨±å¯ãƒªã‚¹ãƒˆã‚’å–å¾—
    doc_ref = db.collection(&quot;config&quot;).document(&quot;access_control&quot;)
    doc = doc_ref.get()

    if not doc.exists:
        # è¨­å®šãŒãªã„å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§æ‹’å¦ï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å„ªå…ˆï¼‰
        return False

    data = doc.to_dict()
    allowed_emails = data.get(&quot;allowed_emails&quot;, [])
    allowed_domains = data.get(&quot;allowed_domains&quot;, [])

    # ãƒ¡ãƒ¼ãƒ«ãŒç›´æ¥è¨±å¯ã•ã‚Œã¦ã„ã‚‹ï¼Ÿ
    if email in allowed_emails:
        return True

    # ãƒ‰ãƒ¡ã‚¤ãƒ³ãŒè¨±å¯ã•ã‚Œã¦ã„ã‚‹ï¼Ÿ
    domain = email.split(&quot;@&quot;)[1] if &quot;@&quot; in email else &quot;&quot;
    if domain in allowed_domains:
        return True

    return False


def get_user_customer_id(uid: str, email: str = None) -&gt; str:
    &quot;&quot;&quot;
    ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®é¡§å®¢IDã‚’å–å¾—ï¼ˆè‡ªå‹•æŒ¯ã‚Šåˆ†ã‘å¯¾å¿œï¼‰

    1. Custom Claims ã« customer_id ãŒã‚ã‚Œã°ãã‚Œã‚’è¿”ã™
    2. ãªã‘ã‚Œã°ãƒ¡ãƒ¼ãƒ«ãƒ‰ãƒ¡ã‚¤ãƒ³ã‹ã‚‰è‡ªå‹•æ¤œç´¢ãƒ»è¨­å®š
    &quot;&quot;&quot;

    # Firebase Auth ã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—
    user = auth.get_user(uid)
    claims = user.custom_claims or {}

    # æ—¢ã« customer_id ãŒã‚ã‚‹å ´åˆ
    if claims.get(&quot;customer_id&quot;):
        return claims[&quot;customer_id&quot;]

    # è‡ªå‹•æŒ¯ã‚Šåˆ†ã‘ã‚’è©¦è¡Œ
    if email:
        customer_id = auto_assign_customer(uid, email)
        if customer_id:
            return customer_id

    # ã©ã¡ã‚‰ã«ã‚‚è©²å½“ã—ãªã„
    raise ValueError(&quot;é¡§å®¢ã«ç´ä»˜ã‘ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ç®¡ç†è€…ã«é€£çµ¡ã—ã¦ãã ã•ã„ã€‚&quot;)


def auto_assign_customer(uid: str, email: str) -&gt; str | None:
    &quot;&quot;&quot;
    ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‹ã‚‰é¡§å®¢ã‚’è‡ªå‹•æ¤œç´¢ã—ã€ç´ä»˜ã‘ã‚‹

    Returns:
        str | None: ç´ä»˜ã‘ã«æˆåŠŸã—ãŸå ´åˆã¯ customer_idã€å¤±æ•—ã—ãŸå ´åˆã¯ None
    &quot;&quot;&quot;
    domain = email.split(&quot;@&quot;)[1] if &quot;@&quot; in email else &quot;&quot;

    # é¡§å®¢ã‚’æ¤œç´¢
    customers_ref = db.collection(&quot;customers&quot;)

    # 1. ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã§ç›´æ¥æ¤œç´¢
    query = customers_ref.where(&quot;allowed_emails&quot;, &quot;array_contains&quot;, email)
    docs = list(query.stream())
    if docs:
        customer_id = docs[0].id
        _set_customer_id_claim(uid, customer_id)
        return customer_id

    # 2. ãƒ‰ãƒ¡ã‚¤ãƒ³ã§æ¤œç´¢
    query = customers_ref.where(&quot;allowed_domains&quot;, &quot;array_contains&quot;, domain)
    docs = list(query.stream())
    if docs:
        customer_id = docs[0].id
        _set_customer_id_claim(uid, customer_id)
        return customer_id

    return None


def _set_customer_id_claim(uid: str, customer_id: str):
    &quot;&quot;&quot;Custom Claims ã« customer_id ã‚’è¨­å®š&quot;&quot;&quot;
    auth.set_custom_user_claims(uid, {&quot;customer_id&quot;: customer_id})
</code></pre>

<hr />
<h2 id="4-agentpy---aiã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ">4. agent.py - AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ<a class="header-link" href="#4-agentpy---aiã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ" title="Permanent link">&para;</a></h2>
<h3 id="aiã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã£ã¦ä½•">AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã£ã¦ä½•ï¼Ÿ<a class="header-link" href="#aiã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã£ã¦ä½•" title="Permanent link">&para;</a></h3>
<div class="info-box">
<div class="box-title">ğŸ¤– AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ = AIã‚’ä½¿ã„ã‚„ã™ãã™ã‚‹ãƒ©ãƒƒãƒ‘ãƒ¼</div>
<div class="box-content">

<strong>ã€AIã‚’ç›´æ¥ä½¿ã†å ´åˆã€‘</strong>

æ¯å›ã“ã‚Œã‚’æ›¸ãå¿…è¦ãŒã‚ã‚‹:
<ul>
<li>ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’è¨­å®š</li>
<li>ä¼šè©±å±¥æ­´ã‚’å–å¾—</li>
<li>AIã«é€ä¿¡</li>
<li>çµæœã‚’ä¿å­˜</li>
</ul>
...é¢å€’ï¼ğŸ˜µ

<strong>ã€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’ä½¿ã†å ´åˆã€‘</strong>

`agent.run("è³ªå•", thread_id)`
â†‘
ã“ã‚Œã ã‘ï¼ä¸­èº«ã¯å…¨éƒ¨ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒã‚„ã£ã¦ãã‚Œã‚‹ ğŸ˜Š

</div>
</div>

<h3 id="ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®æ§‹é€ ">ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®æ§‹é€ <a class="header-link" href="#ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®æ§‹é€ " title="Permanent link">&para;</a></h3>
<div class="architecture-box">
<div class="box-title">ğŸ—ï¸ ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®æ§‹é€ </div>
<div class="box-content">


<pre class="codehilite"><code>TemplateAgentï¼ˆå®Ÿéš›ã«ä½¿ã†ã‚„ã¤ï¼‰
    â†“ ç¶™æ‰¿
BaseAgentï¼ˆå…±é€šæ©Ÿèƒ½ã‚’æŒã¤ï¼‰
  - LLMåˆæœŸåŒ–
  - ã‚°ãƒ©ãƒ•æ§‹ç¯‰
  - run() ãƒ¡ã‚½ãƒƒãƒ‰
    â†“ ä½¿ç”¨
FirestoreCheckpointerï¼ˆä¼šè©±å±¥æ­´ã‚’ä¿å­˜ï¼‰
</code></pre>



ğŸ’¡ ãªãœã“ã‚“ãªæ§‹é€ ï¼Ÿ å…±é€šå‡¦ç†ã¯ BaseAgent ã«ã€å€‹åˆ¥ã®æ€§æ ¼ã¯ TemplateAgent ã«ã™ã‚‹ã¨ã€æ–°ã—ã„ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’è¿½åŠ ã™ã‚‹ã®ãŒæ¥½ï¼

</div>
</div>

<h3 id="system_prompt---aiã®æ€§æ ¼">SYSTEM_PROMPT - AIã®ã€Œæ€§æ ¼ã€<a class="header-link" href="#system_prompt---aiã®æ€§æ ¼" title="Permanent link">&para;</a></h3>
<div class="tip-box">
<div class="box-title">ğŸ­ SYSTEM_PROMPT ã§AIã®æ€§æ ¼ã‚’æ±ºã‚ã‚‹</div>
<div class="box-content">

<strong>ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã€‘</strong>

<pre class="codehilite"><code>ã‚ãªãŸã¯è¦ªåˆ‡ã§ä¸å¯§ãªAIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚
ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è³ªå•ã«å¯¾ã—ã¦ã€ã‚ã‹ã‚Šã‚„ã™ãç°¡æ½”ã«å›ç­”ã—ã¦ãã ã•ã„ã€‚
æ—¥æœ¬èªã§å›ç­”ã—ã¦ãã ã•ã„ã€‚
</code></pre>



<strong>ã€é–¢è¥¿å¼ã«å¤‰ãˆã‚‹ã¨...ã€‘</strong>

<pre class="codehilite"><code>ã‚ãªãŸã¯é–¢è¥¿å¼ã§è©±ã™AIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã‚„ã§ã€‚
ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è³ªå•ã«ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼ã«ç­”ãˆã¦ãªã€‚
ã€Œã‚„ã§ã€ã€Œã‚„ã‚“ã€ã€Œãªã‚“ã§ã‚„ã­ã‚“ã€ã‚’ä½¿ã£ã¦ãªã€‚
</code></pre>



â†’ åŒã˜è³ªå•ã§ã‚‚ã€è¿”ç­”ã®ã‚¹ã‚¿ã‚¤ãƒ«ãŒå¤‰ã‚ã‚‹ï¼

</div>
</div>

<h3 id="ã‚³ãƒ¼ãƒ‰å®Ÿéš›ã®æ§‹é€ ã«è¿‘ã„å½¢_2">ã‚³ãƒ¼ãƒ‰ï¼ˆå®Ÿéš›ã®æ§‹é€ ã«è¿‘ã„å½¢ï¼‰<a class="header-link" href="#ã‚³ãƒ¼ãƒ‰å®Ÿéš›ã®æ§‹é€ ã«è¿‘ã„å½¢_2" title="Permanent link">&para;</a></h3>
<pre class="codehilite"><code class="language-python"># agent.py ã®ä¸»è¦éƒ¨åˆ†

from langchain_google_vertexai import ChatVertexAI
from langgraph.graph import StateGraph, MessagesState

# =============================================
# â˜… ã“ã“ã‚’ç·¨é›†ã—ã¦AIã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º
# =============================================

# AIã®æ€§æ ¼ãƒ»å½¹å‰²
SYSTEM_PROMPT = &quot;&quot;&quot;ã‚ãªãŸã¯è¦ªåˆ‡ã§ä¸å¯§ãªAIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚
ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è³ªå•ã«å¯¾ã—ã¦ã€ã‚ã‹ã‚Šã‚„ã™ãç°¡æ½”ã«å›ç­”ã—ã¦ãã ã•ã„ã€‚
æ—¥æœ¬èªã§å›ç­”ã—ã¦ãã ã•ã„ã€‚&quot;&quot;&quot;

# ä½¿ç”¨ã™ã‚‹ãƒ¢ãƒ‡ãƒ«
MODEL_NAME = &quot;gemini-1.5-flash&quot;

# ä¼šè©±å±¥æ­´ã®æœ€å¤§æ•°ï¼ˆå¤šã„ã»ã©ã‚³ã‚¹ãƒˆãŒã‹ã‹ã‚‹ï¼‰
MAX_HISTORY_MESSAGES = 20  # ç´„10å¾€å¾©åˆ†


class TemplateAgent(BaseAgent):
    &quot;&quot;&quot;ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆQ&amp;Aã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ&quot;&quot;&quot;

    def __init__(self, customer_id: str, user_id: str):
        &quot;&quot;&quot;
        Args:
            customer_id: é¡§å®¢IDï¼ˆãƒ‡ãƒ¼ã‚¿åˆ†é›¢ç”¨ï¼‰
            user_id: ãƒ¦ãƒ¼ã‚¶ãƒ¼IDï¼ˆä¼šè©±å±¥æ­´ç®¡ç†ç”¨ï¼‰
        &quot;&quot;&quot;
        self.customer_id = customer_id
        self.user_id = user_id

        # LLMï¼ˆLarge Language Modelï¼‰ã‚’åˆæœŸåŒ–
        self.llm = ChatVertexAI(
            model=MODEL_NAME,
            temperature=0.7,  # 0=ç¢ºå®Ÿãªå›ç­”ã€1=å‰µé€ çš„ãªå›ç­”
            max_output_tokens=2048,
            streaming=True,  # ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°æœ‰åŠ¹
        )

        # ä¼šè©±å±¥æ­´ä¿å­˜ç”¨ã®ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ã‚¿ãƒ¼
        self.checkpointer = FirestoreCheckpointer(
            db=get_firestore_client(),
            customer_id=customer_id
        )

        # ã‚°ãƒ©ãƒ•ã‚’æ§‹ç¯‰
        self.graph = self._build_graph()

    def _build_graph(self):
        &quot;&quot;&quot;
        LangGraphã®ã‚°ãƒ©ãƒ•ã‚’æ§‹ç¯‰

        LangGraph = AIã®å‡¦ç†ãƒ•ãƒ­ãƒ¼ã‚’ã€Œã‚°ãƒ©ãƒ•ã€ã¨ã—ã¦å®šç¾©ã™ã‚‹ãƒ©ã‚¤ãƒ–ãƒ©ãƒª
        &quot;&quot;&quot;
        # ã‚°ãƒ©ãƒ•ã‚’ä½œæˆ
        builder = StateGraph(MessagesState)

        # ãƒãƒ¼ãƒ‰ã‚’è¿½åŠ ï¼ˆå‡¦ç†ã®ã‚¹ãƒ†ãƒƒãƒ—ï¼‰
        builder.add_node(&quot;chat&quot;, self._chat_node)

        # ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆã‚’è¨­å®š
        builder.set_entry_point(&quot;chat&quot;)

        # çµ‚äº†ãƒãƒ¼ãƒ‰ã‚’è¨­å®š
        builder.set_finish_point(&quot;chat&quot;)

        # ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã—ã¦ã‚°ãƒ©ãƒ•ã‚’ç¢ºå®š
        return builder.compile(checkpointer=self.checkpointer)

    async def _chat_node(self, state: MessagesState) -&gt; dict:
        &quot;&quot;&quot;
        ãƒãƒ£ãƒƒãƒˆå‡¦ç†ã®ãƒ¡ã‚¤ãƒ³ãƒ­ã‚¸ãƒƒã‚¯

        Args:
            state: ç¾åœ¨ã®ä¼šè©±çŠ¶æ…‹ï¼ˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å±¥æ­´ã‚’å«ã‚€ï¼‰

        Returns:
            dict: æ–°ã—ã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å«ã‚€çŠ¶æ…‹
        &quot;&quot;&quot;
        messages = state[&quot;messages&quot;]

        # ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’å…ˆé ­ã«è¿½åŠ 
        full_messages = [
            {&quot;role&quot;: &quot;system&quot;, &quot;content&quot;: SYSTEM_PROMPT},
            *messages[-MAX_HISTORY_MESSAGES:]  # å±¥æ­´ã‚’åˆ¶é™
        ]

        # Gemini ã«å•ã„åˆã‚ã›
        response = await self.llm.ainvoke(full_messages)

        return {&quot;messages&quot;: [response]}

    def run(self, message: str, thread_id: str = None, user_id: str = None):
        &quot;&quot;&quot;
        ãƒãƒ£ãƒƒãƒˆã‚’å®Ÿè¡Œï¼ˆã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ï¼‰

        Args:
            message: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
            thread_id: ä¼šè©±ã®IDï¼ˆæ–°è¦ã®å ´åˆã¯è‡ªå‹•ç”Ÿæˆï¼‰
            user_id: ãƒ¦ãƒ¼ã‚¶ãƒ¼ID

        Yields:
            str: AIã®è¿”ç­”ï¼ˆå°‘ã—ãšã¤ï¼‰
        &quot;&quot;&quot;
        # thread_id ãŒãªã‘ã‚Œã°ç”Ÿæˆ
        if not thread_id:
            thread_id = f&quot;{user_id}_{uuid.uuid4().hex[:8]}&quot;

        # è¨­å®š
        config = {
            &quot;configurable&quot;: {
                &quot;thread_id&quot;: thread_id,
            }
        }

        # å…¥åŠ›
        input_data = {
            &quot;messages&quot;: [
                {&quot;role&quot;: &quot;user&quot;, &quot;content&quot;: message}
            ]
        }

        # ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°å®Ÿè¡Œ
        for event in self.graph.stream(input_data, config, stream_mode=&quot;values&quot;):
            # æœ€å¾Œã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å–å¾—
            if event.get(&quot;messages&quot;):
                last_message = event[&quot;messages&quot;][-1]
                if hasattr(last_message, &quot;content&quot;):
                    yield last_message.content
</code></pre>

<div class="tip-box">
<div class="box-title">ğŸ“– ã‚‚ã£ã¨è©³ã—ãçŸ¥ã‚ŠãŸã„æ–¹ã¸</div>
<div class="box-content">

agent.py ã®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºãƒ«ãƒ¼ãƒ«ã‚’è©³ã—ãè§£èª¬ã—ãŸä»˜éŒ²ãŒã‚ã‚Šã¾ã™:

<p style="margin: 16px 0;">â†’ <a href="03_ä»˜éŒ²_agent.pyã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º.html" style="color: #3b82f6; font-weight: bold;">ä»˜éŒ²: agent.py ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã‚¬ã‚¤ãƒ‰</a></p>

<ul>
<li>åˆå­¦è€…ã€œä¸Šç´šè€…ã¾ã§å¯¾å¿œ</li>
<li>ã€Œã“ã“ã¯è§¦ã£ã¦ã„ã„ / ãƒ€ãƒ¡ã€ãŒä¸€ç›®ã§ã‚ã‹ã‚‹è¡¨</li>
<li>ãƒšãƒ«ã‚½ãƒŠåˆ¥ã‚¢ãƒ‰ãƒã‚¤ã‚¹ï¼ˆåˆå­¦è€…ãƒ»ãƒ™ãƒ†ãƒ©ãƒ³ãƒ»PMãƒ»å­¦ç”Ÿï¼‰</li>
</ul>

</div>
</div>

<hr />
<h2 id="5-firestore_checkpointerpy---ä¼šè©±å±¥æ­´ä¿å­˜">5. firestore_checkpointer.py - ä¼šè©±å±¥æ­´ä¿å­˜<a class="header-link" href="#5-firestore_checkpointerpy---ä¼šè©±å±¥æ­´ä¿å­˜" title="Permanent link">&para;</a></h2>
<h3 id="ãªãœä¼šè©±å±¥æ­´ãŒå¿…è¦">ãªãœä¼šè©±å±¥æ­´ãŒå¿…è¦ï¼Ÿ<a class="header-link" href="#ãªãœä¼šè©±å±¥æ­´ãŒå¿…è¦" title="Permanent link">&para;</a></h3>
<div class="info-box">
<div class="box-title">ğŸ’¾ ä¼šè©±å±¥æ­´ãŒãªã„ã¨...</div>
<div class="box-content">

<strong>ã€å±¥æ­´ãªã—ã€‘</strong>

ãƒ¦ãƒ¼ã‚¶ãƒ¼: ã€Œç§ã®åå‰ã¯å±±ç”°ã§ã™ã€
AI: ã€Œå±±ç”°ã•ã‚“ã€ã“ã‚“ã«ã¡ã¯ï¼ã€

ãƒ¦ãƒ¼ã‚¶ãƒ¼: ã€Œç§ã®åå‰ã¯ä½•ã§ã—ãŸã‹ï¼Ÿã€
AI: ã€Œã™ã¿ã¾ã›ã‚“ã€ã‚ã‹ã‚Šã¾ã›ã‚“ã€ â† å¿˜ã‚Œã¦ã‚‹ï¼ğŸ˜±

<strong>ã€å±¥æ­´ã‚ã‚Šã€‘</strong>

ãƒ¦ãƒ¼ã‚¶ãƒ¼: ã€Œç§ã®åå‰ã¯å±±ç”°ã§ã™ã€
AI: ã€Œå±±ç”°ã•ã‚“ã€ã“ã‚“ã«ã¡ã¯ï¼ã€

ãƒ¦ãƒ¼ã‚¶ãƒ¼: ã€Œç§ã®åå‰ã¯ä½•ã§ã—ãŸã‹ï¼Ÿã€
AI: ã€Œå±±ç”°ã•ã‚“ã§ã™ã­ï¼ã€ â† è¦šãˆã¦ã‚‹ï¼ğŸ˜Š

</div>
</div>

<h3 id="firestore-ã®ãƒ‡ãƒ¼ã‚¿æ§‹é€ ">Firestore ã®ãƒ‡ãƒ¼ã‚¿æ§‹é€ <a class="header-link" href="#firestore-ã®ãƒ‡ãƒ¼ã‚¿æ§‹é€ " title="Permanent link">&para;</a></h3>
<div class="architecture-box">
<div class="box-title">ğŸ“ Firestore ã®ãƒ‡ãƒ¼ã‚¿æ§‹é€ </div>
<div class="box-content">


<pre class="codehilite"><code>Firestore
â””â”€â”€ customers/                    â† é¡§å®¢ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³
    â”œâ”€â”€ acme-corp/                â† é¡§å®¢ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
    â”‚   â”œâ”€â”€ name: &quot;æ ªå¼ä¼šç¤¾ACME&quot;
    â”‚   â”œâ”€â”€ allowed_domains: [&quot;acme.co.jp&quot;]
    â”‚   â””â”€â”€ checkpoints/          â† ä¼šè©±å±¥æ­´ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³
    â”‚       â”œâ”€â”€ user1_abc123/     â† ä¼šè©±1ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
    â”‚       â”‚   â””â”€â”€ checkpoints/  â† ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆã‚µãƒ–ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³
    â”‚       â”‚       â”œâ”€â”€ cp_1: {messages: [...], timestamp: ...}
    â”‚       â”‚       â””â”€â”€ cp_2: {...}
    â”‚       â””â”€â”€ user1_def456/     â† ä¼šè©±2ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
    â”‚           â””â”€â”€ ...
    â””â”€â”€ beta-inc/                 â† åˆ¥ã®é¡§å®¢
        â””â”€â”€ ...
</code></pre>



ğŸ’¡ customer_id ã§ãƒ‘ã‚¹ã‚’åˆ†ã‘ã‚‹ã“ã¨ã§ã€Aç¤¾ãŒBç¤¾ã®ãƒ‡ãƒ¼ã‚¿ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã“ã¨ã‚’é˜²ã

</div>
</div>

<hr />
<h2 id="é‡è¦ãªæ¦‚å¿µ">é‡è¦ãªæ¦‚å¿µ<a class="header-link" href="#é‡è¦ãªæ¦‚å¿µ" title="Permanent link">&para;</a></h2>
<h3 id="asyncawaitéåŒæœŸå‡¦ç†">async/awaitï¼ˆéåŒæœŸå‡¦ç†ï¼‰<a class="header-link" href="#asyncawaitéåŒæœŸå‡¦ç†" title="Permanent link">&para;</a></h3>
<div class="info-box">
<div class="box-title">âš¡ async/await ã‚’å®Œå…¨ç†è§£</div>
<div class="box-content">

<strong>ã€GASã®å ´åˆï¼ˆåŒæœŸå‡¦ç†ï¼‰ã€‘</strong>

<pre class="codehilite"><code class="language-javascript">function fetchData() {
  var response = UrlFetchApp.fetch(url);  // ã“ã“ã§æ­¢ã¾ã‚‹
  var data = response.getContentText();   // çµ‚ã‚ã‚‹ã¾ã§å¾…ã¤
  return data;
}
</code></pre>


â†’ å‡¦ç†Aã‚’å¾…ã£ã¦ã„ã‚‹é–“ã€å‡¦ç†BãŒã§ããªã„

<strong>ã€Python/TypeScriptã®å ´åˆï¼ˆéåŒæœŸå‡¦ç†ï¼‰ã€‘</strong>

<pre class="codehilite"><code class="language-python">async def fetch_data():
    response = await aiohttp.get(url)  # å¾…ã¤ã‘ã©ä»–ã®å‡¦ç†å¯
    data = await response.text()
    return data
</code></pre>


â†’ å‡¦ç†Aã‚’å¾…ã£ã¦ã„ã‚‹é–“ã«ã€å‡¦ç†Bã‚’é€²ã‚ã‚‰ã‚Œã‚‹

<strong>ã€ã‚¤ãƒ¡ãƒ¼ã‚¸ã€‘</strong>
<ul>
<li>åŒæœŸ : æ–™ç†ã®æ³¨æ–‡ â†’ å¾…ã¤ â†’ å—ã‘å–ã‚Š â†’ æ¬¡ã®æ³¨æ–‡</li>
<li>éåŒæœŸ : æ–™ç†ã®æ³¨æ–‡ â†’ æ¬¡ã®æ³¨æ–‡ â†’ æ¬¡ã®æ³¨æ–‡ â†’ æœ€åˆã®æ–™ç†å—ã‘å–ã‚Š</li>
</ul>

ğŸ’¡ AIã®å›ç­”ã‚’å¾…ã¤é–“ã€ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å‡¦ç†ã§ãã‚‹

</div>
</div>

<h3 id="ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼yield">ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼ï¼ˆyieldï¼‰<a class="header-link" href="#ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼yield" title="Permanent link">&para;</a></h3>
<div class="info-box">
<div class="box-title">ğŸŒŠ yieldï¼ˆã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼ï¼‰ã‚’å®Œå…¨ç†è§£</div>
<div class="box-content">

<strong>ã€æ™®é€šã®é–¢æ•°ã€‘</strong>

<pre class="codehilite"><code class="language-python">def get_numbers():
    return [1, 2, 3, 4, 5]  # å…¨éƒ¨ã¾ã¨ã‚ã¦è¿”ã™

result = get_numbers()  # [1, 2, 3, 4, 5] ãŒä¸€åº¦ã«æ¥ã‚‹
</code></pre>



<strong>ã€ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼ï¼ˆyieldä½¿ç”¨ï¼‰ã€‘</strong>

<pre class="codehilite"><code class="language-python">def get_numbers():
    yield 1  # 1ã‚’è¿”ã—ã¦ã€ã“ã“ã§ä¸€æ™‚åœæ­¢
    yield 2  # æ¬¡ã«å‘¼ã°ã‚ŒãŸã‚‰2ã‚’è¿”ã—ã¦ã€ã¾ãŸä¸€æ™‚åœæ­¢
    yield 3
    yield 4
    yield 5

for num in get_numbers():
    print(num)  # 1, 2, 3, 4, 5 ãŒé †ç•ªã«æ¥ã‚‹
</code></pre>



<strong>ã€ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ã§ã®æ´»ç”¨ã€‘</strong>

<pre class="codehilite"><code class="language-python">def stream_response():
    yield &quot;ã“ã‚“&quot;    # ãƒ–ãƒ©ã‚¦ã‚¶ã«ã€Œã“ã‚“ã€ãŒè¡¨ç¤º
    yield &quot;ã«ã¡&quot;    # ãƒ–ãƒ©ã‚¦ã‚¶ã«ã€Œã«ã¡ã€ãŒè¿½åŠ è¡¨ç¤º
    yield &quot;ã¯&quot;      # ãƒ–ãƒ©ã‚¦ã‚¶ã«ã€Œã¯ã€ãŒè¿½åŠ è¡¨ç¤º
</code></pre>


â†’ å…¨éƒ¨ã§ãã‚‹ã®ã‚’å¾…ãŸãšã«ã€ã§ããŸåˆ†ã‹ã‚‰è¡¨ç¤ºï¼

</div>
</div>

<h3 id="ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿ãƒ¼">ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿ãƒ¼ï¼ˆ@ï¼‰<a class="header-link" href="#ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿ãƒ¼" title="Permanent link">&para;</a></h3>
<div class="info-box">
<div class="box-title">ğŸ€ ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿ãƒ¼ã‚’å®Œå…¨ç†è§£</div>
<div class="box-content">

<strong>ã€ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿ãƒ¼ã£ã¦ä½•ï¼Ÿã€‘</strong>
é–¢æ•°ã«ã€Œè¿½åŠ æ©Ÿèƒ½ã€ã‚’ã¤ã‘ã‚‹ä»•çµ„ã¿ã€‚`@something` ã‚’é–¢æ•°ã®å‰ã«æ›¸ã

<strong>ã€ã‚ˆãè¦‹ã‚‹ãƒ‘ã‚¿ãƒ¼ãƒ³ã€‘</strong>

<pre class="codehilite"><code class="language-python">@app.route(&quot;/chat&quot;, methods=[&quot;POST&quot;])
def chat():
    ...
</code></pre>



â†‘ ã“ã‚Œã¯ä»¥ä¸‹ã¨åŒã˜æ„å‘³:

<pre class="codehilite"><code class="language-python">def chat():
    ...
chat = app.route(&quot;/chat&quot;, methods=[&quot;POST&quot;])(chat)
</code></pre>



<strong>ã€ã‚¤ãƒ¡ãƒ¼ã‚¸ã€‘</strong>
ãƒ—ãƒ¬ã‚¼ãƒ³ãƒˆã« ãƒªãƒœãƒ³ ã‚’ã¤ã‘ã‚‹
   â†‘           â†‘
 é–¢æ•°     ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿ãƒ¼

ä¸­èº«ï¼ˆé–¢æ•°ï¼‰ã¯åŒã˜ã ã‘ã©ã€è¦‹ãŸç›®ï¼ˆæ©Ÿèƒ½ï¼‰ãŒå¤‰ã‚ã‚‹

`@app.route(...)` â†’ ã€Œã“ã®é–¢æ•°ã‚’URLã«ç´ã¥ã‘ã‚‹ã€æ©Ÿèƒ½ã‚’è¿½åŠ 

</div>
</div>

<hr />
<h2 id="ã‚ˆãã‚ã‚‹ã‚¨ãƒ©ãƒ¼ã¨å¯¾å‡¦æ³•">ã‚ˆãã‚ã‚‹ã‚¨ãƒ©ãƒ¼ã¨å¯¾å‡¦æ³•<a class="header-link" href="#ã‚ˆãã‚ã‚‹ã‚¨ãƒ©ãƒ¼ã¨å¯¾å‡¦æ³•" title="Permanent link">&para;</a></h2>
<table>
<thead>
<tr>
<th>ã‚¨ãƒ©ãƒ¼</th>
<th>åŸå› </th>
<th>å¯¾å‡¦</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ãŒã‚ã‚Šã¾ã›ã‚“</code></td>
<td>Authorizationãƒ˜ãƒƒãƒ€ãƒ¼ãŒãªã„</td>
<td>ãƒ­ã‚°ã‚¤ãƒ³ã—ç›´ã™</td>
</tr>
<tr>
<td><code>èªè¨¼ãƒ˜ãƒƒãƒ€ãƒ¼ã®å½¢å¼ãŒä¸æ­£ã§ã™</code></td>
<td>Bearerå½¢å¼ã§ãªã„</td>
<td>ãƒ­ã‚°ã‚¤ãƒ³ã—ç›´ã™</td>
</tr>
<tr>
<td><code>ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒç„¡åŠ¹ã§ã™</code></td>
<td>ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå¾Œã®ãƒˆãƒ¼ã‚¯ãƒ³ä½¿ç”¨</td>
<td>å†ãƒ­ã‚°ã‚¤ãƒ³</td>
</tr>
<tr>
<td><code>ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®æœ‰åŠ¹æœŸé™ãŒåˆ‡ã‚Œã¾ã—ãŸ</code></td>
<td>ãƒˆãƒ¼ã‚¯ãƒ³ãŒ1æ™‚é–“è¶…é</td>
<td>ãƒšãƒ¼ã‚¸ãƒªãƒ­ãƒ¼ãƒ‰</td>
</tr>
<tr>
<td><code>èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ãŒç„¡åŠ¹ã§ã™</code></td>
<td>æ”¹ã–ã‚“ã•ã‚ŒãŸãƒˆãƒ¼ã‚¯ãƒ³</td>
<td>å†ãƒ­ã‚°ã‚¤ãƒ³</td>
</tr>
<tr>
<td><code>ã‚¢ã‚¯ã‚»ã‚¹ãŒè¨±å¯ã•ã‚Œã¦ã„ã¾ã›ã‚“</code></td>
<td>è¨±å¯ãƒªã‚¹ãƒˆã«ãªã„</td>
<td>ç®¡ç†è€…ã«é€£çµ¡</td>
</tr>
<tr>
<td><code>é¡§å®¢ã«ç´ä»˜ã‘ã•ã‚Œã¦ã„ã¾ã›ã‚“</code></td>
<td>è‡ªå‹•æŒ¯ã‚Šåˆ†ã‘ã«ã‚‚ãƒãƒƒãƒã—ãªã„</td>
<td>ç®¡ç†è€…ã«é€£çµ¡</td>
</tr>
<tr>
<td><code>ãƒªã‚¯ã‚¨ã‚¹ãƒˆåˆ¶é™ã‚’è¶…ãˆã¾ã—ãŸ</code></td>
<td>1åˆ†60å›è¶…é</td>
<td>1åˆ†å¾…ã¤</td>
</tr>
<tr>
<td><code>ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒé•·ã™ãã¾ã™</code></td>
<td>10,000æ–‡å­—è¶…é</td>
<td>çŸ­ãã™ã‚‹</td>
</tr>
<tr>
<td><code>thread_idã®å½¢å¼ãŒä¸æ­£ã§ã™</code></td>
<td>å¤‰ãªæ–‡å­—ãŒå…¥ã£ã¦ã„ã‚‹</td>
<td>thread_idã‚’æŒ‡å®šã—ãªã„</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="ç†è§£åº¦ãƒã‚§ãƒƒã‚¯">ç†è§£åº¦ãƒã‚§ãƒƒã‚¯<a class="header-link" href="#ç†è§£åº¦ãƒã‚§ãƒƒã‚¯" title="Permanent link">&para;</a></h2>
<p>ä»¥ä¸‹ã®è³ªå•ã«ç­”ãˆã‚‰ã‚ŒãŸã‚‰ã€ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã¯ãƒãƒƒãƒãƒªï¼</p>
<table>
<thead>
<tr>
<th>è³ªå•</th>
<th>è‡ªä¿¡ã‚ã‚Š?</th>
</tr>
</thead>
<tbody>
<tr>
<td>main.py ã® /chat ã¯ã©ã‚“ãªé †ç•ªã§å‡¦ç†ã‚’è¡Œã†ï¼Ÿ</td>
<td>â–¡</td>
</tr>
<tr>
<td>èªè¨¼ã§ã€Œ4ã¤ã®é–¢é–€ã€ã¨ã¯ä½•ï¼Ÿ</td>
<td>â–¡</td>
</tr>
<tr>
<td>SYSTEM_PROMPT ã‚’å¤‰ãˆã‚‹ã¨ã©ã†ãªã‚‹ï¼Ÿ</td>
<td>â–¡</td>
</tr>
<tr>
<td>yield ã¨ return ã®é•ã„ã¯ï¼Ÿ</td>
<td>â–¡</td>
</tr>
<tr>
<td>ãªãœ customer_id ã§ãƒ‡ãƒ¼ã‚¿ã‚’åˆ†ã‘ã¦ã„ã‚‹ï¼Ÿ</td>
<td>â–¡</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—">æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—<a class="header-link" href="#æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—" title="Permanent link">&para;</a></h2>
<div class="summary-box">
<div class="box-title">âœ… ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®ä»•çµ„ã¿ãŒå®Œå…¨ã«ã‚ã‹ã£ãŸï¼</div>
<div class="box-content">

<strong>â†’ æ¬¡ã¯ 04_ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰è§£èª¬.md ã§ç”»é¢å´ã‚’å­¦ã¼ã†ï¼</strong>

ğŸ’¡ ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãŒã‚ã‹ã‚‹ã¨ã€ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚‚ç†è§£ã—ã‚„ã™ããªã‚‹ï¼

</div>
</div>
      </article>
      <footer class="footer">
        GCP AI Agent è¨­è¨ˆè³‡æ–™ | Built with Python & Markdown
      </footer>
    </main>
  </div>

  <script>
    function toggleSidebar() {
      document.getElementById('sidebar').classList.toggle('open');
    }

    // Close sidebar when clicking outside on mobile
    document.addEventListener('click', function(e) {
      const sidebar = document.getElementById('sidebar');
      const toggle = document.querySelector('.menu-toggle');
      if (!sidebar.contains(e.target) && !toggle.contains(e.target)) {
        sidebar.classList.remove('open');
      }
    });
  </script>
</body>
</html>