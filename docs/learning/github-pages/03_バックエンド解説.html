<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>03 バックエンド解説 - GCP AI Agent 設計資料</title>
  <link rel="stylesheet" href="assets/style.css">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>📚</text></svg>">
</head>
<body>
  <header class="header">
    <a href="index.html" class="header-logo">
      <span>📚</span>
      <span>GCP AI Agent 設計資料</span>
    </a>
    <nav class="header-nav">
      <a href="index.html">ホーム</a>
      <a href="02_全体像.html">全体像</a>
      <a href="https://github.com" target="_blank">GitHub</a>
    </nav>
    <button class="menu-toggle" onclick="toggleSidebar()">
      <span></span>
      <span></span>
      <span></span>
    </button>
  </header>

  <div class="layout">
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-section">
        <div class="sidebar-title">📖 はじめに</div>
        <ul class="sidebar-nav">
          <li><a href="01_はじめに読んでください.html" >はじめに読んでください</a></li>
        </ul>
      </div>

      <div class="sidebar-section">
        <div class="sidebar-title">🏗️ 仕組みを理解</div>
        <ul class="sidebar-nav">
          <li><a href="02_全体像.html" >全体像</a></li>
          <li><a href="03_バックエンド解説.html" class="active">バックエンド解説</a></li>
          <li><a href="04_フロントエンド解説.html" >フロントエンド解説</a></li>
        </ul>
      </div>

      <div class="sidebar-section">
        <div class="sidebar-title">🛠️ セットアップ</div>
        <ul class="sidebar-nav">
          <li><a href="05_セットアップの流れ.html" >セットアップの流れ</a></li>
          <li><a href="06_コマンド解説.html" >コマンド解説</a></li>
        </ul>
      </div>

      <div class="sidebar-section">
        <div class="sidebar-title">🚀 動かす</div>
        <ul class="sidebar-nav">
          <li><a href="07_動かしてみよう.html" >動かしてみよう</a></li>
          <li><a href="08_AIカスタマイズ.html" >AIカスタマイズ</a></li>
        </ul>
      </div>

      <div class="sidebar-section">
        <div class="sidebar-title">🔄 参考: フロー解説</div>
        <ul class="sidebar-nav">
          <li><a href="FLOW_01_チャット送信の流れ.html" >チャット送信の流れ</a></li>
          <li><a href="FLOW_02_ログインの流れ.html" >ログインの流れ</a></li>
          <li><a href="FLOW_04_セッション管理の流れ.html" >セッション管理の流れ</a></li>
        </ul>
      </div>
    </aside>

    <main class="main">
      <article class="content">
        <h1 id="バックエンド解説---サーバーの中身を完全理解">バックエンド解説 - サーバーの中身を完全理解！<a class="header-link" href="#バックエンド解説---サーバーの中身を完全理解" title="Permanent link">&para;</a></h1>
<div class="goal-box">
<div class="box-title">🎯 このページのゴール</div>
<div class="box-content">

「サーバー側のコードを見て、何をしてるかわかる！」状態になる

🔥 ゴール達成後のあなた:
「このAPI、認証 → レート制限 → AI呼び出しの順で処理してるね」
と言えるようになる！

</div>
</div>

<hr />
<h2 id="バックエンドって何してるの">バックエンドって何してるの？<a class="header-link" href="#バックエンドって何してるの" title="Permanent link">&para;</a></h2>
<div class="info-box">
<div class="box-title">🐍 バックエンドの仕事</div>
<div class="box-content">

「見えないところで頑張る縁の下の力持ち」

<ul>
<li>この人は本物？ → 認証</li>
<li>この人はアクセスしていい？ → 許可確認</li>
<li>使いすぎてない？ → レート制限</li>
<li>AIに聞いて答えを返す → AI呼び出し</li>
<li>会話を覚えておく → 履歴保存</li>
</ul>

💡 GASで言うと: doGet() や doPost() の中身を作るイメージ

</div>
</div>

<hr />
<h2 id="ファイル構成">ファイル構成<a class="header-link" href="#ファイル構成" title="Permanent link">&para;</a></h2>
<div class="codehilite"><pre><span></span><code>backend/src/
├── main.py              ★ すべての入口（最初に読む）
├── common/
│   ├── auth.py          ★ 認証処理（2番目に読む）
│   ├── config.py           設定読み込み
│   ├── firebase_init.py    Firebase初期化
│   └── rate_limiter.py     レート制限
└── agents/
    ├── _base/
    │   ├── base_agent.py        エージェントの基底クラス
    │   └── firestore_checkpointer.py  会話履歴保存
    └── _template/
        └── agent.py     ★ AIエージェント本体（3番目に読む）

backend/scripts/
└── manage_customer.py   ★ 顧客管理コマンド（運用時に必須）
</code></pre></div>

<hr />
<h2 id="1-mainpy---すべての入口">1. main.py - すべての入口<a class="header-link" href="#1-mainpy---すべての入口" title="Permanent link">&para;</a></h2>
<h3 id="なぜ入口が必要">なぜ「入口」が必要？<a class="header-link" href="#なぜ入口が必要" title="Permanent link">&para;</a></h3>
<div class="info-box">
<div class="box-title">🚪 main.py = ホテルのフロントデスク</div>
<div class="box-content">

<strong>【フロントデスクの仕事】</strong>

お客さん:「チェックインしたいんですけど」
↓
フロント:「かしこまりました。お名前は？予約番号は？」
↓
フロント:「確認できました。こちらがお部屋の鍵です」

<strong>【main.py の仕事】</strong>

リクエスト:「/chat に POST したいんですけど」
↓
main.py:「かしこまりました。トークンは？メッセージは？」
↓
main.py:「確認できました。こちらがAIの回答です」

</div>
</div>

<h3 id="エンドポイント一覧">エンドポイント一覧<a class="header-link" href="#エンドポイント一覧" title="Permanent link">&para;</a></h3>
<div class="info-box">
<div class="box-title">📡 用意されているエンドポイント</div>
<div class="box-content">

<table>
<tr><th>エンドポイント</th><th>メソッド</th><th>役割</th></tr>
<tr><td>/health</td><td>GET</td><td>生存確認（サーバー動いてる？）</td></tr>
<tr><td>/chat</td><td>POST</td><td>チャットAPI（メイン機能）</td></tr>
<tr><td>/agents</td><td>GET</td><td>使えるAIエージェント一覧</td></tr>
</table>

💡 エンドポイントとは:
「このURLにこのメソッドでリクエストすると、この処理が実行されますよ」という窓口のこと

</div>
</div>

<h3 id="chat-エンドポイントの全処理フロー">/chat エンドポイントの全処理フロー<a class="header-link" href="#chat-エンドポイントの全処理フロー" title="Permanent link">&para;</a></h3>
<div class="flow-box">
<div class="box-title">💬 /chat の処理フロー（完全版）</div>
<div class="box-content">

<strong>POST /chat</strong> → `{ "message": "こんにちは", "thread_id": "abc123" }`

<strong>ステップ1: 認証チェック</strong>
<ul>
<li>トークンがない → エラー「認証トークンがありません」</li>
<li>トークンが偽物 → エラー「認証トークンが無効です」</li>
<li>許可されてない → エラー「アクセスが許可されていません」</li>
<li>OK → user_info を取得（uid, email, customer_id）</li>
</ul>

<strong>ステップ2: レート制限チェック</strong>
<ul>
<li>1分60回超過 → エラー「リクエスト制限を超えました」</li>
<li>OK → 処理続行</li>
</ul>

💡 なぜレート制限？ 悪意のあるユーザーがAPIを大量に叩いてサーバーをダウンさせることを防ぐ。AI呼び出しはお金がかかるので課金攻撃も防ぐ

<strong>ステップ3: 入力値検証</strong>
<ul>
<li>メッセージが空？ → エラー</li>
<li>メッセージが10,000文字超？ → エラー（DoS対策）</li>
<li>thread_idに変な文字？ → エラー（インジェクション対策）</li>
</ul>

<strong>ステップ4: AIエージェント取得</strong>
<ul>
<li>顧客IDに紐づいたエージェントを取得</li>
</ul>

<strong>ステップ5: AIを呼び出してストリーミング返却</strong>
<ul>
<li>Server-Sent Events (SSE) 形式で返す</li>
<li>`data: 内容` の形で送ると、ブラウザが自動で受け取る</li>
<li>`[DONE]` は「もう終わりだよ」の合図</li>
</ul>

</div>
</div>

<h3 id="コード実際の構造に近い形">コード（実際の構造に近い形）<a class="header-link" href="#コード実際の構造に近い形" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># main.py の構造（簡略化したもの）</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">flask</span><span class="w"> </span><span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">Response</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">common.auth</span><span class="w"> </span><span class="kn">import</span> <span class="n">authenticate_request</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">common.rate_limiter</span><span class="w"> </span><span class="kn">import</span> <span class="n">check_rate_limit</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="c1"># ========================================</span>
<span class="c1"># ヘルスチェック: サーバーが生きてるか確認</span>
<span class="c1"># ========================================</span>
<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/health&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">health</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;サーバー生存確認&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;healthy&quot;</span><span class="p">}</span>


<span class="c1"># ========================================</span>
<span class="c1"># チャットAPI: メインの機能</span>
<span class="c1"># ========================================</span>
<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/chat&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;POST&quot;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">chat</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;チャットAPI（ストリーミング対応）&quot;&quot;&quot;</span>

    <span class="c1"># === ステップ1: 認証チェック ===</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">user_info</span> <span class="o">=</span> <span class="n">authenticate_request</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)},</span> <span class="mi">401</span>  <span class="c1"># 401 = 認証エラー</span>

    <span class="n">user_id</span> <span class="o">=</span> <span class="n">user_info</span><span class="p">[</span><span class="s2">&quot;uid&quot;</span><span class="p">]</span>
    <span class="n">customer_id</span> <span class="o">=</span> <span class="n">user_info</span><span class="p">[</span><span class="s2">&quot;customer_id&quot;</span><span class="p">]</span>

    <span class="c1"># === ステップ2: レート制限チェック ===</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">check_rate_limit</span><span class="p">(</span><span class="n">user_id</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;リクエスト制限を超えました。1分後に再試行してください。&quot;</span><span class="p">},</span> <span class="mi">429</span>

    <span class="c1"># === ステップ3: 入力値検証 ===</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">get_json</span><span class="p">()</span>
    <span class="n">message</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;message&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="n">thread_id</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;thread_id&quot;</span><span class="p">)</span>

    <span class="c1"># メッセージが空</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">message</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;メッセージが空です&quot;</span><span class="p">},</span> <span class="mi">400</span>

    <span class="c1"># メッセージが長すぎる（DoS対策）</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">message</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">10000</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;メッセージが長すぎます（10,000文字まで）&quot;</span><span class="p">},</span> <span class="mi">400</span>

    <span class="c1"># thread_idの形式チェック（インジェクション対策）</span>
    <span class="k">if</span> <span class="n">thread_id</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">is_valid_thread_id</span><span class="p">(</span><span class="n">thread_id</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;thread_idの形式が不正です&quot;</span><span class="p">},</span> <span class="mi">400</span>

    <span class="c1"># === ステップ4: AIエージェント取得 ===</span>
    <span class="n">agent</span> <span class="o">=</span> <span class="n">get_agent</span><span class="p">(</span><span class="s2">&quot;template&quot;</span><span class="p">,</span> <span class="n">customer_id</span><span class="p">)</span>

    <span class="c1"># === ステップ5: ストリーミングで返す ===</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">generate</span><span class="p">():</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;AIの回答を少しずつ返すジェネレーター&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">agent</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">thread_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">):</span>
                <span class="c1"># Server-Sent Events 形式で返す</span>
                <span class="k">yield</span> <span class="sa">f</span><span class="s2">&quot;data: </span><span class="si">{</span><span class="n">chunk</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="k">yield</span> <span class="s2">&quot;data: [DONE]</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">yield</span> <span class="sa">f</span><span class="s2">&quot;data: エラーが発生しました: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="k">yield</span> <span class="s2">&quot;data: [DONE]</span><span class="se">\n\n</span><span class="s2">&quot;</span>

    <span class="k">return</span> <span class="n">Response</span><span class="p">(</span>
        <span class="n">generate</span><span class="p">(),</span>
        <span class="n">mimetype</span><span class="o">=</span><span class="s2">&quot;text/event-stream&quot;</span><span class="p">,</span>  <span class="c1"># これがSSEの印</span>
        <span class="n">headers</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;Cache-Control&quot;</span><span class="p">:</span> <span class="s2">&quot;no-cache&quot;</span><span class="p">,</span>     <span class="c1"># キャッシュしない</span>
            <span class="s2">&quot;X-Accel-Buffering&quot;</span><span class="p">:</span> <span class="s2">&quot;no&quot;</span>        <span class="c1"># Nginx用のバッファリング無効化</span>
        <span class="p">}</span>
    <span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">is_valid_thread_id</span><span class="p">(</span><span class="n">thread_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;thread_idの形式を検証（英数字、ハイフン、アンダースコアのみ）&quot;&quot;&quot;</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
    <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^[a-zA-Z0-9_-]+$&#39;</span><span class="p">,</span> <span class="n">thread_id</span><span class="p">))</span>
</code></pre></div>

<hr />
<h2 id="2-authpy---認証処理超重要">2. auth.py - 認証処理（超重要！）<a class="header-link" href="#2-authpy---認証処理超重要" title="Permanent link">&para;</a></h2>
<h3 id="なぜ認証が必要">なぜ認証が必要？<a class="header-link" href="#なぜ認証が必要" title="Permanent link">&para;</a></h3>
<div class="warning-box">
<div class="box-title">🔐 認証がないと何が起きる？</div>
<div class="box-content">

<strong>【認証なしの場合】</strong>

悪い人:「俺は山田だ！データ見せろ！」
サーバー:「はい、どうぞ」

→ 情報漏洩！セキュリティ事故！新聞沙汰！😱

<strong>【認証ありの場合】</strong>

悪い人:「俺は山田だ！データ見せろ！」
サーバー:「身分証見せて」
悪い人:「...持ってない」
サーバー:「じゃあダメ」

→ 安全！😊

</div>
</div>

<h3 id="認証の4つの関門詳細版">認証の4つの関門（詳細版）<a class="header-link" href="#認証の4つの関門詳細版" title="Permanent link">&para;</a></h3>
<div class="flow-box">
<div class="box-title">🚨 認証の4つの関門</div>
<div class="box-content">

<strong>リクエスト到着</strong> → Headers: `{ "Authorization": "Bearer eyJhbGciOiJSUzI1NiIsInR5cCI6..." }`

<strong>関門1: トークンがあるか？</strong>
<ul>
<li>`auth_header = request.headers.get("Authorization")`</li>
<li>ない → エラー「認証トークンがありません」</li>
<li>"Bearer "で始まらない → エラー「認証ヘッダーの形式が不正です」</li>
<li>💡 "Bearer" = 「持ち主」の意味。「このトークンを持ってる人に権限を与える」形式</li>
</ul>

<strong>関門2: トークンは本物か？</strong>
<ul>
<li>Firebase Admin SDK で検証</li>
<li>署名をGoogleの公開鍵で検証</li>
<li>有効期限が切れていないか確認（1時間）</li>
<li>トークンの発行者がFirebaseか確認</li>
<li>check_revoked=True なら失効リストも確認</li>
</ul>

<strong>関門3: このユーザーは許可されているか？</strong>
<ul>
<li>Firestoreの config/access_control を確認</li>
<li>許可ドメインリスト (@acme.co.jp など)</li>
<li>許可メールリスト (tanaka@gmail.com など)</li>
<li>どちらかにマッチすればOK</li>
</ul>

<strong>関門4: どの会社に所属しているか？</strong>
<ul>
<li>まずCustom Claimsに customer_id があるか確認 → あればそれを返す</li>
<li>なければ自動振り分けを試行 → メールドメインから顧客を検索</li>
<li>見つかったら自動でCustom Claimsを設定</li>
<li>どちらにも該当しなければエラー → 「顧客に紐付けされていません」</li>
<li>💡 Custom Claims = IDトークンに追加できる属性。サーバーでしか設定できない（改ざん不可能）</li>
</ul>

<strong>✅ 認証成功！</strong> `{ "uid": "abc123", "email": "yamada@acme.co.jp", "name": "山田太郎", "customer_id": "acme-corp" }`

</div>
</div>

<h3 id="コード実際の構造に近い形_1">コード（実際の構造に近い形）<a class="header-link" href="#コード実際の構造に近い形_1" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># auth.py の主要な関数</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">firebase_admin</span><span class="w"> </span><span class="kn">import</span> <span class="n">auth</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">common.firebase_init</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_firestore_client</span>

<span class="n">db</span> <span class="o">=</span> <span class="n">get_firestore_client</span><span class="p">()</span>


<span class="k">def</span><span class="w"> </span><span class="nf">authenticate_request</span><span class="p">(</span><span class="n">request</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    リクエストを認証し、ユーザー情報を返す</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: {uid, email, name, customer_id, ...}</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: 認証に失敗した場合</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># === 関門1: トークンがあるか？ ===</span>
    <span class="n">auth_header</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Authorization&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">auth_header</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;認証トークンがありません&quot;</span><span class="p">)</span>

    <span class="c1"># &quot;Bearer &quot; で始まっているか？</span>
    <span class="c1"># セキュリティ上、形式を厳密にチェック</span>
    <span class="n">parts</span> <span class="o">=</span> <span class="n">auth_header</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span> <span class="ow">or</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;Bearer&quot;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;認証ヘッダーの形式が不正です&quot;</span><span class="p">)</span>

    <span class="n">id_token</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1"># === 関門2: トークンは本物か？ ===</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Firebase Admin SDK でトークンを検証</span>
        <span class="c1"># check_revoked=True: ログアウト後のトークン使用を防ぐ</span>
        <span class="n">user_info</span> <span class="o">=</span> <span class="n">auth</span><span class="o">.</span><span class="n">verify_id_token</span><span class="p">(</span><span class="n">id_token</span><span class="p">,</span> <span class="n">check_revoked</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">except</span> <span class="n">auth</span><span class="o">.</span><span class="n">RevokedIdTokenError</span><span class="p">:</span>
        <span class="c1"># トークンが失効済み（ログアウト後など）</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;セッションが無効です。再度ログインしてください。&quot;</span><span class="p">)</span>

    <span class="k">except</span> <span class="n">auth</span><span class="o">.</span><span class="n">ExpiredIdTokenError</span><span class="p">:</span>
        <span class="c1"># トークンの有効期限切れ（1時間）</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;セッションの有効期限が切れました。再度ログインしてください。&quot;</span><span class="p">)</span>

    <span class="k">except</span> <span class="n">auth</span><span class="o">.</span><span class="n">InvalidIdTokenError</span><span class="p">:</span>
        <span class="c1"># トークンが不正（改ざん、形式エラーなど）</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;認証トークンが無効です&quot;</span><span class="p">)</span>

    <span class="c1"># === 関門3: このユーザーは許可されているか？ ===</span>
    <span class="n">email</span> <span class="o">=</span> <span class="n">user_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;email&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_user_allowed</span><span class="p">(</span><span class="n">email</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;アクセスが許可されていません: </span><span class="si">{</span><span class="n">email</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># === 関門4: 顧客IDを取得 ===</span>
    <span class="n">uid</span> <span class="o">=</span> <span class="n">user_info</span><span class="p">[</span><span class="s2">&quot;uid&quot;</span><span class="p">]</span>
    <span class="n">customer_id</span> <span class="o">=</span> <span class="n">get_user_customer_id</span><span class="p">(</span><span class="n">uid</span><span class="p">,</span> <span class="n">email</span><span class="p">)</span>
    <span class="n">user_info</span><span class="p">[</span><span class="s2">&quot;customer_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">customer_id</span>

    <span class="k">return</span> <span class="n">user_info</span>


<span class="k">def</span><span class="w"> </span><span class="nf">is_user_allowed</span><span class="p">(</span><span class="n">email</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    このメールアドレスはアクセス許可されているか？</span>

<span class="sd">    Firestoreの config/access_control ドキュメントを確認</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">email</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="c1"># Firestore から許可リストを取得</span>
    <span class="n">doc_ref</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">collection</span><span class="p">(</span><span class="s2">&quot;config&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">document</span><span class="p">(</span><span class="s2">&quot;access_control&quot;</span><span class="p">)</span>
    <span class="n">doc</span> <span class="o">=</span> <span class="n">doc_ref</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">doc</span><span class="o">.</span><span class="n">exists</span><span class="p">:</span>
        <span class="c1"># 設定がない場合はデフォルトで拒否（セキュリティ優先）</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="n">data</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
    <span class="n">allowed_emails</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;allowed_emails&quot;</span><span class="p">,</span> <span class="p">[])</span>
    <span class="n">allowed_domains</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;allowed_domains&quot;</span><span class="p">,</span> <span class="p">[])</span>

    <span class="c1"># メールが直接許可されている？</span>
    <span class="k">if</span> <span class="n">email</span> <span class="ow">in</span> <span class="n">allowed_emails</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="c1"># ドメインが許可されている？</span>
    <span class="n">domain</span> <span class="o">=</span> <span class="n">email</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;@&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;@&quot;</span> <span class="ow">in</span> <span class="n">email</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
    <span class="k">if</span> <span class="n">domain</span> <span class="ow">in</span> <span class="n">allowed_domains</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">return</span> <span class="kc">False</span>


<span class="k">def</span><span class="w"> </span><span class="nf">get_user_customer_id</span><span class="p">(</span><span class="n">uid</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">email</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    ユーザーの顧客IDを取得（自動振り分け対応）</span>

<span class="sd">    1. Custom Claims に customer_id があればそれを返す</span>
<span class="sd">    2. なければメールドメインから自動検索・設定</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Firebase Auth からユーザー情報を取得</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">auth</span><span class="o">.</span><span class="n">get_user</span><span class="p">(</span><span class="n">uid</span><span class="p">)</span>
    <span class="n">claims</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">custom_claims</span> <span class="ow">or</span> <span class="p">{}</span>

    <span class="c1"># 既に customer_id がある場合</span>
    <span class="k">if</span> <span class="n">claims</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;customer_id&quot;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">claims</span><span class="p">[</span><span class="s2">&quot;customer_id&quot;</span><span class="p">]</span>

    <span class="c1"># 自動振り分けを試行</span>
    <span class="k">if</span> <span class="n">email</span><span class="p">:</span>
        <span class="n">customer_id</span> <span class="o">=</span> <span class="n">auto_assign_customer</span><span class="p">(</span><span class="n">uid</span><span class="p">,</span> <span class="n">email</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">customer_id</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">customer_id</span>

    <span class="c1"># どちらにも該当しない</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;顧客に紐付けされていません。管理者に連絡してください。&quot;</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">auto_assign_customer</span><span class="p">(</span><span class="n">uid</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">email</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    メールアドレスから顧客を自動検索し、紐付ける</span>

<span class="sd">    Returns:</span>
<span class="sd">        str | None: 紐付けに成功した場合は customer_id、失敗した場合は None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">domain</span> <span class="o">=</span> <span class="n">email</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;@&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;@&quot;</span> <span class="ow">in</span> <span class="n">email</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>

    <span class="c1"># 顧客を検索</span>
    <span class="n">customers_ref</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">collection</span><span class="p">(</span><span class="s2">&quot;customers&quot;</span><span class="p">)</span>

    <span class="c1"># 1. メールアドレスで直接検索</span>
    <span class="n">query</span> <span class="o">=</span> <span class="n">customers_ref</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s2">&quot;allowed_emails&quot;</span><span class="p">,</span> <span class="s2">&quot;array_contains&quot;</span><span class="p">,</span> <span class="n">email</span><span class="p">)</span>
    <span class="n">docs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">stream</span><span class="p">())</span>
    <span class="k">if</span> <span class="n">docs</span><span class="p">:</span>
        <span class="n">customer_id</span> <span class="o">=</span> <span class="n">docs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">id</span>
        <span class="n">_set_customer_id_claim</span><span class="p">(</span><span class="n">uid</span><span class="p">,</span> <span class="n">customer_id</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">customer_id</span>

    <span class="c1"># 2. ドメインで検索</span>
    <span class="n">query</span> <span class="o">=</span> <span class="n">customers_ref</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s2">&quot;allowed_domains&quot;</span><span class="p">,</span> <span class="s2">&quot;array_contains&quot;</span><span class="p">,</span> <span class="n">domain</span><span class="p">)</span>
    <span class="n">docs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">stream</span><span class="p">())</span>
    <span class="k">if</span> <span class="n">docs</span><span class="p">:</span>
        <span class="n">customer_id</span> <span class="o">=</span> <span class="n">docs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">id</span>
        <span class="n">_set_customer_id_claim</span><span class="p">(</span><span class="n">uid</span><span class="p">,</span> <span class="n">customer_id</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">customer_id</span>

    <span class="k">return</span> <span class="kc">None</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_set_customer_id_claim</span><span class="p">(</span><span class="n">uid</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">customer_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Custom Claims に customer_id を設定&quot;&quot;&quot;</span>
    <span class="n">auth</span><span class="o">.</span><span class="n">set_custom_user_claims</span><span class="p">(</span><span class="n">uid</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;customer_id&quot;</span><span class="p">:</span> <span class="n">customer_id</span><span class="p">})</span>
</code></pre></div>

<hr />
<h2 id="3-agentpy---aiエージェント">3. agent.py - AIエージェント<a class="header-link" href="#3-agentpy---aiエージェント" title="Permanent link">&para;</a></h2>
<h3 id="aiエージェントって何">AIエージェントって何？<a class="header-link" href="#aiエージェントって何" title="Permanent link">&para;</a></h3>
<div class="info-box">
<div class="box-title">🤖 AIエージェント = AIを使いやすくするラッパー</div>
<div class="box-content">
<strong>【AIを直接使う場合】</strong>
毎回これを書く必要がある:
<ul>
<li>システムプロンプトを設定</li>
<li>会話履歴を取得</li>
<li>AIに送信</li>
<li>結果を保存</li>
</ul>
...面倒！😵
<strong>【エージェントを使う場合】</strong>
<code>agent.run("質問", thread_id)</code><br>
↑ これだけ！中身は全部エージェントがやってくれる 😊
</div>
</div>

<h3 id="エージェントの構造">エージェントの構造<a class="header-link" href="#エージェントの構造" title="Permanent link">&para;</a></h3>
<div class="architecture-box">
<div class="box-title">🏗️ エージェントの構造</div>
<div class="box-content">


<div class="codehilite"><pre><span></span><code>TemplateAgent（実際に使うやつ）
    ↓ 継承
BaseAgent（共通機能を持つ）
  - LLM初期化
  - グラフ構築
  - run() メソッド
    ↓ 使用
FirestoreCheckpointer（会話履歴を保存）
</code></pre></div>



💡 なぜこんな構造？ 共通処理は BaseAgent に、個別の性格は TemplateAgent にすると、新しいエージェントを追加するのが楽！

</div>
</div>

<h3 id="system_prompt---aiの性格">SYSTEM_PROMPT - AIの「性格」<a class="header-link" href="#system_prompt---aiの性格" title="Permanent link">&para;</a></h3>
<div class="tip-box">
<div class="box-title">🎭 SYSTEM_PROMPT でAIの性格を決める</div>
<div class="box-content">

<strong>【デフォルト】</strong>

<div class="codehilite"><pre><span></span><code>あなたは親切で丁寧なAIアシスタントです。
ユーザーの質問に対して、わかりやすく簡潔に回答してください。
日本語で回答してください。
</code></pre></div>



<strong>【関西弁に変えると...】</strong>

<div class="codehilite"><pre><span></span><code>あなたは関西弁で話すAIアシスタントやで。
ユーザーの質問にフレンドリーに答えてな。
「やで」「やん」「なんでやねん」を使ってな。
</code></pre></div>



→ 同じ質問でも、返答のスタイルが変わる！

</div>
</div>

<h3 id="コード実際の構造に近い形_2">コード（実際の構造に近い形）<a class="header-link" href="#コード実際の構造に近い形_2" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># agent.py の主要部分</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">langchain_google_vertexai</span><span class="w"> </span><span class="kn">import</span> <span class="n">ChatVertexAI</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">langgraph.graph</span><span class="w"> </span><span class="kn">import</span> <span class="n">StateGraph</span><span class="p">,</span> <span class="n">MessagesState</span>

<span class="c1"># =============================================</span>
<span class="c1"># ★ ここを編集してAIをカスタマイズ</span>
<span class="c1"># =============================================</span>

<span class="c1"># AIの性格・役割</span>
<span class="n">SYSTEM_PROMPT</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;あなたは親切で丁寧なAIアシスタントです。</span>
<span class="s2">ユーザーの質問に対して、わかりやすく簡潔に回答してください。</span>
<span class="s2">日本語で回答してください。&quot;&quot;&quot;</span>

<span class="c1"># 使用するモデル</span>
<span class="n">MODEL_NAME</span> <span class="o">=</span> <span class="s2">&quot;gemini-1.5-flash&quot;</span>

<span class="c1"># 会話履歴の最大数（多いほどコストがかかる）</span>
<span class="n">MAX_HISTORY_MESSAGES</span> <span class="o">=</span> <span class="mi">20</span>  <span class="c1"># 約10往復分</span>


<span class="k">class</span><span class="w"> </span><span class="nc">TemplateAgent</span><span class="p">(</span><span class="n">BaseAgent</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;テンプレートQ&amp;Aエージェント&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">customer_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            customer_id: 顧客ID（データ分離用）</span>
<span class="sd">            user_id: ユーザーID（会話履歴管理用）</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">customer_id</span> <span class="o">=</span> <span class="n">customer_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_id</span> <span class="o">=</span> <span class="n">user_id</span>

        <span class="c1"># LLM（Large Language Model）を初期化</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">llm</span> <span class="o">=</span> <span class="n">ChatVertexAI</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="n">MODEL_NAME</span><span class="p">,</span>
            <span class="n">temperature</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>  <span class="c1"># 0=確実な回答、1=創造的な回答</span>
            <span class="n">max_output_tokens</span><span class="o">=</span><span class="mi">2048</span><span class="p">,</span>
            <span class="n">streaming</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># ストリーミング有効</span>
        <span class="p">)</span>

        <span class="c1"># 会話履歴保存用のチェックポインター</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkpointer</span> <span class="o">=</span> <span class="n">FirestoreCheckpointer</span><span class="p">(</span>
            <span class="n">db</span><span class="o">=</span><span class="n">get_firestore_client</span><span class="p">(),</span>
            <span class="n">customer_id</span><span class="o">=</span><span class="n">customer_id</span>
        <span class="p">)</span>

        <span class="c1"># グラフを構築</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">graph</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_graph</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_build_graph</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        LangGraphのグラフを構築</span>

<span class="sd">        LangGraph = AIの処理フローを「グラフ」として定義するライブラリ</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># グラフを作成</span>
        <span class="n">builder</span> <span class="o">=</span> <span class="n">StateGraph</span><span class="p">(</span><span class="n">MessagesState</span><span class="p">)</span>

        <span class="c1"># ノードを追加（処理のステップ）</span>
        <span class="n">builder</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="s2">&quot;chat&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_chat_node</span><span class="p">)</span>

        <span class="c1"># エントリーポイントを設定</span>
        <span class="n">builder</span><span class="o">.</span><span class="n">set_entry_point</span><span class="p">(</span><span class="s2">&quot;chat&quot;</span><span class="p">)</span>

        <span class="c1"># 終了ノードを設定</span>
        <span class="n">builder</span><span class="o">.</span><span class="n">set_finish_point</span><span class="p">(</span><span class="s2">&quot;chat&quot;</span><span class="p">)</span>

        <span class="c1"># コンパイルしてグラフを確定</span>
        <span class="k">return</span> <span class="n">builder</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">checkpointer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">checkpointer</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_chat_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">MessagesState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        チャット処理のメインロジック</span>

<span class="sd">        Args:</span>
<span class="sd">            state: 現在の会話状態（メッセージ履歴を含む）</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: 新しいメッセージを含む状態</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">messages</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;messages&quot;</span><span class="p">]</span>

        <span class="c1"># システムプロンプトを先頭に追加</span>
        <span class="n">full_messages</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;system&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">SYSTEM_PROMPT</span><span class="p">},</span>
            <span class="o">*</span><span class="n">messages</span><span class="p">[</span><span class="o">-</span><span class="n">MAX_HISTORY_MESSAGES</span><span class="p">:]</span>  <span class="c1"># 履歴を制限</span>
        <span class="p">]</span>

        <span class="c1"># Gemini に問い合わせ</span>
        <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">llm</span><span class="o">.</span><span class="n">ainvoke</span><span class="p">(</span><span class="n">full_messages</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;messages&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">response</span><span class="p">]}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">thread_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        チャットを実行（ストリーミング）</span>

<span class="sd">        Args:</span>
<span class="sd">            message: ユーザーのメッセージ</span>
<span class="sd">            thread_id: 会話のID（新規の場合は自動生成）</span>
<span class="sd">            user_id: ユーザーID</span>

<span class="sd">        Yields:</span>
<span class="sd">            str: AIの返答（少しずつ）</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># thread_id がなければ生成</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">thread_id</span><span class="p">:</span>
            <span class="n">thread_id</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">user_id</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span><span class="o">.</span><span class="n">hex</span><span class="p">[:</span><span class="mi">8</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="c1"># 設定</span>
        <span class="n">config</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;configurable&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;thread_id&quot;</span><span class="p">:</span> <span class="n">thread_id</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="c1"># 入力</span>
        <span class="n">input_data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;messages&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">message</span><span class="p">}</span>
            <span class="p">]</span>
        <span class="p">}</span>

        <span class="c1"># ストリーミング実行</span>
        <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">stream</span><span class="p">(</span><span class="n">input_data</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">stream_mode</span><span class="o">=</span><span class="s2">&quot;values&quot;</span><span class="p">):</span>
            <span class="c1"># 最後のメッセージを取得</span>
            <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;messages&quot;</span><span class="p">):</span>
                <span class="n">last_message</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="s2">&quot;messages&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">last_message</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">):</span>
                    <span class="k">yield</span> <span class="n">last_message</span><span class="o">.</span><span class="n">content</span>
</code></pre></div>

<hr />
<h2 id="4-firestore_checkpointerpy---会話履歴保存">4. firestore_checkpointer.py - 会話履歴保存<a class="header-link" href="#4-firestore_checkpointerpy---会話履歴保存" title="Permanent link">&para;</a></h2>
<h3 id="なぜ会話履歴が必要">なぜ会話履歴が必要？<a class="header-link" href="#なぜ会話履歴が必要" title="Permanent link">&para;</a></h3>
<div class="info-box">
<div class="box-title">💾 会話履歴がないと...</div>
<div class="box-content">

<strong>【履歴なし】</strong>

ユーザー: 「私の名前は山田です」
AI: 「山田さん、こんにちは！」

ユーザー: 「私の名前は何でしたか？」
AI: 「すみません、わかりません」 ← 忘れてる！😱

<strong>【履歴あり】</strong>

ユーザー: 「私の名前は山田です」
AI: 「山田さん、こんにちは！」

ユーザー: 「私の名前は何でしたか？」
AI: 「山田さんですね！」 ← 覚えてる！😊

</div>
</div>

<h3 id="firestore-のデータ構造">Firestore のデータ構造<a class="header-link" href="#firestore-のデータ構造" title="Permanent link">&para;</a></h3>
<div class="architecture-box">
<div class="box-title">📁 Firestore のデータ構造</div>
<div class="box-content">


<div class="codehilite"><pre><span></span><code>Firestore
└── customers/                    ← 顧客コレクション
    ├── acme-corp/                ← 顧客ドキュメント
    │   ├── name: &quot;株式会社ACME&quot;
    │   ├── allowed_domains: [&quot;acme.co.jp&quot;]
    │   └── checkpoints/          ← 会話履歴コレクション
    │       ├── user1_abc123/     ← 会話1のドキュメント
    │       │   └── checkpoints/  ← チェックポイントサブコレクション
    │       │       ├── cp_1: {messages: [...], timestamp: ...}
    │       │       └── cp_2: {...}
    │       └── user1_def456/     ← 会話2のドキュメント
    │           └── ...
    └── beta-inc/                 ← 別の顧客
        └── ...
</code></pre></div>



💡 customer_id でパスを分けることで、A社がB社のデータにアクセスすることを防ぐ

</div>
</div>

<hr />
<h2 id="重要な概念">重要な概念<a class="header-link" href="#重要な概念" title="Permanent link">&para;</a></h2>
<h3 id="asyncawait非同期処理">async/await（非同期処理）<a class="header-link" href="#asyncawait非同期処理" title="Permanent link">&para;</a></h3>
<div class="info-box">
<div class="box-title">⚡ async/await を完全理解</div>
<div class="box-content">

<strong>【GASの場合（同期処理）】</strong>

<div class="codehilite"><pre><span></span><code><span class="kd">function</span><span class="w"> </span><span class="nx">fetchData</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">var</span><span class="w"> </span><span class="nx">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">UrlFetchApp</span><span class="p">.</span><span class="nx">fetch</span><span class="p">(</span><span class="nx">url</span><span class="p">);</span><span class="w">  </span><span class="c1">// ここで止まる</span>
<span class="w">  </span><span class="kd">var</span><span class="w"> </span><span class="nx">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">getContentText</span><span class="p">();</span><span class="w">   </span><span class="c1">// 終わるまで待つ</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">data</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>


→ 処理Aを待っている間、処理Bができない

<strong>【Python/TypeScriptの場合（非同期処理）】</strong>

<div class="codehilite"><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">fetch_data</span><span class="p">():</span>
    <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>  <span class="c1"># 待つけど他の処理可</span>
    <span class="n">data</span> <span class="o">=</span> <span class="k">await</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">data</span>
</code></pre></div>


→ 処理Aを待っている間に、処理Bを進められる

<strong>【イメージ】</strong>
<ul>
<li>同期 : 料理の注文 → 待つ → 受け取り → 次の注文</li>
<li>非同期 : 料理の注文 → 次の注文 → 次の注文 → 最初の料理受け取り</li>
</ul>

💡 AIの回答を待つ間、他のユーザーのリクエストを処理できる

</div>
</div>

<h3 id="ジェネレーターyield">ジェネレーター（yield）<a class="header-link" href="#ジェネレーターyield" title="Permanent link">&para;</a></h3>
<div class="info-box">
<div class="box-title">🌊 yield（ジェネレーター）を完全理解</div>
<div class="box-content">

<strong>【普通の関数】</strong>

<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_numbers</span><span class="p">():</span>
    <span class="k">return</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span>  <span class="c1"># 全部まとめて返す</span>

<span class="n">result</span> <span class="o">=</span> <span class="n">get_numbers</span><span class="p">()</span>  <span class="c1"># [1, 2, 3, 4, 5] が一度に来る</span>
</code></pre></div>



<strong>【ジェネレーター（yield使用）】</strong>

<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_numbers</span><span class="p">():</span>
    <span class="k">yield</span> <span class="mi">1</span>  <span class="c1"># 1を返して、ここで一時停止</span>
    <span class="k">yield</span> <span class="mi">2</span>  <span class="c1"># 次に呼ばれたら2を返して、また一時停止</span>
    <span class="k">yield</span> <span class="mi">3</span>
    <span class="k">yield</span> <span class="mi">4</span>
    <span class="k">yield</span> <span class="mi">5</span>

<span class="k">for</span> <span class="n">num</span> <span class="ow">in</span> <span class="n">get_numbers</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">num</span><span class="p">)</span>  <span class="c1"># 1, 2, 3, 4, 5 が順番に来る</span>
</code></pre></div>



<strong>【ストリーミングでの活用】</strong>

<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">stream_response</span><span class="p">():</span>
    <span class="k">yield</span> <span class="s2">&quot;こん&quot;</span>    <span class="c1"># ブラウザに「こん」が表示</span>
    <span class="k">yield</span> <span class="s2">&quot;にち&quot;</span>    <span class="c1"># ブラウザに「にち」が追加表示</span>
    <span class="k">yield</span> <span class="s2">&quot;は&quot;</span>      <span class="c1"># ブラウザに「は」が追加表示</span>
</code></pre></div>


→ 全部できるのを待たずに、できた分から表示！

</div>
</div>

<h3 id="デコレーター">デコレーター（@）<a class="header-link" href="#デコレーター" title="Permanent link">&para;</a></h3>
<div class="info-box">
<div class="box-title">🎀 デコレーターを完全理解</div>
<div class="box-content">

<strong>【デコレーターって何？】</strong>
関数に「追加機能」をつける仕組み。`@something` を関数の前に書く

<strong>【よく見るパターン】</strong>

<div class="codehilite"><pre><span></span><code><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/chat&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;POST&quot;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">chat</span><span class="p">():</span>
    <span class="o">...</span>
</code></pre></div>



↑ これは以下と同じ意味:

<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">chat</span><span class="p">():</span>
    <span class="o">...</span>
<span class="n">chat</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/chat&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;POST&quot;</span><span class="p">])(</span><span class="n">chat</span><span class="p">)</span>
</code></pre></div>



<strong>【イメージ】</strong>
プレゼントに リボン をつける
   ↑           ↑
 関数     デコレーター

中身（関数）は同じだけど、見た目（機能）が変わる

`@app.route(...)` → 「この関数をURLに紐づける」機能を追加

</div>
</div>

<hr />
<h2 id="よくあるエラーと対処法">よくあるエラーと対処法<a class="header-link" href="#よくあるエラーと対処法" title="Permanent link">&para;</a></h2>
<table>
<thead>
<tr>
<th>エラー</th>
<th>原因</th>
<th>対処</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>認証トークンがありません</code></td>
<td>Authorizationヘッダーがない</td>
<td>ログインし直す</td>
</tr>
<tr>
<td><code>認証ヘッダーの形式が不正です</code></td>
<td>Bearer形式でない</td>
<td>ログインし直す</td>
</tr>
<tr>
<td><code>セッションが無効です</code></td>
<td>ログアウト後のトークン使用</td>
<td>再ログイン</td>
</tr>
<tr>
<td><code>セッションの有効期限が切れました</code></td>
<td>トークンが1時間超過</td>
<td>ページリロード</td>
</tr>
<tr>
<td><code>認証トークンが無効です</code></td>
<td>改ざんされたトークン</td>
<td>再ログイン</td>
</tr>
<tr>
<td><code>アクセスが許可されていません</code></td>
<td>許可リストにない</td>
<td>管理者に連絡</td>
</tr>
<tr>
<td><code>顧客に紐付けされていません</code></td>
<td>自動振り分けにもマッチしない</td>
<td>管理者に連絡</td>
</tr>
<tr>
<td><code>リクエスト制限を超えました</code></td>
<td>1分60回超過</td>
<td>1分待つ</td>
</tr>
<tr>
<td><code>メッセージが長すぎます</code></td>
<td>10,000文字超過</td>
<td>短くする</td>
</tr>
<tr>
<td><code>thread_idの形式が不正です</code></td>
<td>変な文字が入っている</td>
<td>thread_idを指定しない</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="理解度チェック">理解度チェック<a class="header-link" href="#理解度チェック" title="Permanent link">&para;</a></h2>
<p>以下の質問に答えられたら、バックエンドはバッチリ！</p>
<table>
<thead>
<tr>
<th>質問</th>
<th>自信あり?</th>
</tr>
</thead>
<tbody>
<tr>
<td>main.py の /chat はどんな順番で処理を行う？</td>
<td>□</td>
</tr>
<tr>
<td>認証で「4つの関門」とは何？</td>
<td>□</td>
</tr>
<tr>
<td>SYSTEM_PROMPT を変えるとどうなる？</td>
<td>□</td>
</tr>
<tr>
<td>yield と return の違いは？</td>
<td>□</td>
</tr>
<tr>
<td>なぜ customer_id でデータを分けている？</td>
<td>□</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="次のステップ">次のステップ<a class="header-link" href="#次のステップ" title="Permanent link">&para;</a></h2>
<div class="summary-box">
<div class="box-title">✅ バックエンドの仕組みが完全にわかった！</div>
<div class="box-content">

<strong>→ 次は 04_フロントエンド解説.md で画面側を学ぼう！</strong>

💡 バックエンドがわかると、フロントエンドも理解しやすくなる！

</div>
</div>
      </article>
      <footer class="footer">
        GCP AI Agent 設計資料 | Built with Python & Markdown
      </footer>
    </main>
  </div>

  <script>
    function toggleSidebar() {
      document.getElementById('sidebar').classList.toggle('open');
    }

    // Close sidebar when clicking outside on mobile
    document.addEventListener('click', function(e) {
      const sidebar = document.getElementById('sidebar');
      const toggle = document.querySelector('.menu-toggle');
      if (!sidebar.contains(e.target) && !toggle.contains(e.target)) {
        sidebar.classList.remove('open');
      }
    });
  </script>
</body>
</html>