# コマンド解説

「黒い画面（ターミナル）」で使うコマンドを解説します。
魔法のように見えますが、一つ一つ意味があります。

---

## 🚀 ワンコマンド起動（推奨）

本プロジェクトでは、複雑なコマンドを1つにまとめた起動スクリプトを用意しています。

```bash
./start.sh
```

**これだけで以下が自動実行されます：**

| ステップ | 内容 | 詳細 |
|---------|------|------|
| 1 | バックエンド起動 | `python -m functions_framework --target=main --port=8080` |
| 2 | フロントエンド起動 | `npm run dev` |
| 3 | 接続確認 | ヘルスチェック |

### start.sh の中身を理解する

```bash
# Step 1: バックエンド起動
python -m functions_framework --target=main --port=8080 &
#   └── python -m: Pythonモジュールとして実行
#   └── functions_framework: Cloud Functionsローカル実行ツール
#   └── --target=main: backend/src/main.py の main関数を実行
#   └── --port=8080: ポート8080で待ち受け
#   └── &: バックグラウンドで実行

# Step 2: フロントエンド起動
npm run dev &
#   └── npm run: package.jsonのscriptsを実行
#   └── dev: 開発サーバー（Vite）を起動
#   └── &: バックグラウンドで実行
```

### 起動後のシステム構成

```
┌─────────────────────────────────────────────────────────────────┐
│                        あなたのPC                                │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  [ブラウザ]                                                      │
│  http://localhost:5173                                          │
│       │                                                         │
│       │ HTTPリクエスト                                           │
│       ▼                                                         │
│  ┌─────────────────┐         ┌─────────────────┐               │
│  │  フロントエンド   │ ──API→ │  バックエンド    │               │
│  │  (React/Vite)   │         │  (Python/Flask) │               │
│  │  :5173          │         │  :8080          │               │
│  └─────────────────┘         └────────┬────────┘               │
│                                       │                         │
│                                       │ Vertex AI API           │
│                                       ▼                         │
│                              ┌─────────────────┐               │
│                              │  Google Cloud    │               │
│                              │  (Gemini AI)     │               │
│                              └─────────────────┘               │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 📦 デプロイコマンド

### 顧客別デプロイ

```bash
./infrastructure/deploy-customer.sh <customer-id>
```

**例:**
```bash
./infrastructure/deploy-customer.sh acme-corp
```

### deploy-customer.sh の中身を理解する

```bash
# 1. バックエンドをCloud Functionsにデプロイ
gcloud functions deploy ${CUSTOMER_ID}-chat-api \
  --runtime python311 \              # Python 3.11を使用
  --trigger-http \                   # HTTPリクエストで起動
  --entry-point main \               # main関数を実行
  --set-env-vars CUSTOMER_ID=${CUSTOMER_ID}  # 環境変数設定

# 2. フロントエンドをビルド
npm run build                        # dist/ フォルダに出力

# 3. Firebase Hostingにデプロイ
firebase deploy --only hosting       # dist/ をアップロード
```

### デプロイ後の構成

```
┌─────────────────────────────────────────────────────────────────┐
│                    Google Cloud Platform                         │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  [ユーザーのブラウザ]                                             │
│       │                                                         │
│       ▼                                                         │
│  ┌─────────────────┐         ┌─────────────────┐               │
│  │ Firebase Hosting │ ──API→ │ Cloud Functions │               │
│  │ (静的ファイル)   │         │ (Python)        │               │
│  │ your-app.web.app│         │ /chat エンドポ  │               │
│  └─────────────────┘         └────────┬────────┘               │
│                                       │                         │
│       ┌───────────────────────────────┼───────────────────┐     │
│       │                               │                   │     │
│       ▼                               ▼                   ▼     │
│  ┌──────────┐                  ┌──────────┐        ┌──────────┐│
│  │ Firestore │                  │ Vertex AI│        │ Firebase ││
│  │ (データ)  │                  │ (AI)     │        │ Auth     ││
│  └──────────┘                  └──────────┘        └──────────┘│
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 基本：ターミナルとは？

```
ターミナル = コンピュータに文字で命令を出す画面

マウスでクリック → GUI（グラフィカル）
文字で命令       → CLI（コマンドライン）
```

プログラマーはCLIをよく使います。速いからです。

---

## 📄 シェルスクリプト（.sh）とは？

### 一言で説明

```
.shファイル = 複数のコマンドをまとめた「レシピ」
```

### 何が嬉しいの？

```
【.shファイルがない場合】
毎回これを打つ必要がある：
  $ cd backend
  $ pip install -r requirements.txt
  $ python -m functions_framework --target=main --port=8080 &
  $ cd ../frontend
  $ npm install
  $ npm run dev

【.shファイルがある場合】
これだけでOK：
  $ ./start.sh
```

### 実行方法

```bash
# 方法1: ./ファイル名
./start.sh

# 方法2: bash ファイル名
bash start.sh

# 方法3: sh ファイル名
sh start.sh
```

### 「./」の意味

```
./start.sh
 │└── start.sh というファイル
 └── 「今いるフォルダの」という意味

「./」がないと、コンピュータは「システムにインストールされたコマンド」を探しに行く
「./」をつけると「今いるフォルダにあるファイル」を実行する
```

### .shファイルの中身

```bash
#!/bin/bash           ← 「このファイルはbashで実行してね」という宣言

echo "Hello"          ← コマンド1
cd backend            ← コマンド2
pip install ...       ← コマンド3

# 上から順番に実行される
```

### 本プロジェクトの.shファイル一覧

| ファイル | 場所 | 役割 |
|---------|------|------|
| `start.sh` | プロジェクト直下 | 開発環境を1コマンドで起動 |
| `deploy.sh` | プロジェクト直下 | 本番環境に1コマンドでデプロイ |
| `deploy-customer.sh` | infrastructure/ | 顧客別デプロイ |

### イメージ

```
.shファイル = 料理のレシピ

【レシピがない場合】
1. 卵を割る
2. 塩を入れる
3. かき混ぜる
4. フライパンで焼く
...を毎回思い出しながら作る

【レシピがある場合】
「卵焼きのレシピ.sh」を見れば誰でも同じように作れる
しかも「./卵焼きのレシピ.sh」で自動で作ってくれる！
```

---

## よく使うコマンド

### cd（Change Directory）

```bash
cd backend
```

**意味**: 「backendフォルダに移動する」

```
【イメージ】
あなたは今「GCP」という部屋にいます
    ↓
「cd backend」で「backend」という部屋に移動
    ↓
今は「GCP/backend」の部屋にいます
```

**よく使うパターン**:
```bash
cd backend      # backendフォルダに入る
cd ..           # 一つ上のフォルダに戻る
cd ~            # ホームフォルダに戻る
```

---

### ls（List）

```bash
ls
```

**意味**: 「今いるフォルダの中身を表示する」

```
【実行例】
$ ls
README.md  backend/  frontend/  learning/
```

**オプション**:
```bash
ls -la    # 隠しファイルも含めて詳細表示
```

---

### pip install

```bash
pip install -r requirements.txt
```

**分解して理解**:

| 部分 | 意味 |
|------|------|
| `pip` | Pythonのパッケージ管理ツール |
| `install` | インストールする |
| `-r` | ファイルから読み込む（-r = read） |
| `requirements.txt` | インストールするパッケージ一覧が書かれたファイル |

**何が起きる？**
```
requirements.txt の中身:
  flask==3.0.0
  firebase-admin==6.2.0
  langchain==0.1.0
  ...

これらのパッケージがインターネットからダウンロードされて
あなたのパソコンにインストールされます
```

**イメージ**:
```
pip install = アプリストアからアプリをインストール
requirements.txt = 買い物リスト
```

---

### npm install

```bash
npm install
```

**意味**: 「package.jsonに書かれたパッケージをインストール」

| 用語 | 意味 |
|------|------|
| `npm` | Node.jsのパッケージ管理ツール（Node Package Manager） |
| `install` | インストールする |
| `package.json` | 必要なパッケージ一覧（自動で読み込まれる） |

**pip と npm の違い**:
```
pip     → Python用
npm     → JavaScript/TypeScript用
```

---

### functions-framework

```bash
functions-framework --target=main --port=8080
```

**分解して理解**:

| 部分 | 意味 |
|------|------|
| `functions-framework` | Cloud Functionsをローカルで動かすツール |
| `--target=main` | main という関数を実行する |
| `--port=8080` | ポート8080で待ち受ける |

**何が起きる？**
```
1. あなたのPythonコード（main.py）が読み込まれる
2. main という関数がサーバーとして起動
3. http://localhost:8080 でアクセス可能になる
```

**ポートとは？**
```
ポート = マンションの部屋番号

http://localhost:8080
  └── localhost = あなたのパソコン
  └── 8080 = 8080号室

別のアプリは別の部屋番号（ポート）を使う
```

---

### npm run dev

```bash
npm run dev
```

**意味**: 「package.jsonのscripts.devを実行」

```json
// package.json の中身（抜粋）
{
  "scripts": {
    "dev": "vite",           ← npm run dev で実行される
    "build": "vite build",   ← npm run build で実行される
  }
}
```

**何が起きる？**
```
1. Vite（開発サーバー）が起動
2. Reactアプリがコンパイルされる
3. http://localhost:5173 でアクセス可能になる
4. コードを変更すると自動で画面が更新される（ホットリロード）
```

---

## ローカル開発の全体像

```
【ターミナル1】                【ターミナル2】
cd backend                     cd frontend
pip install -r requirements.txt    npm install
functions-framework ...        npm run dev
    ↓                              ↓
バックエンド起動                フロントエンド起動
http://localhost:8080          http://localhost:5173
    ↑                              │
    └──────── API呼び出し ─────────┘

【ブラウザ】
http://localhost:5173 を開く
    ↓
Reactの画面が表示される
    ↓
チャット送信すると localhost:8080 にAPIリクエスト
    ↓
AIが返答
```

---

## よくあるエラーと対処

### 「command not found」

```bash
$ pip install ...
zsh: command not found: pip
```

**原因**: pipがインストールされていない、またはパスが通っていない

**対処**:
```bash
# Macの場合
pip3 install ...    # pip の代わりに pip3 を使う

# または Python経由で
python3 -m pip install ...
```

---

### 「EADDRINUSE: address already in use」

```bash
Error: EADDRINUSE: address already in use :::8080
```

**原因**: ポート8080が既に使われている

**対処**:
```bash
# 使っているプロセスを探す
lsof -i :8080

# 見つかったプロセスを終了（PID番号を指定）
kill -9 12345
```

---

### 「ModuleNotFoundError」

```bash
ModuleNotFoundError: No module named 'flask'
```

**原因**: パッケージがインストールされていない

**対処**:
```bash
pip install -r requirements.txt
```

---

## まとめ

| コマンド | 一言で言うと |
|----------|-------------|
| `cd フォルダ名` | フォルダ移動 |
| `ls` | 中身を見る |
| `pip install -r requirements.txt` | Python用パッケージをインストール |
| `npm install` | JavaScript用パッケージをインストール |
| `functions-framework --target=main --port=8080` | バックエンドサーバー起動 |
| `npm run dev` | フロントエンドサーバー起動 |

**最初は意味がわからなくても大丈夫！**
何度も使っていると自然と覚えます。
