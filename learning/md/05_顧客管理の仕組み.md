# 顧客管理の仕組み

複数の顧客（会社）にサービスを提供する仕組みを解説します。

---

## 顧客とユーザーの違い

```
顧客（Customer）= 会社
  ├── ユーザーA（山田さん）
  ├── ユーザーB（田中さん）
  └── ユーザーC（佐藤さん）
```

| 概念 | 例 | 説明 |
|------|-----|------|
| 顧客 | 株式会社ACME | サービスを契約している会社 |
| ユーザー | yamada@acme.co.jp | 実際に使う人 |
| 顧客ID | acme-corp | システム上の識別子 |

---

## データの分離

### なぜ分離が必要？

```
A社の社員がB社のデータを見れたら大問題！
→ 顧客ごとにデータを完全に分離する必要がある
```

### どうやって分離している？

Firestoreの階層構造で分離:

```
customers/
├── acme-corp/                 ← A社のデータ
│   ├── name: "株式会社ACME"
│   └── checkpoints/
│       ├── user1_abc123/      ← A社ユーザーの会話
│       └── user2_def456/
│
├── beta-inc/                  ← B社のデータ
│   ├── name: "ベータ株式会社"
│   └── checkpoints/
│       └── user3_ghi789/      ← B社ユーザーの会話
```

A社のユーザーは `customers/acme-corp/` 以下にしかアクセスできない。

---

## Custom Claims とは？

Firebase Authの「カスタム属性」機能。

### イメージ

```
【普通のログイン情報】
- uid: "abc123"
- email: "yamada@acme.co.jp"
- displayName: "山田太郎"

【Custom Claims を追加】
- uid: "abc123"
- email: "yamada@acme.co.jp"
- displayName: "山田太郎"
- customer_id: "acme-corp"  ← これ！
```

### なぜ Custom Claims を使う？

1. IDトークンに含まれる → API呼び出しのたびに取得不要
2. Firebase が管理 → 安全
3. サーバー側でしか設定できない → ユーザーが改ざんできない

---

## 顧客管理の操作

### 管理スクリプト一覧

```bash
cd backend

# === 基本操作 ===
python scripts/manage_customer.py list                    # 顧客一覧
python scripts/manage_customer.py add 顧客ID "顧客名"     # 顧客作成
python scripts/manage_customer.py show 顧客ID             # 顧客詳細
python scripts/manage_customer.py show-user メール        # ユーザー詳細

# === 自動振り分け設定（推奨） ===
python scripts/manage_customer.py add-domain 顧客ID ドメイン    # ドメイン追加
python scripts/manage_customer.py add-email 顧客ID メール       # メール追加
python scripts/manage_customer.py remove-domain 顧客ID ドメイン # ドメイン削除
python scripts/manage_customer.py remove-email 顧客ID メール    # メール削除

# === 手動紐付け（自動振り分けを使わない場合のみ） ===
python scripts/manage_customer.py add-user 顧客ID メール  # 手動紐付け
```

---

## 自動振り分け機能（推奨）

### なぜ自動振り分け？

```
【従来の方法】400人の会社を登録する場合
  → 400回 add-user コマンドを実行... 大変！

【自動振り分け】
  → 1回 add-domain を実行するだけ！
  → @acme.co.jp のユーザーは全員自動で振り分け
```

### 2種類の自動振り分け

| 方法 | コマンド | 用途 |
|------|----------|------|
| ドメイン登録 | `add-domain` | 社員全員を一括登録（@acme.co.jpなど） |
| メール登録 | `add-email` | 業務委託者を個別登録（外部メール） |

### 自動振り分けの流れ（推奨）

```
【ステップ1】顧客を作成
  python scripts/manage_customer.py add acme-corp "株式会社ACME"

【ステップ2】ドメインを登録（これで400人でも自動対応！）
  python scripts/manage_customer.py add-domain acme-corp acme.co.jp

【ステップ3】業務委託者がいれば個別追加
  python scripts/manage_customer.py add-email acme-corp tanaka@gmail.com

【完了】ユーザーがログインすると自動で振り分けられる！
  → yamada@acme.co.jp でログイン
  → システムが @acme.co.jp を検知
  → 自動で acme-corp に振り分け
```

### 設定の確認

```bash
python scripts/manage_customer.py show acme-corp
```

出力例:
```
=== 株式会社ACME ===

  ID: acme-corp
  作成日: 2024-01-15

  [自動振り分け]
  ドメイン: @acme.co.jp
  メール: tanaka@gmail.com

  [所属ユーザー] 3人
    yamada@acme.co.jp （自動）
    sato@acme.co.jp （自動）
    tanaka@gmail.com （自動）
```

---

## 手動紐付け（従来の方法）

自動振り分けを使わない場合のみ使用します。

### 手動紐付けの流れ

```
1. 顧客を作成
   python scripts/manage_customer.py add acme-corp "株式会社ACME"

   Firestore:
   └── customers/acme-corp/
       └── name: "株式会社ACME"

2. ユーザーがGoogleログイン
   （まだ customer_id は未設定）

3. ユーザーを顧客に紐付け
   python scripts/manage_customer.py add-user acme-corp yamada@acme.co.jp

   - Firebase Auth の Custom Claims に customer_id を設定
   - Firestore にもバックアップを保存

4. ユーザーが再ログインを依頼
   （新しいIDトークンに customer_id が含まれる）

5. APIを呼び出すと...
   - バックエンドが customer_id を取得
   - 対応する顧客のデータにアクセス
```

### 自動振り分け vs 手動紐付け

| 項目 | 自動振り分け | 手動紐付け |
|------|--------------|------------|
| 設定タイミング | ログイン前でもOK | ログイン後のみ |
| 再ログイン | 不要 | 必要 |
| 大量ユーザー | 1コマンドでOK | 1人ずつ必要 |
| 推奨 | はい | 特殊ケースのみ |

---

## コードの解説

### auth.py

```python
def get_user_customer_id(uid: str, email: str = None) -> str:
    """
    ユーザーの customer_id を取得（自動振り分け対応）

    1. まずCustom Claimsを確認
    2. なければメールのドメインから自動検索
    3. 見つかれば自動でCustom Claimsを設定
    """
    user = auth.get_user(uid)
    claims = user.custom_claims or {}
    customer_id = claims.get("customer_id")

    # 既にCustom Claimsがあればそれを返す
    if customer_id:
        return customer_id

    # 自動振り分けを試行
    if email:
        customer_id = auto_assign_customer(uid, email)
        if customer_id:
            return customer_id

    raise ValueError("顧客に紐付けされていません。管理者に連絡してください。")
```

### firestore_checkpointer.py

```python
def _get_checkpoint_ref(self, thread_id: str):
    """
    顧客別のパスを生成
    """
    return (
        self.db.collection("customers")
        .document(self.customer_id)      # ← 顧客ID
        .collection("checkpoints")
        .document(thread_id)
        .collection("checkpoints")
    )
    # → customers/{customer_id}/checkpoints/{thread_id}/checkpoints/
```

---

## 注意事項

### 1. 再ログインが必要

Custom Claims を設定した後、ユーザーは再ログインが必要。
IDトークンは発行時の情報を持っているため。

### 2. 1ユーザー = 1顧客

現在の設計では、1人のユーザーは1つの顧客にしか所属できない。
複数顧客に所属させたい場合は設計変更が必要。

### 3. 未紐付けユーザーの扱い

customer_id が未設定で、自動振り分けにもマッチしないユーザーは
エラーになります。（「顧客に紐付けされていません」）

必ず事前にドメインまたはメールを登録してください。

---

## Firebaseコンソールでの確認

### Custom Claims を確認

Firebase Console → Authentication → Users
→ ユーザーをクリック → カスタム クレーム

### Firestoreのデータを確認

Firebase Console → Firestore Database
→ customers コレクションを展開

---

## まとめ

```
【推奨: 自動振り分けを使う場合】

1. manage_customer.py add で顧客を作成

2. manage_customer.py add-domain でドメインを登録
   → これだけで社員全員が自動振り分け対象に！

3. ユーザーがログイン
   → 自動で顧客に振り分けられる（再ログイン不要）

4. 完了！


【従来: 手動紐付けを使う場合】

1. manage_customer.py add で顧客を作成

2. ユーザーにGoogleログインしてもらう

3. manage_customer.py add-user で紐付け
   - Custom Claims に customer_id を設定
   - Firestore にバックアップ

4. ユーザーに再ログインしてもらう（重要！）

5. 完了
```
