# システム全体像

このシステムは「AIチャットボット」を複数の顧客に提供するプラットフォームです。

---

## 何をするシステム？

```
ユーザー → チャット送信 → AI（Gemini）が返答 → 画面に表示
```

シンプルに言うと「ChatGPTみたいなもの」を自社で作って、
お客さんに提供するシステムです。

---

## 使っている技術

### 全体図

```
┌─────────────────────────────────────────────────┐
│              ユーザーのブラウザ                    │
│              （Chrome, Safari等）                 │
└─────────────────────────────────────────────────┘
                        │
                        │ HTTPS通信
                        ▼
┌─────────────────────────────────────────────────┐
│           Firebase Hosting                       │
│           フロントエンド（React）                  │
│           ※画面を表示する部分                     │
└─────────────────────────────────────────────────┘
                        │
                        │ API呼び出し
                        ▼
┌─────────────────────────────────────────────────┐
│           Cloud Run Functions                    │
│           バックエンド（Python）                  │
│           ※処理をする部分                        │
└─────────────────────────────────────────────────┘
                        │
          ┌─────────────┼─────────────┐
          │             │             │
          ▼             ▼             ▼
    ┌──────────┐  ┌──────────┐  ┌──────────┐
    │ Firebase │  │ Firestore│  │ Vertex AI│
    │   Auth   │  │(データベース)│  │ (Gemini) │
    │(ログイン) │  │          │  │          │
    └──────────┘  └──────────┘  └──────────┘
```

### 各技術の役割

| 技術 | 役割 | 例えるなら |
|------|------|-----------|
| Firebase Hosting | 画面を配信 | レストランの建物 |
| React | 画面を作る | 内装・インテリア |
| Cloud Run Functions | 処理をする | 厨房 |
| Python | 処理を書く言語 | 料理人の技術 |
| Firebase Auth | ログイン管理 | 受付係 |
| Firestore | データ保存 | 冷蔵庫・倉庫 |
| Vertex AI (Gemini) | AIの頭脳 | シェフの知識 |

---

## データの流れ

### 1. ログイン時

```
1. ユーザーが「Googleでログイン」をクリック
       ↓
2. Googleのログイン画面が表示される
       ↓
3. ログイン成功すると「IDトークン」がもらえる
       ↓
4. このトークンを使ってAPIを呼び出す
```

### 2. チャット送信時

```
1. ユーザーがメッセージを入力して送信
       ↓
2. フロントエンドがバックエンドにAPIリクエスト
   （IDトークン付き）
       ↓
3. バックエンドがトークンを検証
   →「このユーザーは本物か？」「許可されているか？」
       ↓
4. Vertex AI（Gemini）にメッセージを送る
       ↓
5. AIが返答を生成
       ↓
6. ストリーミングで少しずつ返答を返す
       ↓
7. フロントエンドが画面に表示
```

---

## マルチテナント（複数顧客対応）

### 顧客ごとにデータを分離

```
Firestore
├── customers/
│   ├── acme-corp/          ← A社のデータ
│   │   ├── name: "株式会社ACME"
│   │   └── checkpoints/    ← A社の会話履歴
│   │
│   ├── beta-inc/           ← B社のデータ
│   │   ├── name: "ベータ株式会社"
│   │   └── checkpoints/    ← B社の会話履歴
│   │
│   └── gamma-llc/          ← C社のデータ
│       ├── name: "ガンマ合同会社"
│       └── checkpoints/    ← C社の会話履歴
```

### どうやって分離している？

1. ユーザーがログインする
2. Firebase Authの「Custom Claims」に `customer_id` が入っている
3. バックエンドがこの `customer_id` を見て、対応するデータにアクセス

```python
# こんなイメージ
customer_id = "acme-corp"
data_path = f"customers/{customer_id}/checkpoints"  # → customers/acme-corp/checkpoints
```

---

## 重要なファイル（バックエンド）

```
backend/src/
├── main.py              ← すべての入口（★最初に読む）
├── common/
│   ├── auth.py          ← 認証処理（★2番目に読む）
│   ├── rate_limiter.py  ← 使いすぎ防止
│   └── ...
└── agents/
    ├── sample_agent/    ← AIエージェント本体（★3番目に読む）
    └── firestore_checkpointer.py  ← 会話履歴保存
```

---

## 重要なファイル（フロントエンド）

```
frontend/src/
├── App.tsx              ← 画面の入口
├── hooks/
│   ├── useAuth.ts       ← ログイン処理
│   └── useChat.ts       ← チャット送受信
└── services/
    └── api.ts           ← バックエンドとの通信
```

---

## 次に読むべきファイル

1. `learning/02_バックエンド解説.py` - Pythonコードの詳細解説
2. 実際のコード `backend/src/main.py` を読んでみる
