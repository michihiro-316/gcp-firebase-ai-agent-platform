# 動かしてみよう

実際にローカルで動かしてみましょう。

---

## 2つの起動方法

| 方法 | 用途 | GCP必要 | 認証必要 |
|------|------|---------|---------|
| **モックモード** | フロントエンド開発、UI確認 | 不要 | 不要 |
| **本番モード** | AI動作確認、本番テスト | 必要 | 必要 |

**おすすめ**: まずモックモードで動作確認 → 本番モードでAI確認

---

## モックモード（GCP不要・すぐ動く）

GCP/Firebase接続なしでフロントエンドの動作確認ができます。

### 準備するもの

- Python 3.11以上
- Node.js 18以上
- **GCPは不要！**

### 手順

**ターミナル1: モックサーバー起動**

```bash
cd backend/dev
pip install flask flask-cors  # 初回のみ
python mock_server.py
```

**ターミナル2: フロントエンド起動**

```bash
cd frontend
npm install  # 初回のみ

# .env を編集（モックサーバーに接続）
# VITE_API_URL=http://localhost:8080
# VITE_DEBUG_MODE=true

npm run dev
```

**ブラウザで確認**

http://localhost:5173/ を開く → 認証なしでチャット画面が表示される

### モックサーバーの特徴

- AIの代わりに固定レスポンスを返す
- 課金なし
- 認証スキップ
- 詳細は `backend/dev/README.md` を参照

---

## 本番モード（AI動作確認）

### 準備するもの

- Python 3.11以上
- Node.js 18以上
- GCPプロジェクト（セットアップ済み）
- service-account.json（ダウンロード済み）

---

## 本番モードの手順

### 1. バックエンドを起動

ターミナル1:

```bash
# backendフォルダに移動
cd backend

# 依存パッケージをインストール（初回のみ）
pip install -r requirements.txt

# サーバーを起動
functions-framework --target=main --port=8080
```

成功すると:
```
* Serving Flask app 'main'
* Running on http://127.0.0.1:8080
```

### 2. フロントエンドを起動

ターミナル2（別のターミナルを開く）:

```bash
# frontendフォルダに移動
cd frontend

# 依存パッケージをインストール（初回のみ）
npm install

# 開発サーバーを起動
npm run dev
```

成功すると:
```
VITE v5.x.x  ready in xxx ms

➜  Local:   http://localhost:5173/
```

### 3. ブラウザでアクセス

http://localhost:5173/ を開く

---

## 試してみること

### 1. ログインする

1. 「Googleでログイン」をクリック
2. Googleアカウントを選択
3. ログイン成功 → チャット画面が表示される

### 2. チャットする

1. 「こんにちは」と入力
2. 送信ボタンをクリック
3. AIが返答する

### 3. Firestoreを確認

1. Firebase Console を開く
2. Firestore Database をクリック
3. `customers/{customer_id}/checkpoints` を確認
4. 会話履歴が保存されている！

---

## トラブルシューティング

### 「CORS エラー」が出る

backend/.env を確認:
```
ALLOWED_ORIGINS=http://localhost:5173
```

### 「認証エラー」が出る

1. Firebase Console → Authentication
2. Sign-in method で Google が有効か確認
3. config/access_control にドメイン/メールを追加

### 「Vertex AI エラー」が出る

1. GCP Console → APIs & Services
2. Vertex AI API が有効か確認
3. サービスアカウントに「Vertex AI ユーザー」ロールがあるか確認

---

## デバッグのコツ

### バックエンドのログを見る

ターミナル1に表示される:
```
127.0.0.1 - - [16/Jan/2024 10:00:00] "POST /chat HTTP/1.1" 200 -
```

### ブラウザの開発者ツール

1. F12 を押す
2. Network タブ → API呼び出しを確認
3. Console タブ → エラーを確認

### Firestoreのデータを見る

Firebase Console → Firestore Database
- リアルタイムでデータが更新される
- どんなデータが保存されているか確認

---

## 次にやること

1. コードを少し変えてみる
2. AIの返答が変わるか確認
3. `learning/05_顧客管理の仕組み.md` を読む
