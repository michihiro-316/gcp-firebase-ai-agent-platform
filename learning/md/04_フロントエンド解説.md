# フロントエンド解説

フロントエンド（画面側）のコードを解説します。

---

## 使っている技術

| 技術 | 役割 |
|------|------|
| React | UIを作るライブラリ |
| TypeScript | 型のあるJavaScript |
| Vite | 開発サーバー・ビルドツール |
| Firebase SDK | Firebase連携 |

---

## ファイル構成

```
frontend/src/
├── App.tsx           ← メインのコンポーネント
├── main.tsx          ← エントリーポイント
├── hooks/            ← カスタムフック
│   ├── useAuth.ts    ← ログイン処理
│   ├── useChat.ts    ← チャット処理
│   └── useSessions.ts ← セッション管理（複数会話の保存）★重要
├── services/         ← 外部サービス連携
│   ├── firebase.ts   ← Firebase初期化
│   └── api.ts        ← APIクライアント
├── components/       ← UIパーツ
│   ├── ChatScreen.tsx ← チャット画面
│   └── LoginScreen.tsx ← ログイン画面
└── renderers/        ← 【上級者向け】チャット表示カスタマイズ
    ├── types.ts      ← 型定義
    ├── index.ts      ← レンダラー選択
    ├── default/      ← デフォルトのレンダラー
    └── _examples/    ← サンプル実装
```

> **💡 初学者へ**: `renderers/` フォルダは上級者向けです。
> 最初の学習では**スキップしてOK**です。
> まずは `App.tsx` と `hooks/` を理解しましょう。

---

## 重要な概念

### 1. コンポーネントとは？

画面のパーツ。レゴブロックのようなもの。

```tsx
// ボタンコンポーネント
function MyButton() {
  return <button>クリック</button>;
}

// 使う側
function App() {
  return (
    <div>
      <MyButton />  {/* ← ここで使う */}
    </div>
  );
}
```

### 2. useState とは？

コンポーネント内で「状態」を持つための仕組み。

```tsx
function Counter() {
  // count という状態を作る（初期値 0）
  // setCount で値を変更できる
  const [count, setCount] = useState(0);

  return (
    <div>
      <p>カウント: {count}</p>
      <button onClick={() => setCount(count + 1)}>
        +1
      </button>
    </div>
  );
}
```

### 3. useEffect とは？

「副作用」を実行するための仕組み。
コンポーネントが表示されたとき、更新されたときに処理を実行。

```tsx
function UserProfile() {
  const [user, setUser] = useState(null);

  // コンポーネントが表示されたときにユーザー情報を取得
  useEffect(() => {
    fetchUser().then(data => setUser(data));
  }, []);  // [] は「最初の1回だけ実行」の意味

  return <div>{user?.name}</div>;
}
```

### 4. カスタムフックとは？

`use` で始まる関数。ロジックを再利用するための仕組み。

```tsx
// useAuth.ts - ログイン処理をまとめたカスタムフック
function useAuth() {
  const [user, setUser] = useState(null);
  const [loading, setLoading] = useState(true);

  const login = async () => {
    // ログイン処理
  };

  const logout = async () => {
    // ログアウト処理
  };

  return { user, loading, login, logout };
}

// 使う側
function App() {
  const { user, login, logout } = useAuth();
  // ...
}
```

---

## ログイン処理の流れ

```tsx
// useAuth.ts の概要

function useAuth() {
  // 1. 状態を定義
  const [user, setUser] = useState(null);

  // 2. Firebase Authの状態変化を監視
  useEffect(() => {
    // ログイン/ログアウトしたときに呼ばれる
    const unsubscribe = onAuthStateChanged(auth, (firebaseUser) => {
      setUser(firebaseUser);
    });

    // クリーンアップ
    return () => unsubscribe();
  }, []);

  // 3. ログイン関数
  const login = async () => {
    const provider = new GoogleAuthProvider();
    await signInWithPopup(auth, provider);
    // → 成功すると onAuthStateChanged が呼ばれる
  };

  return { user, login };
}
```

---

## チャット処理の流れ

```tsx
// useChat.ts の概要

function useChat() {
  const [messages, setMessages] = useState([]);
  const { user } = useAuth();

  const sendMessage = async (text) => {
    // 1. IDトークンを取得
    const token = await user.getIdToken();

    // 2. APIを呼び出し（ストリーミング）
    const response = await fetch('/chat', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ message: text }),
    });

    // 3. ストリーミングで受け取る
    const reader = response.body.getReader();
    while (true) {
      const { done, value } = await reader.read();
      if (done) break;

      // 受け取ったデータを表示
      const chunk = new TextDecoder().decode(value);
      // ... 画面に表示
    }
  };

  return { messages, sendMessage };
}
```

---

## Server-Sent Events (SSE) とは？

サーバーから「少しずつ」データを受け取る仕組み。

```
【普通のAPI】
リクエスト → サーバー処理（3秒）→ 全部まとめてレスポンス

【SSE】
リクエスト → 「こん」→「にち」→「は」→「！」→ 完了

チャットの返答がリアルタイムで表示される！
```

---

## TypeScript の型

TypeScriptでは「型」を指定します。
間違いを事前に防げます。

```tsx
// 型を定義
type Message = {
  id: string;
  text: string;
  sender: 'user' | 'assistant';
  timestamp: Date;
};

// 使う
const messages: Message[] = [];

// ↓ これはエラーになる（型が違う）
// messages.push({ text: 123 });  // text は string のはず！
```

---

## セッション管理（useSessions.ts）

複数の会話を管理する仕組みです。

```tsx
// useSessions.ts の概要

function useSessions() {
  // セッション一覧をローカルストレージから読み込み
  const [sessions, setSessions] = useState([]);

  // 新しいセッション（会話）を作成
  const createSession = () => { /* ... */ };

  // セッションを切り替え
  const switchSession = (id) => { /* ... */ };

  // セッションを削除
  const closeSession = (id) => { /* ... */ };

  return { sessions, createSession, switchSession, closeSession };
}
```

### セッションの特徴

| 項目 | 内容 |
|------|------|
| 保存場所 | ブラウザのローカルストレージ |
| 最大数 | 10セッションまで |
| デバイス間同期 | なし |
| タイトル | 最初のメッセージから自動生成 |

---

## 次に読むべき

1. `frontend/src/App.tsx` - 実際のコード
2. `frontend/src/hooks/useAuth.ts` - ログイン処理
3. `frontend/src/hooks/useSessions.ts` - セッション管理
4. `learning/md/10_動かしてみよう.md` - 実際に動かす
5. `learning/md/FLOW_04_セッション管理の流れ.md` - セッション管理の詳細
