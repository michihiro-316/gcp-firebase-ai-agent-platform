# 動かしてみよう

```
╔══════════════════════════════════════════════════════════════════════════════╗
║                                                                              ║
║   🚀 動かしてみよう                                                           ║
║                                                                              ║
║   「百聞は一見にしかず、百見は一動にしかず」                                    ║
║   「実際に動かしてみると理解が深まる！」                                        ║
║                                                                              ║
╚══════════════════════════════════════════════════════════════════════════════╝
```

---

## この章で学ぶこと

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  📚 学習目標                                                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  1. モックモードで動作確認（GCP不要）                                         │
│  2. 本番モードでAI動作確認                                                   │
│  3. トラブルシューティング                                                    │
│  4. デバッグのコツ                                                           │
│                                                                             │
│  ⏱️ 想定学習時間: 15分                                                       │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 2つの起動方法

| 方法 | 用途 | GCP必要 | 認証必要 |
|------|------|---------|---------|
| **モックモード** | フロントエンド開発、UI確認 | 不要 | 不要 |
| **本番モード** | AI動作確認、本番テスト | 必要 | 必要 |

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  💡 おすすめの順番                                                           │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   1️⃣  まずモックモードで動作確認                                              │
│       → GCP設定なしですぐ動く                                                │
│       → UIやフロントエンドの動作を確認                                        │
│                                                                             │
│   2️⃣  次に本番モードでAI確認                                                  │
│       → 実際のGemini AIと会話                                                │
│       → 本番と同じ動作を確認                                                  │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## モックモード（GCP不要・すぐ動く）

GCP/Firebase接続なしでフロントエンドの動作確認ができます。

### 準備するもの

- Python 3.11以上
- Node.js 18以上
- **GCPは不要！**

### 手順

**ターミナル1: モックサーバー起動**

```bash
cd backend/dev
pip install flask flask-cors  # 初回のみ
python mock_server.py
```

**ターミナル2: フロントエンド起動**

```bash
cd frontend
npm install  # 初回のみ

# .env を編集
# VITE_API_BASE_URL=http://localhost:8080
# VITE_DEBUG_MODE=true

npm run dev
```

**ブラウザで確認**

http://localhost:5173/ を開く → 認証なしでチャット画面が表示される

### モックサーバーの特徴

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  🎭 モックサーバーとは？                                                     │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   本物のバックエンドの「ふり」をするサーバー                                   │
│                                                                             │
│   ✅ AIの代わりに固定レスポンスを返す                                         │
│   ✅ 課金なし（Vertex AI を使わない）                                         │
│   ✅ 認証スキップ                                                            │
│   ✅ フロントエンド開発に集中できる                                           │
│                                                                             │
│   詳細は backend/dev/README.md を参照                                        │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 本番モード（AI動作確認）

### 準備するもの

- Python 3.11以上
- Node.js 18以上
- GCPプロジェクト（セットアップ済み）
- service-account.json（ダウンロード済み）

---

## 本番モードの手順

### 1. バックエンドを起動

ターミナル1:

```bash
# backendフォルダに移動
cd backend

# 依存パッケージをインストール（初回のみ）
pip install -r requirements.txt

# サーバーを起動
functions-framework --target=main --port=8080
```

成功すると:
```
* Serving Flask app 'main'
* Running on http://127.0.0.1:8080
```

### 2. フロントエンドを起動

ターミナル2（別のターミナルを開く）:

```bash
# frontendフォルダに移動
cd frontend

# 依存パッケージをインストール（初回のみ）
npm install

# 開発サーバーを起動
npm run dev
```

成功すると:
```
VITE v5.x.x  ready in xxx ms

➜  Local:   http://localhost:5173/
```

### 3. ブラウザでアクセス

http://localhost:5173/ を開く

---

## 試してみること

### 1. ログインする

1. 「Googleでログイン」をクリック
2. Googleアカウントを選択
3. ログイン成功 → チャット画面が表示される

### 2. チャットする

1. 「こんにちは」と入力
2. 送信ボタンをクリック
3. AIが返答する

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  💬 チャットの動きを観察しよう                                                │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   ・文字が1文字ずつ表示される（ストリーミング）                                │
│   ・入力中はボタンが無効になる                                               │
│   ・エラーがあればメッセージが表示される                                       │
│                                                                             │
│   これらは全てフロントエンドのコードで制御されています！                        │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 3. Firestoreを確認

1. Firebase Console を開く
2. Firestore Database をクリック
3. `customers/{customer_id}/checkpoints` を確認
4. 会話履歴が保存されている！

---

## トラブルシューティング

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  🔧 よくあるエラーと対処法                                                   │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  【CORS エラー】                                                             │
│  backend/.env を確認:                                                       │
│    ALLOWED_ORIGINS=http://localhost:5173                                   │
│  （末尾にスラッシュをつけない）                                               │
│                                                                             │
│  【認証エラー】                                                              │
│  1. Firebase Console → Authentication                                       │
│  2. Sign-in method で Google が有効か確認                                   │
│  3. config/access_control にドメイン/メールを追加                            │
│                                                                             │
│  【Vertex AI エラー】                                                        │
│  1. GCP Console → APIs & Services                                          │
│  2. Vertex AI API が有効か確認                                              │
│  3. サービスアカウントに「Vertex AI ユーザー」ロールがあるか確認               │
│                                                                             │
│  【顧客に紐付けされていません】                                               │
│  python scripts/manage_customer.py add-email test-corp you@gmail.com        │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## デバッグのコツ

### バックエンドのログを見る

ターミナル1に表示される:
```
127.0.0.1 - - [16/Jan/2024 10:00:00] "POST /chat HTTP/1.1" 200 -
```

### ブラウザの開発者ツール

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  🔍 開発者ツールの使い方                                                     │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  1. F12 を押す（または右クリック → 検証）                                     │
│                                                                             │
│  2. Network タブ                                                            │
│     → API呼び出しを確認                                                     │
│     → リクエスト/レスポンスの中身を見る                                       │
│                                                                             │
│  3. Console タブ                                                            │
│     → エラーメッセージを確認                                                  │
│     → console.log の出力を見る                                               │
│                                                                             │
│  4. Application タブ                                                        │
│     → localStorage の中身を確認                                              │
│     → セッション情報を見る                                                   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### Firestoreのデータを見る

Firebase Console → Firestore Database
- リアルタイムでデータが更新される
- どんなデータが保存されているか確認

---

## コードを変更してみよう

### 実験1: AIの返答を変える

```python
# backend/src/agents/_template/agent.py

SYSTEM_PROMPT = """あなたは関西弁で話すAIアシスタントやで。
ユーザーの質問にフレンドリーに答えてや。"""
```

→ バックエンドを再起動 → チャットしてみる

### 実験2: 画面の色を変える

```css
/* frontend/src/styles.css */

.chat-container {
  background-color: #f0f8ff;  /* 薄い青に変更 */
}
```

→ 自動で画面が更新される（ホットリロード）

---

## まとめ

```
╔══════════════════════════════════════════════════════════════════════════════╗
║                                                                              ║
║   🎓 この章で学んだこと                                                       ║
║                                                                              ║
║   ✅ モックモードでGCPなしでも動作確認できる                                   ║
║   ✅ 本番モードで実際のAIと会話できる                                          ║
║   ✅ 開発者ツールでデバッグできる                                              ║
║   ✅ コードを変更して動作を確認する方法                                        ║
║                                                                              ║
║   次は AIのカスタマイズに挑戦してみよう！                                      ║
║                                                                              ║
╚══════════════════════════════════════════════════════════════════════════════╝
```

---

## 次に読むべきドキュメント

| 順番 | ドキュメント | 内容 |
|------|-------------|------|
| 1 | [08_AIカスタマイズ.md](./08_AIカスタマイズ.md) | AIの応答をカスタマイズ |
| 2 | [FLOW_01_チャット送信の流れ.md](./FLOW_01_チャット送信の流れ.md) | 詳細なデータフロー |
