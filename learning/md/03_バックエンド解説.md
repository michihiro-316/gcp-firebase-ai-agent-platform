# ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰è§£èª¬ - ã‚µãƒ¼ãƒãƒ¼ã®ä¸­èº«ã‚’å®Œå…¨ç†è§£ï¼

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  ğŸ¯ ã“ã®ãƒšãƒ¼ã‚¸ã®ã‚´ãƒ¼ãƒ«                                            â•‘
â•‘                                                                    â•‘
â•‘  ã€Œã‚µãƒ¼ãƒãƒ¼å´ã®ã‚³ãƒ¼ãƒ‰ã‚’è¦‹ã¦ã€ä½•ã‚’ã—ã¦ã‚‹ã‹ã‚ã‹ã‚‹ï¼ã€çŠ¶æ…‹ã«ãªã‚‹       â•‘
â•‘                                                                    â•‘
â•‘  ğŸ”¥ ã‚´ãƒ¼ãƒ«é”æˆå¾Œã®ã‚ãªãŸ:                                          â•‘
â•‘  ã€Œã“ã®APIã€èªè¨¼ â†’ ãƒ¬ãƒ¼ãƒˆåˆ¶é™ â†’ AIå‘¼ã³å‡ºã—ã®é †ã§å‡¦ç†ã—ã¦ã‚‹ã­ã€     â•‘
â•‘  ã¨è¨€ãˆã‚‹ã‚ˆã†ã«ãªã‚‹ï¼                                              â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

---

## ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã£ã¦ä½•ã—ã¦ã‚‹ã®ï¼Ÿ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®ä»•äº‹                                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚   ã€Œè¦‹ãˆãªã„ã¨ã“ã‚ã§é ‘å¼µã‚‹ç¸ã®ä¸‹ã®åŠ›æŒã¡ã€                        â”‚
â”‚                                                                 â”‚
â”‚   ãƒ»ã“ã®äººã¯æœ¬ç‰©ï¼Ÿ â†’ èªè¨¼                                        â”‚
â”‚   ãƒ»ã“ã®äººã¯ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã„ã„ï¼Ÿ â†’ è¨±å¯ç¢ºèª                         â”‚
â”‚   ãƒ»ä½¿ã„ã™ãã¦ãªã„ï¼Ÿ â†’ ãƒ¬ãƒ¼ãƒˆåˆ¶é™                                â”‚
â”‚   ãƒ»AIã«èã„ã¦ç­”ãˆã‚’è¿”ã™ â†’ AIå‘¼ã³å‡ºã—                            â”‚
â”‚   ãƒ»ä¼šè©±ã‚’è¦šãˆã¦ãŠã â†’ å±¥æ­´ä¿å­˜                                  â”‚
â”‚                                                                 â”‚
â”‚   ğŸ’¡ GASã§è¨€ã†ã¨: doGet() ã‚„ doPost() ã®ä¸­èº«ã‚’ä½œã‚‹ã‚¤ãƒ¡ãƒ¼ã‚¸        â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ

```
backend/src/
â”œâ”€â”€ main.py              â˜… ã™ã¹ã¦ã®å…¥å£ï¼ˆæœ€åˆã«èª­ã‚€ï¼‰
â”œâ”€â”€ common/
â”‚   â”œâ”€â”€ auth.py          â˜… èªè¨¼å‡¦ç†ï¼ˆ2ç•ªç›®ã«èª­ã‚€ï¼‰
â”‚   â”œâ”€â”€ config.py           è¨­å®šèª­ã¿è¾¼ã¿
â”‚   â”œâ”€â”€ firebase_init.py    FirebaseåˆæœŸåŒ–
â”‚   â””â”€â”€ rate_limiter.py     ãƒ¬ãƒ¼ãƒˆåˆ¶é™
â””â”€â”€ agents/
    â”œâ”€â”€ _base/
    â”‚   â”œâ”€â”€ base_agent.py        ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®åŸºåº•ã‚¯ãƒ©ã‚¹
    â”‚   â””â”€â”€ firestore_checkpointer.py  ä¼šè©±å±¥æ­´ä¿å­˜
    â””â”€â”€ _template/
        â””â”€â”€ agent.py     â˜… AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆæœ¬ä½“ï¼ˆ3ç•ªç›®ã«èª­ã‚€ï¼‰

backend/scripts/
â””â”€â”€ manage_customer.py   â˜… é¡§å®¢ç®¡ç†ã‚³ãƒãƒ³ãƒ‰ï¼ˆé‹ç”¨æ™‚ã«å¿…é ˆï¼‰
```

---

## 1. main.py - ã™ã¹ã¦ã®å…¥å£

### ãªãœã€Œå…¥å£ã€ãŒå¿…è¦ï¼Ÿ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸšª main.py = ãƒ›ãƒ†ãƒ«ã®ãƒ•ãƒ­ãƒ³ãƒˆãƒ‡ã‚¹ã‚¯                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  ã€ãƒ•ãƒ­ãƒ³ãƒˆãƒ‡ã‚¹ã‚¯ã®ä»•äº‹ã€‘                                        â”‚
â”‚                                                                 â”‚
â”‚  ãŠå®¢ã•ã‚“:ã€Œãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³ã—ãŸã„ã‚“ã§ã™ã‘ã©ã€                        â”‚
â”‚       â†“                                                         â”‚
â”‚  ãƒ•ãƒ­ãƒ³ãƒˆ:ã€Œã‹ã—ã“ã¾ã‚Šã¾ã—ãŸã€‚ãŠåå‰ã¯ï¼Ÿäºˆç´„ç•ªå·ã¯ï¼Ÿã€            â”‚
â”‚       â†“                                                         â”‚
â”‚  ãƒ•ãƒ­ãƒ³ãƒˆ:ã€Œç¢ºèªã§ãã¾ã—ãŸã€‚ã“ã¡ã‚‰ãŒãŠéƒ¨å±‹ã®éµã§ã™ã€              â”‚
â”‚                                                                 â”‚
â”‚  ã€main.py ã®ä»•äº‹ã€‘                                              â”‚
â”‚                                                                 â”‚
â”‚  ãƒªã‚¯ã‚¨ã‚¹ãƒˆ:ã€Œ/chat ã« POST ã—ãŸã„ã‚“ã§ã™ã‘ã©ã€                    â”‚
â”‚       â†“                                                         â”‚
â”‚  main.py:ã€Œã‹ã—ã“ã¾ã‚Šã¾ã—ãŸã€‚ãƒˆãƒ¼ã‚¯ãƒ³ã¯ï¼Ÿãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ï¼Ÿã€         â”‚
â”‚       â†“                                                         â”‚
â”‚  main.py:ã€Œç¢ºèªã§ãã¾ã—ãŸã€‚ã“ã¡ã‚‰ãŒAIã®å›ç­”ã§ã™ã€                 â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆä¸€è¦§

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ“¡ ç”¨æ„ã•ã‚Œã¦ã„ã‚‹ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚   ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ      ãƒ¡ã‚½ãƒƒãƒ‰   å½¹å‰²                            â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚
â”‚   /health            GET       ç”Ÿå­˜ç¢ºèªï¼ˆã‚µãƒ¼ãƒãƒ¼å‹•ã„ã¦ã‚‹ï¼Ÿï¼‰    â”‚
â”‚   /chat              POST      ãƒãƒ£ãƒƒãƒˆAPIï¼ˆãƒ¡ã‚¤ãƒ³æ©Ÿèƒ½ï¼‰         â”‚
â”‚   /agents            GET       ä½¿ãˆã‚‹AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆä¸€è¦§          â”‚
â”‚                                                                 â”‚
â”‚   ğŸ’¡ ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¨ã¯:                                         â”‚
â”‚      ã€Œã“ã®URLã«ã“ã®ãƒ¡ã‚½ãƒƒãƒ‰ã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆã™ã‚‹ã¨ã€                 â”‚
â”‚       ã“ã®å‡¦ç†ãŒå®Ÿè¡Œã•ã‚Œã¾ã™ã‚ˆã€ã¨ã„ã†çª“å£ã®ã“ã¨                  â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### /chat ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®å…¨å‡¦ç†ãƒ•ãƒ­ãƒ¼

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ’¬ /chat ã®å‡¦ç†ãƒ•ãƒ­ãƒ¼ï¼ˆå®Œå…¨ç‰ˆï¼‰                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  POST /chat                                                     â”‚
â”‚  {                                                              â”‚
â”‚    "message": "ã“ã‚“ã«ã¡ã¯",                                      â”‚
â”‚    "thread_id": "abc123"  // çœç•¥å¯                             â”‚
â”‚  }                                                              â”‚
â”‚         â”‚                                                       â”‚
â”‚         â–¼                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ ã‚¹ãƒ†ãƒƒãƒ—1: èªè¨¼ãƒã‚§ãƒƒã‚¯                                    â”‚  â”‚
â”‚  â”‚                                                          â”‚  â”‚
â”‚  â”‚   authenticate_request(request)                          â”‚  â”‚
â”‚  â”‚       â”‚                                                  â”‚  â”‚
â”‚  â”‚       â”œâ”€ ãƒˆãƒ¼ã‚¯ãƒ³ãŒãªã„ â†’ ã‚¨ãƒ©ãƒ¼ã€Œèªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ãŒã‚ã‚Šã¾ã›ã‚“ã€â”‚  â”‚
â”‚  â”‚       â”œâ”€ ãƒˆãƒ¼ã‚¯ãƒ³ãŒå½ç‰© â†’ ã‚¨ãƒ©ãƒ¼ã€Œèªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ãŒç„¡åŠ¹ã§ã™ã€  â”‚  â”‚
â”‚  â”‚       â”œâ”€ è¨±å¯ã•ã‚Œã¦ãªã„ â†’ ã‚¨ãƒ©ãƒ¼ã€Œã‚¢ã‚¯ã‚»ã‚¹ãŒè¨±å¯ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€â”‚
â”‚  â”‚       â””â”€ OK â†’ user_info ã‚’å–å¾—ï¼ˆuid, email, customer_idï¼‰ â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚         â”‚                                                       â”‚
â”‚         â–¼                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ ã‚¹ãƒ†ãƒƒãƒ—2: ãƒ¬ãƒ¼ãƒˆåˆ¶é™ãƒã‚§ãƒƒã‚¯                              â”‚  â”‚
â”‚  â”‚                                                          â”‚  â”‚
â”‚  â”‚   check_rate_limit(user_id)                              â”‚  â”‚
â”‚  â”‚       â”‚                                                  â”‚  â”‚
â”‚  â”‚       â”œâ”€ 1åˆ†60å›è¶…é â†’ ã‚¨ãƒ©ãƒ¼ã€Œãƒªã‚¯ã‚¨ã‚¹ãƒˆåˆ¶é™ã‚’è¶…ãˆã¾ã—ãŸã€â”‚  â”‚
â”‚  â”‚       â””â”€ OK â†’ å‡¦ç†ç¶šè¡Œ                                   â”‚  â”‚
â”‚  â”‚                                                          â”‚  â”‚
â”‚  â”‚   ğŸ’¡ ãªãœãƒ¬ãƒ¼ãƒˆåˆ¶é™ï¼Ÿ                                     â”‚  â”‚
â”‚  â”‚      æ‚ªæ„ã®ã‚ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒAPIã‚’å¤§é‡ã«å©ã„ã¦                 â”‚  â”‚
â”‚  â”‚      ã‚µãƒ¼ãƒãƒ¼ã‚’ãƒ€ã‚¦ãƒ³ã•ã›ã‚‹ã“ã¨ã‚’é˜²ã                      â”‚  â”‚
â”‚  â”‚      AIå‘¼ã³å‡ºã—ã¯ãŠé‡‘ãŒã‹ã‹ã‚‹ã®ã§èª²é‡‘æ”»æ’ƒã‚‚é˜²ã            â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚         â”‚                                                       â”‚
â”‚         â–¼                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ ã‚¹ãƒ†ãƒƒãƒ—3: å…¥åŠ›å€¤æ¤œè¨¼                                      â”‚  â”‚
â”‚  â”‚                                                          â”‚  â”‚
â”‚  â”‚   ãƒ»ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒç©ºï¼Ÿ â†’ ã‚¨ãƒ©ãƒ¼                             â”‚  â”‚
â”‚  â”‚   ãƒ»ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒ10,000æ–‡å­—è¶…ï¼Ÿ â†’ ã‚¨ãƒ©ãƒ¼ï¼ˆDoSå¯¾ç­–ï¼‰         â”‚  â”‚
â”‚  â”‚   ãƒ»thread_idã«å¤‰ãªæ–‡å­—ï¼Ÿ â†’ ã‚¨ãƒ©ãƒ¼ï¼ˆã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³å¯¾ç­–ï¼‰ â”‚  â”‚
â”‚  â”‚                                                          â”‚  â”‚
â”‚  â”‚   ğŸ’¡ ãªãœå…¥åŠ›å€¤æ¤œè¨¼ï¼Ÿ                                     â”‚  â”‚
â”‚  â”‚      ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã®å…¥åŠ›ã¯ã€Œä¿¡ç”¨ã—ãªã„ã€ãŒé‰„å‰‡             â”‚  â”‚
â”‚  â”‚      æ‚ªæ„ã®ã‚ã‚‹å…¥åŠ›ã§ã‚·ã‚¹ãƒ†ãƒ ã‚’å£Šã•ã‚Œãªã„ã‚ˆã†ã«            â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚         â”‚                                                       â”‚
â”‚         â–¼                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ ã‚¹ãƒ†ãƒƒãƒ—4: AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå–å¾—                              â”‚  â”‚
â”‚  â”‚                                                          â”‚  â”‚
â”‚  â”‚   agent = get_agent(agent_name, customer_id)             â”‚  â”‚
â”‚  â”‚       â”‚                                                  â”‚  â”‚
â”‚  â”‚       â””â”€ é¡§å®¢IDã«ç´ã¥ã„ãŸã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’å–å¾—               â”‚  â”‚
â”‚  â”‚          ï¼ˆå°†æ¥çš„ã«é¡§å®¢ã”ã¨ã«é•ã†AIã‚’ä½¿ãˆã‚‹è¨­è¨ˆï¼‰          â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚         â”‚                                                       â”‚
â”‚         â–¼                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ ã‚¹ãƒ†ãƒƒãƒ—5: AIã‚’å‘¼ã³å‡ºã—ã¦ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°è¿”å´                â”‚  â”‚
â”‚  â”‚                                                          â”‚  â”‚
â”‚  â”‚   def generate():                                        â”‚  â”‚
â”‚  â”‚       for chunk in agent.run(message, thread_id):        â”‚  â”‚
â”‚  â”‚           yield f"data: {chunk}\n\n"                     â”‚  â”‚
â”‚  â”‚       yield "data: [DONE]\n\n"                           â”‚  â”‚
â”‚  â”‚                                                          â”‚  â”‚
â”‚  â”‚   return Response(generate(), mimetype="text/event-stream")â”‚
â”‚  â”‚                                                          â”‚  â”‚
â”‚  â”‚   ğŸ’¡ Server-Sent Events (SSE) å½¢å¼                       â”‚  â”‚
â”‚  â”‚      ã€Œdata: å†…å®¹ã€ã®å½¢ã§é€ã‚‹ã¨ã€ãƒ–ãƒ©ã‚¦ã‚¶ãŒè‡ªå‹•ã§å—ã‘å–ã‚‹ â”‚  â”‚
â”‚  â”‚      [DONE] ã¯ã€Œã‚‚ã†çµ‚ã‚ã‚Šã ã‚ˆã€ã®åˆå›³                    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ã‚³ãƒ¼ãƒ‰ï¼ˆå®Ÿéš›ã®æ§‹é€ ã«è¿‘ã„å½¢ï¼‰

```python
# main.py ã®æ§‹é€ ï¼ˆç°¡ç•¥åŒ–ã—ãŸã‚‚ã®ï¼‰

from flask import Flask, request, Response
from common.auth import authenticate_request
from common.rate_limiter import check_rate_limit

app = Flask(__name__)

# ========================================
# ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯: ã‚µãƒ¼ãƒãƒ¼ãŒç”Ÿãã¦ã‚‹ã‹ç¢ºèª
# ========================================
@app.route("/health", methods=["GET"])
def health():
    """ã‚µãƒ¼ãƒãƒ¼ç”Ÿå­˜ç¢ºèª"""
    return {"status": "healthy"}


# ========================================
# ãƒãƒ£ãƒƒãƒˆAPI: ãƒ¡ã‚¤ãƒ³ã®æ©Ÿèƒ½
# ========================================
@app.route("/chat", methods=["POST"])
def chat():
    """ãƒãƒ£ãƒƒãƒˆAPIï¼ˆã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°å¯¾å¿œï¼‰"""

    # === ã‚¹ãƒ†ãƒƒãƒ—1: èªè¨¼ãƒã‚§ãƒƒã‚¯ ===
    try:
        user_info = authenticate_request(request)
    except ValueError as e:
        return {"error": str(e)}, 401  # 401 = èªè¨¼ã‚¨ãƒ©ãƒ¼

    user_id = user_info["uid"]
    customer_id = user_info["customer_id"]

    # === ã‚¹ãƒ†ãƒƒãƒ—2: ãƒ¬ãƒ¼ãƒˆåˆ¶é™ãƒã‚§ãƒƒã‚¯ ===
    if not check_rate_limit(user_id):
        return {"error": "ãƒªã‚¯ã‚¨ã‚¹ãƒˆåˆ¶é™ã‚’è¶…ãˆã¾ã—ãŸã€‚1åˆ†å¾Œã«å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚"}, 429

    # === ã‚¹ãƒ†ãƒƒãƒ—3: å…¥åŠ›å€¤æ¤œè¨¼ ===
    data = request.get_json()
    message = data.get("message", "")
    thread_id = data.get("thread_id")

    # ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒç©º
    if not message.strip():
        return {"error": "ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒç©ºã§ã™"}, 400

    # ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒé•·ã™ãã‚‹ï¼ˆDoSå¯¾ç­–ï¼‰
    if len(message) > 10000:
        return {"error": "ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒé•·ã™ãã¾ã™ï¼ˆ10,000æ–‡å­—ã¾ã§ï¼‰"}, 400

    # thread_idã®å½¢å¼ãƒã‚§ãƒƒã‚¯ï¼ˆã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³å¯¾ç­–ï¼‰
    if thread_id and not is_valid_thread_id(thread_id):
        return {"error": "thread_idã®å½¢å¼ãŒä¸æ­£ã§ã™"}, 400

    # === ã‚¹ãƒ†ãƒƒãƒ—4: AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå–å¾— ===
    agent = get_agent("template", customer_id)

    # === ã‚¹ãƒ†ãƒƒãƒ—5: ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ã§è¿”ã™ ===
    def generate():
        """AIã®å›ç­”ã‚’å°‘ã—ãšã¤è¿”ã™ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼"""
        try:
            for chunk in agent.run(message, thread_id, user_id):
                # Server-Sent Events å½¢å¼ã§è¿”ã™
                yield f"data: {chunk}\n\n"
            yield "data: [DONE]\n\n"
        except Exception as e:
            yield f"data: ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {str(e)}\n\n"
            yield "data: [DONE]\n\n"

    return Response(
        generate(),
        mimetype="text/event-stream",  # ã“ã‚ŒãŒSSEã®å°
        headers={
            "Cache-Control": "no-cache",     # ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã—ãªã„
            "X-Accel-Buffering": "no"        # Nginxç”¨ã®ãƒãƒƒãƒ•ã‚¡ãƒªãƒ³ã‚°ç„¡åŠ¹åŒ–
        }
    )


def is_valid_thread_id(thread_id: str) -> bool:
    """thread_idã®å½¢å¼ã‚’æ¤œè¨¼ï¼ˆè‹±æ•°å­—ã€ãƒã‚¤ãƒ•ãƒ³ã€ã‚¢ãƒ³ãƒ€ãƒ¼ã‚¹ã‚³ã‚¢ã®ã¿ï¼‰"""
    import re
    return bool(re.match(r'^[a-zA-Z0-9_-]+$', thread_id))
```

---

## 2. auth.py - èªè¨¼å‡¦ç†ï¼ˆè¶…é‡è¦ï¼ï¼‰

### ãªãœèªè¨¼ãŒå¿…è¦ï¼Ÿ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ” èªè¨¼ãŒãªã„ã¨ä½•ãŒèµ·ãã‚‹ï¼Ÿ                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  ã€èªè¨¼ãªã—ã®å ´åˆã€‘                                              â”‚
â”‚                                                                 â”‚
â”‚  æ‚ªã„äºº:ã€Œä¿ºã¯å±±ç”°ã ï¼ãƒ‡ãƒ¼ã‚¿è¦‹ã›ã‚ï¼ã€                           â”‚
â”‚  ã‚µãƒ¼ãƒãƒ¼:ã€Œã¯ã„ã€ã©ã†ãã€                                       â”‚
â”‚                                                                 â”‚
â”‚  â†’ æƒ…å ±æ¼æ´©ï¼ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£äº‹æ•…ï¼æ–°èæ²™æ±°ï¼ğŸ˜±                      â”‚
â”‚                                                                 â”‚
â”‚  ã€èªè¨¼ã‚ã‚Šã®å ´åˆã€‘                                              â”‚
â”‚                                                                 â”‚
â”‚  æ‚ªã„äºº:ã€Œä¿ºã¯å±±ç”°ã ï¼ãƒ‡ãƒ¼ã‚¿è¦‹ã›ã‚ï¼ã€                           â”‚
â”‚  ã‚µãƒ¼ãƒãƒ¼:ã€Œèº«åˆ†è¨¼è¦‹ã›ã¦ã€                                       â”‚
â”‚  æ‚ªã„äºº:ã€Œ...æŒã£ã¦ãªã„ã€                                       â”‚
â”‚  ã‚µãƒ¼ãƒãƒ¼:ã€Œã˜ã‚ƒã‚ãƒ€ãƒ¡ã€                                        â”‚
â”‚                                                                 â”‚
â”‚  â†’ å®‰å…¨ï¼ğŸ˜Š                                                     â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### èªè¨¼ã®4ã¤ã®é–¢é–€ï¼ˆè©³ç´°ç‰ˆï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸš¨ èªè¨¼ã®4ã¤ã®é–¢é–€                                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  ãƒªã‚¯ã‚¨ã‚¹ãƒˆåˆ°ç€                                                  â”‚
â”‚  Headers: {                                                     â”‚
â”‚    "Authorization": "Bearer eyJhbGciOiJSUzI1NiIsInR5cCI6..."   â”‚
â”‚  }                                                              â”‚
â”‚         â”‚                                                       â”‚
â”‚         â–¼                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ é–¢é–€1: ãƒˆãƒ¼ã‚¯ãƒ³ãŒã‚ã‚‹ã‹ï¼Ÿ                                  â”‚  â”‚
â”‚  â”‚                                                          â”‚  â”‚
â”‚  â”‚   auth_header = request.headers.get("Authorization")     â”‚  â”‚
â”‚  â”‚                                                          â”‚  â”‚
â”‚  â”‚   if not auth_header:                                    â”‚  â”‚
â”‚  â”‚       â†’ ã‚¨ãƒ©ãƒ¼ã€Œèªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ãŒã‚ã‚Šã¾ã›ã‚“ã€                 â”‚  â”‚
â”‚  â”‚                                                          â”‚  â”‚
â”‚  â”‚   if not auth_header.startswith("Bearer "):              â”‚  â”‚
â”‚  â”‚       â†’ ã‚¨ãƒ©ãƒ¼ã€Œèªè¨¼ãƒ˜ãƒƒãƒ€ãƒ¼ã®å½¢å¼ãŒä¸æ­£ã§ã™ã€             â”‚  â”‚
â”‚  â”‚                                                          â”‚  â”‚
â”‚  â”‚   ğŸ’¡ "Bearer" = ã€ŒæŒã¡ä¸»ã€ã®æ„å‘³                          â”‚  â”‚
â”‚  â”‚      ã€Œã“ã®ãƒˆãƒ¼ã‚¯ãƒ³ã‚’æŒã£ã¦ã‚‹äººã«æ¨©é™ã‚’ä¸ãˆã‚‹ã€å½¢å¼        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚         â”‚ OK                                                    â”‚
â”‚         â–¼                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ é–¢é–€2: ãƒˆãƒ¼ã‚¯ãƒ³ã¯æœ¬ç‰©ã‹ï¼Ÿ                                  â”‚  â”‚
â”‚  â”‚                                                          â”‚  â”‚
â”‚  â”‚   user_info = auth.verify_id_token(                      â”‚  â”‚
â”‚  â”‚       id_token,                                          â”‚  â”‚
â”‚  â”‚       check_revoked=True  # â† å¤±åŠ¹ãƒã‚§ãƒƒã‚¯ï¼ˆé‡è¦ï¼ï¼‰       â”‚  â”‚
â”‚  â”‚   )                                                      â”‚  â”‚
â”‚  â”‚                                                          â”‚  â”‚
â”‚  â”‚   ã€Firebase Admin SDK ãŒå†…éƒ¨ã§ã‚„ã£ã¦ã‚‹ã“ã¨ã€‘             â”‚  â”‚
â”‚  â”‚   1. ãƒˆãƒ¼ã‚¯ãƒ³ã®ç½²åã‚’Googleã®å…¬é–‹éµã§æ¤œè¨¼                 â”‚  â”‚
â”‚  â”‚   2. æœ‰åŠ¹æœŸé™ãŒåˆ‡ã‚Œã¦ã„ãªã„ã‹ç¢ºèªï¼ˆ1æ™‚é–“ï¼‰                â”‚  â”‚
â”‚  â”‚   3. ãƒˆãƒ¼ã‚¯ãƒ³ã®ç™ºè¡Œè€…ãŒFirebaseã‹ç¢ºèª                     â”‚  â”‚
â”‚  â”‚   4. check_revoked=True ãªã‚‰å¤±åŠ¹ãƒªã‚¹ãƒˆã‚‚ç¢ºèª              â”‚  â”‚
â”‚  â”‚                                                          â”‚  â”‚
â”‚  â”‚   å¤±æ•—ãƒ‘ã‚¿ãƒ¼ãƒ³:                                           â”‚  â”‚
â”‚  â”‚   ãƒ»ç½²åãŒé•ã† â†’ æ”¹ã–ã‚“ã•ã‚ŒãŸãƒˆãƒ¼ã‚¯ãƒ³                     â”‚  â”‚
â”‚  â”‚   ãƒ»æœŸé™åˆ‡ã‚Œ â†’ å†ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦                          â”‚  â”‚
â”‚  â”‚   ãƒ»å¤±åŠ¹æ¸ˆã¿ â†’ ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå¾Œã®ãƒˆãƒ¼ã‚¯ãƒ³ä½¿ç”¨                 â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚         â”‚ OK                                                    â”‚
â”‚         â–¼                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ é–¢é–€3: ã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯è¨±å¯ã•ã‚Œã¦ã„ã‚‹ã‹ï¼Ÿ                    â”‚  â”‚
â”‚  â”‚                                                          â”‚  â”‚
â”‚  â”‚   email = user_info.get("email")                         â”‚  â”‚
â”‚  â”‚   if not is_user_allowed(email):                         â”‚  â”‚
â”‚  â”‚       â†’ ã‚¨ãƒ©ãƒ¼ã€Œã‚¢ã‚¯ã‚»ã‚¹ãŒè¨±å¯ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€             â”‚  â”‚
â”‚  â”‚                                                          â”‚  â”‚
â”‚  â”‚   ã€is_user_allowed ã®ä¸­èº«ã€‘                              â”‚  â”‚
â”‚  â”‚   1. Firestoreã® config/access_control ã‚’ç¢ºèª            â”‚  â”‚
â”‚  â”‚   2. è¨±å¯ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒªã‚¹ãƒˆ (@acme.co.jp ãªã©)               â”‚  â”‚
â”‚  â”‚   3. è¨±å¯ãƒ¡ãƒ¼ãƒ«ãƒªã‚¹ãƒˆ (tanaka@gmail.com ãªã©)            â”‚  â”‚
â”‚  â”‚                                                          â”‚  â”‚
â”‚  â”‚   ã©ã¡ã‚‰ã‹ã«ãƒãƒƒãƒã™ã‚Œã°OK                                â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚         â”‚ OK                                                    â”‚
â”‚         â–¼                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ é–¢é–€4: ã©ã®ä¼šç¤¾ã«æ‰€å±ã—ã¦ã„ã‚‹ã‹ï¼Ÿ                          â”‚  â”‚
â”‚  â”‚                                                          â”‚  â”‚
â”‚  â”‚   customer_id = get_user_customer_id(uid, email)         â”‚  â”‚
â”‚  â”‚                                                          â”‚  â”‚
â”‚  â”‚   ã€å‡¦ç†ã®æµã‚Œã€‘                                          â”‚  â”‚
â”‚  â”‚   1. ã¾ãšCustom Claimsã« customer_id ãŒã‚ã‚‹ã‹ç¢ºèª        â”‚  â”‚
â”‚  â”‚      â†’ ã‚ã‚Œã°ãã‚Œã‚’è¿”ã™                                  â”‚  â”‚
â”‚  â”‚                                                          â”‚  â”‚
â”‚  â”‚   2. ãªã‘ã‚Œã°è‡ªå‹•æŒ¯ã‚Šåˆ†ã‘ã‚’è©¦è¡Œ                           â”‚  â”‚
â”‚  â”‚      â†’ ãƒ¡ãƒ¼ãƒ«ãƒ‰ãƒ¡ã‚¤ãƒ³ã‹ã‚‰é¡§å®¢ã‚’æ¤œç´¢                      â”‚  â”‚
â”‚  â”‚      â†’ è¦‹ã¤ã‹ã£ãŸã‚‰è‡ªå‹•ã§Custom Claimsã‚’è¨­å®š             â”‚  â”‚
â”‚  â”‚                                                          â”‚  â”‚
â”‚  â”‚   3. ã©ã¡ã‚‰ã«ã‚‚è©²å½“ã—ãªã‘ã‚Œã°ã‚¨ãƒ©ãƒ¼                       â”‚  â”‚
â”‚  â”‚      â†’ ã€Œé¡§å®¢ã«ç´ä»˜ã‘ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€                    â”‚  â”‚
â”‚  â”‚                                                          â”‚  â”‚
â”‚  â”‚   ğŸ’¡ Custom Claims = IDãƒˆãƒ¼ã‚¯ãƒ³ã«è¿½åŠ ã§ãã‚‹å±æ€§           â”‚  â”‚
â”‚  â”‚      ã‚µãƒ¼ãƒãƒ¼ã§ã—ã‹è¨­å®šã§ããªã„ï¼ˆæ”¹ã–ã‚“ä¸å¯èƒ½ï¼‰            â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚         â”‚ OK                                                    â”‚
â”‚         â–¼                                                       â”‚
â”‚  âœ… èªè¨¼æˆåŠŸï¼user_info ã‚’è¿”ã™                                  â”‚
â”‚                                                                 â”‚
â”‚  {                                                              â”‚
â”‚    "uid": "abc123",                                             â”‚
â”‚    "email": "yamada@acme.co.jp",                                â”‚
â”‚    "name": "å±±ç”°å¤ªéƒ",                                          â”‚
â”‚    "customer_id": "acme-corp"  // â† ã“ã‚ŒãŒé‡è¦                  â”‚
â”‚  }                                                              â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ã‚³ãƒ¼ãƒ‰ï¼ˆå®Ÿéš›ã®æ§‹é€ ã«è¿‘ã„å½¢ï¼‰

```python
# auth.py ã®ä¸»è¦ãªé–¢æ•°

from firebase_admin import auth
from common.firebase_init import get_firestore_client

db = get_firestore_client()


def authenticate_request(request) -> dict:
    """
    ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’èªè¨¼ã—ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’è¿”ã™

    Returns:
        dict: {uid, email, name, customer_id, ...}

    Raises:
        ValueError: èªè¨¼ã«å¤±æ•—ã—ãŸå ´åˆ
    """

    # === é–¢é–€1: ãƒˆãƒ¼ã‚¯ãƒ³ãŒã‚ã‚‹ã‹ï¼Ÿ ===
    auth_header = request.headers.get("Authorization", "")

    if not auth_header:
        raise ValueError("èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ãŒã‚ã‚Šã¾ã›ã‚“")

    # "Bearer " ã§å§‹ã¾ã£ã¦ã„ã‚‹ã‹ï¼Ÿ
    # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¸Šã€å½¢å¼ã‚’å³å¯†ã«ãƒã‚§ãƒƒã‚¯
    parts = auth_header.split(" ")
    if len(parts) != 2 or parts[0] != "Bearer":
        raise ValueError("èªè¨¼ãƒ˜ãƒƒãƒ€ãƒ¼ã®å½¢å¼ãŒä¸æ­£ã§ã™")

    id_token = parts[1]

    # === é–¢é–€2: ãƒˆãƒ¼ã‚¯ãƒ³ã¯æœ¬ç‰©ã‹ï¼Ÿ ===
    try:
        # Firebase Admin SDK ã§ãƒˆãƒ¼ã‚¯ãƒ³ã‚’æ¤œè¨¼
        # check_revoked=True: ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå¾Œã®ãƒˆãƒ¼ã‚¯ãƒ³ä½¿ç”¨ã‚’é˜²ã
        user_info = auth.verify_id_token(id_token, check_revoked=True)

    except auth.RevokedIdTokenError:
        # ãƒˆãƒ¼ã‚¯ãƒ³ãŒå¤±åŠ¹æ¸ˆã¿ï¼ˆãƒ­ã‚°ã‚¢ã‚¦ãƒˆå¾Œãªã©ï¼‰
        raise ValueError("ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒç„¡åŠ¹ã§ã™ã€‚å†åº¦ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚")

    except auth.ExpiredIdTokenError:
        # ãƒˆãƒ¼ã‚¯ãƒ³ã®æœ‰åŠ¹æœŸé™åˆ‡ã‚Œï¼ˆ1æ™‚é–“ï¼‰
        raise ValueError("ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®æœ‰åŠ¹æœŸé™ãŒåˆ‡ã‚Œã¾ã—ãŸã€‚å†åº¦ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚")

    except auth.InvalidIdTokenError:
        # ãƒˆãƒ¼ã‚¯ãƒ³ãŒä¸æ­£ï¼ˆæ”¹ã–ã‚“ã€å½¢å¼ã‚¨ãƒ©ãƒ¼ãªã©ï¼‰
        raise ValueError("èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ãŒç„¡åŠ¹ã§ã™")

    # === é–¢é–€3: ã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯è¨±å¯ã•ã‚Œã¦ã„ã‚‹ã‹ï¼Ÿ ===
    email = user_info.get("email", "")

    if not is_user_allowed(email):
        raise ValueError(f"ã‚¢ã‚¯ã‚»ã‚¹ãŒè¨±å¯ã•ã‚Œã¦ã„ã¾ã›ã‚“: {email}")

    # === é–¢é–€4: é¡§å®¢IDã‚’å–å¾— ===
    uid = user_info["uid"]
    customer_id = get_user_customer_id(uid, email)
    user_info["customer_id"] = customer_id

    return user_info


def is_user_allowed(email: str) -> bool:
    """
    ã“ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯ã‚¢ã‚¯ã‚»ã‚¹è¨±å¯ã•ã‚Œã¦ã„ã‚‹ã‹ï¼Ÿ

    Firestoreã® config/access_control ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ç¢ºèª
    """
    if not email:
        return False

    # Firestore ã‹ã‚‰è¨±å¯ãƒªã‚¹ãƒˆã‚’å–å¾—
    doc_ref = db.collection("config").document("access_control")
    doc = doc_ref.get()

    if not doc.exists:
        # è¨­å®šãŒãªã„å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§æ‹’å¦ï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å„ªå…ˆï¼‰
        return False

    data = doc.to_dict()
    allowed_emails = data.get("allowed_emails", [])
    allowed_domains = data.get("allowed_domains", [])

    # ãƒ¡ãƒ¼ãƒ«ãŒç›´æ¥è¨±å¯ã•ã‚Œã¦ã„ã‚‹ï¼Ÿ
    if email in allowed_emails:
        return True

    # ãƒ‰ãƒ¡ã‚¤ãƒ³ãŒè¨±å¯ã•ã‚Œã¦ã„ã‚‹ï¼Ÿ
    domain = email.split("@")[1] if "@" in email else ""
    if domain in allowed_domains:
        return True

    return False


def get_user_customer_id(uid: str, email: str = None) -> str:
    """
    ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®é¡§å®¢IDã‚’å–å¾—ï¼ˆè‡ªå‹•æŒ¯ã‚Šåˆ†ã‘å¯¾å¿œï¼‰

    1. Custom Claims ã« customer_id ãŒã‚ã‚Œã°ãã‚Œã‚’è¿”ã™
    2. ãªã‘ã‚Œã°ãƒ¡ãƒ¼ãƒ«ãƒ‰ãƒ¡ã‚¤ãƒ³ã‹ã‚‰è‡ªå‹•æ¤œç´¢ãƒ»è¨­å®š
    """

    # Firebase Auth ã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—
    user = auth.get_user(uid)
    claims = user.custom_claims or {}

    # æ—¢ã« customer_id ãŒã‚ã‚‹å ´åˆ
    if claims.get("customer_id"):
        return claims["customer_id"]

    # è‡ªå‹•æŒ¯ã‚Šåˆ†ã‘ã‚’è©¦è¡Œ
    if email:
        customer_id = auto_assign_customer(uid, email)
        if customer_id:
            return customer_id

    # ã©ã¡ã‚‰ã«ã‚‚è©²å½“ã—ãªã„
    raise ValueError("é¡§å®¢ã«ç´ä»˜ã‘ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ç®¡ç†è€…ã«é€£çµ¡ã—ã¦ãã ã•ã„ã€‚")


def auto_assign_customer(uid: str, email: str) -> str | None:
    """
    ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‹ã‚‰é¡§å®¢ã‚’è‡ªå‹•æ¤œç´¢ã—ã€ç´ä»˜ã‘ã‚‹

    Returns:
        str | None: ç´ä»˜ã‘ã«æˆåŠŸã—ãŸå ´åˆã¯ customer_idã€å¤±æ•—ã—ãŸå ´åˆã¯ None
    """
    domain = email.split("@")[1] if "@" in email else ""

    # é¡§å®¢ã‚’æ¤œç´¢
    customers_ref = db.collection("customers")

    # 1. ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã§ç›´æ¥æ¤œç´¢
    query = customers_ref.where("allowed_emails", "array_contains", email)
    docs = list(query.stream())
    if docs:
        customer_id = docs[0].id
        _set_customer_id_claim(uid, customer_id)
        return customer_id

    # 2. ãƒ‰ãƒ¡ã‚¤ãƒ³ã§æ¤œç´¢
    query = customers_ref.where("allowed_domains", "array_contains", domain)
    docs = list(query.stream())
    if docs:
        customer_id = docs[0].id
        _set_customer_id_claim(uid, customer_id)
        return customer_id

    return None


def _set_customer_id_claim(uid: str, customer_id: str):
    """Custom Claims ã« customer_id ã‚’è¨­å®š"""
    auth.set_custom_user_claims(uid, {"customer_id": customer_id})
```

---

## 3. agent.py - AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ

### AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã£ã¦ä½•ï¼Ÿ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ¤– AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ = AIã‚’ä½¿ã„ã‚„ã™ãã™ã‚‹ãƒ©ãƒƒãƒ‘ãƒ¼                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  ã€AIã‚’ç›´æ¥ä½¿ã†å ´åˆã€‘                                            â”‚
â”‚                                                                 â”‚
â”‚  æ¯å›ã“ã‚Œã‚’æ›¸ãå¿…è¦ãŒã‚ã‚‹:                                       â”‚
â”‚  ãƒ»ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’è¨­å®š                                      â”‚
â”‚  ãƒ»ä¼šè©±å±¥æ­´ã‚’å–å¾—                                               â”‚
â”‚  ãƒ»AIã«é€ä¿¡                                                     â”‚
â”‚  ãƒ»çµæœã‚’ä¿å­˜                                                   â”‚
â”‚  ...é¢å€’ï¼ğŸ˜µ                                                    â”‚
â”‚                                                                 â”‚
â”‚  ã€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’ä½¿ã†å ´åˆã€‘                                      â”‚
â”‚                                                                 â”‚
â”‚  agent.run("è³ªå•", thread_id)                                   â”‚
â”‚  â†‘                                                              â”‚
â”‚  ã“ã‚Œã ã‘ï¼ä¸­èº«ã¯å…¨éƒ¨ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒã‚„ã£ã¦ãã‚Œã‚‹ ğŸ˜Š                â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®æ§‹é€ 

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ—ï¸ ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®æ§‹é€                                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
â”‚                 â”‚     TemplateAgent       â”‚                     â”‚
â”‚                 â”‚    ï¼ˆå®Ÿéš›ã«ä½¿ã†ã‚„ã¤ï¼‰    â”‚                     â”‚
â”‚                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
â”‚                             â”‚ ç¶™æ‰¿                              â”‚
â”‚                             â–¼                                   â”‚
â”‚                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
â”‚                 â”‚      BaseAgent          â”‚                     â”‚
â”‚                 â”‚   ï¼ˆå…±é€šæ©Ÿèƒ½ã‚’æŒã¤ï¼‰     â”‚                     â”‚
â”‚                 â”‚                         â”‚                     â”‚
â”‚                 â”‚  ãƒ»LLMåˆæœŸåŒ–            â”‚                     â”‚
â”‚                 â”‚  ãƒ»ã‚°ãƒ©ãƒ•æ§‹ç¯‰            â”‚                     â”‚
â”‚                 â”‚  ãƒ»run() ãƒ¡ã‚½ãƒƒãƒ‰        â”‚                     â”‚
â”‚                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
â”‚                             â”‚ ä½¿ç”¨                              â”‚
â”‚                             â–¼                                   â”‚
â”‚                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
â”‚                 â”‚   FirestoreCheckpointer â”‚                     â”‚
â”‚                 â”‚   ï¼ˆä¼šè©±å±¥æ­´ã‚’ä¿å­˜ï¼‰     â”‚                     â”‚
â”‚                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
â”‚                                                                 â”‚
â”‚  ğŸ’¡ ãªãœã“ã‚“ãªæ§‹é€ ï¼Ÿ                                             â”‚
â”‚     å…±é€šå‡¦ç†ã¯ BaseAgent ã«ã€                                    â”‚
â”‚     å€‹åˆ¥ã®æ€§æ ¼ã¯ TemplateAgent ã«ã™ã‚‹ã¨ã€                        â”‚
â”‚     æ–°ã—ã„ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’è¿½åŠ ã™ã‚‹ã®ãŒæ¥½ï¼                          â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### SYSTEM_PROMPT - AIã®ã€Œæ€§æ ¼ã€

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ­ SYSTEM_PROMPT ã§AIã®æ€§æ ¼ã‚’æ±ºã‚ã‚‹                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã€‘                                                  â”‚
â”‚  SYSTEM_PROMPT = """                                            â”‚
â”‚  ã‚ãªãŸã¯è¦ªåˆ‡ã§ä¸å¯§ãªAIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚                         â”‚
â”‚  ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è³ªå•ã«å¯¾ã—ã¦ã€ã‚ã‹ã‚Šã‚„ã™ãç°¡æ½”ã«å›ç­”ã—ã¦ãã ã•ã„ã€‚     â”‚
â”‚  æ—¥æœ¬èªã§å›ç­”ã—ã¦ãã ã•ã„ã€‚                                      â”‚
â”‚  """                                                            â”‚
â”‚                                                                 â”‚
â”‚  ã€é–¢è¥¿å¼ã«å¤‰ãˆã‚‹ã¨...ã€‘                                        â”‚
â”‚  SYSTEM_PROMPT = """                                            â”‚
â”‚  ã‚ãªãŸã¯é–¢è¥¿å¼ã§è©±ã™AIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã‚„ã§ã€‚                         â”‚
â”‚  ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è³ªå•ã«ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼ã«ç­”ãˆã¦ãªã€‚                         â”‚
â”‚  ã€Œã‚„ã§ã€ã€Œã‚„ã‚“ã€ã€Œãªã‚“ã§ã‚„ã­ã‚“ã€ã‚’ä½¿ã£ã¦ãªã€‚                     â”‚
â”‚  """                                                            â”‚
â”‚                                                                 â”‚
â”‚  â†’ åŒã˜è³ªå•ã§ã‚‚ã€è¿”ç­”ã®ã‚¹ã‚¿ã‚¤ãƒ«ãŒå¤‰ã‚ã‚‹ï¼                        â”‚
â”‚                                                                 â”‚
â”‚  ã€Gemini ã«é€ã‚‰ã‚Œã‚‹ã‚¤ãƒ¡ãƒ¼ã‚¸ã€‘                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ [System] ã‚ãªãŸã¯è¦ªåˆ‡ã§ä¸å¯§ãªAIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™...       â”‚   â”‚
â”‚  â”‚ [User]   Pythonã£ã¦ä½•ï¼Ÿ                                  â”‚   â”‚
â”‚  â”‚ [AI]     Pythonã¯ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°è¨€èªã§ã™...               â”‚   â”‚
â”‚  â”‚ [User]   ã‚‚ã£ã¨è©³ã—ãæ•™ãˆã¦                              â”‚   â”‚
â”‚  â”‚ [AI]     ???  â† ã“ã‚Œã‚’GeminiãŒç”Ÿæˆ                       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ã‚³ãƒ¼ãƒ‰ï¼ˆå®Ÿéš›ã®æ§‹é€ ã«è¿‘ã„å½¢ï¼‰

```python
# agent.py ã®ä¸»è¦éƒ¨åˆ†

from langchain_google_vertexai import ChatVertexAI
from langgraph.graph import StateGraph, MessagesState

# =============================================
# â˜… ã“ã“ã‚’ç·¨é›†ã—ã¦AIã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º
# =============================================

# AIã®æ€§æ ¼ãƒ»å½¹å‰²
SYSTEM_PROMPT = """ã‚ãªãŸã¯è¦ªåˆ‡ã§ä¸å¯§ãªAIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚
ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è³ªå•ã«å¯¾ã—ã¦ã€ã‚ã‹ã‚Šã‚„ã™ãç°¡æ½”ã«å›ç­”ã—ã¦ãã ã•ã„ã€‚
æ—¥æœ¬èªã§å›ç­”ã—ã¦ãã ã•ã„ã€‚"""

# ä½¿ç”¨ã™ã‚‹ãƒ¢ãƒ‡ãƒ«
MODEL_NAME = "gemini-1.5-flash"

# ä¼šè©±å±¥æ­´ã®æœ€å¤§æ•°ï¼ˆå¤šã„ã»ã©ã‚³ã‚¹ãƒˆãŒã‹ã‹ã‚‹ï¼‰
MAX_HISTORY_MESSAGES = 20  # ç´„10å¾€å¾©åˆ†


class TemplateAgent(BaseAgent):
    """ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆQ&Aã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ"""

    def __init__(self, customer_id: str, user_id: str):
        """
        Args:
            customer_id: é¡§å®¢IDï¼ˆãƒ‡ãƒ¼ã‚¿åˆ†é›¢ç”¨ï¼‰
            user_id: ãƒ¦ãƒ¼ã‚¶ãƒ¼IDï¼ˆä¼šè©±å±¥æ­´ç®¡ç†ç”¨ï¼‰
        """
        self.customer_id = customer_id
        self.user_id = user_id

        # LLMï¼ˆLarge Language Modelï¼‰ã‚’åˆæœŸåŒ–
        self.llm = ChatVertexAI(
            model=MODEL_NAME,
            temperature=0.7,  # 0=ç¢ºå®Ÿãªå›ç­”ã€1=å‰µé€ çš„ãªå›ç­”
            max_output_tokens=2048,
            streaming=True,  # ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°æœ‰åŠ¹
        )

        # ä¼šè©±å±¥æ­´ä¿å­˜ç”¨ã®ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ã‚¿ãƒ¼
        self.checkpointer = FirestoreCheckpointer(
            db=get_firestore_client(),
            customer_id=customer_id
        )

        # ã‚°ãƒ©ãƒ•ã‚’æ§‹ç¯‰
        self.graph = self._build_graph()

    def _build_graph(self):
        """
        LangGraphã®ã‚°ãƒ©ãƒ•ã‚’æ§‹ç¯‰

        LangGraph = AIã®å‡¦ç†ãƒ•ãƒ­ãƒ¼ã‚’ã€Œã‚°ãƒ©ãƒ•ã€ã¨ã—ã¦å®šç¾©ã™ã‚‹ãƒ©ã‚¤ãƒ–ãƒ©ãƒª
        """
        # ã‚°ãƒ©ãƒ•ã‚’ä½œæˆ
        builder = StateGraph(MessagesState)

        # ãƒãƒ¼ãƒ‰ã‚’è¿½åŠ ï¼ˆå‡¦ç†ã®ã‚¹ãƒ†ãƒƒãƒ—ï¼‰
        builder.add_node("chat", self._chat_node)

        # ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆã‚’è¨­å®š
        builder.set_entry_point("chat")

        # çµ‚äº†ãƒãƒ¼ãƒ‰ã‚’è¨­å®š
        builder.set_finish_point("chat")

        # ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã—ã¦ã‚°ãƒ©ãƒ•ã‚’ç¢ºå®š
        return builder.compile(checkpointer=self.checkpointer)

    async def _chat_node(self, state: MessagesState) -> dict:
        """
        ãƒãƒ£ãƒƒãƒˆå‡¦ç†ã®ãƒ¡ã‚¤ãƒ³ãƒ­ã‚¸ãƒƒã‚¯

        Args:
            state: ç¾åœ¨ã®ä¼šè©±çŠ¶æ…‹ï¼ˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å±¥æ­´ã‚’å«ã‚€ï¼‰

        Returns:
            dict: æ–°ã—ã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å«ã‚€çŠ¶æ…‹
        """
        messages = state["messages"]

        # ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’å…ˆé ­ã«è¿½åŠ 
        full_messages = [
            {"role": "system", "content": SYSTEM_PROMPT},
            *messages[-MAX_HISTORY_MESSAGES:]  # å±¥æ­´ã‚’åˆ¶é™
        ]

        # Gemini ã«å•ã„åˆã‚ã›
        response = await self.llm.ainvoke(full_messages)

        return {"messages": [response]}

    def run(self, message: str, thread_id: str = None, user_id: str = None):
        """
        ãƒãƒ£ãƒƒãƒˆã‚’å®Ÿè¡Œï¼ˆã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ï¼‰

        Args:
            message: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
            thread_id: ä¼šè©±ã®IDï¼ˆæ–°è¦ã®å ´åˆã¯è‡ªå‹•ç”Ÿæˆï¼‰
            user_id: ãƒ¦ãƒ¼ã‚¶ãƒ¼ID

        Yields:
            str: AIã®è¿”ç­”ï¼ˆå°‘ã—ãšã¤ï¼‰
        """
        # thread_id ãŒãªã‘ã‚Œã°ç”Ÿæˆ
        if not thread_id:
            thread_id = f"{user_id}_{uuid.uuid4().hex[:8]}"

        # è¨­å®š
        config = {
            "configurable": {
                "thread_id": thread_id,
            }
        }

        # å…¥åŠ›
        input_data = {
            "messages": [
                {"role": "user", "content": message}
            ]
        }

        # ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°å®Ÿè¡Œ
        for event in self.graph.stream(input_data, config, stream_mode="values"):
            # æœ€å¾Œã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å–å¾—
            if event.get("messages"):
                last_message = event["messages"][-1]
                if hasattr(last_message, "content"):
                    yield last_message.content
```

---

## 4. firestore_checkpointer.py - ä¼šè©±å±¥æ­´ä¿å­˜

### ãªãœä¼šè©±å±¥æ­´ãŒå¿…è¦ï¼Ÿ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ’¾ ä¼šè©±å±¥æ­´ãŒãªã„ã¨...                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  ã€å±¥æ­´ãªã—ã€‘                                                    â”‚
â”‚                                                                 â”‚
â”‚  ãƒ¦ãƒ¼ã‚¶ãƒ¼: ã€Œç§ã®åå‰ã¯å±±ç”°ã§ã™ã€                                 â”‚
â”‚  AI: ã€Œå±±ç”°ã•ã‚“ã€ã“ã‚“ã«ã¡ã¯ï¼ã€                                  â”‚
â”‚                                                                 â”‚
â”‚  ãƒ¦ãƒ¼ã‚¶ãƒ¼: ã€Œç§ã®åå‰ã¯ä½•ã§ã—ãŸã‹ï¼Ÿã€                            â”‚
â”‚  AI: ã€Œã™ã¿ã¾ã›ã‚“ã€ã‚ã‹ã‚Šã¾ã›ã‚“ã€ â† å¿˜ã‚Œã¦ã‚‹ï¼ğŸ˜±                 â”‚
â”‚                                                                 â”‚
â”‚  ã€å±¥æ­´ã‚ã‚Šã€‘                                                    â”‚
â”‚                                                                 â”‚
â”‚  ãƒ¦ãƒ¼ã‚¶ãƒ¼: ã€Œç§ã®åå‰ã¯å±±ç”°ã§ã™ã€                                 â”‚
â”‚  AI: ã€Œå±±ç”°ã•ã‚“ã€ã“ã‚“ã«ã¡ã¯ï¼ã€                                  â”‚
â”‚                                                                 â”‚
â”‚  ãƒ¦ãƒ¼ã‚¶ãƒ¼: ã€Œç§ã®åå‰ã¯ä½•ã§ã—ãŸã‹ï¼Ÿã€                            â”‚
â”‚  AI: ã€Œå±±ç”°ã•ã‚“ã§ã™ã­ï¼ã€ â† è¦šãˆã¦ã‚‹ï¼ğŸ˜Š                         â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Firestore ã®ãƒ‡ãƒ¼ã‚¿æ§‹é€ 

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ“ Firestore ã®ãƒ‡ãƒ¼ã‚¿æ§‹é€                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  Firestore                                                      â”‚
â”‚  â”‚                                                              â”‚
â”‚  â””â”€â”€ customers/                    â† é¡§å®¢ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³            â”‚
â”‚      â”‚                                                          â”‚
â”‚      â”œâ”€â”€ acme-corp/                â† é¡§å®¢ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ            â”‚
â”‚      â”‚   â”‚                                                      â”‚
â”‚      â”‚   â”œâ”€â”€ name: "æ ªå¼ä¼šç¤¾ACME"                               â”‚
â”‚      â”‚   â”œâ”€â”€ allowed_domains: ["acme.co.jp"]                   â”‚
â”‚      â”‚   â”‚                                                      â”‚
â”‚      â”‚   â””â”€â”€ checkpoints/          â† ä¼šè©±å±¥æ­´ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³       â”‚
â”‚      â”‚       â”‚                                                  â”‚
â”‚      â”‚       â”œâ”€â”€ user1_abc123/     â† ä¼šè©±1ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ        â”‚
â”‚      â”‚       â”‚   â””â”€â”€ checkpoints/  â† ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆã‚µãƒ–ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³â”‚
â”‚      â”‚       â”‚       â”œâ”€â”€ cp_1: {messages: [...], timestamp: ...}â”‚
â”‚      â”‚       â”‚       â””â”€â”€ cp_2: {...}                           â”‚
â”‚      â”‚       â”‚                                                  â”‚
â”‚      â”‚       â””â”€â”€ user1_def456/     â† ä¼šè©±2ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ        â”‚
â”‚      â”‚           â””â”€â”€ ...                                        â”‚
â”‚      â”‚                                                          â”‚
â”‚      â””â”€â”€ beta-inc/                 â† åˆ¥ã®é¡§å®¢                   â”‚
â”‚          â””â”€â”€ ...                                                â”‚
â”‚                                                                 â”‚
â”‚  ğŸ’¡ customer_id ã§ãƒ‘ã‚¹ã‚’åˆ†ã‘ã‚‹ã“ã¨ã§ã€                           â”‚
â”‚     Aç¤¾ãŒBç¤¾ã®ãƒ‡ãƒ¼ã‚¿ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã“ã¨ã‚’é˜²ã                     â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## é‡è¦ãªæ¦‚å¿µ

### async/awaitï¼ˆéåŒæœŸå‡¦ç†ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  âš¡ async/await ã‚’å®Œå…¨ç†è§£                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  ã€GASã®å ´åˆï¼ˆåŒæœŸå‡¦ç†ï¼‰ã€‘                                       â”‚
â”‚                                                                 â”‚
â”‚  function fetchData() {                                         â”‚
â”‚    var response = UrlFetchApp.fetch(url);  // ã“ã“ã§æ­¢ã¾ã‚‹       â”‚
â”‚    var data = response.getContentText();   // çµ‚ã‚ã‚‹ã¾ã§å¾…ã¤     â”‚
â”‚    return data;                                                 â”‚
â”‚  }                                                              â”‚
â”‚                                                                 â”‚
â”‚  â†’ å‡¦ç†Aã‚’å¾…ã£ã¦ã„ã‚‹é–“ã€å‡¦ç†BãŒã§ããªã„                          â”‚
â”‚                                                                 â”‚
â”‚  ã€Python/TypeScriptã®å ´åˆï¼ˆéåŒæœŸå‡¦ç†ï¼‰ã€‘                        â”‚
â”‚                                                                 â”‚
â”‚  async def fetch_data():                                        â”‚
â”‚      response = await aiohttp.get(url)  # å¾…ã¤ã‘ã©ä»–ã®å‡¦ç†å¯     â”‚
â”‚      data = await response.text()                               â”‚
â”‚      return data                                                â”‚
â”‚                                                                 â”‚
â”‚  â†’ å‡¦ç†Aã‚’å¾…ã£ã¦ã„ã‚‹é–“ã«ã€å‡¦ç†Bã‚’é€²ã‚ã‚‰ã‚Œã‚‹                       â”‚
â”‚                                                                 â”‚
â”‚  ã€ã‚¤ãƒ¡ãƒ¼ã‚¸ã€‘                                                    â”‚
â”‚                                                                 â”‚
â”‚  åŒæœŸ   : æ–™ç†ã®æ³¨æ–‡ â†’ å¾…ã¤ â†’ å—ã‘å–ã‚Š â†’ æ¬¡ã®æ³¨æ–‡                 â”‚
â”‚  éåŒæœŸ : æ–™ç†ã®æ³¨æ–‡ â†’ æ¬¡ã®æ³¨æ–‡ â†’ æ¬¡ã®æ³¨æ–‡ â†’ æœ€åˆã®æ–™ç†å—ã‘å–ã‚Š   â”‚
â”‚                                                                 â”‚
â”‚  ğŸ’¡ AIã®å›ç­”ã‚’å¾…ã¤é–“ã€ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å‡¦ç†ã§ãã‚‹        â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼ï¼ˆyieldï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸŒŠ yieldï¼ˆã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼ï¼‰ã‚’å®Œå…¨ç†è§£                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  ã€æ™®é€šã®é–¢æ•°ã€‘                                                  â”‚
â”‚                                                                 â”‚
â”‚  def get_numbers():                                             â”‚
â”‚      return [1, 2, 3, 4, 5]  # å…¨éƒ¨ã¾ã¨ã‚ã¦è¿”ã™                  â”‚
â”‚                                                                 â”‚
â”‚  result = get_numbers()  # [1, 2, 3, 4, 5] ãŒä¸€åº¦ã«æ¥ã‚‹          â”‚
â”‚                                                                 â”‚
â”‚  ã€ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼ï¼ˆyieldä½¿ç”¨ï¼‰ã€‘                                 â”‚
â”‚                                                                 â”‚
â”‚  def get_numbers():                                             â”‚
â”‚      yield 1  # 1ã‚’è¿”ã—ã¦ã€ã“ã“ã§ä¸€æ™‚åœæ­¢                        â”‚
â”‚      yield 2  # æ¬¡ã«å‘¼ã°ã‚ŒãŸã‚‰2ã‚’è¿”ã—ã¦ã€ã¾ãŸä¸€æ™‚åœæ­¢             â”‚
â”‚      yield 3                                                    â”‚
â”‚      yield 4                                                    â”‚
â”‚      yield 5                                                    â”‚
â”‚                                                                 â”‚
â”‚  for num in get_numbers():                                      â”‚
â”‚      print(num)  # 1, 2, 3, 4, 5 ãŒé †ç•ªã«æ¥ã‚‹                   â”‚
â”‚                                                                 â”‚
â”‚  ã€ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ã§ã®æ´»ç”¨ã€‘                                      â”‚
â”‚                                                                 â”‚
â”‚  def stream_response():                                         â”‚
â”‚      yield "ã“ã‚“"    # ãƒ–ãƒ©ã‚¦ã‚¶ã«ã€Œã“ã‚“ã€ãŒè¡¨ç¤º                  â”‚
â”‚      yield "ã«ã¡"    # ãƒ–ãƒ©ã‚¦ã‚¶ã«ã€Œã«ã¡ã€ãŒè¿½åŠ è¡¨ç¤º               â”‚
â”‚      yield "ã¯"      # ãƒ–ãƒ©ã‚¦ã‚¶ã«ã€Œã¯ã€ãŒè¿½åŠ è¡¨ç¤º                 â”‚
â”‚                                                                 â”‚
â”‚  â†’ å…¨éƒ¨ã§ãã‚‹ã®ã‚’å¾…ãŸãšã«ã€ã§ããŸåˆ†ã‹ã‚‰è¡¨ç¤ºï¼                     â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿ãƒ¼ï¼ˆ@ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ€ ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿ãƒ¼ã‚’å®Œå…¨ç†è§£                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  ã€ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿ãƒ¼ã£ã¦ä½•ï¼Ÿã€‘                                        â”‚
â”‚                                                                 â”‚
â”‚  é–¢æ•°ã«ã€Œè¿½åŠ æ©Ÿèƒ½ã€ã‚’ã¤ã‘ã‚‹ä»•çµ„ã¿                                 â”‚
â”‚  @something ã‚’é–¢æ•°ã®å‰ã«æ›¸ã                                     â”‚
â”‚                                                                 â”‚
â”‚  ã€ã‚ˆãè¦‹ã‚‹ãƒ‘ã‚¿ãƒ¼ãƒ³ã€‘                                            â”‚
â”‚                                                                 â”‚
â”‚  @app.route("/chat", methods=["POST"])                          â”‚
â”‚  def chat():                                                    â”‚
â”‚      ...                                                        â”‚
â”‚                                                                 â”‚
â”‚  â†‘ ã“ã‚Œã¯ä»¥ä¸‹ã¨åŒã˜æ„å‘³:                                        â”‚
â”‚                                                                 â”‚
â”‚  def chat():                                                    â”‚
â”‚      ...                                                        â”‚
â”‚  chat = app.route("/chat", methods=["POST"])(chat)              â”‚
â”‚                                                                 â”‚
â”‚  ã€ã‚¤ãƒ¡ãƒ¼ã‚¸ã€‘                                                    â”‚
â”‚                                                                 â”‚
â”‚  ãƒ—ãƒ¬ã‚¼ãƒ³ãƒˆã« ãƒªãƒœãƒ³ ã‚’ã¤ã‘ã‚‹                                     â”‚
â”‚       â†‘           â†‘                                             â”‚
â”‚     é–¢æ•°     ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿ãƒ¼                                        â”‚
â”‚                                                                 â”‚
â”‚  ä¸­èº«ï¼ˆé–¢æ•°ï¼‰ã¯åŒã˜ã ã‘ã©ã€è¦‹ãŸç›®ï¼ˆæ©Ÿèƒ½ï¼‰ãŒå¤‰ã‚ã‚‹                 â”‚
â”‚                                                                 â”‚
â”‚  @app.route(...) â†’ ã€Œã“ã®é–¢æ•°ã‚’URLã«ç´ã¥ã‘ã‚‹ã€æ©Ÿèƒ½ã‚’è¿½åŠ          â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ã‚ˆãã‚ã‚‹ã‚¨ãƒ©ãƒ¼ã¨å¯¾å‡¦æ³•

| ã‚¨ãƒ©ãƒ¼ | åŸå›  | å¯¾å‡¦ |
|--------|------|------|
| `èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ãŒã‚ã‚Šã¾ã›ã‚“` | Authorizationãƒ˜ãƒƒãƒ€ãƒ¼ãŒãªã„ | ãƒ­ã‚°ã‚¤ãƒ³ã—ç›´ã™ |
| `èªè¨¼ãƒ˜ãƒƒãƒ€ãƒ¼ã®å½¢å¼ãŒä¸æ­£ã§ã™` | Bearerå½¢å¼ã§ãªã„ | ãƒ­ã‚°ã‚¤ãƒ³ã—ç›´ã™ |
| `ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒç„¡åŠ¹ã§ã™` | ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå¾Œã®ãƒˆãƒ¼ã‚¯ãƒ³ä½¿ç”¨ | å†ãƒ­ã‚°ã‚¤ãƒ³ |
| `ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®æœ‰åŠ¹æœŸé™ãŒåˆ‡ã‚Œã¾ã—ãŸ` | ãƒˆãƒ¼ã‚¯ãƒ³ãŒ1æ™‚é–“è¶…é | ãƒšãƒ¼ã‚¸ãƒªãƒ­ãƒ¼ãƒ‰ |
| `èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ãŒç„¡åŠ¹ã§ã™` | æ”¹ã–ã‚“ã•ã‚ŒãŸãƒˆãƒ¼ã‚¯ãƒ³ | å†ãƒ­ã‚°ã‚¤ãƒ³ |
| `ã‚¢ã‚¯ã‚»ã‚¹ãŒè¨±å¯ã•ã‚Œã¦ã„ã¾ã›ã‚“` | è¨±å¯ãƒªã‚¹ãƒˆã«ãªã„ | ç®¡ç†è€…ã«é€£çµ¡ |
| `é¡§å®¢ã«ç´ä»˜ã‘ã•ã‚Œã¦ã„ã¾ã›ã‚“` | è‡ªå‹•æŒ¯ã‚Šåˆ†ã‘ã«ã‚‚ãƒãƒƒãƒã—ãªã„ | ç®¡ç†è€…ã«é€£çµ¡ |
| `ãƒªã‚¯ã‚¨ã‚¹ãƒˆåˆ¶é™ã‚’è¶…ãˆã¾ã—ãŸ` | 1åˆ†60å›è¶…é | 1åˆ†å¾…ã¤ |
| `ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒé•·ã™ãã¾ã™` | 10,000æ–‡å­—è¶…é | çŸ­ãã™ã‚‹ |
| `thread_idã®å½¢å¼ãŒä¸æ­£ã§ã™` | å¤‰ãªæ–‡å­—ãŒå…¥ã£ã¦ã„ã‚‹ | thread_idã‚’æŒ‡å®šã—ãªã„ |

---

## ç†è§£åº¦ãƒã‚§ãƒƒã‚¯

ä»¥ä¸‹ã®è³ªå•ã«ç­”ãˆã‚‰ã‚ŒãŸã‚‰ã€ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã¯ãƒãƒƒãƒãƒªï¼

| è³ªå• | è‡ªä¿¡ã‚ã‚Š? |
|------|----------|
| main.py ã® /chat ã¯ã©ã‚“ãªé †ç•ªã§å‡¦ç†ã‚’è¡Œã†ï¼Ÿ | â–¡ |
| èªè¨¼ã§ã€Œ4ã¤ã®é–¢é–€ã€ã¨ã¯ä½•ï¼Ÿ | â–¡ |
| SYSTEM_PROMPT ã‚’å¤‰ãˆã‚‹ã¨ã©ã†ãªã‚‹ï¼Ÿ | â–¡ |
| yield ã¨ return ã®é•ã„ã¯ï¼Ÿ | â–¡ |
| ãªãœ customer_id ã§ãƒ‡ãƒ¼ã‚¿ã‚’åˆ†ã‘ã¦ã„ã‚‹ï¼Ÿ | â–¡ |

---

## æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                                                                    â•‘
â•‘   âœ… ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®ä»•çµ„ã¿ãŒå®Œå…¨ã«ã‚ã‹ã£ãŸï¼                        â•‘
â•‘                                                                    â•‘
â•‘   â†’ æ¬¡ã¯ 04_ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰è§£èª¬.md ã§ç”»é¢å´ã‚’å­¦ã¼ã†ï¼               â•‘
â•‘                                                                    â•‘
â•‘   ğŸ’¡ ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãŒã‚ã‹ã‚‹ã¨ã€ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚‚ç†è§£ã—ã‚„ã™ããªã‚‹ï¼     â•‘
â•‘                                                                    â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```
