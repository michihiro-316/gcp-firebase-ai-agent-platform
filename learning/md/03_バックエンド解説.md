# バックエンド解説

このドキュメントでは、バックエンド（サーバー側）の仕組みを解説します。
実際のコードは `backend/src/` にあります。

---

## 読む順番

1. main.py の全体構造を理解
2. 認証の流れを理解
3. チャットAPIの流れを理解

---

## 1. main.py の構造

main.py は「入口」です。すべてのAPIリクエストはここに来ます。

### 構造のイメージ

| エンドポイント | 役割 |
|--------------|------|
| `/health` | ヘルスチェック（サーバーが生きてるか確認） |
| `/chat` | チャットAPI（メインの機能） |
| `/agents` | エージェント一覧（使えるAIの一覧） |

```
┌─────────────────────────────────────┐
│            main.py                  │
├─────────────────────────────────────┤
│                                     │
│  /health  → ヘルスチェック           │
│  /chat    → チャットAPI              │
│  /agents  → エージェント一覧          │
│                                     │
└─────────────────────────────────────┘
```

---

## 2. 認証の流れ

認証とは「この人は本物か？」を確認すること。

### なぜ認証が必要？

- 誰でもAPIを使えたら、悪い人に悪用される
- 顧客ごとにデータを分ける必要がある
- 使いすぎを防ぐ必要がある

### 認証のステップ

```
1. ユーザーがリクエストを送る
   ↓
   リクエストヘッダーに「IDトークン」が入っている
   （Authorization: Bearer xxxxx）

2. verify_token() でトークンを検証
   ↓
   Firebase Authが「このトークンは本物か」を確認
   偽物なら → エラーを返す

3. is_user_allowed() でアクセス権限を確認
   ↓
   「このメールアドレス/ドメインは許可されているか」
   許可されていない → エラーを返す

4. get_user_customer_id() で顧客IDを取得
   ↓
   【自動振り分け対応】
   - まずCustom Claimsに customer_id があるか確認
   - なければ、メールのドメインから顧客を自動検索
   - 見つかれば自動でCustom Claimsを設定
```

### コード例（簡略版）

```python
def authenticate_request(request):
    """リクエストを認証する"""

    # ステップ1: ヘッダーからトークンを取り出す
    auth_header = request.headers.get("Authorization", "")
    if not auth_header:
        raise ValueError("トークンがありません")

    # "Bearer xxxxx" という形式かチェック
    parts = auth_header.split(" ")
    if len(parts) != 2 or parts[0] != "Bearer":
        raise ValueError("認証ヘッダーの形式が不正です")

    id_token = parts[1]

    # ステップ2: トークンを検証（Firebase Authが行う）
    user_info = verify_token(id_token, check_revoked=True)

    # ステップ3: このユーザーは許可されている？
    email = user_info.get("email", "")
    if not is_user_allowed(email):
        raise ValueError("このユーザーはアクセスできません")

    # ステップ4: 顧客IDを取得（自動振り分け対応）
    user_info["customer_id"] = get_user_customer_id(user_info["uid"], email)

    return user_info
```

---

## 3. チャットAPIの流れ

`/chat` エンドポイントの処理フローです。

### リクエスト形式

```json
{
    "message": "こんにちは",
    "thread_id": "xxx"
}
```

> `thread_id` は省略可能（省略すると新しい会話が始まる）

### セキュリティチェック

| チェック項目 | 内容 |
|------------|------|
| メッセージ長制限 | 10,000文字まで（DoS/コスト攻撃対策） |
| thread_id形式検証 | 英数字、ハイフン、アンダースコアのみ |

### 処理の流れ

```
1. prepare_chat_request() で前準備
   - 認証チェック
   - レート制限チェック（使いすぎ防止）
   - 入力値検証

2. get_agent() でAIエージェントを取得
   - 顧客ごとに別々のエージェントを使う

3. agent.run() でAIに質問
   - ストリーミングで少しずつ返答

4. Server-Sent Events で返す
   - 「data: こん」
   - 「data: にち」
   - 「data: は」
   - 「data: [DONE]」
```

### コード例（簡略版）

```python
def chat():
    """チャットAPI"""

    # ステップ1: 前準備
    agent, message, thread_id, user_id, customer_id = prepare_chat_request()

    # ステップ2: AIに質問してストリーミングで返す
    def generate():
        for chunk in agent.run(message, thread_id):
            yield f"data: {chunk}\n\n"
        yield "data: [DONE]\n\n"

    # Server-Sent Events 形式で返す
    return Response(generate(), mimetype="text/event-stream")
```

---

## 4. 重要な概念

### async/await とは？

非同期処理のための書き方です。

**なぜ必要？**
AIの返答を待っている間、サーバーが何もできないと困る。
async/await を使うと、待っている間に他の処理ができる。

**イメージ**

| 処理方式 | 例え |
|---------|------|
| 普通の処理 | 料理を注文 → 料理ができるまで待つ → 次の客の注文を聞く |
| 非同期処理 | 料理を注文 → 次の客の注文を聞く → 料理ができたら運ぶ |

```python
async def async_example():
    """非同期関数の例"""
    # AIの返答を待つ（待っている間、他の処理ができる）
    result = await ai.generate("こんにちは")
    return result
```

### ジェネレーター（yield）とは？

「少しずつ値を返す」ための書き方です。

**なぜ必要？**
AIの返答が長い場合、全部完成するまで待つと遅い。
yield を使うと、できたところから少しずつ返せる。

```python
def count():
    """yieldを使うと、呼び出すたびに次の値を返す"""
    yield 1  # 1回目: 1を返す
    yield 2  # 2回目: 2を返す
    yield 3  # 3回目: 3を返す

# 使い方
for num in count():
    print(num)  # → 1, 2, 3 と表示
```

### デコレーター（@）とは？

関数に「追加機能」を付ける仕組みです。

**よく使うデコレーター**

| デコレーター | 意味 |
|------------|------|
| `@app.route("/chat", methods=["POST"])` | /chat へのPOSTリクエストを処理 |
| `@functions_framework.http` | Cloud Functionsのエントリーポイント |

---

## 5. 次に読むべきファイル

| ファイル | 内容 |
|---------|------|
| `backend/src/main.py` | 本番コード |
| `backend/src/common/auth.py` | 認証処理の詳細 |
| `backend/src/agents/_template/agent.py` | AIエージェントの実装 |
| `backend/scripts/manage_customer.py` | 顧客管理コマンド |
| `learning/md/04_フロントエンド解説.md` | 画面側の解説 |
