# システム全体像 - 5分で掴む！

<div class="goal-box">
<div class="box-title">🎯 このページのゴール</div>
<div class="box-content">

「このシステムってこういう仕組みなんだ！」と説明できるようになる

</div>
</div>

---

## ズバリ、何をするシステム？

<div class="flow-box">
<div class="box-content" style="text-align: center;">

<strong>👤 ユーザー → 💬 チャット送信 → 🤖 AI回答 → 📱 画面表示</strong>

つまり「ChatGPTみたいなもの」を
自分で作って提供するシステム！

</div>
</div>

---

## アーキテクチャ全体図

<div class="architecture-box">
<div class="box-title">🏗️ システム構成図</div>
<div class="box-content" style="text-align: center;">

<strong>👤 ユーザー（ブラウザ）</strong>
↓ ① 画面を見る

<strong>🖥️ フロントエンド（画面担当）</strong>
React + TypeScript「見た目」を作る
↓ ② APIリクエスト

<strong>🐍 バックエンド（処理担当）</strong>
Python + Flask「中身」を作る
↓

<table>
<tr><th>🔐 認証</th><th>💾 DB</th><th>🤖 AI</th></tr>
<tr><td>Firebase Auth</td><td>Firestore</td><td>Vertex AI (Gemini)</td></tr>
</table>

</div>
</div>

---

## 各パーツの役割（レストランで例える）

<div class="info-box">
<div class="box-title">🍽️ レストランに例えると...</div>
<div class="box-content">

<table>
<tr><th>技術</th><th>役割</th><th>レストランで言うと</th></tr>
<tr><td>React</td><td>画面を作る</td><td>内装・メニュー表</td></tr>
<tr><td>Python/Flask</td><td>処理をする</td><td>厨房</td></tr>
<tr><td>Firebase Auth</td><td>ログイン</td><td>受付・会員証確認</td></tr>
<tr><td>Firestore</td><td>データ保存</td><td>冷蔵庫・倉庫</td></tr>
<tr><td>Vertex AI (Gemini)</td><td>AI回答生成</td><td>シェフの頭脳</td></tr>
</table>

</div>
</div>

---

## データの流れ①: ログイン

<div class="flow-box">
<div class="box-title">🔐 ログインの流れ</div>
<div class="box-content">

1️⃣ ユーザーが「Googleでログイン」をクリック
↓
2️⃣ Googleの画面が出る（おなじみのやつ！）
↓
3️⃣ ログイン成功 → 「IDトークン」をもらう（これが「私は〇〇です」の証明書）
↓
4️⃣ このトークンを使ってAPIを呼び出す

</div>
</div>

**IDトークンって何？**

<div class="info-box">
<div class="box-title">📜 IDトークン = デジタル身分証明書</div>
<div class="box-content">

中身（イメージ）:
```json
{
  "name": "山田太郎",
  "email": "yamada@acme.co.jp",
  "会社": "株式会社ACME",
  "有効期限": "2024-01-16 15:00",
  "署名": "Google公式のお墨付き ✅"
}
```

✅ Googleが「この人は本物」と保証
✅ 改ざんすると署名が壊れる → 偽造不可能

</div>
</div>

---

## データの流れ②: チャット送信

<div class="flow-box">
<div class="box-title">💬 チャット送信の流れ</div>
<div class="box-content">

1️⃣ ユーザーが「こんにちは」と入力して送信
↓
2️⃣ フロントエンド → バックエンドにリクエスト（IDトークン付き）
↓
3️⃣ バックエンドでトークン検証
　「この人、本物？」→ ✅ OK!
　「許可されてる？」→ ✅ OK!
↓
4️⃣ Vertex AI (Gemini) に質問
↓
5️⃣ AIが回答を生成
↓
6️⃣ ストリーミングで少しずつ返す（「こん」→「にち」→「は！」）
↓
7️⃣ 画面にリアルタイム表示（かっこいい！）

</div>
</div>

---

## マルチテナント（複数会社対応）

<div class="architecture-box">
<div class="box-title">🏢 会社ごとにデータを分離</div>
<div class="box-content">

**Firestore（データベース）**

```
customers/
├── 🏢 acme-corp/          ← A社のデータ
│   ├── name: "株式会社ACME"
│   └── checkpoints/       ← A社の会話履歴
│       ├── user1_abc/
│       └── user2_def/
│
├── 🏢 beta-inc/           ← B社のデータ
│   ├── name: "ベータ株式会社"
│   └── checkpoints/       ← B社の会話履歴
│
└── 🏢 gamma-llc/          ← C社のデータ
```

💡 A社の人はB社のデータを見れない！（セキュリティ確保）

</div>
</div>

**自動振り分けの仕組み**

<div class="tip-box">
<div class="box-title">🎯 メールドメインで自動振り分け</div>
<div class="box-content">

<strong>【従来】</strong> 400人の社員を1人ずつ登録... 😓 大変！

<strong>【今のシステム】</strong>
<ol>
<li>管理者:「acme.co.jp というメールドメインを登録しておくね」</li>
<li>yamada@acme.co.jp がログイン</li>
<li>システム:「@acme.co.jp だ！→ A社のデータに振り分け」</li>
<li>完了！✅（再ログイン不要）</li>
</ol>

<p><strong>メモ:</strong> ここでいう「ドメイン」は、メールアドレスの@以降の部分（メールドメイン）です。URLドメインではありません。</p>

</div>
</div>

---

## 重要なファイル一覧

<div class="info-box">
<div class="box-title">📁 覚えておきたいファイル</div>
<div class="box-content">

**【バックエンド】backend/src/**
```
├── main.py              ★ すべての入口
├── common/
│   ├── auth.py          ★ 認証処理（自動振り分け）
│   └── rate_limiter.py    使いすぎ防止
└── agents/
    └── _template/
        └── agent.py     ★ AI処理本体
```

**【フロントエンド】frontend/src/**
```
├── App.tsx              ★ 画面の入口
├── hooks/
│   ├── useAuth.ts       ★ ログイン処理
│   ├── useChat.ts       ★ チャット処理
│   └── useSessions.ts     セッション管理
└── services/
    ├── firebase.ts        Firebase接続
    └── api.ts             サーバー通信
```

**【管理ツール】backend/scripts/**
```
└── manage_customer.py   ★ 顧客管理コマンド
```

</div>
</div>

---

## 理解度チェック

以下の質問に答えられたら、全体像はバッチリ！

| 質問 | ヒント |
|------|--------|
| ユーザーが送ったメッセージは、どの順番で処理される？ | フロント→バック→AI→... |
| 会社Aのデータが会社Bに見えないのはなぜ？ | customer_id で分離 |
| ログイン後、何がもらえる？ | IDトークン |

---

## 次のステップ

<div class="summary-box">
<div class="box-title">✅ 全体像を把握できた！</div>
<div class="box-content">

<strong>→ 次は 03_バックエンド解説.md でPython/AIの仕組みを学ぼう！</strong>

</div>
</div>
