# システム全体像 - 5分で掴む！

```
╔══════════════════════════════════════════════════════════════════╗
║  🎯 このページのゴール                                            ║
║                                                                    ║
║  「このシステムってこういう仕組みなんだ！」と説明できるようになる    ║
╚══════════════════════════════════════════════════════════════════╝
```

---

## ズバリ、何をするシステム？

```
┌─────────────────────────────────────────────────────────────────┐
│                                                                 │
│   👤 ユーザー  →  💬 チャット送信  →  🤖 AI回答  →  📱 画面表示   │
│                                                                 │
│                 つまり「ChatGPTみたいなもの」を                   │
│                 自分で作って提供するシステム！                    │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## アーキテクチャ全体図

```
┌─────────────────────────────────────────────────────────────────────┐
│                          🏗️ システム構成図                          │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│     👤 ユーザー（ブラウザ）                                          │
│         │                                                           │
│         │ ① 画面を見る                                              │
│         ▼                                                           │
│    ┌─────────────────────────┐                                     │
│    │   🖥️ フロントエンド      │  ← React + TypeScript               │
│    │   （画面担当）           │     「見た目」を作る                 │
│    └───────────┬─────────────┘                                     │
│                │ ② APIリクエスト                                    │
│                ▼                                                    │
│    ┌─────────────────────────┐                                     │
│    │   🐍 バックエンド        │  ← Python + Flask                   │
│    │   （処理担当）           │     「中身」を作る                   │
│    └───────────┬─────────────┘                                     │
│                │                                                    │
│       ┌────────┼────────┐                                          │
│       ▼        ▼        ▼                                          │
│    ┌─────┐ ┌─────┐ ┌─────┐                                        │
│    │🔐   │ │💾   │ │🤖   │                                        │
│    │認証 │ │DB   │ │AI   │                                        │
│    │     │ │     │ │     │                                        │
│    └─────┘ └─────┘ └─────┘                                        │
│    Firebase  Firestore Vertex AI                                    │
│     Auth               (Gemini)                                     │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 各パーツの役割（レストランで例える）

```
┌──────────────────────────────────────────────────────────────────┐
│  🍽️ レストランに例えると...                                        │
├──────────────────────────────────────────────────────────────────┤
│                                                                  │
│   技術                  役割            レストランで言うと        │
│  ─────────────────────────────────────────────────────────────   │
│   React              画面を作る         内装・メニュー表           │
│   Python/Flask       処理をする         厨房                      │
│   Firebase Auth      ログイン           受付・会員証確認          │
│   Firestore          データ保存         冷蔵庫・倉庫              │
│   Vertex AI (Gemini) AI回答生成         シェフの頭脳              │
│                                                                  │
└──────────────────────────────────────────────────────────────────┘
```

---

## データの流れ①: ログイン

```
┌─────────────────────────────────────────────────────────────────┐
│  🔐 ログインの流れ                                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│    1️⃣ ユーザーが「Googleでログイン」をクリック                    │
│         │                                                       │
│         ▼                                                       │
│    2️⃣ Googleの画面が出る（おなじみのやつ！）                      │
│         │                                                       │
│         ▼                                                       │
│    3️⃣ ログイン成功 → 「IDトークン」をもらう                       │
│         │             ~~~~~~~~~~~~~~~~                          │
│         │             これが「私は〇〇です」の証明書              │
│         ▼                                                       │
│    4️⃣ このトークンを使ってAPIを呼び出す                          │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

**IDトークンって何？**

```
┌─────────────────────────────────────────────────────────────────┐
│  📜 IDトークン = デジタル身分証明書                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  中身（イメージ）:                                               │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ {                                                       │   │
│  │   "name": "山田太郎",                                    │   │
│  │   "email": "yamada@acme.co.jp",                         │   │
│  │   "会社": "株式会社ACME",                                │   │
│  │   "有効期限": "2024-01-16 15:00",                        │   │
│  │   "署名": "Google公式のお墨付き ✅"                       │   │
│  │ }                                                       │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  ✅ Googleが「この人は本物」と保証                               │
│  ✅ 改ざんすると署名が壊れる → 偽造不可能                        │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## データの流れ②: チャット送信

```
┌─────────────────────────────────────────────────────────────────┐
│  💬 チャット送信の流れ                                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│    1️⃣ ユーザーが「こんにちは」と入力して送信                      │
│         │                                                       │
│         ▼                                                       │
│    2️⃣ フロントエンド → バックエンドにリクエスト                  │
│         │              （IDトークン付き）                        │
│         ▼                                                       │
│    3️⃣ バックエンドでトークン検証                                 │
│         │   「この人、本物？」→ ✅ OK!                           │
│         │   「許可されてる？」→ ✅ OK!                           │
│         ▼                                                       │
│    4️⃣ Vertex AI (Gemini) に質問                                 │
│         │                                                       │
│         ▼                                                       │
│    5️⃣ AIが回答を生成                                            │
│         │                                                       │
│         ▼                                                       │
│    6️⃣ ストリーミングで少しずつ返す                               │
│         │   「こん」→「にち」→「は！」                           │
│         ▼                                                       │
│    7️⃣ 画面にリアルタイム表示（かっこいい！）                      │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## マルチテナント（複数会社対応）

```
┌─────────────────────────────────────────────────────────────────┐
│  🏢 会社ごとにデータを分離                                       │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   Firestore（データベース）                                      │
│   │                                                             │
│   └── customers/                                                │
│       │                                                         │
│       ├── 🏢 acme-corp/          ← A社のデータ                  │
│       │   ├── name: "株式会社ACME"                              │
│       │   └── checkpoints/       ← A社の会話履歴                │
│       │       ├── user1_abc/                                    │
│       │       └── user2_def/                                    │
│       │                                                         │
│       ├── 🏢 beta-inc/           ← B社のデータ                  │
│       │   ├── name: "ベータ株式会社"                            │
│       │   └── checkpoints/       ← B社の会話履歴                │
│       │                                                         │
│       └── 🏢 gamma-llc/          ← C社のデータ                  │
│                                                                 │
│   💡 A社の人はB社のデータを見れない！（セキュリティ確保）         │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

**自動振り分けの仕組み**

```
┌─────────────────────────────────────────────────────────────────┐
│  🎯 ドメインで自動振り分け                                       │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   【従来】400人の社員を1人ずつ登録... 😓 大変！                   │
│                                                                 │
│   【今のシステム】                                               │
│                                                                 │
│   管理者:「acme.co.jp を登録しておくね」                         │
│        ↓                                                        │
│   yamada@acme.co.jp がログイン                                   │
│        ↓                                                        │
│   システム:「@acme.co.jp だ！→ A社のデータに振り分け」           │
│        ↓                                                        │
│   完了！✅ （再ログイン不要）                                     │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 重要なファイル一覧

```
┌─────────────────────────────────────────────────────────────────┐
│  📁 覚えておきたいファイル                                       │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  【バックエンド】backend/src/                                    │
│  ├── main.py              ★ すべての入口                        │
│  ├── common/                                                    │
│  │   ├── auth.py          ★ 認証処理（自動振り分け）            │
│  │   └── rate_limiter.py    使いすぎ防止                        │
│  └── agents/                                                    │
│      └── _template/                                             │
│          └── agent.py     ★ AI処理本体                         │
│                                                                 │
│  【フロントエンド】frontend/src/                                 │
│  ├── App.tsx              ★ 画面の入口                          │
│  ├── hooks/                                                     │
│  │   ├── useAuth.ts       ★ ログイン処理                        │
│  │   ├── useChat.ts       ★ チャット処理                        │
│  │   └── useSessions.ts     セッション管理                      │
│  └── services/                                                  │
│      ├── firebase.ts        Firebase接続                        │
│      └── api.ts             サーバー通信                        │
│                                                                 │
│  【管理ツール】backend/scripts/                                  │
│  └── manage_customer.py   ★ 顧客管理コマンド                    │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 理解度チェック

以下の質問に答えられたら、全体像はバッチリ！

| 質問 | ヒント |
|------|--------|
| ユーザーが送ったメッセージは、どの順番で処理される？ | フロント→バック→AI→... |
| 会社Aのデータが会社Bに見えないのはなぜ？ | customer_id で分離 |
| ログイン後、何がもらえる？ | IDトークン |

---

## 次のステップ

```
╔══════════════════════════════════════════════════════════════════╗
║                                                                    ║
║   ✅ 全体像を把握できた！                                          ║
║                                                                    ║
║   → 次は 03_バックエンド解説.md でPython/AIの仕組みを学ぼう！      ║
║                                                                    ║
╚══════════════════════════════════════════════════════════════════╝
```
