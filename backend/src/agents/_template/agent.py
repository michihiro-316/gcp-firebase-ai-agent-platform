"""
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                                                                              â•‘
â•‘   ğŸ§  AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆå¿ƒè‡“éƒ¨ï¼‰                                      â•‘
â•‘                                                                              â•‘
â•‘   â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â•‘
â•‘   ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯AIã®ã€Œæ€§æ ¼ã€ã¨ã€Œèƒ½åŠ›ã€ã‚’å®šç¾©ã™ã‚‹æœ€ã‚‚é‡è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ã§ã™ã€‚        â•‘
â•‘   ã“ã“ã‚’ç·¨é›†ã™ã‚‹ã“ã¨ã§AIã®å¿œç­”ã‚’è‡ªç”±ã«ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã§ãã¾ã™ã€‚                   â•‘
â•‘   â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â•‘
â•‘                                                                              â•‘
â•‘   ğŸ“ ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºæ–¹æ³•:                                                       â•‘
â•‘      1. SYSTEM_PROMPT ã‚’å¤‰æ›´ â†’ AIã®æ€§æ ¼ãƒ»å½¹å‰²ãŒå¤‰ã‚ã‚‹                        â•‘
â•‘      2. MODEL_NAME ã‚’å¤‰æ›´    â†’ é€Ÿåº¦ãƒ»ç²¾åº¦ãƒ»ã‚³ã‚¹ãƒˆãŒå¤‰ã‚ã‚‹                    â•‘
â•‘      3. TEMPERATURE ã‚’å¤‰æ›´   â†’ å‰µé€ æ€§ãƒ»ä¸€è²«æ€§ã®ãƒãƒ©ãƒ³ã‚¹ãŒå¤‰ã‚ã‚‹              â•‘
â•‘      4. create_graph() å¤‰æ›´  â†’ è¤‡é›‘ãªãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’è¿½åŠ ï¼ˆä¸Šç´šè€…å‘ã‘ï¼‰        â•‘
â•‘                                                                              â•‘
â•‘   ğŸ“ é¡§å®¢åˆ¥ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ä½œæˆ:                                               â•‘
â•‘      cp -r _template acme-corp                                               â•‘
â•‘      â†’ acme-corp/agent.py ã‚’ç·¨é›†                                             â•‘
â•‘      â†’ main.py ã® AGENTS è¾æ›¸ã«è¿½åŠ                                           â•‘
â•‘                                                                              â•‘
â•‘   ğŸ“š è©³ç´°ã‚¬ã‚¤ãƒ‰:                                                             â•‘
â•‘      - learning/md/08_AIã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º.md                                      â•‘
â•‘      - LangGraphå…¬å¼: https://langchain-ai.github.io/langgraph/             â•‘
â•‘                                                                              â•‘
â•‘   ğŸ’¡ LangGraphã¨ã¯ï¼Ÿ                                                         â•‘
â•‘      AIã®ã€Œæ€è€ƒã®æµã‚Œã€ã‚’å®šç¾©ã™ã‚‹ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã€‚                              â•‘
â•‘      è¤‡é›‘ãªå‡¦ç†ï¼ˆãƒ„ãƒ¼ãƒ«ä½¿ç”¨ã€æ¡ä»¶åˆ†å²ç­‰ï¼‰ã‚’è¿½åŠ ã§ãã¾ã™ã€‚                      â•‘
â•‘      å…¬å¼: https://langchain-ai.github.io/langgraph/                         â•‘
â•‘                                                                              â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
"""
from langchain_google_vertexai import ChatVertexAI
from langgraph.graph import StateGraph, END

from .._base.base_agent import BaseAgent
from .state import AgentState


class TemplateAgent(BaseAgent):
    """
    ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ

    é¡§å®¢åˆ¥ã«ã‚³ãƒ”ãƒ¼ã—ã¦ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã—ã¦ãã ã•ã„ã€‚
    """

    # â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    # â•‘                                                                       â•‘
    # â•‘   ğŸ¨ ã“ã“ã‹ã‚‰ä¸‹ã‚’è‡ªç”±ã«ç·¨é›†ã—ã¦ãã ã•ã„ï¼                               â•‘
    # â•‘                                                                       â•‘
    # â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”“
    # â”ƒ  1ï¸âƒ£  AIã®æ€§æ ¼ãƒ»å½¹å‰²ã‚’å®šç¾©ï¼ˆSYSTEM_PROMPTï¼‰                            â”ƒ
    # â”£â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”«
    # â”ƒ  ã“ã“ã‚’å¤‰æ›´ã™ã‚‹ã¨AIã®ã€Œäººæ ¼ã€ãŒå¤‰ã‚ã‚Šã¾ã™                              â”ƒ
    # â”ƒ                                                                       â”ƒ
    # â”ƒ  ğŸ’¡ ãƒ’ãƒ³ãƒˆ:                                                           â”ƒ
    # â”ƒ  - ã€Œã‚ãªãŸã¯ã€‡ã€‡ã§ã™ã€ã§å½¹å‰²ã‚’å®šç¾©                                   â”ƒ
    # â”ƒ  - ã€Œã€‡ã€‡ã—ã¦ãã ã•ã„ã€ã§è¡Œå‹•æŒ‡é‡ã‚’è¨­å®š                               â”ƒ
    # â”ƒ  - å…·ä½“ä¾‹ã‚’å…¥ã‚Œã‚‹ã¨ç²¾åº¦ãŒä¸ŠãŒã‚‹                                       â”ƒ
    # â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”›

    SYSTEM_PROMPT = """ã‚ãªãŸã¯è¦ªåˆ‡ã§ä¸å¯§ãªAIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚
ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è³ªå•ã«å¯¾ã—ã¦ã€ã‚ã‹ã‚Šã‚„ã™ãç°¡æ½”ã«å›ç­”ã—ã¦ãã ã•ã„ã€‚
æ—¥æœ¬èªã§å›ç­”ã—ã¦ãã ã•ã„ã€‚
éå»ã®ä¼šè©±ã®æ–‡è„ˆã‚’è¸ã¾ãˆã¦å›ç­”ã—ã¦ãã ã•ã„ã€‚"""

    # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”“
    # â”ƒ  2ï¸âƒ£  ä½¿ç”¨ã™ã‚‹AIãƒ¢ãƒ‡ãƒ«ã‚’é¸æŠï¼ˆMODEL_NAMEï¼‰                             â”ƒ
    # â”£â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”«
    # â”ƒ  é¸æŠè‚¢:                                                              â”ƒ
    # â”ƒ  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”ƒ
    # â”ƒ  â”‚ ãƒ¢ãƒ‡ãƒ«å          â”‚ é€Ÿåº¦    â”‚ ã‚³ã‚¹ãƒˆ  â”‚ ãŠã™ã™ã‚ç”¨é€”     â”‚         â”ƒ
    # â”ƒ  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤         â”ƒ
    # â”ƒ  â”‚ gemini-1.5-flash â”‚ âš¡é«˜é€Ÿ  â”‚ ğŸ’°å®‰ã„  â”‚ ä¸€èˆ¬çš„ãªä¼šè©±     â”‚         â”ƒ
    # â”ƒ  â”‚ gemini-1.5-pro   â”‚ ğŸ¢æ™®é€š  â”‚ ğŸ’°ğŸ’°é«˜ã„â”‚ è¤‡é›‘ãªæ¨è«–       â”‚         â”ƒ
    # â”ƒ  â”‚ gemini-2.0-flash â”‚ âš¡æœ€é€Ÿ  â”‚ ğŸ’°å®‰ã„  â”‚ æœ€æ–°æ©Ÿèƒ½ãŒå¿…è¦æ™‚ â”‚         â”ƒ
    # â”ƒ  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”ƒ
    # â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”›

    MODEL_NAME = "gemini-1.5-flash"

    # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”“
    # â”ƒ  3ï¸âƒ£  ä¼šè©±å±¥æ­´ã®ä¿æŒæ•°ï¼ˆMAX_HISTORY_MESSAGESï¼‰                         â”ƒ
    # â”£â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”«
    # â”ƒ  å¤šã„ â†’ æ–‡è„ˆã‚’ã‚ˆãè¦šãˆã‚‹ã€ã§ã‚‚ã‚³ã‚¹ãƒˆå¢—                                â”ƒ
    # â”ƒ  å°‘ãªã„ â†’ ã‚³ã‚¹ãƒˆæŠ‘ãˆã‚‹ã€ã§ã‚‚å¿˜ã‚Œã‚„ã™ã„                                â”ƒ
    # â”ƒ                                                                       â”ƒ
    # â”ƒ  ç›®å®‰: 10ã€œ30 ãŒä¸€èˆ¬çš„                                                â”ƒ
    # â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”›

    MAX_HISTORY_MESSAGES = 20

    # â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    # â•‘                                                                       â•‘
    # â•‘   ğŸ”’ ã“ã“ã‹ã‚‰ä¸‹ã¯é€šå¸¸å¤‰æ›´ä¸è¦ï¼ˆä¸Šç´šè€…å‘ã‘ï¼‰                             â•‘
    # â•‘                                                                       â•‘
    # â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    def __init__(self, checkpointer=None, project_id: str = None, location: str = "asia-northeast1"):
        super().__init__(checkpointer)
        self.project_id = project_id
        self.location = location

        self.llm = ChatVertexAI(
            model=self.MODEL_NAME,
            project=project_id,
            location=location,
            temperature=0.7,
            max_tokens=2048,
            streaming=True,
        )

    def create_graph(self) -> StateGraph:
        """LangGraphã®ã‚°ãƒ©ãƒ•ã‚’ä½œæˆ"""
        graph = StateGraph(AgentState)
        graph.add_node("chat", self._chat_node)
        graph.set_entry_point("chat")
        graph.add_edge("chat", END)
        return graph

    def get_initial_state(self) -> dict:
        return {"messages": []}

    def _trim_messages(self, messages: list) -> list:
        """ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å±¥æ­´ã‚’ç›´è¿‘Nä»¶ã«åˆ¶é™"""
        if len(messages) <= self.MAX_HISTORY_MESSAGES:
            return messages
        return messages[-self.MAX_HISTORY_MESSAGES:]

    async def _chat_node(self, state: AgentState) -> dict:
        """ãƒãƒ£ãƒƒãƒˆãƒãƒ¼ãƒ‰: ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ã«å¯¾ã—ã¦LLMã§å¿œç­”"""
        messages = state["messages"]
        trimmed_messages = self._trim_messages(messages)

        full_messages = [
            {"role": "system", "content": self.SYSTEM_PROMPT},
            *trimmed_messages
        ]

        response = await self.llm.ainvoke(full_messages)
        return {"messages": [response]}
